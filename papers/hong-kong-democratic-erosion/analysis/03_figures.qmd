---
title: "03 - Figures"
format: html
execute:
  echo: true
  warning: false
  message: false
  cache: true
fig-dpi: 300
---

```{r setup}
library(tidyverse)
library(patchwork)
library(scales)

theme_set(theme_minimal(base_size = 11) +
  theme(
    plot.title = element_text(face = "bold", size = 12),
    strip.text = element_text(face = "bold"),
    legend.position = "bottom"
  ))

focus_colors <- c(
  "Hong Kong" = "#E53935",
  "Taiwan" = "#1E88E5",
  "Singapore" = "#43A047",
  "Regional mean" = "#9E9E9E"
)

focus_shapes <- c(
  "Hong Kong" = 16,
  "Taiwan" = 15,
  "Singapore" = 17,
  "Regional mean" = 18
)
```

# Load Prepared Data

```{r load-data}
load("tables/prepared_data.RData")
```

# Helper: Build Trajectory Data

```{r trajectory-helper}
build_trajectory <- function(data, var, focus = focus_countries) {
  focus_means <- data |>
    filter(country_name %in% focus, wave <= 5) |>
    group_by(country_name, wave) |>
    summarise(mean = mean(!!sym(var), na.rm = TRUE), .groups = "drop")

  regional <- data |>
    filter(!country_name %in% focus, wave <= 5) |>
    group_by(wave) |>
    summarise(mean = mean(!!sym(var), na.rm = TRUE), .groups = "drop") |>
    mutate(country_name = "Regional mean")

  bind_rows(focus_means, regional) |>
    mutate(country_name = factor(country_name,
      levels = c("Hong Kong", "Taiwan", "Singapore", "Regional mean")))
}
```

# Figure 1: Key Democratic Attitude Trajectories

```{r fig1-trajectories, fig.width=14, fig.height=9}
traj_vars <- list(
  list(var = "democracy_suitability", title = "Democracy Suitability (1–10)"),
  list(var = "trust_president", title = "Trust in President/CE (1–4)"),
  list(var = "trust_police", title = "Trust in Police (1–4)"),
  list(var = "gov_free_to_organize", title = "Freedom to Organize (1–4)"),
  list(var = "dem_free_speech", title = "Press Censors Views (1–4)\n(higher = more censorship)"),
  list(var = "system_needs_change", title = "System Needs Major Change (1–4)")
)

make_traj_panel <- function(var, title) {
  df <- build_trajectory(d, var)
  ggplot(df, aes(x = wave, y = mean, color = country_name, shape = country_name)) +
    geom_line(aes(linetype = country_name), linewidth = 1) +
    geom_point(size = 3) +
    scale_color_manual(values = focus_colors) +
    scale_shape_manual(values = focus_shapes) +
    scale_linetype_manual(values = c("solid", "solid", "solid", "dashed")) +
    scale_x_continuous(breaks = 1:5, labels = paste0("W", 1:5)) +
    labs(title = title, x = NULL, y = NULL, color = NULL, shape = NULL, linetype = NULL) +
    theme(legend.position = "none")
}

panels <- map2(
  map_chr(traj_vars, "var"),
  map_chr(traj_vars, "title"),
  make_traj_panel
)

# Add legend to first panel
panels[[1]] <- panels[[1]] + theme(legend.position = "bottom")

fig1 <- wrap_plots(panels, ncol = 3) +
  plot_annotation(
    title = "Hong Kong's Democratic Erosion in Comparative Context",
    subtitle = "Asian Barometer Survey, Waves 1–5",
    theme = theme(
      plot.title = element_text(face = "bold", size = 14),
      plot.subtitle = element_text(size = 11)
    )
  )

fig1
ggsave("figures/fig1_trajectories.pdf", fig1, width = 14, height = 9)
ggsave("figures/fig1_trajectories.png", fig1, width = 14, height = 9, dpi = 300)
```

# Figure 2: Pre/Post NSL Comparison (Bar Chart)

```{r fig2-pre-post-nsl, fig.width=13, fig.height=6}
nsl_vars <- tribble(
  ~var, ~label,
  "trust_national_government", "Trust in\nGovernment",
  "trust_police", "Trust in\nPolice",
  "trust_president", "Trust in\nPresident/CE",
  "dem_always_preferable", "Democracy\nAlways Preferable",
  "gov_free_to_organize", "Freedom to\nOrganize",
  "dem_free_speech", "Press Censors\nOpposing Views",
  "democracy_suitability", "Democracy\nSuitability",
  "govt_responds_people", "Govt Responds\nto People",
  "system_needs_change", "System Needs\nMajor Change"
)

nsl_data <- hk5 |>
  filter(period %in% c("Protest", "Post-NSL")) |>
  pivot_longer(cols = all_of(nsl_vars$var), names_to = "variable", values_to = "value") |>
  filter(!is.na(value)) |>
  group_by(variable, period) |>
  summarise(mean = mean(value), se = sd(value) / sqrt(n()), .groups = "drop") |>
  left_join(nsl_vars, by = c("variable" = "var"))

fig2 <- ggplot(nsl_data, aes(x = label, y = mean, fill = period)) +
  geom_col(position = position_dodge(0.8), width = 0.7, alpha = 0.85) +
  geom_errorbar(aes(ymin = mean - 1.96 * se, ymax = mean + 1.96 * se),
                position = position_dodge(0.8), width = 0.25) +
  scale_fill_manual(values = c("Protest" = "#FF7043", "Post-NSL" = "#5C6BC0")) +
  labs(
    title = "Within-Wave 5: Protest Period vs Post-NSL (Hong Kong)",
    subtitle = sprintf("Protest period (Oct 2019–Jan 2020, n=%d) vs Post-NSL (Mar–May 2021, n=%d)",
                       sum(hk5$period == "Protest"), sum(hk5$period == "Post-NSL")),
    x = NULL, y = "Mean", fill = NULL
  ) +
  theme(axis.text.x = element_text(size = 8))

fig2
ggsave("figures/fig2_pre_post_nsl.pdf", fig2, width = 13, height = 6)
ggsave("figures/fig2_pre_post_nsl.png", fig2, width = 13, height = 6, dpi = 300)
```

# Figure 3: Cross-National Bar Charts (HK as Outlier)

```{r fig3-cross-national, fig.width=14, fig.height=10}
w5 <- d |> filter(wave == 5)

outlier_vars <- list(
  list(var = "dem_extent_current",
       title = "Extent of Current Democracy\n(1=full, 4=not at all)"),
  list(var = "trust_police",
       title = "Trust in Police\n(1=none, 4=great deal)"),
  list(var = "gov_free_to_organize",
       title = "Freedom to Organize\n(1=none, 4=great deal)"),
  list(var = "dem_free_speech",
       title = "Press Censors Views\n(1=strongly disagree, 4=agree)")
)

make_outlier_panel <- function(var, title) {
  means <- w5 |>
    group_by(country_name) |>
    summarise(mean = mean(!!sym(var), na.rm = TRUE), .groups = "drop") |>
    filter(!is.na(mean)) |>
    arrange(mean) |>
    mutate(
      fill = case_when(
        country_name == "Hong Kong" ~ "#E53935",
        country_name == "Taiwan" ~ "#1E88E5",
        country_name == "Singapore" ~ "#43A047",
        TRUE ~ "#BDBDBD"
      ),
      country_name = fct_inorder(country_name)
    )

  ggplot(means, aes(x = mean, y = country_name, fill = fill)) +
    geom_col(alpha = 0.8, show.legend = FALSE) +
    scale_fill_identity() +
    labs(title = title, x = NULL, y = NULL) +
    theme(axis.text.y = element_text(size = 8))
}

panels3 <- map2(
  map_chr(outlier_vars, "var"),
  map_chr(outlier_vars, "title"),
  make_outlier_panel
)

fig3 <- wrap_plots(panels3, ncol = 2) +
  plot_annotation(
    title = "Hong Kong as Cross-National Outlier (Wave 5)",
    subtitle = "Country means — Red: Hong Kong, Blue: Taiwan, Green: Singapore",
    theme = theme(plot.title = element_text(face = "bold", size = 14))
  )

fig3
ggsave("figures/fig3_cross_national.pdf", fig3, width = 14, height = 10)
ggsave("figures/fig3_cross_national.png", fig3, width = 14, height = 10, dpi = 300)
```

# Figure 4: Flipped Correlation (dem_preferable → dem_satisfaction)

```{r fig4-flipped, fig.width=14, fig.height=5}
corr_data <- d |>
  filter(country_name %in% c("Hong Kong", "Taiwan", "Singapore"),
         wave %in% c(3, 4, 5)) |>
  filter(!is.na(dem_always_preferable), !is.na(democracy_satisfaction))

fig4 <- ggplot(corr_data,
       aes(x = dem_always_preferable, y = democracy_satisfaction)) +
  geom_jitter(alpha = 0.05, width = 0.1, height = 0.1, size = 0.5, color = "grey50") +
  geom_smooth(method = "lm", color = "red", linewidth = 1.2) +
  facet_wrap(~country_name) +
  labs(
    title = "The Flipped Relationship: Democratic Preference → Democratic Satisfaction",
    subtitle = "HK is the only country where committed democrats are MORE satisfied (Waves 3–5)",
    x = "Democracy Always Preferable (1=always, 3=doesn't matter)",
    y = "Democracy Satisfaction (1–4)"
  )

fig4
ggsave("figures/fig4_flipped_correlation.pdf", fig4, width = 14, height = 5)
ggsave("figures/fig4_flipped_correlation.png", fig4, width = 14, height = 5, dpi = 300)
```

# Figure 5: Institutional Trust Trajectories

```{r fig5-trust, fig.width=13, fig.height=5.5}
trust_long <- d |>
  filter(wave <= 5) |>
  pivot_longer(cols = all_of(trust_vars[trust_vars %in% names(d)]),
               names_to = "institution", values_to = "value") |>
  filter(!is.na(value)) |>
  mutate(
    panel = if_else(country_name == "Hong Kong", "Hong Kong", "Regional Mean (excl. HK)"),
    institution = str_remove(institution, "trust_") |>
      str_replace_all("_", " ") |>
      str_to_title()
  ) |>
  group_by(panel, wave, institution) |>
  summarise(mean = mean(value), .groups = "drop")

fig5 <- ggplot(trust_long, aes(x = wave, y = mean, color = institution)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2.5) +
  facet_wrap(~panel) +
  scale_x_continuous(breaks = 1:5, labels = paste0("W", 1:5)) +
  scale_y_continuous(limits = c(1.5, 3.5)) +
  labs(
    title = "Institutional Trust Trajectories",
    x = NULL, y = "Trust (1=None, 4=Great deal)", color = NULL
  )

fig5
ggsave("figures/fig5_trust_trajectories.pdf", fig5, width = 13, height = 5.5)
ggsave("figures/fig5_trust_trajectories.png", fig5, width = 13, height = 5.5, dpi = 300)
```

# Figure 6: Monthly Timeline Within HK Wave 5

```{r fig6-monthly, fig.width=14, fig.height=9}
# Only keep months with n >= 30
monthly_data <- hk5 |>
  filter(!is.na(int_year), !is.na(int_month)) |>
  group_by(int_year, int_month) |>
  filter(n() >= 30) |>
  ungroup() |>
  mutate(date_decimal = int_year + (int_month - 0.5) / 12)

monthly_vars <- list(
  list(var = "democracy_suitability", title = "Democracy Suitability (1–10)"),
  list(var = "trust_police", title = "Trust in Police (1–4)"),
  list(var = "trust_national_government", title = "Trust in Government (1–4)"),
  list(var = "gov_free_to_organize", title = "Freedom to Organize (1–4)"),
  list(var = "dem_free_speech", title = "Press Censors Views (1–4)"),
  list(var = "dem_always_preferable", title = "Dem. Always Preferable\n(1=always, 3=doesn't matter)")
)

nsl_date <- 2020 + 5.5 / 12  # June 30, 2020

make_monthly_panel <- function(var, title) {
  summary_data <- monthly_data |>
    group_by(date_decimal) |>
    summarise(
      mean = mean(!!sym(var), na.rm = TRUE),
      se = sd(!!sym(var), na.rm = TRUE) / sqrt(sum(!is.na(!!sym(var)))),
      .groups = "drop"
    )

  ggplot(summary_data, aes(x = date_decimal, y = mean)) +
    geom_vline(xintercept = nsl_date, linetype = "dashed", alpha = 0.7) +
    annotate("text", x = nsl_date + 0.02, y = Inf, label = "NSL",
             vjust = 1.5, fontface = "bold", size = 3) +
    geom_ribbon(aes(ymin = mean - 1.96 * se, ymax = mean + 1.96 * se),
                alpha = 0.2, fill = "#E53935") +
    geom_line(color = "#E53935", linewidth = 1) +
    geom_point(color = "#E53935", size = 2.5) +
    scale_x_continuous(
      breaks = c(2019.75, 2020, 2020.25, 2020.5, 2021, 2021.25, 2021.5),
      labels = c("Oct\n2019", "Jan\n2020", "Apr", "Jul", "Jan\n2021", "Apr", "Jul")
    ) +
    labs(title = title, x = NULL, y = NULL)
}

panels6 <- map2(
  map_chr(monthly_vars, "var"),
  map_chr(monthly_vars, "title"),
  make_monthly_panel
)

fig6 <- wrap_plots(panels6, ncol = 3) +
  plot_annotation(
    title = "Hong Kong Wave 5: Monthly Attitude Trajectories",
    subtitle = "Oct 2019 – May 2021 | Dashed line: National Security Law (June 30, 2020)",
    theme = theme(plot.title = element_text(face = "bold", size = 14))
  )

fig6
ggsave("figures/fig6_monthly_timeline.pdf", fig6, width = 14, height = 9)
ggsave("figures/fig6_monthly_timeline.png", fig6, width = 14, height = 9, dpi = 300)
```

# Figure 7: Diverging Twins — Hong Kong vs Taiwan

```{r fig7-divergence, fig.width=14, fig.height=9}
div_vars <- list(
  list(var = "democracy_suitability", title = "Democracy Suitability (1–10)"),
  list(var = "trust_police", title = "Trust in Police (1–4)"),
  list(var = "dem_country_present_govt", title = "Rate Govt as Democratic (1–10)"),
  list(var = "election_free_fair", title = "Elections Free & Fair (1–4)"),
  list(var = "gov_free_to_organize", title = "Freedom to Organize (1–4)"),
  list(var = "system_proud", title = "Proud of System (1–4)")
)

make_div_panel <- function(var, title) {
  df <- d |>
    filter(country_name %in% c("Hong Kong", "Taiwan"), wave <= 5) |>
    group_by(country_name, wave) |>
    summarise(mean = mean(!!sym(var), na.rm = TRUE), .groups = "drop")

  ggplot(df, aes(x = wave, y = mean, color = country_name)) +
    geom_line(linewidth = 1.5) +
    geom_point(size = 3.5) +
    scale_color_manual(values = c("Hong Kong" = "#E53935", "Taiwan" = "#1E88E5")) +
    scale_x_continuous(breaks = 1:5, labels = paste0("W", 1:5)) +
    labs(title = title, x = NULL, y = NULL, color = NULL) +
    theme(legend.position = "none")
}

panels7 <- map2(
  map_chr(div_vars, "var"),
  map_chr(div_vars, "title"),
  make_div_panel
)

panels7[[1]] <- panels7[[1]] + theme(legend.position = "bottom")

fig7 <- wrap_plots(panels7, ncol = 3) +
  plot_annotation(
    title = 'Diverging Twins: Hong Kong vs Taiwan',
    subtitle = '"Same cultural heritage, opposite democratic trajectories"',
    theme = theme(plot.title = element_text(face = "bold", size = 14))
  )

fig7
ggsave("figures/fig7_hk_tw_divergence.pdf", fig7, width = 14, height = 9)
ggsave("figures/fig7_hk_tw_divergence.png", fig7, width = 14, height = 9, dpi = 300)
```

# Figure 8: Z-Score Heatmap (All Countries × All Indicators, Wave 5)

```{r fig8-heatmap, fig.width=15, fig.height=9}
zscore_vars <- c(
  "democracy_suitability", "dem_extent_current", "dem_always_preferable",
  "trust_president", "trust_police", "trust_courts", "trust_national_government",
  "gov_free_to_organize", "dem_free_speech", "election_free_fair",
  "system_needs_change", "system_proud", "democracy_satisfaction"
)
zscore_vars <- zscore_vars[zscore_vars %in% names(d)]

w5 <- d |> filter(wave == 5)

z_long <- w5 |>
  group_by(country_name) |>
  summarise(across(all_of(zscore_vars), ~mean(.x, na.rm = TRUE)), .groups = "drop") |>
  pivot_longer(-country_name, names_to = "variable", values_to = "value") |>
  group_by(variable) |>
  mutate(z = (value - mean(value, na.rm = TRUE)) / sd(value, na.rm = TRUE)) |>
  ungroup() |>
  mutate(
    variable = str_remove(variable, "^dem_|^trust_|^gov_|^system_|^democracy_") |>
      str_replace_all("_", " ") |>
      str_to_title(),
    country_name = fct_relevel(country_name, "Hong Kong")
  )

fig8 <- ggplot(z_long, aes(x = variable, y = country_name, fill = z)) +
  geom_tile(color = "white", linewidth = 0.5) +
  geom_text(aes(label = round(z, 1)),
            size = 2.5,
            color = if_else(abs(z_long$z) > 1.5, "white", "black")) +
  scale_fill_gradient2(low = "#1565C0", mid = "white", high = "#C62828",
                       midpoint = 0, limits = c(-3, 3),
                       name = "Z-score") +
  labs(
    title = "Wave 5 Country Positions Across Democratic Attitude Indicators",
    subtitle = "Red = above mean, Blue = below mean (z-scores)",
    x = NULL, y = NULL
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 9),
    axis.text.y = element_text(size = 9)
  )

fig8
ggsave("figures/fig8_zscore_heatmap.pdf", fig8, width = 15, height = 9)
ggsave("figures/fig8_zscore_heatmap.png", fig8, width = 15, height = 9, dpi = 300)
```
