---
title: "00 - Data Preparation"
format: html
execute:
  echo: true
  warning: false
  message: false
  cache: true
---

```{r setup}
library(tidyverse)
library(knitr)
```

# Load Harmonized Data

```{r load-data}
d <- readRDS("../../../data/processed/abs_econdev_authpref.rds")

country_labels <- c(
  `1` = "Japan", `2` = "Hong Kong", `3` = "South Korea", `4` = "China",
  `5` = "Mongolia", `6` = "Philippines", `7` = "Taiwan", `8` = "Thailand",
  `9` = "Indonesia", `10` = "Singapore", `11` = "Vietnam", `12` = "Cambodia",
  `13` = "Malaysia", `14` = "Myanmar", `15` = "Australia", `18` = "India"
)

d <- d |>
  mutate(country_name = country_labels[as.character(country)])

cat("Full dataset:", nrow(d), "respondents,",
    n_distinct(d$country_name), "countries,",
    n_distinct(d$wave), "waves\n")
```

# Hong Kong Subset

```{r hk-subset}
hk <- d |> filter(country == 2)

hk |>
  count(wave) |>
  kable(caption = "Hong Kong respondents by wave")
```

# Define Key Variable Sets

```{r variable-sets}
# Democratic attitudes
dem_vars <- c(
  "dem_always_preferable", "democracy_satisfaction", "democracy_suitability",
  "dem_extent_current", "dem_country_present_govt"
)

# Institutional trust
trust_vars <- c(
  "trust_national_government", "trust_president", "trust_parliament",
  "trust_police", "trust_military", "trust_courts"
)

# Efficacy & participation
efficacy_vars <- c(
  "efficacy_ability_participate", "efficacy_no_influence",
  "political_interest", "pol_discuss"
)

# Governance perceptions
gov_vars <- c(
  "gov_free_to_organize", "dem_free_speech", "gov_opposition_opportunities",
  "govt_responds_people", "gov_courts_powerless"
)

# Rights & freedoms
rights_vars <- c("rich_poor_treated_equally", "election_free_fair")

# Authoritarian alternatives
auth_vars <- c("strongman_rule", "military_rule", "single_party_rule")

# System support
system_vars <- c("system_deserves_support", "system_proud", "system_needs_change")

# All key variables combined
key_vars <- c(dem_vars, trust_vars, efficacy_vars, gov_vars,
              rights_vars, auth_vars, system_vars, "nat_willing_emigrate")
key_vars <- key_vars[key_vars %in% names(d)]
```

# Construct Pre/Post NSL Variable (HK Wave 5)

Hong Kong Wave 5 fieldwork: October 2019 – May 2021.
National Security Law enacted: June 30, 2020.

```{r nsl-split}
hk5 <- hk |>
  filter(wave == 5) |>
  mutate(
    int_month = as.numeric(int_month),
    int_year = as.numeric(int_year),
    # Define periods based on fieldwork clustering
    # Protest period: Oct 2019 - Jan 2020 (n ≈ 473)
    # Gap: Feb 2020 - Feb 2021 (n ≈ 51, COVID disruption)
    # Post-NSL: Mar - May 2021 (n ≈ 676)
    period = case_when(
      int_year == 2019 | (int_year == 2020 & int_month <= 1) ~ "Protest",
      int_year == 2021 & int_month >= 3 ~ "Post-NSL",
      TRUE ~ "Gap"
    ),
    period = factor(period, levels = c("Protest", "Gap", "Post-NSL"))
  )

hk5 |>
  count(period) |>
  kable(caption = "HK W5 respondents by period")
```

```{r interview-timeline}
hk5 |>
  filter(!is.na(int_year), !is.na(int_month)) |>
  count(int_year, int_month) |>
  mutate(date_label = paste0(int_year, "-", sprintf("%02d", int_month))) |>
  kable(caption = "HK W5 interview distribution by month")
```

# Age Cohort Variable

```{r age-cohorts}
hk5 <- hk5 |>
  mutate(
    age_group = cut(age,
      breaks = c(17, 29, 39, 49, 59, Inf),
      labels = c("18-29", "30-39", "40-49", "50-59", "60+")
    )
  )

hk5 |>
  count(age_group) |>
  kable(caption = "HK W5 respondents by age group")
```

# Focus Countries for Comparative Analysis

```{r focus-countries}
focus_countries <- c("Hong Kong", "Taiwan", "Singapore")

d_focus <- d |>
  filter(country_name %in% focus_countries)

d_focus |>
  count(country_name, wave) |>
  pivot_wider(names_from = wave, values_from = n, names_prefix = "W") |>
  kable(caption = "Respondents by country and wave (focus countries)")
```

# Save Prepared Objects

```{r save}
save(d, hk, hk5, key_vars, dem_vars, trust_vars, efficacy_vars,
     gov_vars, rights_vars, auth_vars, system_vars,
     country_labels, focus_countries,
     file = "results/prepared_data.RData")
```
