---
title: "06 - WVS Wave 7 Triangulation"
subtitle: "Pre-protest baseline comparison for Hong Kong democratic attitudes"
format: html
execute:
  echo: true
  warning: false
  message: false
  cache: true
---

# Overview
#
# This script loads the harmonized WVS dataset to establish a pre-protest
# baseline (fieldwork ~2018) for comparison with ABS Wave 5 protest-period
# and post-NSL measures. The goal is a compact triangulation showing that
# ABS W5 represents a sharp departure from pre-protest attitudes.
#
# DATA: Harmonized WVS parquet from the survey-data-prep pipeline.
#   Trust items are already reversed (higher = more trust, 1-4) to match ABS.
#   Democracy items are on native scales.

```{r setup}
library(tidyverse)
library(arrow)
library(knitr)
```

# ─── 1. Load harmonized WVS Wave 7 Hong Kong ─────────────────────────────

```{r load-wvs}
wvs_path <- "/Users/jeffreystark/Development/Research/survey-data-prep/data/processed/wvs_harmonized.parquet"

stopifnot("Harmonized WVS parquet not found" = file.exists(wvs_path))

wvs_all <- read_parquet(wvs_path)
cat("Harmonized WVS:", nrow(wvs_all), "respondents,",
    n_distinct(wvs_all$country), "countries\n")

# Extract Hong Kong Wave 7
wvs_hk <- wvs_all |> filter(country == "HKG", wave == 7)
cat("Hong Kong W7 N:", nrow(wvs_hk), "\n")
```

# ─── 2. Select key variables ──────────────────────────────────────────────

```{r select-vars}
# The harmonized dataset already has trust reversed (higher = more trust, 1-4)
# and democracy items on native scales, matching ABS conventions.
wvs_hk_clean <- wvs_hk |>
  transmute(
    source = "WVS W7",

    # Trust items (1-4, higher = more trust) — already match ABS
    trust_police     = trust_police,
    trust_govt       = trust_government,
    trust_parliament = trust_parliament,
    trust_courts     = trust_courts,
    trust_military   = trust_armed_forces,

    # Democracy importance (1-10, higher = more important)
    # Compared with ABS democracy_suitability (q104), also 1-10
    dem_suitability  = dem_importance_democracy
  )

cat("Valid observations per variable:\n")
wvs_hk_clean |>
  summarise(across(where(is.numeric), ~sum(!is.na(.)))) |>
  pivot_longer(everything(), names_to = "variable", values_to = "n_valid") |>
  kable()
```

# ─── 3. Load ABS W5 Hong Kong means ──────────────────────────────────────

```{r load-abs}
d <- readRDS("../../../data/processed/abs_econdev_authpref.rds")

hk5 <- d |>
  filter(country == 2, wave == 5) |>
  mutate(
    int_month = as.numeric(int_month),
    int_year = as.numeric(int_year),
    period = case_when(
      int_year == 2019 | (int_year == 2020 & int_month <= 1) ~ "Protest",
      int_year == 2021 & int_month >= 3 ~ "Post-NSL",
      TRUE ~ "Gap"
    )
  ) |>
  filter(period != "Gap")
```

# ─── 4. Compute comparison means ─────────────────────────────────────────

```{r comparison-means}
# WVS W7 (pre-protest baseline)
wvs_means <- wvs_hk_clean |>
  summarise(
    trust_police    = mean(trust_police, na.rm = TRUE),
    trust_govt      = mean(trust_govt, na.rm = TRUE),
    trust_parliament = mean(trust_parliament, na.rm = TRUE),
    trust_courts    = mean(trust_courts, na.rm = TRUE),
    trust_military  = mean(trust_military, na.rm = TRUE),
    dem_suitability = mean(dem_suitability, na.rm = TRUE)
  ) |>
  pivot_longer(everything(), names_to = "variable", values_to = "mean") |>
  mutate(source = "WVS W7 (Pre-protest)", .before = 1)

# ABS W5 Protest period (weighted)
abs_protest <- hk5 |>
  filter(period == "Protest") |>
  summarise(
    trust_police    = weighted.mean(trust_police, weight, na.rm = TRUE),
    trust_govt      = weighted.mean(trust_national_government, weight, na.rm = TRUE),
    trust_parliament = weighted.mean(trust_parliament, weight, na.rm = TRUE),
    trust_courts    = weighted.mean(trust_courts, weight, na.rm = TRUE),
    trust_military  = weighted.mean(trust_military, weight, na.rm = TRUE),
    dem_suitability = weighted.mean(democracy_suitability, weight, na.rm = TRUE)
  ) |>
  pivot_longer(everything(), names_to = "variable", values_to = "mean") |>
  mutate(source = "ABS W5 (Protest)", .before = 1)

# ABS W5 Post-NSL period (weighted)
abs_postnsl <- hk5 |>
  filter(period == "Post-NSL") |>
  summarise(
    trust_police    = weighted.mean(trust_police, weight, na.rm = TRUE),
    trust_govt      = weighted.mean(trust_national_government, weight, na.rm = TRUE),
    trust_parliament = weighted.mean(trust_parliament, weight, na.rm = TRUE),
    trust_courts    = weighted.mean(trust_courts, weight, na.rm = TRUE),
    trust_military  = weighted.mean(trust_military, weight, na.rm = TRUE),
    dem_suitability = weighted.mean(democracy_suitability, weight, na.rm = TRUE)
  ) |>
  pivot_longer(everything(), names_to = "variable", values_to = "mean") |>
  mutate(source = "ABS W5 (Post-NSL)", .before = 1)

# Combine
comparison <- bind_rows(wvs_means, abs_protest, abs_postnsl) |>
  mutate(
    source = factor(source, levels = c(
      "WVS W7 (Pre-protest)", "ABS W5 (Protest)", "ABS W5 (Post-NSL)"
    )),
    variable = recode(variable,
      "trust_police" = "Police",
      "trust_govt" = "National Gov't",
      "trust_parliament" = "Parliament",
      "trust_courts" = "Courts",
      "trust_military" = "Military",
      "dem_suitability" = "Democracy Suitability"
    )
  )

comparison |>
  pivot_wider(names_from = source, values_from = mean) |>
  mutate(across(where(is.numeric), ~round(., 2))) |>
  kable(caption = "Hong Kong: WVS W7 pre-protest baseline vs. ABS W5 periods (trust: 1-4, higher = more trust; dem suitability: 1-10).")
```

# ─── 5. Dot plot ──────────────────────────────────────────────────────────

```{r dot-plot, fig.width=8, fig.height=6}
# Separate trust (1-4) and democracy suitability (1-10) into facets
comparison <- comparison |>
  mutate(
    scale_group = if_else(
      variable == "Democracy Suitability",
      "Democracy Suitability (1-10)",
      "Institutional Trust (1-4)"
    )
  )

ggplot(comparison, aes(x = mean, y = fct_rev(variable), color = source, shape = source)) +
  geom_point(size = 3.5, position = position_dodge(width = 0.4)) +
  facet_wrap(~scale_group, scales = "free", ncol = 1) +
  scale_color_manual(
    values = c(
      "WVS W7 (Pre-protest)" = "#4477AA",
      "ABS W5 (Protest)" = "#EE6677",
      "ABS W5 (Post-NSL)" = "#228833"
    )
  ) +
  scale_shape_manual(values = c(16, 17, 15)) +
  labs(
    title = "Hong Kong: WVS W7 pre-protest baseline vs. ABS W5 periods",
    subtitle = "WVS W7 (2018) provides pre-crisis reference point",
    x = NULL,
    y = NULL,
    color = NULL, shape = NULL,
    caption = paste0(
      "Note: All trust items scaled 1-4 (higher = more trust). ",
      "WVS dem. importance compared with ABS dem. suitability, both 1-10.\n",
      "WVS W7 mode: mixed PAPI + CAWI. ABS W5 mode: face-to-face."
    )
  ) +
  theme_minimal(base_size = 13) +
  theme(
    legend.position = "top",
    panel.grid.major.y = element_line(color = "grey90"),
    plot.caption = element_text(size = 9, hjust = 0),
    strip.text = element_text(face = "bold")
  )

ggsave("figures/wvs_abs_comparison.pdf", width = 8, height = 6)
ggsave("figures/wvs_abs_comparison.png", width = 8, height = 6, dpi = 300)
```

# ─── 6. Summary statistics ───────────────────────────────────────────────

```{r summary}
# Print key takeaway
cat("\n=== KEY COMPARISON ===\n\n")
comparison |>
  pivot_wider(names_from = source, values_from = mean) |>
  mutate(
    `Protest vs WVS` = round(`ABS W5 (Protest)` - `WVS W7 (Pre-protest)`, 2),
    `Post-NSL vs WVS` = round(`ABS W5 (Post-NSL)` - `WVS W7 (Pre-protest)`, 2)
  ) |>
  kable(digits = 2,
        caption = "Change from WVS W7 pre-protest baseline to ABS W5 periods")
```

```{r wvs-n}
# Report for manuscript
cat("\nFor manuscript reporting:\n")
cat("WVS W7 Hong Kong N =", nrow(wvs_hk), "\n")
cat("Mode: Mixed PAPI + CAWI\n")
```
