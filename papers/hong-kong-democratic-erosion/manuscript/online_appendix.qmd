---
title: "Online Appendix: When the Levee Breaks"
author:
  - name: Jeffrey Stark
    affiliations:
      - name: Yonsei University
        department: Department of Sociology
    email: jeffrey.stark@yonsei.ac.kr
date: today
format:
  pdf:
    documentclass: article
    classoption: [letterpaper, 12pt]
    geometry: margin=1in
    linestretch: 2
    number-sections: true
    colorlinks: true
    linkcolor: blue
    urlcolor: blue
    citecolor: blue
    keep-tex: true
    include-in-header:
      text: |
        \usepackage{threeparttable}
        \usepackage{threeparttablex}
        \renewcommand{\thesection}{\Alph{section}}
        \renewcommand{\thesubsection}{\Alph{section}.\arabic{subsection}}
        \renewcommand{\thetable}{\Alph{section}\arabic{table}}
        \renewcommand{\thefigure}{\Alph{section}\arabic{figure}}
  html:
    toc: true
    toc-depth: 3
    number-sections: true
    theme: cosmo
  docx:
    toc: true
    number-sections: true
bibliography: references.bib
csl: apa.csl
execute:
  echo: false
  warning: false
  message: false
---

```{r setup}
#| include: false
library(tidyverse)
library(knitr)
library(kableExtra)
```

```{r load-data}
#| include: false
load("../analysis/results/prepared_data.RData")
load("../analysis/results/descriptive_results.RData")
load("../analysis/results/robustness_results.RData")

# Load main analysis results (falsification, FDR, sensitivity)
if (file.exists("../analysis/results/main_analysis_results.RData")) {
  load("../analysis/results/main_analysis_results.RData")
}
```

# Variable Definitions and Coding {#sec-variables}

@tbl-var-definitions presents the full set of variables used in the analysis, including original ABS item names, scale ranges, coding direction, and any recoding decisions.

```{r}
#| label: tbl-var-definitions
#| tbl-cap: "Variable definitions and coding. All scales oriented so that higher values indicate more of the named concept."

# TODO: Build this table from the actual variable metadata.
# Each row should include: Variable name (as used in text), ABS item code,
# Scale range (e.g., 1-4, 1-10), Original direction, Recoded?, Description.
# This can be constructed manually or extracted from the data preparation script.
# Example structure:
var_defs <- tribble(
  ~Variable, ~`ABS Item`, ~Scale, ~Direction, ~Description,
  "Democracy suitability", "q104", "1--10", "Higher = more suitable", "How suitable is democracy for [country]?",
  "Trust in police", "q14", "1--4", "Higher = more trust", "How much trust do you have in the police?",
  "Trust in national government", "q9", "1--4", "Higher = more trust", "How much trust do you have in the national government?",
  "Trust in president/CE", "q7", "1--4", "Higher = more trust", "How much trust do you have in the president/chief executive?",
  "Trust in courts", "q8", "1--4", "Higher = more trust", "How much trust do you have in the courts?",
  "Trust in parliament", "q11", "1--4", "Higher = more trust", "How much trust do you have in the parliament/legislature?",
  "Trust in military", "q13", "1--4", "Higher = more trust", "How much trust do you have in the military?",
  "Democracy always preferable", "q132", "1--3", "Higher = stronger preference", "Democracy is always preferable / sometimes authoritarian / doesn't matter",
  "Democratic satisfaction", "q99", "1--4", "Higher = more satisfied", "On the whole, how satisfied or dissatisfied are you with the way democracy works?",
  "Freedom to organize", "q116", "1--4", "Higher = more free", "People can join any organization they like without fear",
  "Free to speak without fear", "q115", "1--4", "Higher = more freedom", "People are free to speak what they think without fear",
  "Govt responds to people", "q121", "1--4", "Higher = more responsive", "How well do you think the government responds to what people want?",
  "Elections free and fair", "q38", "1--4", "Higher = more fair", "On the whole, how free and fair would you say the last national election was?",
  "System deserves support", "q88", "1--4", "Higher = more support", "A system like ours, even if it runs into problems, deserves the people's support",
  "System needs major change", "q90", "varies", "Higher = more change needed", "Would you say our system of government works fine as it is, needs minor change, needs major change, or should be replaced?",
  "Willing to emigrate", "q167", "varies", "Higher = more willing", "Given the chance, how willing would you be to go and live in another country?"
)

var_defs |>
  kable(booktabs = TRUE) |>
  kable_styling(latex_options = c("scale_down", "hold_position"))
```

**Note:** Item codes refer to the ABS Wave 5 merged questionnaire numbering (20230505_W5_merge_15).


# Mann-Whitney U Tests {#sec-mannwhitney}

All two-sample $t$-tests reported in the main text were cross-validated with non-parametric Mann-Whitney $U$ (Wilcoxon rank-sum) tests. This guards against violations of normality assumptions, which are plausible given that many indicators are measured on short ordinal scales (1--4). @tbl-mw-comparison reports both test results side by side.

```{r}
#| label: tbl-mw-comparison
#| tbl-cap: "Parametric (t-test) vs. non-parametric (Mann-Whitney U) comparison for all pre/post NSL variables."

if (exists("mw_results")) {
  mw_results |>
    select(variable, cohens_d, t_p, t_sig, mw_p, mw_sig, agree) |>
    mutate(across(c(cohens_d), ~round(.x, 3)),
           t_p = format.pval(t_p, digits = 3),
           mw_p = format.pval(mw_p, digits = 3)) |>
    kable(
      col.names = c("Variable", "Cohen's d", "t p-value", "", "MW p-value", "", "Agree?"),
      booktabs = TRUE
    ) |>
    kable_styling(latex_options = c("scale_down", "hold_position"))
} else {
  cat("Mann-Whitney results not yet computed. Run 04_robustness_checks.qmd first.")
}
```


# Demographic Balance Across Periods {#sec-balance}

A key concern with the within-wave quasi-experiment is that the Protest and Post-NSL sub-samples may differ systematically on demographic covariates, which could account for some of the observed attitudinal shifts. @tbl-balance reports means or proportions for age, gender, and education across the two periods, along with $t$-tests (continuous) or $\chi^2$ tests (categorical) for between-period differences.

```{r}
#| label: tbl-balance
#| tbl-cap: "Demographic balance across fieldwork periods (Protest vs. Post-NSL)."

if (exists("balance_table")) {
  balance_table |>
    kable(
      col.names = c("Covariate", "Protest", "Post-NSL", "Test", "p-value", ""),
      booktabs = TRUE
    ) |>
    kable_styling(latex_options = c("hold_position"))
} else {
  cat("Balance table not yet computed. Run 04_robustness_checks.qmd first.")
}
```


# Stratified Bootstrap and Manski Bounds {#sec-robustness}

## Stratified Percentile Bootstrap {#sec-bootstrap}

To assess the robustness of the pre/post NSL shifts to sampling variability, I employed a stratified percentile bootstrap with 5,000 iterations, resampling independently within the Protest and Post-NSL periods to preserve the temporal structure of the quasi-experiment. @tbl-bootstrap reports the observed Cohen's $d$ alongside 95% bias-corrected and accelerated (BCa) confidence intervals.

```{r}
#| label: tbl-bootstrap
#| tbl-cap: "Stratified bootstrap results (5,000 iterations): BCa 95% confidence intervals for Cohen's d."

if (exists("boot_results")) {
  boot_results |>
    select(variable, observed_d, boot_d_lo, boot_d_hi, ci_type, sig_boot) |>
    mutate(across(where(is.numeric), ~round(.x, 3))) |>
    kable(
      col.names = c("Variable", "Observed d", "d CI Lo", "d CI Hi",
                     "CI Type", "Sig?"),
      booktabs = TRUE
    ) |>
    kable_styling(latex_options = c("scale_down", "hold_position"))
} else {
  cat("Bootstrap results not yet computed. Run 04_robustness_checks.qmd first.")
}
```

```{r}
#| label: fig-bootstrap-forest
#| fig-cap: "Stratified bootstrap 95% BCa confidence intervals for Cohen's d (Protest − Post-NSL). Variables where the CI excludes zero are shown in colour."
#| fig-width: 10
#| fig-height: 8

if (exists("boot_results")) {
  boot_results |>
    mutate(
      variable = str_replace_all(variable, "_", " ") |> str_to_title(),
      sig_label = ifelse(sig_boot, "Significant", "Not significant")
    ) |>
    ggplot(aes(x = observed_d, y = reorder(variable, observed_d), color = sig_label)) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") +
    geom_point(size = 3) +
    geom_errorbarh(aes(xmin = boot_d_lo, xmax = boot_d_hi), height = 0.25) +
    scale_color_manual(values = c("Significant" = "#E53935", "Not significant" = "#9E9E9E")) +
    labs(
      x = "Cohen's d (Protest - Post-NSL)",
      y = NULL,
      color = NULL
    ) +
    theme_minimal(base_size = 11) +
    theme(legend.position = "bottom")
}
```


## Informal Bounding Analysis {#sec-manski}

A key concern with the trust increase is that compositional selection --- whereby regime critics disproportionately declined to participate in the post-NSL survey --- could entirely account for the observed shift. To assess the plausibility of this account, I conduct an informal bounding exercise in the spirit of @Manski2003-bounds.

The logic is as follows: if we assume that all non-respondents in the post-NSL period would have reported the minimum possible trust score (1 on the 1--4 scale), what proportion of the target population would need to have been "missing critics" for the trust increase to disappear? @tbl-manski-bounds-police and @tbl-manski-bounds-govt present the results for trust in police and trust in the national government, respectively.

```{r}
#| label: tbl-manski-bounds-police
#| tbl-cap: "Worst-case bounding analysis for trust in police. Each row assumes an additional percentage of the post-NSL target population declined to participate and would have reported minimum trust (1 on 1--4 scale)."

if (exists("manski_scenarios")) {
  manski_scenarios |>
    filter(variable == "Trust in Police") |>
    mutate(across(c(adjusted_mean), ~round(.x, 3))) |>
    select(pct_missing_critics, n_observed, n_missing, adjusted_mean, trust_still_higher) |>
    kable(
      col.names = c("% Missing Critics", "N Observed", "N Missing (imputed)",
                     "Adjusted Post-NSL Mean", "Still > Protest Mean?"),
      booktabs = TRUE
    ) |>
    kable_styling(latex_options = c("hold_position"))
} else {
  cat("Manski scenarios not yet computed. Run 04_robustness_checks.qmd first.")
}
```

```{r}
#| label: tbl-manski-bounds-govt
#| tbl-cap: "Worst-case bounding analysis for trust in national government. Each row assumes an additional percentage of the post-NSL target population declined to participate and would have reported minimum trust (1 on 1--4 scale)."

if (exists("manski_scenarios")) {
  manski_scenarios |>
    filter(variable == "Trust in Nat'l Government") |>
    mutate(across(c(adjusted_mean), ~round(.x, 3))) |>
    select(pct_missing_critics, n_observed, n_missing, adjusted_mean, trust_still_higher) |>
    kable(
      col.names = c("% Missing Critics", "N Observed", "N Missing (imputed)",
                     "Adjusted Post-NSL Mean", "Still > Protest Mean?"),
      booktabs = TRUE
    ) |>
    kable_styling(latex_options = c("hold_position"))
} else {
  cat("Manski scenarios for national government not yet computed.")
}
```

The results suggest that the observed trust increase is moderately robust to worst-case selection assumptions. The trust increase persists even under the assumption that a substantial proportion of missing respondents would have reported minimal trust, though it does eventually disappear under extreme non-response scenarios. This exercise does not resolve the ambiguity between preference falsification and compositional selection --- both remain plausible contributors --- but it provides a concrete benchmark for evaluating the magnitude of selection required to explain the full trust shift.


# Supplementary Figures {#sec-figures}

## Age-Stratified Pre/Post NSL Shifts {#sec-age-stratified}

@fig-age-strat-appendix presents the pre/post NSL mean comparison within each age cohort for trust in police, trust in government, democracy suitability, and freedom to organize. If the trust increase were driven entirely by compositional selection --- specifically, by younger, more critical respondents declining to participate in the post-NSL period --- we would expect the shift to appear primarily or exclusively in younger age groups. The figure shows that while the magnitude of change varies across cohorts, the direction of the trust increase is broadly consistent across age groups, which is more consistent with preference falsification operating across the population than with a purely compositional account.

```{r}
#| label: fig-age-strat-appendix
#| fig-cap: "Pre/Post NSL mean shifts within age cohorts for key indicators. Error bars show 95% confidence intervals."
#| fig-width: 12
#| fig-height: 7

hk5_analysis <- hk5 |>
  filter(period %in% c("Protest", "Post-NSL")) |>
  mutate(period = droplevels(period))

age_strat_vars <- c("trust_police", "democracy_suitability",
                     "trust_national_government", "gov_free_to_organize")

age_strat_labels <- c(
  trust_police = "Trust in Police",
  democracy_suitability = "Democracy Suitability",
  trust_national_government = "Trust in Government",
  gov_free_to_organize = "Freedom to Organize"
)

age_strat_data <- hk5_analysis |>
  filter(!is.na(age_group)) |>
  pivot_longer(cols = all_of(age_strat_vars), names_to = "variable", values_to = "value") |>
  filter(!is.na(value)) |>
  group_by(variable, period, age_group) |>
  summarise(
    mean = mean(value),
    se = sd(value) / sqrt(n()),
    n = n(),
    .groups = "drop"
  ) |>
  mutate(var_label = age_strat_labels[variable])

ggplot(age_strat_data, aes(x = age_group, y = mean, fill = period)) +
  geom_col(position = position_dodge(0.8), width = 0.7, alpha = 0.85) +
  geom_errorbar(aes(ymin = mean - 1.96 * se, ymax = mean + 1.96 * se),
                position = position_dodge(0.8), width = 0.25) +
  facet_wrap(~var_label, scales = "free_y", ncol = 2) +
  scale_fill_manual(values = c("Protest" = "#FF7043", "Post-NSL" = "#5C6BC0")) +
  labs(x = "Age Cohort", y = "Mean", fill = NULL) +
  theme_minimal(base_size = 11) +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45, hjust = 1))
```


# Falsification Tests and Multiple Comparisons {#sec-falsification}

## Negative Control Outcomes

To assess whether the observed attitudinal shifts are specifically attributable to politically sensitive mechanisms rather than generalized confounding (e.g., pandemic effects, time trends), I pre-specified a set of items that should not be sensitive to political repression. @tbl-falsification reports the pre/post NSL comparison for these "negative control" items.

```{r}
#| label: tbl-falsification
#| tbl-cap: "Falsification tests: pre-specified politically insensitive items. Small or non-significant effects are consistent with NSL-specific mechanisms rather than generalized confounding."

if (exists("falsification_results") && !is.null(falsification_results)) {
  falsification_results |>
    mutate(across(c(protest_mean, postnsl_mean, delta, cohens_d), ~round(.x, 3)),
           p_value = format.pval(p_value, digits = 3)) |>
    kable(
      col.names = c("Variable", "Protest Mean", "Post-NSL Mean",
                     "Delta", "Cohen's d", "p-value", "Sig"),
      booktabs = TRUE
    ) |>
    kable_styling(latex_options = c("hold_position"))
} else {
  cat("Falsification results not yet computed. Run 02_main_analysis.qmd first.")
}
```

## Benjamini-Hochberg FDR Correction

The main analysis tests multiple variables simultaneously. To guard against inflated Type I error rates, @tbl-fdr reports raw and Benjamini-Hochberg adjusted $p$-values for all pre/post NSL comparisons. The four pre-specified primary outcomes are flagged.

```{r}
#| label: tbl-fdr
#| tbl-cap: "Raw and FDR-corrected (Benjamini-Hochberg) p-values for all pre/post NSL comparisons."

if (exists("fdr_results")) {
  fdr_results |>
    select(variable, primary, cohens_d, p_value, sig, p_bh, sig_bh) |>
    mutate(across(c(cohens_d), ~round(.x, 3)),
           p_value = format.pval(p_value, digits = 3),
           p_bh = format.pval(p_bh, digits = 3)) |>
    kable(
      col.names = c("Variable", "Primary?", "Cohen's d", "p (raw)", "",
                     "p (BH-adj)", ""),
      booktabs = TRUE
    ) |>
    kable_styling(latex_options = c("scale_down", "hold_position"))
} else {
  cat("FDR results not yet computed. Run 02_main_analysis.qmd first.")
}
```


# Critical Citizens Correlation: CI and Period Decomposition {#sec-critical-citizens}

The main text reports that Hong Kong is the only country among the sixteen ABS Wave 5 polities where the correlation between democratic preference ("democracy is always preferable") and democratic satisfaction is positive. This section reports the precise estimate with 95% confidence intervals and decomposes the correlation by fieldwork period.

```{r}
#| label: tbl-critical-citizens-ci
#| tbl-cap: "Critical citizens correlation (democratic preference × democratic satisfaction): overall and by fieldwork period, with 95% confidence intervals."

# TODO: This code should be run once the data objects are confirmed.
# The structure below is correct for the ABS data.

if (exists("hk5")) {
  hk5_cc <- hk5 |>
    filter(!is.na(dem_always_preferable), !is.na(democracy_satisfaction))

  # Overall correlation with CI
  overall_test <- cor.test(hk5_cc$dem_always_preferable, hk5_cc$democracy_satisfaction,
                           method = "pearson")

  # By period
  protest_cc <- hk5_cc |> filter(period == "Protest")
  postnsl_cc <- hk5_cc |> filter(period == "Post-NSL")

  protest_test <- if (nrow(protest_cc) > 10) {
    cor.test(protest_cc$dem_always_preferable, protest_cc$democracy_satisfaction)
  } else { NULL }

  postnsl_test <- if (nrow(postnsl_cc) > 10) {
    cor.test(postnsl_cc$dem_always_preferable, postnsl_cc$democracy_satisfaction)
  } else { NULL }

  cc_results <- tibble(
    Period = c("Overall (Wave 5)", "Protest period", "Post-NSL period"),
    N = c(nrow(hk5_cc), nrow(protest_cc), nrow(postnsl_cc)),
    r = c(overall_test$estimate,
          if (!is.null(protest_test)) protest_test$estimate else NA,
          if (!is.null(postnsl_test)) postnsl_test$estimate else NA),
    CI_lo = c(overall_test$conf.int[1],
              if (!is.null(protest_test)) protest_test$conf.int[1] else NA,
              if (!is.null(postnsl_test)) postnsl_test$conf.int[1] else NA),
    CI_hi = c(overall_test$conf.int[2],
              if (!is.null(protest_test)) protest_test$conf.int[2] else NA,
              if (!is.null(postnsl_test)) postnsl_test$conf.int[2] else NA),
    p = c(overall_test$p.value,
          if (!is.null(protest_test)) protest_test$p.value else NA,
          if (!is.null(postnsl_test)) postnsl_test$p.value else NA)
  )

  cc_results |>
    mutate(across(c(r, CI_lo, CI_hi), ~round(.x, 3)),
           p = format.pval(p, digits = 3)) |>
    kable(
      col.names = c("Period", "N", "r", "95% CI Lo", "95% CI Hi", "p-value"),
      booktabs = TRUE
    ) |>
    kable_styling(latex_options = c("hold_position"))
} else {
  cat("Data not loaded. Ensure prepared_data.RData is available.")
}
```

If the positive correlation is concentrated in the post-NSL period, this supports the interpretation that concept co-optation --- the regime's redefinition of "democracy" --- is driving the reversal of the standard critical citizens pattern. If the positive correlation is already present during the protest period, the interpretation is more ambiguous and may reflect features of Hong Kong's political culture that predate the NSL.
