---
title: "Online Appendix: When the Levee Breaks"
author:
  - name: Jeffrey Stark
    affiliations:
      - name: Yonsei University
        department: Department of Sociology
    email: jeffrey.stark@yonsei.ac.kr
date: today
format:
  pdf:
    documentclass: article
    classoption: [letterpaper, 12pt]
    geometry: margin=1in
    linestretch: 2
    number-sections: true
    colorlinks: true
    linkcolor: blue
    urlcolor: blue
    citecolor: blue
    keep-tex: true
    include-in-header:
      text: |
        \usepackage{threeparttable}
        \usepackage{threeparttablex}
        \renewcommand{\thesection}{\Alph{section}}
        \renewcommand{\thesubsection}{\Alph{section}.\arabic{subsection}}
        \renewcommand{\thetable}{\Alph{section}\arabic{table}}
        \renewcommand{\thefigure}{\Alph{section}\arabic{figure}}
  html:
    toc: true
    toc-depth: 3
    number-sections: true
    theme: cosmo
  docx:
    toc: true
    number-sections: true
bibliography: references.bib
csl: apa.csl
execute:
  echo: false
  warning: false
  message: false
---

```{r setup}
#| include: false
library(tidyverse)
library(knitr)
library(kableExtra)
```

```{r load-data}
#| include: false
load("../analysis/results/prepared_data.RData")
load("../analysis/results/descriptive_results.RData")
load("../analysis/results/robustness_results.RData")

# Load main analysis results (falsification, FDR, sensitivity)
if (file.exists("../analysis/results/main_analysis_results.RData")) {
  load("../analysis/results/main_analysis_results.RData")
}
```

# Variable Definitions and Coding {#sec-variables}

@tbl-var-definitions presents the full set of variables used in the analysis, including original ABS item names, scale ranges, coding direction, and any recoding decisions.

```{r}
#| label: tbl-var-definitions
#| tbl-cap: "Variable definitions and coding. All scales oriented so that higher values indicate more of the named concept."

# TODO: Build this table from the actual variable metadata.
# Each row should include: Variable name (as used in text), ABS item code,
# Scale range (e.g., 1-4, 1-10), Original direction, Recoded?, Description.
# This can be constructed manually or extracted from the data preparation script.
# Example structure:
var_defs <- tribble(
  ~Variable, ~`ABS Item`, ~Scale, ~Direction, ~Description,
  "Democracy suitability", "q104", "1--10", "Higher = more suitable", "How suitable is democracy for [country]?",
  "Trust in police", "q14", "1--4", "Higher = more trust", "How much trust do you have in the police?",
  "Trust in national government", "q9", "1--4", "Higher = more trust", "How much trust do you have in the national government?",
  "Trust in president/CE", "q7", "1--4", "Higher = more trust", "How much trust do you have in the president/chief executive?",
  "Trust in courts", "q8", "1--4", "Higher = more trust", "How much trust do you have in the courts?",
  "Trust in parliament", "q11", "1--4", "Higher = more trust", "How much trust do you have in the parliament/legislature?",
  "Trust in military", "q13", "1--4", "Higher = more trust", "How much trust do you have in the military?",
  "Democracy always preferable", "q132", "1--3", "Higher = stronger preference", "Democracy is always preferable / sometimes authoritarian / doesn't matter",
  "Democratic satisfaction", "q99", "1--4", "Higher = more satisfied", "On the whole, how satisfied or dissatisfied are you with the way democracy works?",
  "Freedom to organize", "q116", "1--4", "Higher = more free", "People can join any organization they like without fear",
  "Free to speak without fear", "q115", "1--4", "Higher = more freedom", "People are free to speak what they think without fear",
  "Govt responds to people", "q121", "1--4", "Higher = more responsive", "How well do you think the government responds to what people want?",
  "Elections free and fair", "q38", "1--4", "Higher = more fair", "On the whole, how free and fair would you say the last national election was?",
  "System deserves support", "q88", "1--4", "Higher = more support", "A system like ours, even if it runs into problems, deserves the people's support",
  "System needs major change", "q90", "varies", "Higher = more change needed", "Would you say our system of government works fine as it is, needs minor change, needs major change, or should be replaced?",
  "Willing to emigrate", "q167", "varies", "Higher = more willing", "Given the chance, how willing would you be to go and live in another country?"
)

var_defs |>
  kable(booktabs = TRUE) |>
  kable_styling(latex_options = c("scale_down", "hold_position"))
```

**Note:** Item codes refer to the ABS Wave 5 merged questionnaire numbering (20230505_W5_merge_15).


# Mann-Whitney U Tests {#sec-mannwhitney}

All two-sample $t$-tests reported in the main text were cross-validated with non-parametric Mann-Whitney $U$ (Wilcoxon rank-sum) tests. This guards against violations of normality assumptions, which are plausible given that many indicators are measured on short ordinal scales (1--4). @tbl-mw-comparison reports both test results side by side.

```{r}
#| label: tbl-mw-comparison
#| tbl-cap: "Parametric (t-test) vs. non-parametric (Mann-Whitney U) comparison for all pre/post NSL variables."

if (exists("mw_results")) {
  mw_results |>
    select(variable, cohens_d, t_p, t_sig, mw_p, mw_sig, agree) |>
    mutate(across(c(cohens_d), ~round(.x, 3)),
           t_p = format.pval(t_p, digits = 3),
           mw_p = format.pval(mw_p, digits = 3)) |>
    kable(
      col.names = c("Variable", "Cohen's d", "t p-value", "", "MW p-value", "", "Agree?"),
      booktabs = TRUE
    ) |>
    kable_styling(latex_options = c("scale_down", "hold_position")) |>
    footnote(
      general = "Cohen's d computed as (Post-NSL \u2212 Protest) / pooled SD; positive values indicate higher post-NSL responses.",
      general_title = "Note: ",
      footnote_as_chunk = TRUE
    )
} else {
  cat("Mann-Whitney results not yet computed. Run 04_robustness_checks.qmd first.")
}
```


# Demographic Balance Across Periods {#sec-balance}

A key concern with the within-wave quasi-experiment is that the Protest and Post-NSL sub-samples may differ systematically on demographic covariates, which could account for some of the observed attitudinal shifts. @tbl-balance reports means or proportions for age, gender, and education across the two periods, along with $t$-tests (continuous) or $\chi^2$ tests (categorical) for between-period differences.

```{r}
#| label: tbl-balance
#| tbl-cap: "Demographic balance across fieldwork periods (Protest vs. Post-NSL). SMD = standardized mean difference."

hk5_balance <- hk5 |>
  filter(period %in% c("Protest", "Post-NSL"))

balance_rows <- list()

# Age (continuous)
age_protest <- hk5_balance |> filter(period == "Protest") |> pull(age)
age_postnsl <- hk5_balance |> filter(period == "Post-NSL") |> pull(age)
age_t <- t.test(age_protest, age_postnsl)
pooled_sd_age <- sqrt(((length(age_protest) - 1) * sd(age_protest, na.rm = TRUE)^2 +
                        (length(age_postnsl) - 1) * sd(age_postnsl, na.rm = TRUE)^2) /
                       (length(age_protest) + length(age_postnsl) - 2))
smd_age <- (mean(age_protest, na.rm = TRUE) - mean(age_postnsl, na.rm = TRUE)) / pooled_sd_age

balance_rows[[1]] <- tibble(
  Covariate = "Age (mean)",
  Protest = as.character(round(mean(age_protest, na.rm = TRUE), 1)),
  `Post-NSL` = as.character(round(mean(age_postnsl, na.rm = TRUE), 1)),
  SMD = round(smd_age, 3),
  Test = "t-test",
  `p-value` = round(age_t$p.value, 3)
)

# Gender
gender_var <- if ("female" %in% names(hk5_balance)) "female" else
              if ("gender" %in% names(hk5_balance)) "gender" else NULL

if (!is.null(gender_var)) {
  gender_tab <- hk5_balance |>
    filter(!is.na(!!sym(gender_var))) |>
    count(period, !!sym(gender_var)) |>
    group_by(period) |>
    mutate(prop = n / sum(n)) |>
    ungroup()

  gender_chi <- chisq.test(table(hk5_balance[[gender_var]], hk5_balance$period))

  if (gender_var == "female") {
    p1 <- mean(hk5_balance$female[hk5_balance$period == "Protest"], na.rm = TRUE)
    p2 <- mean(hk5_balance$female[hk5_balance$period == "Post-NSL"], na.rm = TRUE)
  } else {
    protest_tab <- gender_tab |> filter(period == "Protest")
    postnsl_tab <- gender_tab |> filter(period == "Post-NSL")
    p1 <- if (nrow(protest_tab) >= 2) protest_tab$prop[2] else NA
    p2 <- if (nrow(postnsl_tab) >= 2) postnsl_tab$prop[2] else NA
  }
  pooled_p <- (p1 + p2) / 2
  smd_gender <- if (!is.na(p1) && !is.na(p2)) (p1 - p2) / sqrt(pooled_p * (1 - pooled_p)) else NA

  balance_rows[[2]] <- tibble(
    Covariate = "Gender (% female)",
    Protest = paste0(round(p1 * 100, 1), "%"),
    `Post-NSL` = paste0(round(p2 * 100, 1), "%"),
    SMD = round(smd_gender, 3),
    Test = "Chi-squared",
    `p-value` = round(gender_chi$p.value, 3)
  )
}

# Education
edu_var <- if ("education_level_clean" %in% names(hk5_balance)) "education_level_clean" else
           if ("education_level" %in% names(hk5_balance)) "education_level" else NULL

if (!is.null(edu_var)) {
  edu_data <- hk5_balance |> mutate(
    edu_clean = case_when(
      !!sym(edu_var) %in% c(-1, 11, 97, 98, 99) ~ NA_real_,
      TRUE ~ as.numeric(!!sym(edu_var))
    )
  )
  edu_protest <- edu_data |> filter(period == "Protest") |> pull(edu_clean)
  edu_postnsl <- edu_data |> filter(period == "Post-NSL") |> pull(edu_clean)
  edu_t <- t.test(edu_protest, edu_postnsl)
  pooled_sd_edu <- sqrt(((sum(!is.na(edu_protest)) - 1) * sd(edu_protest, na.rm = TRUE)^2 +
                          (sum(!is.na(edu_postnsl)) - 1) * sd(edu_postnsl, na.rm = TRUE)^2) /
                         (sum(!is.na(edu_protest)) + sum(!is.na(edu_postnsl)) - 2))
  smd_edu <- (mean(edu_protest, na.rm = TRUE) - mean(edu_postnsl, na.rm = TRUE)) / pooled_sd_edu

  balance_rows[[length(balance_rows) + 1]] <- tibble(
    Covariate = "Education level (SE5, ordinal 1-10)",
    Protest = as.character(round(mean(edu_protest, na.rm = TRUE), 2)),
    `Post-NSL` = as.character(round(mean(edu_postnsl, na.rm = TRUE), 2)),
    SMD = round(smd_edu, 3),
    Test = "t-test",
    `p-value` = round(edu_t$p.value, 3)
  )
}

# Age groups (categorical)
if ("age_group" %in% names(hk5_balance)) {
  age_grp_tab <- hk5_balance |>
    filter(!is.na(age_group)) |>
    count(period, age_group) |>
    group_by(period) |>
    mutate(prop = round(n / sum(n) * 100, 1)) |>
    ungroup()

  age_chi <- chisq.test(table(hk5_balance$age_group, hk5_balance$period))

  for (ag in sort(unique(age_grp_tab$age_group))) {
    p_val <- age_grp_tab |> filter(period == "Protest", age_group == ag) |> pull(prop)
    pn_val <- age_grp_tab |> filter(period == "Post-NSL", age_group == ag) |> pull(prop)
    p_val <- if (length(p_val) == 0) 0 else p_val
    pn_val <- if (length(pn_val) == 0) 0 else pn_val

    balance_rows[[length(balance_rows) + 1]] <- tibble(
      Covariate = paste0("  Age ", ag),
      Protest = paste0(p_val, "%"),
      `Post-NSL` = paste0(pn_val, "%"),
      SMD = NA_real_,
      Test = if (ag == sort(unique(age_grp_tab$age_group))[1]) "Chi-squared" else "",
      `p-value` = if (ag == sort(unique(age_grp_tab$age_group))[1]) round(age_chi$p.value, 3) else NA_real_
    )
  }
}

bind_rows(balance_rows) |>
  kable(booktabs = TRUE) |>
  kable_styling(latex_options = c("hold_position")) |>
  footnote(
    general = "SMD computed as (Protest \u2212 Post-NSL) / pooled SD for continuous variables and as the difference in proportions / pooled SD for binary variables. Values |SMD| < 0.1 indicate good balance.",
    general_title = "Note: ",
    footnote_as_chunk = TRUE
  )
```


# Stratified Bootstrap and Manski Bounds {#sec-robustness}

## Stratified Percentile Bootstrap {#sec-bootstrap}

To assess the robustness of the pre/post NSL shifts to sampling variability, I employed a stratified percentile bootstrap with 5,000 iterations, resampling independently within the Protest and Post-NSL periods to preserve the temporal structure of the quasi-experiment. @tbl-bootstrap reports the observed Cohen's $d$ alongside 95% bias-corrected and accelerated (BCa) confidence intervals.

```{r}
#| label: tbl-bootstrap
#| tbl-cap: "Stratified bootstrap results (5,000 iterations): BCa 95% confidence intervals for Cohen's d."

if (exists("boot_results")) {
  boot_results |>
    select(variable, observed_d, boot_d_lo, boot_d_hi, ci_type, sig_boot) |>
    mutate(across(where(is.numeric), ~round(.x, 3))) |>
    kable(
      col.names = c("Variable", "Observed d", "d CI Lo", "d CI Hi",
                     "CI Type", "Sig?"),
      booktabs = TRUE
    ) |>
    kable_styling(latex_options = c("scale_down", "hold_position")) |>
    footnote(
      general = "Cohen's d computed as (Post-NSL \u2212 Protest) / pooled SD; positive values indicate higher post-NSL responses.",
      general_title = "Note: ",
      footnote_as_chunk = TRUE
    )
} else {
  cat("Bootstrap results not yet computed. Run 04_robustness_checks.qmd first.")
}
```

```{r}
#| label: fig-bootstrap-forest
#| fig-cap: "Stratified bootstrap 95% BCa confidence intervals for Cohen's d (Post-NSL − Protest). Positive values indicate higher post-NSL responses. Variables where the CI excludes zero are shown in colour."
#| fig-width: 10
#| fig-height: 8

if (exists("boot_results")) {
  boot_results |>
    mutate(
      variable = str_replace_all(variable, "_", " ") |> str_to_title(),
      sig_label = ifelse(sig_boot, "Significant", "Not significant")
    ) |>
    ggplot(aes(x = observed_d, y = reorder(variable, observed_d), color = sig_label)) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "grey50") +
    geom_point(size = 3) +
    geom_errorbarh(aes(xmin = boot_d_lo, xmax = boot_d_hi), height = 0.25) +
    scale_color_manual(values = c("Significant" = "#E53935", "Not significant" = "#9E9E9E")) +
    labs(
      x = "Cohen's d (Post-NSL \u2212 Protest)",
      y = NULL,
      color = NULL
    ) +
    theme_minimal(base_size = 11) +
    theme(legend.position = "bottom")
}
```


## Informal Bounding Analysis {#sec-manski}

A key concern with the trust increase is that compositional selection --- whereby regime critics disproportionately declined to participate in the post-NSL survey --- could entirely account for the observed shift. To assess the plausibility of this account, I conduct an informal bounding exercise in the spirit of @Manski2003-bounds.

The logic is as follows: if we assume that all non-respondents in the post-NSL period would have reported the minimum possible trust score (1 on the 1--4 scale), what proportion of the target population would need to have been "missing critics" for the trust increase to disappear? I present two scenarios: a worst-case bound (imputing the scale minimum) and a more empirically grounded scenario (imputing the 25th percentile of the protest-period distribution, representing respondents drawn from the bottom quartile of critics). @tbl-manski-bounds-police and @tbl-manski-bounds-govt present the results for trust in police and trust in the national government, respectively.

```{r}
#| label: tbl-manski-bounds-police
#| tbl-cap: "Bounding analysis for trust in police: worst-case (impute minimum) and bottom-quartile (impute 25th percentile of protest distribution) scenarios."

hk5_manski <- hk5 |> filter(period %in% c("Protest", "Post-NSL"))

protest_police <- hk5_manski |> filter(period == "Protest", !is.na(trust_police)) |> pull(trust_police)
postnsl_police <- hk5_manski |> filter(period == "Post-NSL", !is.na(trust_police)) |> pull(trust_police)
protest_mean_police <- mean(protest_police, na.rm = TRUE)
q25_police <- quantile(protest_police, 0.25, na.rm = TRUE)
scale_min_police <- min(c(protest_police, postnsl_police), na.rm = TRUE)

manski_police_ext <- map_dfr(seq(0, 40, by = 5), function(pct) {
  n_obs <- length(postnsl_police)
  n_miss <- round(n_obs * pct / (100 - pct))
  total_n <- n_obs + n_miss
  adj_mean_min <- (sum(postnsl_police) + n_miss * scale_min_police) / total_n
  adj_mean_q25 <- (sum(postnsl_police) + n_miss * q25_police) / total_n
  tibble(
    `% Missing` = pct,
    `N Obs` = n_obs,
    `N Missing` = n_miss,
    `Adj Mean (min)` = round(adj_mean_min, 3),
    `Still > Protest? (min)` = adj_mean_min > protest_mean_police,
    `Adj Mean (Q25)` = round(adj_mean_q25, 3),
    `Still > Protest? (Q25)` = adj_mean_q25 > protest_mean_police
  )
})

manski_police_ext |>
  kable(booktabs = TRUE) |>
  kable_styling(latex_options = c("scale_down", "hold_position")) |>
  footnote(
    general = paste0(
      "Protest-period mean: ", round(protest_mean_police, 3),
      ". Worst-case imputes scale minimum (", scale_min_police,
      "); Q25 imputes the 25th percentile of the protest-period distribution (",
      q25_police, "), a more empirically grounded assumption."
    ),
    general_title = "Note: ",
    footnote_as_chunk = TRUE
  )
```

```{r}
#| label: tbl-manski-bounds-govt
#| tbl-cap: "Bounding analysis for trust in national government: worst-case (impute minimum) and bottom-quartile (impute 25th percentile of protest distribution) scenarios."

protest_govt <- hk5_manski |> filter(period == "Protest", !is.na(trust_national_government)) |> pull(trust_national_government)
postnsl_govt <- hk5_manski |> filter(period == "Post-NSL", !is.na(trust_national_government)) |> pull(trust_national_government)
protest_mean_govt <- mean(protest_govt, na.rm = TRUE)
q25_govt <- quantile(protest_govt, 0.25, na.rm = TRUE)
scale_min_govt <- min(c(protest_govt, postnsl_govt), na.rm = TRUE)

manski_govt_ext <- map_dfr(seq(0, 40, by = 5), function(pct) {
  n_obs <- length(postnsl_govt)
  n_miss <- round(n_obs * pct / (100 - pct))
  total_n <- n_obs + n_miss
  adj_mean_min <- (sum(postnsl_govt) + n_miss * scale_min_govt) / total_n
  adj_mean_q25 <- (sum(postnsl_govt) + n_miss * q25_govt) / total_n
  tibble(
    `% Missing` = pct,
    `N Obs` = n_obs,
    `N Missing` = n_miss,
    `Adj Mean (min)` = round(adj_mean_min, 3),
    `Still > Protest? (min)` = adj_mean_min > protest_mean_govt,
    `Adj Mean (Q25)` = round(adj_mean_q25, 3),
    `Still > Protest? (Q25)` = adj_mean_q25 > protest_mean_govt
  )
})

manski_govt_ext |>
  kable(booktabs = TRUE) |>
  kable_styling(latex_options = c("scale_down", "hold_position")) |>
  footnote(
    general = paste0(
      "Protest-period mean: ", round(protest_mean_govt, 3),
      ". Worst-case imputes scale minimum (", scale_min_govt,
      "); Q25 imputes the 25th percentile of the protest-period distribution (",
      q25_govt, "), a more empirically grounded assumption."
    ),
    general_title = "Note: ",
    footnote_as_chunk = TRUE
  )
```

The results suggest that the observed trust increase is moderately robust to worst-case selection assumptions. Under the more empirically plausible bottom-quartile scenario, the trust increase persists at even higher levels of missing critics. The trust increase disappears only under extreme non-response scenarios with worst-case imputation. This exercise does not resolve the ambiguity between preference falsification and compositional selection --- both remain plausible contributors --- but it provides a concrete benchmark for evaluating the magnitude of selection required to explain the full trust shift.


# Supplementary Figures {#sec-figures}

## Age-Stratified Pre/Post NSL Shifts {#sec-age-stratified}

@fig-age-strat-appendix presents the pre/post NSL mean comparison within each age cohort for trust in police, trust in government, democracy suitability, and freedom to organize. If the trust increase were driven entirely by compositional selection --- specifically, by younger, more critical respondents declining to participate in the post-NSL period --- we would expect the shift to appear primarily or exclusively in younger age groups. The figure shows that while the magnitude of change varies across cohorts, the direction of the trust increase is broadly consistent across age groups, which is more consistent with preference falsification operating across the population than with a purely compositional account.

```{r}
#| label: fig-age-strat-appendix
#| fig-cap: "Pre/Post NSL mean shifts within age cohorts for key indicators. Error bars show 95% confidence intervals."
#| fig-width: 12
#| fig-height: 7

hk5_analysis <- hk5 |>
  filter(period %in% c("Protest", "Post-NSL")) |>
  mutate(period = droplevels(period))

age_strat_vars <- c("trust_police", "democracy_suitability",
                     "trust_national_government", "gov_free_to_organize")

age_strat_labels <- c(
  trust_police = "Trust in Police",
  democracy_suitability = "Democracy Suitability",
  trust_national_government = "Trust in Government",
  gov_free_to_organize = "Freedom to Organize"
)

age_strat_data <- hk5_analysis |>
  filter(!is.na(age_group)) |>
  pivot_longer(cols = all_of(age_strat_vars), names_to = "variable", values_to = "value") |>
  filter(!is.na(value)) |>
  group_by(variable, period, age_group) |>
  summarise(
    mean = mean(value),
    se = sd(value) / sqrt(n()),
    n = n(),
    .groups = "drop"
  ) |>
  mutate(var_label = age_strat_labels[variable])

ggplot(age_strat_data, aes(x = age_group, y = mean, fill = period)) +
  geom_col(position = position_dodge(0.8), width = 0.7, alpha = 0.85) +
  geom_errorbar(aes(ymin = mean - 1.96 * se, ymax = mean + 1.96 * se),
                position = position_dodge(0.8), width = 0.25) +
  facet_wrap(~var_label, scales = "free_y", ncol = 2) +
  scale_fill_manual(values = c("Protest" = "#FF7043", "Post-NSL" = "#5C6BC0")) +
  labs(x = "Age Cohort", y = "Mean", fill = NULL) +
  theme_minimal(base_size = 11) +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45, hjust = 1))
```


# Falsification Tests and Multiple Comparisons {#sec-falsification}

## Placebo-Adjacent Items

To assess whether the observed attitudinal shifts are specifically attributable to politically sensitive mechanisms rather than generalized confounding (e.g., pandemic effects, time trends), I pre-specified a set of items with lower expected political sensitivity. @tbl-falsification reports the pre/post NSL comparison for these placebo-adjacent items.

```{r}
#| label: tbl-falsification
#| tbl-cap: "Placebo-adjacent items: pre-specified items with lower expected political sensitivity. Small or non-significant effects are consistent with NSL-specific mechanisms rather than generalized confounding."

if (exists("falsification_results") && !is.null(falsification_results)) {
  falsification_results |>
    mutate(across(c(protest_mean, postnsl_mean, delta, cohens_d), ~round(.x, 3)),
           p_value = format.pval(p_value, digits = 3)) |>
    kable(
      col.names = c("Variable", "Protest Mean", "Post-NSL Mean",
                     "Delta", "Cohen's d", "p-value", "Sig"),
      booktabs = TRUE
    ) |>
    kable_styling(latex_options = c("hold_position")) |>
    footnote(
      general = "Cohen's d computed as (Post-NSL \u2212 Protest) / pooled SD; positive values indicate higher post-NSL responses.",
      general_title = "Note: ",
      footnote_as_chunk = TRUE
    )
} else {
  cat("Falsification results not yet computed. Run 02_main_analysis.qmd first.")
}
```

## Benjamini-Hochberg FDR Correction

The main analysis tests multiple variables simultaneously. To guard against inflated Type I error rates, @tbl-fdr reports raw and Benjamini-Hochberg adjusted $p$-values for all pre/post NSL comparisons. The four pre-specified primary outcomes are flagged.

```{r}
#| label: tbl-fdr
#| tbl-cap: "Raw and FDR-corrected (Benjamini-Hochberg) p-values for all pre/post NSL comparisons."

if (exists("fdr_results")) {
  fdr_results |>
    select(variable, primary, cohens_d, p_value, sig, p_bh, sig_bh) |>
    mutate(across(c(cohens_d), ~round(.x, 3)),
           p_value = format.pval(p_value, digits = 3),
           p_bh = format.pval(p_bh, digits = 3)) |>
    kable(
      col.names = c("Variable", "Primary?", "Cohen's d", "p (raw)", "",
                     "p (BH-adj)", ""),
      booktabs = TRUE
    ) |>
    kable_styling(latex_options = c("scale_down", "hold_position")) |>
    footnote(
      general = "Cohen's d computed as (Post-NSL \u2212 Protest) / pooled SD; positive values indicate higher post-NSL responses.",
      general_title = "Note: ",
      footnote_as_chunk = TRUE
    )
} else {
  cat("FDR results not yet computed. Run 02_main_analysis.qmd first.")
}
```


# Critical Citizens Correlation: CI and Period Decomposition {#sec-critical-citizens}

The main text reports that Hong Kong is the only country among the sixteen ABS Wave 5 polities where the correlation between democratic preference ("democracy is always preferable") and democratic satisfaction is positive. This section reports the precise estimate with 95% confidence intervals and decomposes the correlation by fieldwork period.

```{r}
#| label: tbl-critical-citizens-ci
#| tbl-cap: "Critical citizens correlation (democratic preference × democratic satisfaction): overall and by fieldwork period, with 95% confidence intervals."

# TODO: This code should be run once the data objects are confirmed.
# The structure below is correct for the ABS data.

if (exists("hk5")) {
  hk5_cc <- hk5 |>
    filter(!is.na(dem_always_preferable), !is.na(democracy_satisfaction))

  # Overall correlation with CI
  overall_test <- cor.test(hk5_cc$dem_always_preferable, hk5_cc$democracy_satisfaction,
                           method = "pearson")

  # By period
  protest_cc <- hk5_cc |> filter(period == "Protest")
  postnsl_cc <- hk5_cc |> filter(period == "Post-NSL")

  protest_test <- if (nrow(protest_cc) > 10) {
    cor.test(protest_cc$dem_always_preferable, protest_cc$democracy_satisfaction)
  } else { NULL }

  postnsl_test <- if (nrow(postnsl_cc) > 10) {
    cor.test(postnsl_cc$dem_always_preferable, postnsl_cc$democracy_satisfaction)
  } else { NULL }

  cc_results <- tibble(
    Period = c("Overall (Wave 5)", "Protest period", "Post-NSL period"),
    N = c(nrow(hk5_cc), nrow(protest_cc), nrow(postnsl_cc)),
    r = c(overall_test$estimate,
          if (!is.null(protest_test)) protest_test$estimate else NA,
          if (!is.null(postnsl_test)) postnsl_test$estimate else NA),
    CI_lo = c(overall_test$conf.int[1],
              if (!is.null(protest_test)) protest_test$conf.int[1] else NA,
              if (!is.null(postnsl_test)) postnsl_test$conf.int[1] else NA),
    CI_hi = c(overall_test$conf.int[2],
              if (!is.null(protest_test)) protest_test$conf.int[2] else NA,
              if (!is.null(postnsl_test)) postnsl_test$conf.int[2] else NA),
    p = c(overall_test$p.value,
          if (!is.null(protest_test)) protest_test$p.value else NA,
          if (!is.null(postnsl_test)) postnsl_test$p.value else NA)
  )

  cc_results |>
    mutate(across(c(r, CI_lo, CI_hi), ~round(.x, 3)),
           p = format.pval(p, digits = 3)) |>
    kable(
      col.names = c("Period", "N", "r", "95% CI Lo", "95% CI Hi", "p-value"),
      booktabs = TRUE
    ) |>
    kable_styling(latex_options = c("hold_position"))
} else {
  cat("Data not loaded. Ensure prepared_data.RData is available.")
}
```

If the positive correlation is concentrated in the post-NSL period, this supports the interpretation that concept co-optation --- the regime's redefinition of "democracy" --- is driving the reversal of the standard critical citizens pattern. If the positive correlation is already present during the protest period, the interpretation is more ambiguous and may reflect features of Hong Kong's political culture that predate the NSL.


# Robust Standard Errors {#sec-robust-se}

To address potential heteroskedasticity and assess sensitivity to standard error computation, @tbl-robust-se reports covariate-adjusted estimates with both conventional OLS standard errors and heteroskedasticity-consistent (HC2) robust standard errors for the four primary outcomes.

```{r}
#| label: tbl-robust-se
#| tbl-cap: "Covariate-adjusted Post-NSL effect estimates with conventional and HC2 robust standard errors."

library(sandwich)
library(lmtest)

hk5_robust <- hk5 |>
  filter(period %in% c("Protest", "Post-NSL")) |>
  mutate(post_nsl = as.integer(period == "Post-NSL"))

outcomes <- c("trust_police", "trust_national_government",
              "democracy_suitability", "gov_free_to_organize")
labels_robust <- c("Trust in Police", "Trust in National Government",
            "Democracy Suitability", "Freedom to Organize")

# Build covariate formula dynamically based on available variables
covs <- c()
if ("age" %in% names(hk5_robust) && sum(!is.na(hk5_robust$age)) > 100) covs <- c(covs, "age")
if ("female" %in% names(hk5_robust) && sum(!is.na(hk5_robust$female)) > 100) {
  covs <- c(covs, "female")
} else if ("gender" %in% names(hk5_robust) && sum(!is.na(hk5_robust$gender)) > 100) {
  covs <- c(covs, "gender")
}
if ("education_level_clean" %in% names(hk5_robust) && sum(!is.na(hk5_robust$education_level_clean)) > 100) {
  covs <- c(covs, "education_level_clean")
} else if ("education_level" %in% names(hk5_robust)) {
  hk5_robust <- hk5_robust |> mutate(
    edu_clean = case_when(
      education_level %in% c(-1, 11, 97, 98, 99) ~ NA_real_,
      TRUE ~ as.numeric(education_level)
    )
  )
  if (sum(!is.na(hk5_robust$edu_clean)) > 100) covs <- c(covs, "edu_clean")
}

cov_string <- if (length(covs) > 0) paste("+", paste(covs, collapse = " + ")) else ""

robust_results <- map2_dfr(outcomes, labels_robust, function(outcome, label) {
  f <- as.formula(paste(outcome, "~ post_nsl", cov_string))
  m <- lm(f, data = hk5_robust)
  robust_test <- coeftest(m, vcov = vcovHC(m, type = "HC2"))

  tibble(
    Outcome = label,
    b = round(coef(m)["post_nsl"], 3),
    `SE (conv)` = round(summary(m)$coefficients["post_nsl", "Std. Error"], 3),
    `SE (HC2)` = round(robust_test["post_nsl", "Std. Error"], 3),
    `p (conv)` = format.pval(summary(m)$coefficients["post_nsl", "Pr(>|t|)"], digits = 3),
    `p (HC2)` = format.pval(robust_test["post_nsl", "Pr(>|t|)"], digits = 3)
  )
})

robust_results |>
  kable(booktabs = TRUE) |>
  kable_styling(latex_options = c("hold_position")) |>
  footnote(
    general = paste0("All models control for ", paste(covs, collapse = ", "),
                     ". HC2 standard errors are heteroskedasticity-consistent. ",
                     "Substantive conclusions are unchanged across specifications."),
    general_title = "Note: ",
    footnote_as_chunk = TRUE
  )
```

The HC2 robust standard errors are substantively indistinguishable from conventional OLS standard errors across all four primary outcomes, confirming that heteroskedasticity does not meaningfully affect inference.
