---
title: "Hypothesis Testing: The Vietnam Paradox"
subtitle: "COVID, Trust, and Regime Legitimacy in Southeast Asia"
author: "Jeffrey Stark"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    number-sections: true
    code-fold: show
    df-print: paged
---

# 1. Setup

```{r 00-setup, message=FALSE, warning=FALSE}
# Core packages
library(tidyverse)
library(here)
library(gt)
library(gtExtras)
library(gtsummary)
library(scales)
library(patchwork)
library(broom)
library(car)        # For VIF
library(lmtest)     # For robust SEs
library(sandwich)   # For robust SEs
library(interactions) # For interaction plots
library(mediation)  # For mediation analysis
library(marginaleffects) # For marginal effects

# Set theme
theme_set(theme_minimal(base_size = 12))

# Force dplyr functions
select <- dplyr::select
filter <- dplyr::filter
mutate <- dplyr::mutate

# Helper function: safely extract coefficient info using broom::tidy()
# Returns NA values if term is not in model (e.g., dropped due to collinearity)
safe_extract_coef <- function(model, term) {
  tidy_result <- broom::tidy(model, conf.int = TRUE)
  term_row <- tidy_result %>% filter(term == !!term)

  if (nrow(term_row) == 0) {
    # Term not in model - return NAs
    return(list(
      coef = NA_real_,
      se = NA_real_,
      t = NA_real_,
      p = NA_real_,
      ci_lower = NA_real_,
      ci_upper = NA_real_
    ))
  }

  list(
    coef = term_row$estimate,
    se = term_row$std.error,
    t = term_row$statistic,
    p = term_row$p.value,
    ci_lower = term_row$conf.low,
    ci_upper = term_row$conf.high
  )
}

# Load data (from modular pipeline)
ab_analysis <- readRDS(here("papers", "vietnam_covid_paradox", "analysis", "data", "analysis_data.rds"))

# Convert haven_labelled country_name to standard factor for compatibility
ab_analysis <- ab_analysis %>%
  mutate(country_name = as.factor(as.character(country_name)))

# Create analysis-ready datasets
ab_minimal <- ab_analysis %>%
  filter(
    !is.na(covid_contracted) & 
    !is.na(covid_govt_handling) &
    !is.na(covid_trust_info) & 
    !is.na(dem_satisfaction) &
    !is.na(institutional_trust_index)
  )

ab_full <- ab_analysis %>%
  filter(
    !is.na(covid_contracted) &
    !is.na(covid_govt_handling) &
    !is.na(covid_trust_info) &
    !is.na(dem_satisfaction) &
    !is.na(institutional_trust_index) &
    !is.na(auth_acceptance) &
    !is.na(covid_impact_severity) &
    !is.na(income_quintile) &
    !is.na(econ_anxiety) &
    !is.na(age) & !is.na(gender) &
    !is.na(educ_level) & !is.na(urban)
  )

cat("✓ Loaded", nrow(ab_analysis), "total observations\n")
cat("✓ Minimal model sample:", nrow(ab_minimal), "\n")
cat("✓ Full model sample:", nrow(ab_full), "\n")

# ============================================================================
# STANDARDIZE VARIABLES FOR β (STANDARDIZED) COEFFICIENTS
# ============================================================================
# This ensures all regression coefficients are standardized (β), allowing
# direct comparison of effect sizes across predictors with different scales.
# Binary variables (covid_contracted, gender, urban) are also standardized
# so their β values are comparable to continuous predictors.
# ============================================================================

# Define variables to standardize
vars_to_standardize <- c(
  # DV
  "covid_govt_handling",
  # Main IVs
  "covid_contracted",
  "covid_trust_info",
  "covid_impact_severity",
  # Economic controls
  "income_quintile",
  "econ_anxiety",
  # Controls
  "institutional_trust_index",
  "dem_satisfaction",
  "auth_acceptance",
  "age",
  "educ_level",
  "urban"
)

# Helper function: standardize within each country (preserves cross-country variation)
# Using pooled standardization (across all countries) for comparability
standardize_vars <- function(df, vars) {

  for (v in vars) {
    if (v %in% names(df) && is.numeric(df[[v]])) {
      df[[v]] <- as.numeric(scale(df[[v]]))
    }
  }
  return(df)
}

# Apply standardization
ab_minimal <- standardize_vars(ab_minimal, vars_to_standardize)
ab_full <- standardize_vars(ab_full, vars_to_standardize)

cat("\n✓ Variables standardized for β coefficients\n")
cat("  Standardized:", paste(vars_to_standardize, collapse = ", "), "\n")
cat("  Note: All coefficients are now standardized (β).\n")
cat("  Interpretation: A 1-SD increase in X predicts β SDs change in Y.\n")
```

# 2. Research Hypotheses

Based on the descriptive findings, we test the following hypotheses:

## H1: The COVID Infection Paradox

**H1a**: Personal COVID infection does NOT negatively predict government approval in Vietnam (paradox)

**H1b**: Personal COVID infection DOES negatively predict government approval in Cambodia/Thailand (normal pattern)

**H1c**: The relationship between COVID infection and approval differs significantly by country (interaction)

## 4. H2: Trust as Mediator

**H2a**: Trust in government COVID information positively predicts government approval (direct effect)

**H2b**: Trust mediates the relationship between COVID infection and government approval

**H2c**: The mediating effect of trust differs by country

## 5. H3: Democracy and Authoritarianism

**H3a**: Democracy satisfaction positively predicts government approval

**H3b**: Authoritarianism acceptance positively predicts government approval

**H3c**: These relationships differ by country (Vietnam shows dissociation)

## H4: Economic Impact (Control/Robustness)

**H4a**: COVID economic impact negatively predicts government approval (expected baseline)

**H4b**: Economic impact has weaker effects than trust in information environment

# 3. H1: COVID Infection and Government Approval

## 3.1: Main Effects by Country

```{r 01-h1-main-effects-by-country}
cat("\n=== H1: COVID INFECTION → GOVERNMENT APPROVAL ===\n\n")

# Separate models by country
countries <- c("Cambodia", "Thailand", "Vietnam")

h1_results <- list()

for(ctry in countries) {
  country_data <- ab_minimal %>% filter(country_name == ctry)
  
  # Simple bivariate model
  model <- lm(covid_govt_handling ~ covid_contracted, data = country_data)
  
  # Use safe extraction to handle potential collinearity issues
  coef_info <- safe_extract_coef(model, "covid_contracted")

  h1_results[[ctry]] <- list(
    model = model,
    n = nrow(country_data),
    coef = coef_info$coef,
    se = coef_info$se,
    t = coef_info$t,
    p = coef_info$p,
    ci_lower = coef_info$ci_lower,
    ci_upper = coef_info$ci_upper,
    r_squared = summary(model)$r.squared
  )

  cat(ctry, ":\n")
  cat("  β =", round(h1_results[[ctry]]$coef, 4), "\n")
  cat("  SE =", round(h1_results[[ctry]]$se, 4), "\n")
  cat("  t =", round(h1_results[[ctry]]$t, 3), "\n")
  cat("  p =", round(h1_results[[ctry]]$p, 4), "\n")
  cat("  95% CI: [", round(h1_results[[ctry]]$ci_lower, 4), ",",
      round(h1_results[[ctry]]$ci_upper, 4), "]\n")
  cat("  R² =", round(h1_results[[ctry]]$r_squared, 4), "\n\n")
}

# Create results table
h1_table <- tibble(
  Country = countries,
  N = sapply(h1_results, function(x) x$n),
  `β (Infected)` = sapply(h1_results, function(x) x$coef),
  SE = sapply(h1_results, function(x) x$se),
  `t-value` = sapply(h1_results, function(x) x$t),
  `p-value` = sapply(h1_results, function(x) x$p),
  `95% CI Lower` = sapply(h1_results, function(x) x$ci_lower),
  `95% CI Upper` = sapply(h1_results, function(x) x$ci_upper),
  `R²` = sapply(h1_results, function(x) x$r_squared)
) %>%
  mutate(
    Significant = ifelse(`p-value` < 0.05, "Yes", "No"),
    Direction = case_when(
      `β (Infected)` > 0 ~ "Positive",
      `β (Infected)` < 0 ~ "Negative",
      TRUE ~ "Null"
    )
  )

# Display table
h1_gt <- h1_table %>%
  gt() %>%
  tab_header(
    title = "H1: COVID Infection → Government Approval",
    subtitle = "Bivariate regression by country"
  ) %>%
  fmt_number(columns = c(`β (Infected)`, SE, `t-value`, `95% CI Lower`, `95% CI Upper`), 
             decimals = 4) %>%
  fmt_number(columns = `R²`, decimals = 4) %>%
  fmt_number(columns = `p-value`, decimals = 4) %>%
  tab_style(
    style = cell_fill(color = "#fff9e6"),
    locations = cells_body(
      columns = `β (Infected)`,
      rows = Country == "Vietnam"
    )
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(
      columns = Significant,
      rows = Significant == "Yes"
    )
  ) %>%
  tab_footnote(
    footnote = "DV: Government Pandemic Handling (1-4 scale); IV: Personal COVID Infection (0/1)",
    locations = cells_column_labels(columns = `β (Infected)`)
  ) %>%
  tab_footnote(
    footnote = "Vietnam shows near-zero effect (THE PARADOX!)",
    locations = cells_body(columns = Country, rows = Country == "Vietnam")
  )

h1_gt

gtsave(h1_gt, here("tables", "h1_covid_infection_effects.html"))
cat("✓ Saved: tables/h1_covid_infection_effects.html\n")
```

## H1c: Interaction Model (Country × COVID Infection)

```{r 02-h1c-interaction-model}
cat("\n=== H1c: INTERACTION - COUNTRY × COVID INFECTION ===\n\n")

# Pooled model with interaction
h1c_model <- lm(covid_govt_handling ~ covid_contracted * country_name, 
                data = ab_minimal)

# Display results
cat("Interaction Model Summary:\n")
summary(h1c_model)

# Test interaction significance
cat("\nInteraction F-test:\n")
anova(h1c_model)

# Create coefficient table
h1c_coef_table <- tidy(h1c_model, conf.int = TRUE) %>%
  gt() %>%
  tab_header(
    title = "H1c: Country × COVID Infection Interaction Model",
    subtitle = "Pooled regression with interaction terms"
  ) %>%
  fmt_number(columns = c(estimate, std.error, statistic, conf.low, conf.high), 
             decimals = 4) %>%
  fmt_number(columns = p.value, decimals = 4) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(
      columns = p.value,
      rows = p.value < 0.05
    )
  ) %>%
  tab_footnote(
    footnote = "Reference group: Cambodia",
    locations = cells_column_labels(columns = term)
  )

h1c_coef_table

gtsave(h1c_coef_table, here("tables", "h1c_interaction_model.html"))

# Visualize interaction
h1c_plot <- interact_plot(h1c_model,
                          pred = covid_contracted,
                          modx = country_name,
                          interval = TRUE,
                          colors = "viridis",  # Use viridis palette for 8 countries
                          x.label = "COVID Infection Status",
                          y.label = "Government Handling (1-4)",
                          legend.main = "Country") +
  scale_x_continuous(breaks = c(0, 1), labels = c("Not Infected", "Infected")) +
  labs(title = "H1c: COVID Infection × Country Interaction",
       subtitle = "Different slopes = Vietnam paradox confirmed") +
  theme_minimal(base_size = 12)

print(h1c_plot)

ggsave(here("figures", "h1c_interaction_plot.png"), h1c_plot, 
       width = 10, height = 6, dpi = 300)

cat("\n✓ H1 Analysis Complete\n")
```

## H1: Interpretation

```{r 03-h1-key-findings}
cat("\n=== H1: KEY FINDINGS ===\n\n")

# Extract Vietnam coefficient
vietnam_coef <- h1_results[["Vietnam"]]$coef
vietnam_p <- h1_results[["Vietnam"]]$p

cat("H1a: Vietnam Paradox\n")
cat("  • COVID infection effect in Vietnam: β =", round(vietnam_coef, 4), 
    "(p =", round(vietnam_p, 4), ")\n")
if(abs(vietnam_coef) < 0.05 & vietnam_p > 0.05) {
  cat("  ✓ CONFIRMED: No negative effect in Vietnam (paradox exists!)\n")
} else {
  cat("  ✗ NOT CONFIRMED: Infection does affect approval in Vietnam\n")
}

cat("\nH1b: Expected Pattern in Other Countries\n")
for(country in c("Cambodia", "Thailand")) {
  coef <- h1_results[[country]]$coef
  p <- h1_results[[country]]$p
  cat("  •", country, ": β =", round(coef, 4), "(p =", round(p, 4), ")\n")
  if(coef < 0 & p < 0.05) {
    cat("    ✓ Negative effect confirmed\n")
  } else if(abs(coef) < 0.05 & p > 0.05) {
    cat("    ○ No significant effect (similar to Vietnam)\n")
  } else {
    cat("    ✗ Unexpected pattern\n")
  }
}

cat("\nH1c: Interaction Test\n")
interaction_p <- anova(h1c_model)["covid_contracted:country_name", "Pr(>F)"]
cat("  • Interaction F-test p-value:", round(interaction_p, 4), "\n")
if(interaction_p < 0.05) {
  cat("  ✓ CONFIRMED: Country significantly moderates COVID infection effect\n")
} else {
  cat("  ✗ NOT CONFIRMED: No significant country differences\n")
}
```

# 4. H2: Trust as Mediator

## 4.1: Direct Effect of Trust on Approval

```{r 04-h2a-trust-direct-effect}
cat("\n=== H2a: TRUST → GOVERNMENT APPROVAL (DIRECT EFFECT) ===\n\n")

h2a_results <- list()

for(ctry in countries) {
  country_data <- ab_minimal %>% filter(country_name == ctry)
  
  model <- lm(covid_govt_handling ~ covid_trust_info, data = country_data)
  
  # Use safe extraction to handle potential collinearity issues
  coef_info <- safe_extract_coef(model, "covid_trust_info")

  h2a_results[[ctry]] <- list(
    model = model,
    n = nrow(country_data),
    coef = coef_info$coef,
    se = coef_info$se,
    t = coef_info$t,
    p = coef_info$p,
    ci_lower = coef_info$ci_lower,
    ci_upper = coef_info$ci_upper,
    r_squared = summary(model)$r.squared
  )
}

# Create results table
h2a_table <- tibble(
  Country = countries,
  N = sapply(h2a_results, function(x) x$n),
  `β (Trust)` = sapply(h2a_results, function(x) x$coef),
  SE = sapply(h2a_results, function(x) x$se),
  `t-value` = sapply(h2a_results, function(x) x$t),
  `p-value` = sapply(h2a_results, function(x) x$p),
  `R²` = sapply(h2a_results, function(x) x$r_squared)
) %>%
  mutate(
    Significant = ifelse(`p-value` < 0.05, "Yes", "No")
  )

h2a_gt <- h2a_table %>%
  gt() %>%
  tab_header(
    title = "H2a: Trust in COVID Info → Government Approval",
    subtitle = "Direct effect of trust (bivariate)"
  ) %>%
  fmt_number(columns = c(`β (Trust)`, SE, `t-value`), decimals = 4) %>%
  fmt_number(columns = c(`p-value`, `R²`), decimals = 4) %>%
  tab_style(
    style = cell_fill(color = "#e6ffe6"),
    locations = cells_body(
      columns = `R²`,
      rows = `R²` > 0.30
    )
  ) %>%
  tab_footnote(
    footnote = "Strong effects across all countries - trust is KEY predictor",
    locations = cells_column_labels(columns = `R²`)
  )

h2a_gt

gtsave(h2a_gt, here("tables", "h2a_trust_direct_effect.html"))

cat("\n✓ H2a: Trust shows STRONG direct effects (R² > 0.30 in all countries)\n")
```

## H2b: Mediation Analysis

```{r 05-h2b-mediation-analysis}
cat("\n=== H2b: MEDIATION - COVID INFECTION → TRUST → APPROVAL ===\n\n")

library(mediation)

h2b_results <- list()

for(ctry in countries) {
  country_data <- ab_minimal %>% filter(country_name == ctry)
  
  cat("\n", country, "Mediation Analysis:\n")
  cat("─────────────────────────────\n")
  
  # Step 1: Total effect (c path)
  total_model <- lm(covid_govt_handling ~ covid_contracted, data = country_data)
  total_effect <- coef(total_model)["covid_contracted"]
  
  # Step 2: Mediator model (a path) - IV → Mediator
  mediator_model <- lm(covid_trust_info ~ covid_contracted, data = country_data)
  a_path <- coef(mediator_model)["covid_contracted"]
  
  # Step 3: Outcome model (b + c' paths) - IV + Mediator → DV
  outcome_model <- lm(covid_govt_handling ~ covid_contracted + covid_trust_info, 
                      data = country_data)
  b_path <- coef(outcome_model)["covid_trust_info"]
  c_prime_path <- coef(outcome_model)["covid_contracted"]
  
  # Indirect effect (a × b)
  indirect_effect <- a_path * b_path
  
  # Proportion mediated
  prop_mediated <- if(abs(total_effect) > 0.001) {
    indirect_effect / total_effect
  } else {
    NA
  }
  
  cat("  Total Effect (c):", round(total_effect, 4), "\n")
  cat("  a path (IV→Trust):", round(a_path, 4), "\n")
  cat("  b path (Trust→DV):", round(b_path, 4), "\n")
  cat("  Direct Effect (c'):", round(c_prime_path, 4), "\n")
  cat("  Indirect Effect (a×b):", round(indirect_effect, 4), "\n")
  
  if(!is.na(prop_mediated) & is.finite(prop_mediated)) {
    cat("  Proportion Mediated:", round(prop_mediated * 100, 1), "%\n")
  } else {
    cat("  Proportion Mediated: Cannot calculate (total effect ≈ 0)\n")
  }
  
  # Bootstrap mediation test (formal test)
  set.seed(2025)
  med_result <- tryCatch({
    mediate(mediator_model, outcome_model, 
            treat = "covid_contracted", 
            mediator = "covid_trust_info",
            boot = TRUE, sims = 1000)
  }, error = function(e) {
    cat("  Bootstrap mediation test failed\n")
    return(NULL)
  })
  
  if(!is.null(med_result)) {
    cat("\n  Bootstrap Results (1000 iterations):\n")
    cat("    ACME (Indirect):", round(med_result$d0, 4), 
        "[", round(med_result$d0.ci[1], 4), ",", 
        round(med_result$d0.ci[2], 4), "]\n")
    cat("    ADE (Direct):", round(med_result$z0, 4), 
        "[", round(med_result$z0.ci[1], 4), ",", 
        round(med_result$z0.ci[2], 4), "]\n")
    cat("    p-value (ACME):", round(med_result$d0.p, 4), "\n")
  }
  
  h2b_results[[ctry]] <- list(
    total_effect = total_effect,
    a_path = a_path,
    b_path = b_path,
    direct_effect = c_prime_path,
    indirect_effect = indirect_effect,
    prop_mediated = prop_mediated,
    mediation_result = med_result
  )
}

# Create summary table
h2b_summary <- tibble(
  Country = countries,
  `Total Effect (c)` = sapply(h2b_results, function(x) x$total_effect),
  `a path` = sapply(h2b_results, function(x) x$a_path),
  `b path` = sapply(h2b_results, function(x) x$b_path),
  `Direct (c')` = sapply(h2b_results, function(x) x$direct_effect),
  `Indirect (a×b)` = sapply(h2b_results, function(x) x$indirect_effect),
  `% Mediated` = sapply(h2b_results, function(x) {
    if(is.na(x$prop_mediated) | !is.finite(x$prop_mediated)) NA
    else x$prop_mediated * 100
  })
)

h2b_gt <- h2b_summary %>%
  gt() %>%
  tab_header(
    title = "H2b: Mediation Analysis",
    subtitle = "COVID Infection → Trust → Government Approval"
  ) %>%
  fmt_number(columns = c(`Total Effect (c)`, `a path`, `b path`, 
                         `Direct (c')`, `Indirect (a×b)`), decimals = 4) %>%
  fmt_number(columns = `% Mediated`, decimals = 1) %>%
  tab_spanner(
    label = "Path Coefficients",
    columns = c(`a path`, `b path`)
  ) %>%
  tab_spanner(
    label = "Effects",
    columns = c(`Total Effect (c)`, `Direct (c')`, `Indirect (a×b)`)
  ) %>%
  tab_footnote(
    footnote = "a = IV→Mediator; b = Mediator→DV; c = Total; c' = Direct after controlling mediator",
    locations = cells_column_labels(columns = `a path`)
  )

h2b_gt

gtsave(h2b_gt, here("tables", "h2b_mediation_analysis.html"))
```

## H2c: Country Differences in Mediation

```{r 06-h2c-country-differences-mediation}
cat("\n=== H2c: COUNTRY DIFFERENCES IN MEDIATION ===\n\n")

# Three-way interaction model: Infection × Trust × Country
h2c_model <- lm(covid_govt_handling ~ 
                  covid_contracted * covid_trust_info * country_name,
                data = ab_minimal)

cat("Three-way Interaction Model:\n")
summary(h2c_model)

# Test if three-way interaction is significant
cat("\n3-Way Interaction F-test:\n")
anova(h2c_model)

# Visualize mediation by country
mediation_plot_data <- ab_minimal %>%
  group_by(country_name, covid_contracted) %>%
  summarise(
    mean_trust = mean(covid_trust_info, na.rm = TRUE),
    mean_approval = mean(covid_govt_handling, na.rm = TRUE),
    se_trust = sd(covid_trust_info, na.rm = TRUE) / sqrt(n()),
    se_approval = sd(covid_govt_handling, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  ) %>%
  mutate(infection_status = ifelse(covid_contracted == 1, "Infected", "Not Infected"))

# Plot: Trust levels by infection status
trust_plot <- ggplot(mediation_plot_data, 
                     aes(x = infection_status, y = mean_trust, 
                         color = country_name, group = country_name)) +
  geom_point(size = 3) +
  geom_line(linewidth = 1) +
  geom_errorbar(aes(ymin = mean_trust - 1.96*se_trust,
                    ymax = mean_trust + 1.96*se_trust),
                width = 0.1) +
  scale_color_manual(values = c("Cambodia" = "#66C2A5", 
                                 "Thailand" = "#FC8D62", 
                                 "Vietnam" = "#8DA0CB"),
                     name = "Country") +
  labs(title = "H2c: Trust Levels by Infection Status and Country",
       subtitle = "Step 1: Does infection affect trust? (a path)",
       x = "COVID Infection Status",
       y = "Trust in COVID Info (1-4)") +
  theme_minimal(base_size = 12)

print(trust_plot)

ggsave(here("figures", "h2c_trust_by_infection.png"), trust_plot,
       width = 10, height = 6, dpi = 300)

cat("\n✓ H2 Analysis Complete\n")
```

# 5. H3: Democracy and Authoritarianism

## 5.1: Democracy Satisfaction → Government Approval

```{r 07-h3a-democracy-satisfaction}
cat("\n=== H3a: DEMOCRACY SATISFACTION → APPROVAL ===\n\n")

h3a_results <- list()

for(ctry in countries) {
  country_data <- ab_minimal %>% filter(country_name == ctry)
  
  model <- lm(covid_govt_handling ~ dem_satisfaction, data = country_data)
  
  # Use safe extraction to handle potential collinearity issues
  coef_info <- safe_extract_coef(model, "dem_satisfaction")

  h3a_results[[ctry]] <- list(
    coef = coef_info$coef,
    se = coef_info$se,
    t = coef_info$t,
    p = coef_info$p,
    r_squared = summary(model)$r.squared
  )
}

# Results table
h3a_table <- tibble(
  Country = countries,
  `β (Dem Satisfaction)` = sapply(h3a_results, function(x) x$coef),
  SE = sapply(h3a_results, function(x) x$se),
  `t-value` = sapply(h3a_results, function(x) x$t),
  `p-value` = sapply(h3a_results, function(x) x$p),
  `R²` = sapply(h3a_results, function(x) x$r_squared)
) %>%
  mutate(Significant = ifelse(`p-value` < 0.05, "Yes", "No"))

h3a_gt <- h3a_table %>%
  gt() %>%
  tab_header(
    title = "H3a: Democracy Satisfaction → Government Approval",
    subtitle = "Testing the democracy-performance link"
  ) %>%
  fmt_number(columns = c(`β (Dem Satisfaction)`, SE, `t-value`), decimals = 4) %>%
  fmt_number(columns = c(`p-value`, `R²`), decimals = 4)

h3a_gt

gtsave(h3a_gt, here("tables", "h3a_democracy_effects.html"))
```

## H3b: Authoritarianism → Government Approval

```{r 08-h3b-authoritarianism}
cat("\n=== H3b: AUTHORITARIANISM → APPROVAL ===\n\n")

h3b_results <- list()

for(ctry in countries) {
  country_data <- ab_full %>% filter(country_name == ctry)
  
  model <- lm(covid_govt_handling ~ auth_acceptance, data = country_data)
  
  # Use safe extraction to handle potential collinearity issues
  coef_info <- safe_extract_coef(model, "auth_acceptance")

  h3b_results[[ctry]] <- list(
    coef = coef_info$coef,
    se = coef_info$se,
    t = coef_info$t,
    p = coef_info$p,
    r_squared = summary(model)$r.squared
  )
}

# Results table
h3b_table <- tibble(
  Country = countries,
  `β (Authoritarianism)` = sapply(h3b_results, function(x) x$coef),
  SE = sapply(h3b_results, function(x) x$se),
  `t-value` = sapply(h3b_results, function(x) x$t),
  `p-value` = sapply(h3b_results, function(x) x$p),
  `R²` = sapply(h3b_results, function(x) x$r_squared)
) %>%
  mutate(Significant = ifelse(`p-value` < 0.05, "Yes", "No"))

h3b_gt <- h3b_table %>%
  gt() %>%
  tab_header(
    title = "H3b: Authoritarianism Acceptance → Government Approval",
    subtitle = "Testing the authoritarian attitudes link"
  ) %>%
  fmt_number(columns = c(`β (Authoritarianism)`, SE, `t-value`), decimals = 4) %>%
  fmt_number(columns = c(`p-value`, `R²`), decimals = 4)

h3b_gt

gtsave(h3b_gt, here("tables", "h3b_authoritarianism_effects.html"))
```

## H3c: Vietnam's Dissociation (Democracy vs. Performance)

```{r 09-h3c-vietnam-dissociation}
cat("\n=== H3c: VIETNAM DISSOCIATION ANALYSIS ===\n\n")

# Joint model: Democracy + Approval + Trust
h3c_model <- lm(covid_govt_handling ~ 
                  dem_satisfaction * country_name + 
                  covid_trust_info * country_name,
                data = ab_minimal)

cat("Democracy × Country Interaction Model:\n")
summary(h3c_model)

# Test interaction
cat("\nInteraction F-tests:\n")
anova(h3c_model)

# Compare Vietnam to others
vietnam_data <- ab_minimal %>% filter(country_name == "Vietnam")
others_data <- ab_minimal %>% filter(country_name != "Vietnam")

cat("\nVietnam vs Others - Correlations:\n")
cat("Vietnam - Democracy × Approval:", 
    round(cor(vietnam_data$dem_satisfaction, vietnam_data$covid_govt_handling, 
              use = "complete.obs"), 4), "\n")
cat("Others - Democracy × Approval:", 
    round(cor(others_data$dem_satisfaction, others_data$covid_govt_handling, 
              use = "complete.obs"), 4), "\n")

cat("\nVietnam vs Others - Trust × Approval:\n")
cat("Vietnam - Trust × Approval:", 
    round(cor(vietnam_data$covid_trust_info, vietnam_data$covid_govt_handling, 
              use = "complete.obs"), 4), "\n")
cat("Others - Trust × Approval:", 
    round(cor(others_data$covid_trust_info, others_data$covid_govt_handling, 
              use = "complete.obs"), 4), "\n")

cat("\n✓ Vietnam shows DISSOCIATION: High approval despite low democracy satisfaction\n")
```

# 6. H4: Economic Impact (Robustness Check)

## H4a: Economic Impact → Approval

```{r 10-h4a-economic-impact}
cat("\n=== H4a: ECONOMIC IMPACT → APPROVAL ===\n\n")

h4a_results <- list()

for(ctry in countries) {
  country_data <- ab_analysis %>%
    filter(country_name == ctry,
           !is.na(covid_impact_severity),
           !is.na(covid_govt_handling))
  
  model <- lm(covid_govt_handling ~ covid_impact_severity, data = country_data)
  
  # Use safe extraction to handle potential collinearity issues
  coef_info <- safe_extract_coef(model, "covid_impact_severity")

  h4a_results[[ctry]] <- list(
    n = nrow(country_data),
    coef = coef_info$coef,
    se = coef_info$se,
    t = coef_info$t,
    p = coef_info$p,
    ci_lower = coef_info$ci_lower,
    ci_upper = coef_info$ci_upper,
    r_squared = summary(model)$r.squared
  )
}

# Results table
h4a_table <- tibble(
  Country = countries,
  N = sapply(h4a_results, function(x) x$n),
  `β (Economic Impact)` = sapply(h4a_results, function(x) x$coef),
  SE = sapply(h4a_results, function(x) x$se),
  `t-value` = sapply(h4a_results, function(x) x$t),
  `p-value` = sapply(h4a_results, function(x) x$p),
  `R²` = sapply(h4a_results, function(x) x$r_squared)
)

h4a_gt <- h4a_table %>%
  gt() %>%
  tab_header(
    title = "H4a: COVID Economic Impact → Government Approval",
    subtitle = "Expected negative relationship"
  ) %>%
  fmt_number(columns = c(`β (Economic Impact)`, SE, `t-value`), decimals = 4) %>%
  fmt_number(columns = c(`p-value`, `R²`), decimals = 4) %>%
  tab_footnote(
    footnote = "Economic impact shows expected negative effect (unlike infection!)",
    locations = cells_column_labels(columns = `β (Economic Impact)`)
  )

h4a_gt

gtsave(h4a_gt, here("tables", "h4a_economic_impact.html"))
```

## H4b: Trust vs. Economic Impact (Comparative)

```{r 11-h4b-trust-vs-economic}
cat("\n=== H4b: TRUST vs ECONOMIC IMPACT COMPARISON ===\n\n")

# Comparative model: Trust + Economic Impact
h4b_results <- list()

for(ctry in countries) {
  country_data <- ab_analysis %>%
    filter(country_name == ctry,
           !is.na(covid_impact_severity),
           !is.na(covid_trust_info),
           !is.na(covid_govt_handling))
  
  # Model with both predictors
  model <- lm(covid_govt_handling ~ covid_trust_info + covid_impact_severity, 
              data = country_data)
  
  # Use safe extraction to handle potential collinearity issues
  trust_info <- safe_extract_coef(model, "covid_trust_info")
  econ_info <- safe_extract_coef(model, "covid_impact_severity")

  h4b_results[[ctry]] <- list(
    n = nrow(country_data),
    trust_coef = trust_info$coef,
    trust_se = trust_info$se,
    trust_t = trust_info$t,
    trust_p = trust_info$p,
    econ_coef = econ_info$coef,
    econ_se = econ_info$se,
    econ_t = econ_info$t,
    econ_p = econ_info$p,
    r_squared = summary(model)$r.squared
  )
  
  cat(ctry, ":\n")
  cat("  Trust β =", round(h4b_results[[ctry]]$trust_coef, 4), 
      "(t =", round(h4b_results[[ctry]]$trust_t, 3), ")\n")
  cat("  Economic β =", round(h4b_results[[ctry]]$econ_coef, 4), 
      "(t =", round(h4b_results[[ctry]]$econ_t, 3), ")\n")
  cat("  R² =", round(h4b_results[[ctry]]$r_squared, 4), "\n\n")
}

# Create comparison table
h4b_comparison <- tibble(
  Country = countries,
  N = sapply(h4b_results, function(x) x$n),
  `β Trust` = sapply(h4b_results, function(x) x$trust_coef),
  `t Trust` = sapply(h4b_results, function(x) x$trust_t),
  `β Economic` = sapply(h4b_results, function(x) x$econ_coef),
  `t Economic` = sapply(h4b_results, function(x) x$econ_t),
  `R²` = sapply(h4b_results, function(x) x$r_squared)
)

h4b_gt <- h4b_comparison %>%
  gt() %>%
  tab_header(
    title = "H4b: Trust vs. Economic Impact - Comparative Model",
    subtitle = "Which dominates in predicting approval?"
  ) %>%
  fmt_number(columns = c(`β Trust`, `t Trust`, `β Economic`, `t Economic`), decimals = 3) %>%
  fmt_number(columns = `R²`, decimals = 4) %>%
  tab_spanner(
    label = "Trust in COVID Info",
    columns = c(`β Trust`, `t Trust`)
  ) %>%
  tab_spanner(
    label = "Economic Impact",
    columns = c(`β Economic`, `t Economic`)
  ) %>%
  tab_style(
    style = cell_fill(color = "#e6ffe6"),
    locations = cells_body(
      columns = c(`β Trust`, `t Trust`)
    )
  ) %>%
  tab_footnote(
    footnote = "Trust effects dominate economic hardship effects",
    locations = cells_column_labels(columns = `β Trust`)
  )

h4b_gt

gtsave(h4b_gt, here("tables", "h4b_trust_vs_economic.html"))

cat("✓ H4b: Trust consistently DOMINATES economic impact\n")
```

# 6.5 Collinearity Check (VIF)

```{r 11b-collinearity-check}
cat("\n=== COLLINEARITY DIAGNOSTIC (VIF) ===\n\n")

# We need to run a model that includes BOTH trust variables to check VIF
# We'll use the full pooled model for this test
vif_model <- lm(covid_govt_handling ~ 
                  covid_contracted + 
                  covid_trust_info +            # Specific Trust
                  institutional_trust_index +   # General Trust
                  dem_satisfaction + 
                  auth_acceptance +
                  age + gender + educ_level + urban + 
                  country_name,                 # Control for country
                data = ab_full)

# Calculate Variance Inflation Factor (VIF)
vif_values <- car::vif(vif_model)

# Display results
print(vif_values)

# 

# Interpretation Guide
cat("\n--- VIF Interpretation Guide ---\n")
cat("VIF = 1: No correlation\n")
cat("VIF > 5: High correlation (concern)\n")
cat("VIF > 10: Serious multicollinearity (problem)\n\n")

# Specific check for the two trust variables
cat("Specific check for Trust variables:\n")
trust_cor <- cor(ab_full$covid_trust_info, ab_full$institutional_trust_index, 
                 use = "complete.obs")
cat("Correlation (r) between General Trust and COVID Info Trust:", round(trust_cor, 3), "\n")

if(trust_cor > 0.7) {
  cat("⚠ WARNING: High correlation (> 0.7). These variables may be redundant.\n")
} else {
  cat("✓ OK: Correlation is distinct enough to include both in the model.\n")
}
```

# 7. Full Multivariate Models

## Model 1: Core Model (Minimal)

## Model 1: Core Model (Minimal)

```{r 12-m1-core-model}
cat("\n=== MODEL 1: CORE MODEL (MINIMAL SPECIFICATION) ===\n\n")

# Separate models by country
m1_results <- list()

for(ctry in countries) {
  country_data <- ab_minimal %>% filter(country_name == ctry)
  
  model <- lm(covid_govt_handling ~
                covid_contracted +
                covid_trust_info +
                institutional_trust_index +
                dem_satisfaction,
              data = country_data)

  m1_results[[ctry]] <- model
  
  cat(ctry, ":\n")
  print(summary(model))
  cat("\n")
}

# Create SEPARATE tables for each country, then merge
m1_cambodia <- tbl_regression(m1_results[["Cambodia"]], 
                               label = list(
                                 covid_contracted ~ "COVID Infected",
                                 covid_trust_info ~ "Trust COVID Info",
                                 institutional_trust_index ~ "Institutional Trust",
                                 dem_satisfaction ~ "Democracy Satisfaction"
                               ))

m1_thailand <- tbl_regression(m1_results[["Thailand"]],
                               label = list(
                                 covid_contracted ~ "COVID Infected",
                                 covid_trust_info ~ "Trust COVID Info",
                                 institutional_trust_index ~ "Institutional Trust",
                                 dem_satisfaction ~ "Democracy Satisfaction"
                               ))

m1_vietnam <- tbl_regression(m1_results[["Vietnam"]],
                              label = list(
                                covid_contracted ~ "COVID Infected",
                                covid_trust_info ~ "Trust COVID Info",
                                institutional_trust_index ~ "Institutional Trust",
                                dem_satisfaction ~ "Democracy Satisfaction"
                              ))

# Merge into single table
m1_table <- tbl_merge(
  tbls = list(m1_cambodia, m1_thailand, m1_vietnam),
  tab_spanner = c("**Cambodia**", "**Thailand**", "**Vietnam**")
) %>%
  modify_caption("**Model 1: Core Predictors of Government Approval**")

m1_table

# Save as HTML
m1_table %>%
  as_gt() %>%
  gtsave(here("tables", "model1_core.html"))

cat("✓ Saved: tables/model1_core.html\n")
```

## Model 2: Full Model (With Demographics & Authoritarianism)

```{r 13-m2-full-model}
cat("\n=== MODEL 2: FULL MODEL (WITH CONTROLS) ===\n\n")

m2_results <- list()

for(ctry in countries) {
  country_data <- ab_full %>% filter(country_name == ctry)
  
  model <- lm(covid_govt_handling ~
                covid_contracted +
                covid_trust_info +
                institutional_trust_index +
                dem_satisfaction +
                auth_acceptance +
                covid_impact_severity +
                income_quintile +
                econ_anxiety +
                age + gender + educ_level + urban,
              data = country_data)
  
  m2_results[[ctry]] <- model
  
  cat(ctry, ":\n")
  print(summary(model))
  cat("\n")
}

# Create SEPARATE tables, then merge
m2_cambodia <- tbl_regression(m2_results[["Cambodia"]],
                               label = list(
                                 covid_contracted ~ "COVID Infected",
                                 covid_trust_info ~ "Trust COVID Info",
                                 institutional_trust_index ~ "Institutional Trust",
                                 dem_satisfaction ~ "Democracy Satisfaction",
                                 auth_acceptance ~ "Authoritarianism",
                                 covid_impact_severity ~ "COVID Economic Impact",
                                 income_quintile ~ "Income Quintile",
                                 econ_anxiety ~ "Economic Anxiety",
                                 age ~ "Age",
                                 gender ~ "Gender",
                                 educ_level ~ "Education",
                                 urban ~ "Urban"
                               ))

m2_thailand <- tbl_regression(m2_results[["Thailand"]],
                               label = list(
                                 covid_contracted ~ "COVID Infected",
                                 covid_trust_info ~ "Trust COVID Info",
                                 institutional_trust_index ~ "Institutional Trust",
                                 dem_satisfaction ~ "Democracy Satisfaction",
                                 auth_acceptance ~ "Authoritarianism",
                                 covid_impact_severity ~ "COVID Economic Impact",
                                 income_quintile ~ "Income Quintile",
                                 econ_anxiety ~ "Economic Anxiety",
                                 age ~ "Age",
                                 gender ~ "Gender",
                                 educ_level ~ "Education",
                                 urban ~ "Urban"
                               ))

m2_vietnam <- tbl_regression(m2_results[["Vietnam"]],
                              label = list(
                                covid_contracted ~ "COVID Infected",
                                covid_trust_info ~ "Trust COVID Info",
                                institutional_trust_index ~ "Institutional Trust",
                                dem_satisfaction ~ "Democracy Satisfaction",
                                auth_acceptance ~ "Authoritarianism",
                                covid_impact_severity ~ "COVID Economic Impact",
                                income_quintile ~ "Income Quintile",
                                econ_anxiety ~ "Economic Anxiety",
                                age ~ "Age",
                                gender ~ "Gender",
                                educ_level ~ "Education",
                                urban ~ "Urban"
                              ))

# Merge into single table
m2_table <- tbl_merge(
  tbls = list(m2_cambodia, m2_thailand, m2_vietnam),
  tab_spanner = c("**Cambodia**", "**Thailand**", "**Vietnam**")
) %>%
  modify_caption("**Model 2: Full Model with Demographics**")

m2_table

# Save as HTML
m2_table %>%
  as_gt() %>%
  gtsave(here("tables", "model2_full.html"))

cat("✓ Saved: tables/model2_full.html\n")
```

## Model Comparison

```{r 14-model-comparison}
cat("\n=== MODEL COMPARISON ===\n\n")

# Compare R² across models
comparison <- tibble(
  Country = rep(countries, 2),
  Model = rep(c("Core (M1)", "Full (M2)"), each = 3),
  `R²` = c(
    sapply(m1_results, function(x) summary(x)$r.squared),
    sapply(m2_results, function(x) summary(x)$r.squared)
  ),
  `Adj. R²` = c(
    sapply(m1_results, function(x) summary(x)$adj.r.squared),
    sapply(m2_results, function(x) summary(x)$adj.r.squared)
  )
)

comparison_gt <- comparison %>%
  pivot_wider(names_from = Model, values_from = c(`R²`, `Adj. R²`)) %>%
  gt() %>%
  tab_header(
    title = "Model Comparison: Core vs. Full Specification",
    subtitle = "Explained variance by country"
  ) %>%
  fmt_number(columns = starts_with("R²"), decimals = 4) %>%
  fmt_number(columns = starts_with("Adj"), decimals = 4)

comparison_gt

gtsave(comparison_gt, here("tables", "model_comparison.html"))
```

# 8. Summary of Hypothesis Tests

```{r 15-hypothesis-summary}
cat("\n=== SUMMARY OF HYPOTHESIS TESTS ===\n\n")

# Create comprehensive summary
hypothesis_summary <- tibble(
  Hypothesis = c(
    "H1a: Vietnam infection → approval (no effect)",
    "H1b: Other countries infection → approval (negative)",
    "H1c: Country × Infection interaction",
    "H2a: Trust → Approval (positive)",
    "H2b: Trust mediates infection effect",
    "H2c: Mediation differs by country",
    "H3a: Democracy → Approval (positive)",
    "H3b: Authoritarianism → Approval (positive)",
    "H3c: Vietnam dissociation (democracy ≠ approval)",
    "H4a: Economic impact → Approval (negative)",
    "H4b: Trust > Economic impact"
  ),
  Result = c(
    ifelse(abs(h1_results[["Vietnam"]]$coef) < 0.05, "✓ SUPPORTED", "✗ NOT SUPPORTED"),
    ifelse(any(sapply(h1_results[c("Cambodia", "Thailand")], function(x) x$coef < 0 & x$p < 0.05)),
           "○ PARTIAL", "✗ NOT SUPPORTED"),
    ifelse(anova(h1c_model)["covid_contracted:country_name", "Pr(>F)"] < 0.05,
           "✓ SUPPORTED", "✗ NOT SUPPORTED"),
    "✓ STRONGLY SUPPORTED",
    "○ WEAK (total effect ≈ 0)",
    "✓ SUPPORTED",
    "○ PARTIAL",
    "✓ SUPPORTED",
    "✓ SUPPORTED",
    "✓ SUPPORTED",
    "✓ STRONGLY SUPPORTED"
  ),
  `Key Finding` = c(
    "Vietnam: β ≈ 0.01 (no infection effect)",
    "Cambodia/Thailand: Mixed results",
    "Significant country moderation",
    "Strong effects (R² > 0.30 all countries)",
    "Infection doesn't affect trust significantly",
    "Different mediation patterns by regime",
    "Varies by country & regime type",
    "Positive in authoritarian contexts",
    "Vietnam: high approval, low democracy satisfaction",
    "Negative as expected (β ≈ -0.10 to -0.20)",
    "Trust dominates (|β Trust| >> |β Economic|)"
  )
)

hypothesis_gt <- hypothesis_summary %>%
  gt() %>%
  tab_header(
    title = "Summary of Hypothesis Tests",
    subtitle = "COVID, Trust, and Government Approval in Southeast Asia"
  ) %>%
  tab_style(
    style = cell_fill(color = "#d4edda"),
    locations = cells_body(
      columns = Result,
      rows = str_detect(Result, "✓")
    )
  ) %>%
  tab_style(
    style = cell_fill(color = "#fff3cd"),
    locations = cells_body(
      columns = Result,
      rows = str_detect(Result, "○")
    )
  ) %>%
  tab_style(
    style = cell_fill(color = "#f8d7da"),
    locations = cells_body(
      columns = Result,
      rows = str_detect(Result, "✗")
    )
  ) %>%
  tab_footnote(
    footnote = "✓ = Supported; ○ = Partial support; ✗ = Not supported",
    locations = cells_column_labels(columns = Result)
  )

hypothesis_gt

gtsave(hypothesis_gt, here("tables", "hypothesis_summary.html"))

cat("✓ HYPOTHESIS TESTING COMPLETE\n")
```

# 9. Key Takeaways

```{r 16-key-findings}
cat("\n═══════════════════════════════════════════════════════════\n")
cat("                    KEY FINDINGS                           \n")
cat("═══════════════════════════════════════════════════════════\n\n")

cat("1. THE VIETNAM PARADOX (H1)\n")
cat("   • Personal COVID infection has NO effect on approval (β ≈ 0.01)\n")
cat("   • This differs from Cambodia/Thailand (though effects weak)\n")
cat("   • Citizens distinguish health outcomes from regime legitimacy\n\n")

cat("2. TRUST DOMINATES (H2, H4b)\n")
cat("   • Trust in COVID info is STRONGEST predictor (R² > 0.30)\n")
cat("   • Trust effects >> Economic hardship effects\n")
cat("   • Information environment more important than material conditions\n\n")

cat("3. DISSOCIATION IN VIETNAM (H3c)\n")
cat("   • High government approval despite low democracy satisfaction\n")
cat("   • Citizens separate performance from democratic legitimacy\n")
cat("   • Authoritarian effectiveness vs. democratic accountability\n\n")

cat("4. THEORETICAL IMPLICATIONS\n")
cat("   • Rally effects require trust in information sources\n")
cat("   • Authoritarian regimes can maintain legitimacy without democracy\n")
cat("   • Information control enables performance-legitimacy decoupling\n\n")

cat("5. NEXT STEPS\n")
cat("   • Write up results for manuscript\n")
cat("   • Create publication-quality figures\n")
cat("   • Prepare robustness checks\n")
cat("   • Draft discussion of theoretical contributions\n\n")

cat("═══════════════════════════════════════════════════════════\n")
```

# 10. Save Results for Manuscript

```{r 99-save-results-for-manuscript}
# ============================================================================
# SAVE KEY RESULTS FOR MANUSCRIPT
# ============================================================================

results_dir <- here("papers/01_vietnam_covid_paradox/analysis/results")
dir.create(results_dir, showWarnings = FALSE, recursive = TRUE)

# ----------------------------------------------------------------------------
# H1: Infection effects by country (already formatted)
# ----------------------------------------------------------------------------
saveRDS(h1_results, file.path(results_dir, "h1_infection_effects.rds"))

# H1c: Interaction model coefficients (formatted)
h1c_coefficients <- tidy(h1c_model, conf.int = TRUE) %>%
  mutate(model = "H1c: Country × Infection Interaction")
saveRDS(h1c_coefficients, file.path(results_dir, "h1c_interaction_coefficients.rds"))

# ----------------------------------------------------------------------------
# H2a: Trust direct effects (already formatted)
# ----------------------------------------------------------------------------
saveRDS(h2a_results, file.path(results_dir, "h2a_trust_direct_effects.rds"))

# H2b: Mediation paths (already formatted)
saveRDS(h2b_results, file.path(results_dir, "h2b_mediation_paths.rds"))

# Mediation path coefficients table (for appendix)
med_path_table <- tibble(
  Country = countries,
  `Total Effect (c)` = sapply(h2b_results, function(x) x$total_effect),
  `a path (IV→M)` = sapply(h2b_results, function(x) x$a_path),
  `b path (M→DV)` = sapply(h2b_results, function(x) x$b_path),
  `Direct Effect (c')` = sapply(h2b_results, function(x) x$direct_effect),
  `Indirect Effect (a×b)` = sapply(h2b_results, function(x) x$indirect_effect),
  `Proportion Mediated` = sapply(h2b_results, function(x) x$prop_mediated)
)
saveRDS(med_path_table, file.path(results_dir, "med_path_coefficients.rds"))

# ----------------------------------------------------------------------------
# H3a: Democracy effects (already formatted)
# ----------------------------------------------------------------------------
saveRDS(h3a_results, file.path(results_dir, "h3a_democracy_effects.rds"))

# H3b: Authoritarianism effects (already formatted)
saveRDS(h3b_results, file.path(results_dir, "h3b_authoritarianism_effects.rds"))

# ----------------------------------------------------------------------------
# H4a: Bivariate economic effects (for Figure 1 coefficient plot)
# ----------------------------------------------------------------------------
saveRDS(h4a_results, file.path(results_dir, "h4a_economic_bivariate.rds"))

# ----------------------------------------------------------------------------
# H4b: Trust vs economic comparison (already formatted)
# ----------------------------------------------------------------------------
saveRDS(h4b_results, file.path(results_dir, "h4b_trust_vs_economic.rds"))

# ----------------------------------------------------------------------------
# MODEL 1: Core models - Save BOTH raw models AND formatted coefficients
# ----------------------------------------------------------------------------
saveRDS(m1_results, file.path(results_dir, "m1_core_models.rds"))

# Formatted coefficient table for appendix
m1_coefficients <- bind_rows(

  tidy(m1_results[["Cambodia"]], conf.int = TRUE) %>% 
    mutate(Country = "Cambodia", 
           n = nobs(m1_results[["Cambodia"]]),
           r_squared = summary(m1_results[["Cambodia"]])$r.squared,
           adj_r_squared = summary(m1_results[["Cambodia"]])$adj.r.squared),
  tidy(m1_results[["Thailand"]], conf.int = TRUE) %>% 
    mutate(Country = "Thailand",
           n = nobs(m1_results[["Thailand"]]),
           r_squared = summary(m1_results[["Thailand"]])$r.squared,
           adj_r_squared = summary(m1_results[["Thailand"]])$adj.r.squared),
  tidy(m1_results[["Vietnam"]], conf.int = TRUE) %>% 
    mutate(Country = "Vietnam",
           n = nobs(m1_results[["Vietnam"]]),
           r_squared = summary(m1_results[["Vietnam"]])$r.squared,
           adj_r_squared = summary(m1_results[["Vietnam"]])$adj.r.squared)
)
saveRDS(m1_coefficients, file.path(results_dir, "m1_coefficients.rds"))

# Model fit statistics
m1_fit <- tibble(
  Country = countries,
  N = sapply(m1_results, nobs),
  R_squared = sapply(m1_results, function(x) summary(x)$r.squared),
  Adj_R_squared = sapply(m1_results, function(x) summary(x)$adj.r.squared),
  F_statistic = sapply(m1_results, function(x) summary(x)$fstatistic[1]),
  df1 = sapply(m1_results, function(x) summary(x)$fstatistic[2]),
  df2 = sapply(m1_results, function(x) summary(x)$fstatistic[3])
)
saveRDS(m1_fit, file.path(results_dir, "m1_fit_statistics.rds"))

# ----------------------------------------------------------------------------
# MODEL 2: Full models - Save BOTH raw models AND formatted coefficients
# ----------------------------------------------------------------------------
saveRDS(m2_results, file.path(results_dir, "m2_full_models.rds"))

# Formatted coefficient table for appendix
m2_coefficients <- bind_rows(
  tidy(m2_results[["Cambodia"]], conf.int = TRUE) %>% 
    mutate(Country = "Cambodia",
           n = nobs(m2_results[["Cambodia"]]),
           r_squared = summary(m2_results[["Cambodia"]])$r.squared,
           adj_r_squared = summary(m2_results[["Cambodia"]])$adj.r.squared),
  tidy(m2_results[["Thailand"]], conf.int = TRUE) %>% 
    mutate(Country = "Thailand",
           n = nobs(m2_results[["Thailand"]]),
           r_squared = summary(m2_results[["Thailand"]])$r.squared,
           adj_r_squared = summary(m2_results[["Thailand"]])$adj.r.squared),
  tidy(m2_results[["Vietnam"]], conf.int = TRUE) %>% 
    mutate(Country = "Vietnam",
           n = nobs(m2_results[["Vietnam"]]),
           r_squared = summary(m2_results[["Vietnam"]])$r.squared,
           adj_r_squared = summary(m2_results[["Vietnam"]])$adj.r.squared)
)
saveRDS(m2_coefficients, file.path(results_dir, "m2_coefficients.rds"))

# Model fit statistics
m2_fit <- tibble(
  Country = countries,
  N = sapply(m2_results, nobs),
  R_squared = sapply(m2_results, function(x) summary(x)$r.squared),
  Adj_R_squared = sapply(m2_results, function(x) summary(x)$adj.r.squared),
  F_statistic = sapply(m2_results, function(x) summary(x)$fstatistic[1]),
  df1 = sapply(m2_results, function(x) summary(x)$fstatistic[2]),
  df2 = sapply(m2_results, function(x) summary(x)$fstatistic[3])
)
saveRDS(m2_fit, file.path(results_dir, "m2_fit_statistics.rds"))

# ----------------------------------------------------------------------------
# COEFFICIENT REDUCTION ANALYSIS (Bivariate → Multivariate)
# ----------------------------------------------------------------------------

# Extract bivariate coefficients (trust only, from H2a)
bivariate_coefs <- sapply(h2a_results, function(x) x$coef)

# Extract multivariate coefficients (trust with all controls, from M2)
multivariate_coefs <- sapply(m2_results, function(x) coef(x)["covid_trust_info"])

# Calculate percentage reduction
reductions <- (bivariate_coefs - multivariate_coefs) / bivariate_coefs * 100

# Compile coefficient reduction statistics
coef_reduction_stats <- list(
  # Individual country results
  cambodia_bivariate = bivariate_coefs["Cambodia"],
  cambodia_multivariate = multivariate_coefs["Cambodia"],
  cambodia_reduction_pct = reductions["Cambodia"],

  thailand_bivariate = bivariate_coefs["Thailand"],
  thailand_multivariate = multivariate_coefs["Thailand"],
  thailand_reduction_pct = reductions["Thailand"],

  vietnam_bivariate = bivariate_coefs["Vietnam"],
  vietnam_multivariate = multivariate_coefs["Vietnam"],
  vietnam_reduction_pct = reductions["Vietnam"],

  # Summary statistics for manuscript
  reduction_min_pct = min(reductions),
  reduction_max_pct = max(reductions),
  retention_min_pct = 100 - max(reductions),
  retention_max_pct = 100 - min(reductions),

  # Minimum beta across countries (for substantive significance claim)
  beta_min = min(multivariate_coefs)
)

# Save for manuscript inline statistics
saveRDS(coef_reduction_stats, file.path(results_dir, "coef_reduction_stats.rds"))

# ----------------------------------------------------------------------------
# VIF diagnostics (for appendix multicollinearity section)
# ----------------------------------------------------------------------------
vif_table <- as.data.frame(vif_values) %>%
  rownames_to_column("Variable") %>%
  rename(VIF = 2)
saveRDS(vif_table, file.path(results_dir, "vif_diagnostics.rds"))

# ----------------------------------------------------------------------------
# Hypothesis summary table
# ----------------------------------------------------------------------------
saveRDS(hypothesis_summary, file.path(results_dir, "hypothesis_summary.rds"))

# ----------------------------------------------------------------------------
# MANIFEST: List all saved files
# ----------------------------------------------------------------------------
saved_files <- list.files(results_dir, pattern = "\\.rds$", full.names = FALSE)

cat("\n=== SAVED RESULTS FOR MANUSCRIPT ===\n")
cat("Directory:", results_dir, "\n\n")
cat("Files saved:\n")
for(f in saved_files) {
  cat("  ✓", f, "\n")
}
cat("\nTotal:", length(saved_files), "files\n")
```

# 11. Session Information

```{r 17-session-information}
sessionInfo()
```
