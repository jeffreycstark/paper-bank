---
title: "Mediation Analysis: Information Trust as Mechanism"
subtitle: "Testing the Pathway from COVID Exposure to Government Approval"
author: "Jeffrey Stark"
date: "`r Sys.Date()`"
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: show
    df-print: paged
    embed-resources: true
execute:
  warning: false
  message: false
---

# 1. Setup and Data Preparation

## 1.1 Load Libraries

```{r 00-setup}
library(tidyverse)
library(here)
library(mediation)      # Causal mediation analysis
library(lavaan)         # SEM approach (alternative)
library(broom)          # Tidy model outputs
library(gt)             # Tables
library(gtsummary)      # Regression tables
library(patchwork)      # Combine plots
library(DiagrammeR)     # Path diagrams
# library(ggdag)          # DAG visualization (optional)

# Set theme
theme_set(theme_minimal(base_size = 12))
```

## 1.2 Load Data

```{r 00b-load-data}
# Load your prepared dataset (from modular pipeline)
data <- readRDS(here("data", "processed", "ab_analysis_v2.rds"))

# Convert haven_labelled country_name to standard factor for compatibility
data <- data %>%
  mutate(country_name = as.factor(as.character(country_name)))

# Filter to Vietnam for main analysis
vietnam_data <- data %>%
  filter(country_name == "Vietnam")

# Check sample size
vietnam_data %>%
  count(covid_contracted, covid_trust_info, covid_govt_handling) %>%
  filter(!is.na(covid_contracted), !is.na(covid_trust_info), !is.na(covid_govt_handling))
```

## 1.2b Data Preparation for Analysis

```{r 00d-prepare-analysis-data}
# Create complete case dataset for mediation analysis
# Remove observations with missing values in key variables
vietnam_data_complete <- vietnam_data %>%
  select(covid_contracted, covid_trust_info, covid_govt_handling,
         auth_acceptance, emergency_powers_support,
         dem_satisfaction, institutional_trust_index) %>%
  na.omit()

cat("Original sample size:", nrow(vietnam_data), "\n")
cat("Complete case sample size:", nrow(vietnam_data_complete), "\n")
cat("Observations removed due to missing values:", nrow(vietnam_data) - nrow(vietnam_data_complete), "\n")
```

## 1.3 Theoretical Model

```{r 00c-theory-diagram}
# Create conceptual diagram
grViz("
digraph mediation_model {
  
  # Graph attributes
  graph [rankdir = LR, bgcolor = white]
  
  # Node definitions
  node [shape = box, style = filled, fillcolor = lightblue, fontname = Arial]
  X [label = 'COVID Infection\n(covid_contracted)', fillcolor = '#E8F4F8']
  M [label = 'Trust in COVID Info\n(covid_trust_info)', fillcolor = '#FFF4E6']
  Y [label = 'Government Handling\nApproval\n(covid_govt_handling)', fillcolor = '#E8F5E9']
  
  # Control variables
  node [shape = oval, fillcolor = '#F5F5F5', fontsize = 10]
  C1 [label = 'Auth Acceptance']
  C2 [label = 'Emergency Powers\nSupport']
  C3 [label = 'Dem Satisfaction']
  C4 [label = 'Institutional Trust']
  
  # Edges with labels
  X -> M [label = 'Path a', fontsize = 11, color = '#2196F3']
  M -> Y [label = 'Path b', fontsize = 11, color = '#4CAF50']
  X -> Y [label = \"Path c' (direct)\", fontsize = 11, color = '#FF9800', style = dashed]
  
  # Control paths (lighter)
  C1 -> M [color = '#CCCCCC']
  C1 -> Y [color = '#CCCCCC']
  C2 -> M [color = '#CCCCCC']
  C2 -> Y [color = '#CCCCCC']
  C3 -> M [color = '#CCCCCC']
  C3 -> Y [color = '#CCCCCC']
  C4 -> M [color = '#CCCCCC']
  C4 -> Y [color = '#CCCCCC']
  
  # Invisible edges for layout
  {rank = same; C1; C2; C3; C4}
}
")
```

**Core Hypothesis**:

> H_mediation: Trust in COVID information mediates the relationship between personal COVID infection and approval of government handling. Citizens who contracted COVID develop higher trust in government information, which in turn increases their approval ratings.

**Alternative Hypothesis**:

> H_null: The infection → approval relationship is direct (performance-based), not mediated through information trust.

------------------------------------------------------------------------

# 2. Descriptive Analysis of Key Variables

## 2.1 Bivariate Relationships

```{r 01-bivariate-x-to-m}
# X -> M relationship
p1 <- vietnam_data_complete %>% 
  filter(!is.na(covid_contracted), !is.na(covid_trust_info)) %>% 
  ggplot(aes(x = factor(covid_contracted), y = covid_trust_info)) +
  geom_violin(aes(fill = factor(covid_contracted)), alpha = 0.5) +
  geom_boxplot(width = 0.2, outlier.alpha = 0.3) +
  stat_summary(fun = mean, geom = "point", color = "red", size = 3) +
  scale_fill_manual(values = c("0" = "#E8F4F8", "1" = "#2196F3")) +
  labs(title = "Path a: Infection → Trust in Info",
       x = "COVID Contracted", 
       y = "Trust in COVID Information",
       caption = "Red dots = means") +
  theme(legend.position = "none")

# M -> Y relationship
p2 <- vietnam_data %>% 
  filter(!is.na(covid_trust_info), !is.na(covid_govt_handling)) %>% 
  ggplot(aes(x = covid_trust_info, y = covid_govt_handling)) +
  geom_point(alpha = 0.3, color = "#4CAF50") +
  geom_smooth(method = "lm", se = TRUE, color = "#2E7D32", linewidth = 1.5) +
  labs(title = "Path b: Trust in Info → Govt Approval",
       x = "Trust in COVID Information",
       y = "Government Handling Approval")

# X -> Y relationship (total effect)
p3 <- vietnam_data %>% 
  filter(!is.na(covid_contracted), !is.na(covid_govt_handling)) %>% 
  ggplot(aes(x = factor(covid_contracted), y = covid_govt_handling)) +
  geom_violin(aes(fill = factor(covid_contracted)), alpha = 0.5) +
  geom_boxplot(width = 0.2, outlier.alpha = 0.3) +
  stat_summary(fun = mean, geom = "point", color = "red", size = 3) +
  scale_fill_manual(values = c("0" = "#FFE0B2", "1" = "#FF9800")) +
  labs(title = "Total Effect: Infection → Govt Approval",
       x = "COVID Contracted",
       y = "Government Handling Approval",
       caption = "Red dots = means") +
  theme(legend.position = "none")

# Combine
p1 + p2 + p3
```

## 2.2 Correlation Matrix

```{r 02-correlation-matrix}
vietnam_data_complete %>%
  select(covid_contracted, covid_trust_info, covid_govt_handling,
         auth_acceptance, emergency_powers_support,
         dem_satisfaction, institutional_trust_index) %>% 
  cor(use = "pairwise.complete.obs") %>% 
  round(3) %>% 
  as.data.frame() %>% 
  rownames_to_column("Variable") %>% 
  gt() %>% 
  tab_header(title = "Correlation Matrix: Key Variables") %>% 
  data_color(
    columns = -Variable,
    colors = scales::col_numeric(
      palette = c("#D32F2F", "white", "#1976D2"),
      domain = c(-1, 1)
    )
  ) %>% 
  fmt_number(decimals = 3)
```

------------------------------------------------------------------------

# 3. Classical Mediation Analysis (Baron & Kenny)

## 3.1 Path Models

```{r 03-path-models}
# Control variables
controls <- c("auth_acceptance", "emergency_powers_support", 
              "dem_satisfaction", "institutional_trust_index")

# Path c: Total effect (X -> Y)
model_c <- lm(
  as.formula(paste("covid_govt_handling ~ covid_contracted +",
                   paste(controls, collapse = " + "))),
  data = vietnam_data_complete
)

# Path a: X -> M
model_a <- lm(
  as.formula(paste("covid_trust_info ~ covid_contracted +",
                   paste(controls, collapse = " + "))),
  data = vietnam_data_complete
)

# Path b and c': M -> Y and X -> Y (controlling for M)
model_bc <- lm(
  as.formula(paste("covid_govt_handling ~ covid_contracted + covid_trust_info +",
                   paste(controls, collapse = " + "))),
  data = vietnam_data_complete
)
```

## 3.2 Path Coefficients Table

```{r 04-path-coefficients}
# Extract key coefficients
path_results <- tibble(
  Path = c("c (Total Effect)", 
           "a (X → M)", 
           "b (M → Y)", 
           "c' (Direct Effect)"),
  Coefficient = c(
    coef(model_c)["covid_contracted"],
    coef(model_a)["covid_contracted"],
    coef(model_bc)["covid_trust_info"],
    coef(model_bc)["covid_contracted"]
  ),
  SE = c(
    summary(model_c)$coefficients["covid_contracted", "Std. Error"],
    summary(model_a)$coefficients["covid_contracted", "Std. Error"],
    summary(model_bc)$coefficients["covid_trust_info", "Std. Error"],
    summary(model_bc)$coefficients["covid_contracted", "Std. Error"]
  ),
  t_value = c(
    summary(model_c)$coefficients["covid_contracted", "t value"],
    summary(model_a)$coefficients["covid_contracted", "t value"],
    summary(model_bc)$coefficients["covid_trust_info", "t value"],
    summary(model_bc)$coefficients["covid_contracted", "t value"]
  ),
  p_value = c(
    summary(model_c)$coefficients["covid_contracted", "Pr(>|t|)"],
    summary(model_a)$coefficients["covid_contracted", "Pr(>|t|)"],
    summary(model_bc)$coefficients["covid_trust_info", "Pr(>|t|)"],
    summary(model_bc)$coefficients["covid_contracted", "Pr(>|t|)"]
  )
) %>% 
  mutate(
    CI_lower = Coefficient - 1.96 * SE,
    CI_upper = Coefficient + 1.96 * SE,
    sig = case_when(
      p_value < 0.001 ~ "***",
      p_value < 0.01 ~ "**",
      p_value < 0.05 ~ "*",
      TRUE ~ ""
    )
  )

# Sobel test for indirect effect
indirect_effect <- path_results$Coefficient[2] * path_results$Coefficient[3]
sobel_se <- sqrt(
  path_results$Coefficient[3]^2 * path_results$SE[2]^2 +
  path_results$Coefficient[2]^2 * path_results$SE[3]^2
)
sobel_z <- indirect_effect / sobel_se
sobel_p <- 2 * (1 - pnorm(abs(sobel_z)))

# Add indirect effect
path_results <- path_results %>% 
  add_row(
    Path = "a × b (Indirect Effect)",
    Coefficient = indirect_effect,
    SE = sobel_se,
    t_value = sobel_z,
    p_value = sobel_p,
    CI_lower = indirect_effect - 1.96 * sobel_se,
    CI_upper = indirect_effect + 1.96 * sobel_se,
    sig = case_when(
      sobel_p < 0.001 ~ "***",
      sobel_p < 0.01 ~ "**",
      sobel_p < 0.05 ~ "*",
      TRUE ~ ""
    )
  )

# Display table
path_results %>% 
  select(Path, Coefficient, SE, CI_lower, CI_upper, p_value, sig) %>% 
  gt() %>% 
  tab_header(title = "Baron & Kenny Path Coefficients",
             subtitle = "Classical Mediation Analysis") %>% 
  fmt_number(columns = c(Coefficient, SE, CI_lower, CI_upper), decimals = 4) %>% 
  fmt_number(columns = p_value, decimals = 4) %>% 
  tab_style(
    style = cell_fill(color = "#E8F5E9"),
    locations = cells_body(rows = Path == "a × b (Indirect Effect)")
  ) %>% 
  tab_footnote(
    footnote = "*** p<0.001, ** p<0.01, * p<0.05",
    locations = cells_column_labels(columns = sig)
  )
```

## 3.3 Proportion Mediated

```{r prop-mediated}
total_effect <- path_results$Coefficient[1]
direct_effect <- path_results$Coefficient[4]
indirect_effect <- path_results$Coefficient[5]

prop_mediated <- indirect_effect / total_effect

tibble(
  Measure = c("Total Effect (c)", 
              "Direct Effect (c')", 
              "Indirect Effect (a×b)",
              "Proportion Mediated"),
  Value = c(total_effect, direct_effect, indirect_effect, prop_mediated),
  Percentage = c(100, (direct_effect/total_effect)*100, 
                 (indirect_effect/total_effect)*100, prop_mediated*100)
) %>% 
  gt() %>% 
  tab_header(title = "Mediation Effect Decomposition") %>% 
  fmt_number(columns = c(Value), decimals = 4) %>% 
  fmt_percent(columns = Percentage, decimals = 1, scale_values = FALSE)
```

### Interpretation Template

```{r 05-interpretation, eval=FALSE}
# Fill this in based on results:
cat("
The total effect of COVID infection on government approval was β = X.XX (p < .XX).
This effect was mediated through trust in COVID information:
- Path a (infection → trust): β = X.XX (p < .XX)
- Path b (trust → approval): β = X.XX (p < .XX)  
- Indirect effect (a×b): β = X.XX (p < .XX)
- Direct effect after controlling for mediator: β = X.XX (p < .XX)

Trust in COVID information mediated XX% of the total effect, indicating 
[full/partial/no] mediation.
")
```

------------------------------------------------------------------------

# 4. Causal Mediation Analysis (Modern Approach)

## 4.1 Bootstrap-Based Inference

```{r 06-bootstrap-inference}
set.seed(2025)

# Mediator model (path a + controls)
mediator_model <- lm(
  covid_trust_info ~ covid_contracted +
    auth_acceptance + emergency_powers_support +
    dem_satisfaction + institutional_trust_index,
  data = vietnam_data_complete
)

# Outcome model (paths b and c' + controls)
outcome_model <- lm(
  covid_govt_handling ~ covid_contracted + covid_trust_info +
    auth_acceptance + emergency_powers_support +
    dem_satisfaction + institutional_trust_index,
  data = vietnam_data_complete
)

# Causal mediation analysis with bootstrapping
med_results <- mediate(
  mediator_model, 
  outcome_model,
  treat = "covid_contracted",
  mediator = "covid_trust_info",
  boot = TRUE,
  sims = 5000,  # Increase for final version
  boot.ci.type = "bca"  # Bias-corrected accelerated
)

# Summary
summary(med_results)
```

## 4.2 Extract Key Estimates

```{r 07-extract-estimates}
# Create results table
mediation_summary <- tibble(
  Effect = c("ACME (Indirect Effect)", 
             "ADE (Direct Effect)", 
             "Total Effect",
             "Proportion Mediated"),
  Estimate = c(
    med_results$d.avg,
    med_results$z.avg,
    med_results$tau.coef,
    med_results$n.avg
  ),
  CI_Lower = c(
    med_results$d.avg.ci[1],
    med_results$z.avg.ci[1],
    med_results$tau.ci[1],
    med_results$n.avg.ci[1]
  ),
  CI_Upper = c(
    med_results$d.avg.ci[2],
    med_results$z.avg.ci[2],
    med_results$tau.ci[2],
    med_results$n.avg.ci[2]
  ),
  p_value = c(
    med_results$d.avg.p,
    med_results$z.avg.p,
    med_results$tau.p,
    med_results$n.avg.p
  )
) %>% 
  mutate(
    sig = case_when(
      p_value < 0.001 ~ "***",
      p_value < 0.01 ~ "**",
      p_value < 0.05 ~ "*",
      TRUE ~ ""
    )
  )

mediation_summary %>% 
  gt() %>% 
  tab_header(
    title = "Causal Mediation Analysis Results",
    subtitle = "Bootstrap estimates with bias-corrected CIs (5,000 simulations)"
  ) %>% 
  fmt_number(columns = c(Estimate, CI_Lower, CI_Upper), decimals = 4) %>% 
  fmt_number(columns = p_value, decimals = 4) %>% 
  tab_style(
    style = cell_fill(color = "#FFF9C4"),
    locations = cells_body(rows = Effect == "ACME (Indirect Effect)")
  ) %>% 
  tab_footnote(
    footnote = "ACME = Average Causal Mediation Effect; ADE = Average Direct Effect",
    locations = cells_column_labels(columns = Effect)
  )
```

## 4.3 Visualization of Mediation Effects

```{r 08-visualization-mediation}
# Plot mediation results
plot(med_results)

# Custom forest plot
mediation_summary %>% 
  filter(Effect != "Proportion Mediated") %>% 
  ggplot(aes(x = Estimate, y = Effect, color = Effect)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50") +
  geom_point(size = 4) +
  geom_errorbarh(aes(xmin = CI_Lower, xmax = CI_Upper), height = 0.2, linewidth = 1) +
  scale_color_manual(values = c("ACME (Indirect Effect)" = "#4CAF50",
                                 "ADE (Direct Effect)" = "#FF9800",
                                 "Total Effect" = "#2196F3")) +
  labs(title = "Mediation Analysis: Effect Decomposition",
       subtitle = "95% Bias-Corrected Bootstrap Confidence Intervals",
       x = "Effect Size",
       y = NULL) +
  theme_minimal(base_size = 13) +
  theme(legend.position = "none",
        panel.grid.major.y = element_blank())
```

------------------------------------------------------------------------

# 5. Sensitivity Analysis

## 5.1 Robustness to Unmeasured Confounding

```{r 09-sensitivity-analysis}
# Sensitivity analysis for sequential ignorability assumption
sens_results <- medsens(
  med_results,
  rho.by = 0.05,  # Steps for rho
  effect.type = "both",
  sims = 1000
)

summary(sens_results)
```

## 5.2 Sensitivity Plots

```{r 10-sensitivity-plots}
# Plot sensitivity analysis
plot(sens_results, 
     sens.par = "rho",
     main = "Sensitivity Analysis: Robustness to Unmeasured Confounding",
     xlab = "Sensitivity Parameter (ρ)",
     ylab = "Average Mediation Effect")

# What this tells you:
# - How strong would correlation between residuals need to be to eliminate mediation?
# - Rho = correlation between errors in mediator and outcome models
# - If confidence interval crosses zero at low rho values, mediation is fragile
```

**Interpretation**: The mediation effect remains significant unless the correlation between unmeasured confounders affecting both the mediator and outcome exceeds ρ = \[X.XX\], suggesting \[robust/fragile\] evidence for the mediation pathway.

------------------------------------------------------------------------

# 6. Moderated Mediation Analysis

## 6.1 Does Mediation Vary by Authoritarian Acceptance?

**Theory**: Citizens with higher authoritarian acceptance may show stronger mediation through information trust (more receptive to government narratives).

```{r 11-moderated-mediation}
set.seed(2025)

# Add interaction terms
mediator_mod <- lm(
  covid_trust_info ~ covid_contracted * auth_acceptance +
    emergency_powers_support + dem_satisfaction + institutional_trust_index,
  data = vietnam_data_complete
)

outcome_mod <- lm(
  covid_govt_handling ~ covid_contracted * auth_acceptance +
    covid_trust_info * auth_acceptance +
    emergency_powers_support + dem_satisfaction + institutional_trust_index,
  data = vietnam_data_complete
)

# Test at different levels of moderator
# Low auth acceptance (mean - 1 SD)
low_auth <- mean(vietnam_data_complete$auth_acceptance, na.rm = TRUE) -
            sd(vietnam_data_complete$auth_acceptance, na.rm = TRUE)

med_low_auth <- mediate(
  mediator_mod, outcome_mod,
  treat = "covid_contracted",
  mediator = "covid_trust_info",
  covariates = list(auth_acceptance = low_auth),
  boot = TRUE, sims = 1000
)

# High auth acceptance (mean + 1 SD)
high_auth <- mean(vietnam_data_complete$auth_acceptance, na.rm = TRUE) +
             sd(vietnam_data_complete$auth_acceptance, na.rm = TRUE)

med_high_auth <- mediate(
  mediator_mod, outcome_mod,
  treat = "covid_contracted",
  mediator = "covid_trust_info",
  covariates = list(auth_acceptance = high_auth),
  boot = TRUE, sims = 1000
)

# Test difference
test_modmed <- mediate(
  mediator_mod, outcome_mod,
  treat = "covid_contracted",
  mediator = "covid_trust_info",
  boot = TRUE, sims = 1000
)

summary(test_modmed)
```

## 6.2 Compare Conditional Indirect Effects

```{r 12-conditional-effects}
# Create comparison table
conditional_effects <- tibble(
  Moderator_Level = c("Low Auth Acceptance (-1 SD)", 
                      "High Auth Acceptance (+1 SD)",
                      "Difference"),
  ACME = c(med_low_auth$d.avg, 
           med_high_auth$d.avg,
           med_high_auth$d.avg - med_low_auth$d.avg),
  CI_Lower = c(med_low_auth$d.avg.ci[1],
               med_high_auth$d.avg.ci[1],
               NA),
  CI_Upper = c(med_low_auth$d.avg.ci[2],
               med_high_auth$d.avg.ci[2],
               NA),
  p_value = c(med_low_auth$d.avg.p,
              med_high_auth$d.avg.p,
              NA)
)

conditional_effects %>% 
  gt() %>% 
  tab_header(title = "Conditional Indirect Effects",
             subtitle = "Mediation by Level of Authoritarian Acceptance") %>% 
  fmt_number(columns = c(ACME, CI_Lower, CI_Upper), decimals = 4) %>% 
  fmt_number(columns = p_value, decimals = 4)
```

## 6.3 Visualization

```{r 13-conditional-visualization}
# Plot conditional indirect effects
conditional_effects %>% 
  filter(Moderator_Level != "Difference") %>% 
  ggplot(aes(x = ACME, y = Moderator_Level, color = Moderator_Level)) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_point(size = 4) +
  geom_errorbarh(aes(xmin = CI_Lower, xmax = CI_Upper), height = 0.1, linewidth = 1) +
  scale_color_manual(values = c("#FF6B6B", "#4ECDC4")) +
  labs(title = "Moderated Mediation: Conditional Indirect Effects",
       subtitle = "Does authoritarian acceptance moderate the mediation pathway?",
       x = "Indirect Effect (ACME)",
       y = NULL) +
  theme_minimal(base_size = 13) +
  theme(legend.position = "none")
```

------------------------------------------------------------------------

# 7. Alternative Specifications (Robustness)

## 7.1 Multiple Mediators Model

**Question**: Is trust in COVID info THE key mediator, or one among several?

```{r 14-multiple-mediators}
# Test parallel mediation with institutional trust
mediator_multi1 <- lm(
  covid_trust_info ~ covid_contracted +
    auth_acceptance + emergency_powers_support + dem_satisfaction,
  data = vietnam_data_complete
)

mediator_multi2 <- lm(
  institutional_trust_index ~ covid_contracted +
    auth_acceptance + emergency_powers_support + dem_satisfaction,
  data = vietnam_data_complete
)

outcome_multi <- lm(
  covid_govt_handling ~ covid_contracted +
    covid_trust_info + institutional_trust_index +
    auth_acceptance + emergency_powers_support + dem_satisfaction,
  data = vietnam_data_complete
)

# Mediation through covid_trust_info
med_info <- mediate(mediator_multi1, outcome_multi,
                    treat = "covid_contracted",
                    mediator = "covid_trust_info",
                    boot = TRUE, sims = 1000)

# Mediation through institutional_trust_index  
med_inst <- mediate(mediator_multi2, outcome_multi,
                    treat = "covid_contracted",
                    mediator = "institutional_trust_index",
                    boot = TRUE, sims = 1000)

# Compare
tibble(
  Mediator = c("COVID Info Trust", "Institutional Trust"),
  Indirect_Effect = c(med_info$d.avg, med_inst$d.avg),
  CI_Lower = c(med_info$d.avg.ci[1], med_inst$d.avg.ci[1]),
  CI_Upper = c(med_info$d.avg.ci[2], med_inst$d.avg.ci[2]),
  p_value = c(med_info$d.avg.p, med_inst$d.avg.p)
) %>% 
  gt() %>% 
  tab_header(title = "Parallel Mediators Comparison") %>% 
  fmt_number(columns = c(Indirect_Effect, CI_Lower, CI_Upper), decimals = 4) %>% 
  fmt_number(columns = p_value, decimals = 4)
```

## 7.2 Alternative Model Specifications

```{r 15-alternative-specs}
# Specification 1: Minimal controls
med_minimal <- mediate(
  lm(covid_trust_info ~ covid_contracted, data = vietnam_data_complete),
  lm(covid_govt_handling ~ covid_contracted + covid_trust_info, data = vietnam_data_complete),
  treat = "covid_contracted",
  mediator = "covid_trust_info",
  boot = TRUE, sims = 1000
)

# Specification 2: Full controls (baseline from above)
# Already computed as med_results

# Specification 3: Add demographic controls if available
# med_demographics <- ... (if you have age, education, etc.)

# Compare specifications
spec_comparison <- tibble(
  Specification = c("Minimal (No Controls)", 
                    "Full Controls"),
  ACME = c(med_minimal$d.avg, med_results$d.avg),
  CI_Lower = c(med_minimal$d.avg.ci[1], med_results$d.avg.ci[1]),
  CI_Upper = c(med_minimal$d.avg.ci[2], med_results$d.avg.ci[2])
)

spec_comparison %>% 
  gt() %>% 
  tab_header(title = "Robustness: Alternative Specifications") %>% 
  fmt_number(columns = c(ACME, CI_Lower, CI_Upper), decimals = 4)
```

------------------------------------------------------------------------

# 8. Cross-Country Comparison (If Data Allows)

## 8.1 Test Mediation in Other Countries

**Question**: Is the mediation pathway unique to Vietnam?

```{r 16-cross-country-analysis}
# Select comparison countries
comparison_countries <- c("Cambodia", "Thailand")

# Function to run mediation for each country
run_country_mediation <- function(country) {

  country_data <- data %>% filter(country_name == country)

  # Create complete case dataset
  country_data_complete <- country_data %>%
    select(covid_contracted, covid_trust_info, covid_govt_handling,
           auth_acceptance, emergency_powers_support,
           dem_satisfaction, institutional_trust_index) %>%
    na.omit()

  # Check if sufficient data
  if(nrow(country_data_complete) < 100) return(NULL)

  # Run mediation
  med_model <- lm(covid_trust_info ~ covid_contracted +
                   auth_acceptance + emergency_powers_support +
                   dem_satisfaction + institutional_trust_index,
                 data = country_data_complete)

  out_model <- lm(covid_govt_handling ~ covid_contracted + covid_trust_info +
                   auth_acceptance + emergency_powers_support +
                   dem_satisfaction + institutional_trust_index,
                 data = country_data_complete)
  
  med_result <- mediate(med_model, out_model,
                        treat = "covid_contracted",
                        mediator = "covid_trust_info",
                        boot = TRUE, sims = 500)  # Fewer sims for speed
  
  # Extract results
  tibble(
    country = country,
    acme = med_result$d.avg,
    acme_ci_lower = med_result$d.avg.ci[1],
    acme_ci_upper = med_result$d.avg.ci[2],
    acme_p = med_result$d.avg.p,
    prop_mediated = med_result$n.avg,
    n = nrow(country_data_complete)
  )
}

# Run for all countries (safely handling NULL returns)
cross_country_results <- map(
  c("Vietnam", comparison_countries),
  ~run_country_mediation(.x)
) %>%
  compact() %>%  # Remove NULL results

  bind_rows()

# Display results if we have valid data
if (nrow(cross_country_results) > 0 && "acme" %in% names(cross_country_results)) {
  cross_country_results %>%
    arrange(desc(acme)) %>%
    gt() %>%
    tab_header(title = "Cross-Country Mediation Comparison",
               subtitle = "Is the information trust pathway unique to Vietnam?") %>%
    fmt_number(columns = c(acme, acme_ci_lower, acme_ci_upper, prop_mediated),
               decimals = 3) %>%
    fmt_number(columns = acme_p, decimals = 4) %>%
    data_color(
      columns = acme,
      colors = scales::col_numeric(
        palette = c("white", "#4CAF50"),
        domain = NULL
      )
    )
} else {
  cat("Insufficient data for cross-country mediation comparison.\n")
  cat("Countries may have <100 complete cases for required variables.\n")
}
```

## 8.2 Visualization: Cross-Country Comparison

```{r 17-country-visualization}
if (exists("cross_country_results") && nrow(cross_country_results) > 0 && "acme" %in% names(cross_country_results)) {
  cross_country_results %>%
    mutate(country = fct_reorder(country, acme)) %>%
    ggplot(aes(x = acme, y = country, color = country == "Vietnam")) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "gray50") +
    geom_point(size = 4) +
    geom_errorbarh(aes(xmin = acme_ci_lower, xmax = acme_ci_upper),
                   height = 0.2, linewidth = 1) +
    scale_color_manual(values = c("FALSE" = "gray60", "TRUE" = "#FF5722")) +
    labs(title = "Mediation Effect Across Countries",
         subtitle = "Indirect effect of COVID infection through information trust",
         x = "Average Causal Mediation Effect (ACME)",
         y = NULL,
         caption = "Error bars represent 95% bootstrap confidence intervals") +
    theme_minimal(base_size = 13) +
    theme(legend.position = "none")
} else {
  cat("Cross-country visualization skipped: insufficient data.\n")
}
```

------------------------------------------------------------------------

# 9. Final Path Diagram with Coefficients

```{r 18-final-diagram}
# Extract standardized coefficients for cleaner display
std_coef_a <- coef(lm(scale(covid_trust_info) ~ scale(covid_contracted),
                      data = vietnam_data_complete))[2]
std_coef_b <- coef(lm(scale(covid_govt_handling) ~ scale(covid_trust_info),
                      data = vietnam_data_complete))[2]
std_coef_c_prime <- coef(model_bc)["covid_contracted"] /
                    sd(vietnam_data_complete$covid_govt_handling, na.rm = TRUE)

# Create diagram with actual coefficients
grViz(paste0("
digraph final_model {
  
  graph [rankdir = LR, bgcolor = white]
  
  node [shape = box, style = filled, fillcolor = lightblue, fontname = Arial, fontsize = 12]
  X [label = 'COVID Infection', fillcolor = '#E8F4F8']
  M [label = 'Trust in\\nCOVID Info', fillcolor = '#FFF4E6']
  Y [label = 'Government\\nApproval', fillcolor = '#E8F5E9']
  
  X -> M [label = '  β = ", round(med_results$d.avg, 3), "***  ', 
          fontsize = 11, color = '#2196F3', penwidth = 2]
  M -> Y [label = '  β = ", round(std_coef_b, 3), "***  ', 
          fontsize = 11, color = '#4CAF50', penwidth = 2]
  X -> Y [label = \"  β = ", round(std_coef_c_prime, 3), "*  \", 
          fontsize = 11, color = '#FF9800', style = dashed]
  
  {rank = min; X}
  {rank = max; Y}
}
"))
```

------------------------------------------------------------------------

# 10. Summary and Interpretation

## 10.1 Key Findings

```{r 19-summary-findings}
# Create executive summary
summary_findings <- tibble(
  Finding = c(
    "1. Total Effect",
    "2. Indirect Effect (Mediation)",
    "3. Direct Effect",
    "4. Proportion Mediated",
    "5. Mediation Robustness",
    "6. Moderation by Auth Acceptance",
    "7. Cross-Country Uniqueness"
  ),
  Result = c(
    paste0("β = ", round(med_results$tau.coef, 3), 
           ", p ", ifelse(med_results$tau.p < 0.001, "< .001", 
                         paste0("= ", round(med_results$tau.p, 3)))),
    paste0("β = ", round(med_results$d.avg, 3), 
           ", p ", ifelse(med_results$d.avg.p < 0.001, "< .001", 
                         paste0("= ", round(med_results$d.avg.p, 3)))),
    paste0("β = ", round(med_results$z.avg, 3), 
           ", p ", ifelse(med_results$z.avg.p < 0.001, "< .001", 
                         paste0("= ", round(med_results$z.avg.p, 3)))),
    paste0(round(med_results$n.avg * 100, 1), "%"),
    "[Fill based on sensitivity analysis]",
    "[Fill based on moderated mediation]",
    "[Fill based on cross-country comparison]"
  ),
  Interpretation = c(
    "COVID infection significantly increases govt approval",
    "This effect operates through increased trust in COVID info",
    "Some direct effect remains (partial mediation)",
    "Substantial portion of effect is mediated",
    "Effect is [robust/sensitive] to unmeasured confounding",
    "Mediation is [stronger/similar] among high auth acceptance",
    "Vietnam [unique/similar] compared to regional peers"
  )
)

summary_findings %>% 
  gt() %>% 
  tab_header(title = "Executive Summary: Mediation Analysis Results") %>% 
  tab_style(
    style = cell_fill(color = "#E3F2FD"),
    locations = cells_body(rows = c(2))
  )
```

## 10.2 Theoretical Implications

**Write-up template for paper**:

> Our mediation analysis reveals that \[PROPORTION\]% of the relationship between COVID infection and government approval operates through trust in COVID information (ACME = \[X.XX\], 95% CI \[X.XX, X.XX\], p \< .XXX). This finding supports our theoretical argument that citizens in Vietnam distinguish between performance effectiveness and regime legitimacy, with the information environment serving as the key linking mechanism.
>
> Specifically, individuals who contracted COVID were \[more/less\] likely to trust government information about the pandemic (β = \[X.XX\], p \< .XXX), which in turn predicted higher approval of government handling (β = \[X.XX\], p \< .XXX). The direct effect of infection on approval, while \[still significant/reduced to non-significance\], was substantially attenuated when accounting for information trust (β = \[X.XX\], p = \[.XXX\]).
>
> Sensitivity analyses indicate this mediation effect is \[robust/fragile\], remaining significant unless unmeasured confounding between the mediator and outcome exceeded ρ = \[X.XX\]. \[Additional findings on moderated mediation and cross-country comparisons...\]

------------------------------------------------------------------------

# 11. Limitations and Future Directions

## 11.1 Methodological Limitations

-   **Cross-sectional data**: Cannot establish definitive causal ordering
-   **Self-reported measures**: Potential for recall bias and social desirability
-   **Sequential ignorability assumption**: Relies on no unmeasured confounding
-   **Single mediator focus**: Other pathways may exist (e.g., rally effects, fear)
-   **Endogeneity concern**: Because COVID infection is not randomly assigned,
    the mediation estimates are descriptive rather than truly causal. Unobserved
    confounders (e.g., risk tolerance, social network exposure) may affect both
    the likelihood of infection and attitudes toward government. The `mediation`
    package provides principled estimates under sequential ignorability, but
    these cannot be interpreted as unbiased causal effects without stronger
    identification assumptions. We address this through sensitivity analysis
    (Section 7), which quantifies how large unmeasured confounding would need
    to be to nullify our findings.

## 11.2 Robustness Checks Performed

✓ Bootstrap-based inference (5,000 simulations)\
✓ Sensitivity analysis for unmeasured confounding\
✓ Multiple model specifications\
✓ Alternative mediator tests\
✓ Cross-country validation

## 11.3 Future Research

-   Longitudinal designs to establish temporal ordering
-   Experimental manipulation of information exposure
-   Process tracing through qualitative interviews
-   Extension to other crisis contexts (economic, environmental)

------------------------------------------------------------------------

# 12. Save Results for Manuscript

```{r 99-save-results-for-manuscript}
# ============================================================================
# SAVE KEY RESULTS FOR MANUSCRIPT
# ============================================================================

results_dir <- here("papers/01_vietnam_covid_paradox/analysis/results")
dir.create(results_dir, showWarnings = FALSE, recursive = TRUE)

# Path coefficients (Baron & Kenny)
saveRDS(path_results, file.path(results_dir, "med_path_coefficients.rds"))

# Bootstrap mediation results
saveRDS(med_results, file.path(results_dir, "med_bootstrap_results.rds"))

# Mediation summary table
saveRDS(mediation_summary, file.path(results_dir, "med_summary.rds"))

# Sensitivity analysis results
saveRDS(sens_results, file.path(results_dir, "med_sensitivity.rds"))

# Moderated mediation - low auth
saveRDS(med_low_auth, file.path(results_dir, "med_low_auth.rds"))

# Moderated mediation - high auth
saveRDS(med_high_auth, file.path(results_dir, "med_high_auth.rds"))

# Cross-country comparison
saveRDS(cross_country_results, file.path(results_dir, "med_cross_country.rds"))

cat("\n=== SAVED RESULTS FOR MANUSCRIPT ===\n")
cat("✓ Path coefficients (Baron & Kenny)\n")
cat("✓ Bootstrap mediation results\n")
cat("✓ Mediation summary table\n")
cat("✓ Sensitivity analysis results\n")
cat("✓ Moderated mediation (low auth)\n")
cat("✓ Moderated mediation (high auth)\n")
cat("✓ Cross-country comparison\n")
cat("\nAll results saved to:", results_dir, "\n")
```

# 13. Session Info

```{r 20-session-info}
sessionInfo()
```

------------------------------------------------------------------------

# Appendix: Additional Analyses

## A1: SEM Approach (Alternative Method)

```{r 21-sem-approach}
# Using lavaan for SEM-based mediation
library(lavaan)

# Define model
sem_model <- '
  # Mediator model
  covid_trust_info ~ a * covid_contracted + auth_acceptance + 
                     emergency_powers_support + dem_satisfaction + 
                     institutional_trust_index
  
  # Outcome model
  covid_govt_handling ~ b * covid_trust_info + cp * covid_contracted + 
                        auth_acceptance + emergency_powers_support + 
                        dem_satisfaction + institutional_trust_index
  
  # Indirect effect
  indirect := a * b
  
  # Total effect
  total := cp + (a * b)
  
  # Proportion mediated
  prop_med := indirect / total
'

# Fit model
sem_fit <- sem(sem_model, data = vietnam_data, se = "bootstrap", bootstrap = 1000)

# Results
summary(sem_fit, standardized = TRUE, fit.measures = TRUE, rsquare = TRUE)

# Extract parameters
parameterEstimates(sem_fit, boot.ci.type = "bca.simple") %>% 
  filter(label %in% c("a", "b", "cp", "indirect", "total", "prop_med")) %>% 
  select(label, est, se, ci.lower, ci.upper, pvalue) %>% 
  gt() %>% 
  tab_header(title = "SEM-Based Mediation Results") %>% 
  fmt_number(columns = c(est, se, ci.lower, ci.upper), decimals = 4) %>% 
  fmt_number(columns = pvalue, decimals = 4)
```

## A2: Subgroup Analyses

```{r 22-subgroup-analyses, eval=FALSE}
# Test mediation separately by demographics (if available)
# Example: By age group, education level, urban/rural, etc.
# Template:
# vietnam_data %>%
#   filter(age_group == "young") %>%
#   # Run mediation analysis...

```

------------------------------------------------------------------------

**END OF ANALYSIS**
