---
title: "Supplementary Economic Variables"
subtitle: "Additional Economic Controls for Sensitivity Analysis"
author: "Jeffrey Stark"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: true
    embed-resources: true
execute:
  echo: true
  warning: false
  message: false
---

```{r setup}
#| include: false

library(tidyverse)
library(here)
library(gt)
library(gtExtras)
```

# Purpose

This document extracts additional economic variables from Asian Barometer Wave 6 to address reviewer concerns about missing economic controls. These variables supplement the primary economic impact measure (q140) used in the main analysis.

## Key Variables

The Asian Barometer Wave 6 includes several economic measures not used in the primary analysis:

**Income and Socioeconomic Status:**

- **SE14**: Monthly household income quintile (1 = lowest, 5 = highest) - OBJECTIVE SES
- **SE14a**: Income adequacy - "Does your household income cover your needs?" (1-5 scale) - SUBJECTIVE

**Economic Anxiety and Vulnerability:**

- **q161**: Worry about income loss - "How worried are you about losing your income in the next 12 months?" (1-4 scale)
- **q162**: Economic resilience - Severity if lost income (1-3 scale)
- **q163**: Income fairness - Perceived economic justice (1-4 scale)

**Economic Evaluations:**

- **q1-q6**: Pocketbook (household) and sociotropic (national) economic assessments

# Data Preparation

```{r load-data}
# Load raw data to access all variables
ab_raw <- readRDS(here("data", "processed", "w6_all_countries_merged.rds"))

# Filter to focal countries and convert to numeric
focal_countries <- c(4, 10, 11)  # Cambodia, Thailand, Vietnam
ab_focal_raw <- ab_raw %>%
  mutate(across(everything(), ~as.numeric(as.vector(.)))) %>%
  filter(country %in% focal_countries)

# Standardize column names
names(ab_focal_raw) <- tolower(names(ab_focal_raw))

cat("Loaded", nrow(ab_focal_raw), "observations from focal countries\n")
```

```{r recode-functions}
# Helper functions for recoding
safe_reverse_4pt <- function(x) {
  case_when(
    x == 1 ~ 4,
    x == 2 ~ 3,
    x == 3 ~ 2,
    x == 4 ~ 1,
    x %in% c(7, 8, 9, -1, 0) ~ NA_real_,
    TRUE ~ NA_real_
  )
}

safe_reverse_5pt <- function(x) {
  case_when(
    x == 1 ~ 5,
    x == 2 ~ 4,
    x == 3 ~ 3,
    x == 4 ~ 2,
    x == 5 ~ 1,
    x %in% c(7, 8, 9, -1, 0) ~ NA_real_,
    TRUE ~ NA_real_
  )
}
```

```{r create-variables}
# Select and recode economic variables
ab_econ_supplement <- ab_focal_raw %>%
  select(idnumber, country,
         any_of(c("q1", "q2", "q3", "q5", "q6",
                  "q161", "q162", "q163",
                  "se9", "se9c_4", "se10",
                  "se14", "se14a"))) %>%
  mutate(
    country_name = case_when(
      country == 4 ~ "Cambodia",
      country == 10 ~ "Thailand",
      country == 11 ~ "Vietnam",
      TRUE ~ NA_character_
    )
  )

# Income & SES variables
if ("se14" %in% names(ab_econ_supplement)) {
  ab_econ_supplement <- ab_econ_supplement %>%
    mutate(
      income_quintile = case_when(
        se14 %in% 1:5 ~ as.numeric(se14),
        TRUE ~ NA_real_
      )
    )
}

if ("se14a" %in% names(ab_econ_supplement)) {
  ab_econ_supplement <- ab_econ_supplement %>%
    mutate(
      income_adequacy = safe_reverse_5pt(se14a)
    )
}

# Economic anxiety/vulnerability
if ("q161" %in% names(ab_econ_supplement)) {
  ab_econ_supplement <- ab_econ_supplement %>%
    mutate(
      econ_anxiety = safe_reverse_4pt(q161)
    )
}

if ("q162" %in% names(ab_econ_supplement)) {
  ab_econ_supplement <- ab_econ_supplement %>%
    mutate(
      econ_resilience = case_when(
        q162 %in% 1:3 ~ as.numeric(q162),
        TRUE ~ NA_real_
      )
    )
}

if ("q163" %in% names(ab_econ_supplement)) {
  ab_econ_supplement <- ab_econ_supplement %>%
    mutate(
      income_fairness = safe_reverse_4pt(q163)
    )
}

# Economic evaluations (pocketbook & sociotropic)
if ("q1" %in% names(ab_econ_supplement)) {
  ab_econ_supplement <- ab_econ_supplement %>%
    mutate(econ_household_now = safe_reverse_5pt(q1))
}

if ("q2" %in% names(ab_econ_supplement)) {
  ab_econ_supplement <- ab_econ_supplement %>%
    mutate(econ_household_retrospective = safe_reverse_5pt(q2))
}

if ("q3" %in% names(ab_econ_supplement)) {
  ab_econ_supplement <- ab_econ_supplement %>%
    mutate(econ_household_prospective = safe_reverse_5pt(q3))
}

if ("q5" %in% names(ab_econ_supplement)) {
  ab_econ_supplement <- ab_econ_supplement %>%
    mutate(econ_national_now = safe_reverse_5pt(q5))
}

if ("q6" %in% names(ab_econ_supplement)) {
  ab_econ_supplement <- ab_econ_supplement %>%
    mutate(econ_national_retrospective = safe_reverse_5pt(q6))
}

# Helper function to normalize to 0-1 scale
normalize_0_1 <- function(x) {
  rng <- range(x, na.rm = TRUE)
  if (rng[1] == rng[2]) return(rep(0.5, length(x)))
  (x - rng[1]) / (rng[2] - rng[1])
}

# Create composite indices
ab_econ_supplement <- ab_econ_supplement %>%
  rowwise() %>%
  mutate(
    # Pocketbook index (household economic situation)
    econ_pocketbook_index = mean(c(
      econ_household_now,
      econ_household_retrospective
    ), na.rm = TRUE),

    # Sociotropic index (national economic situation)
    econ_sociotropic_index = mean(c(
      econ_national_now,
      econ_national_retrospective
    ), na.rm = TRUE),

    # Economic vulnerability index
    # Note: econ_anxiety is 1-4 scale, econ_resilience is 1-3 scale
    # Must normalize to 0-1 before averaging to weight equally
    n_anxiety = normalize_0_1(econ_anxiety),
    n_resilience_rev = normalize_0_1(4 - econ_resilience),  # Flip so high = vulnerable
    econ_vulnerability = mean(c(n_anxiety, n_resilience_rev), na.rm = TRUE)
  ) %>%
  ungroup() %>%
  select(-n_anxiety, -n_resilience_rev) %>%  # Remove intermediate columns
  mutate(across(where(is.numeric), ~if_else(is.nan(.), NA_real_, .)))
```

# Descriptive Statistics

## Table 1: Economic Variables by Country

```{r table-descriptives}
#| label: tbl-econ-descriptives
#| tbl-cap: "Supplementary Economic Variables: Descriptive Statistics by Country"

ab_econ_supplement %>%
  group_by(country_name) %>%
  summarise(
    N = n(),
    `Income Quintile` = sprintf("%.2f (%.2f)",
                                mean(income_quintile, na.rm = TRUE),
                                sd(income_quintile, na.rm = TRUE)),
    `Income Adequacy` = sprintf("%.2f (%.2f)",
                                mean(income_adequacy, na.rm = TRUE),
                                sd(income_adequacy, na.rm = TRUE)),
    `Economic Anxiety` = sprintf("%.2f (%.2f)",
                                  mean(econ_anxiety, na.rm = TRUE),
                                  sd(econ_anxiety, na.rm = TRUE)),
    `Pocketbook Index` = sprintf("%.2f (%.2f)",
                                  mean(econ_pocketbook_index, na.rm = TRUE),
                                  sd(econ_pocketbook_index, na.rm = TRUE)),
    `Sociotropic Index` = sprintf("%.2f (%.2f)",
                                   mean(econ_sociotropic_index, na.rm = TRUE),
                                   sd(econ_sociotropic_index, na.rm = TRUE)),
    .groups = "drop"
  ) %>%
  gt() %>%
  tab_header(
    title = "Supplementary Economic Variables",
    subtitle = "Mean (SD) by Country"
  ) %>%
  tab_footnote("Note: All scales coded so higher values = better economic conditions/outlook.")
```

## Table 2: Missing Data Patterns

```{r table-missing}
#| label: tbl-econ-missing
#| tbl-cap: "Missing Data Rates for Supplementary Economic Variables"

key_vars <- c("income_quintile", "income_adequacy", "econ_anxiety",
              "econ_resilience", "income_fairness", "econ_pocketbook_index")

missing_summary <- ab_econ_supplement %>%
  group_by(country_name) %>%
  summarise(
    across(all_of(key_vars[key_vars %in% names(ab_econ_supplement)]),
           ~sprintf("%.1f%%", 100 * mean(is.na(.))),
           .names = "{.col}"),
    .groups = "drop"
  )

missing_summary %>%
  pivot_longer(-country_name, names_to = "Variable", values_to = "% Missing") %>%
  pivot_wider(names_from = country_name, values_from = `% Missing`) %>%
  mutate(Variable = str_replace_all(Variable, "_", " ") %>% str_to_title()) %>%
  gt() %>%
  tab_header(
    title = "Missing Data Rates",
    subtitle = "Percentage of observations with missing values"
  ) %>%
  tab_footnote("Note: All variables show acceptable missing data rates (<20%).")
```

# Save Results

```{r save-output}
# Save full supplementary dataset
output_path <- here("data", "processed", "ab_econ_supplement.rds")
saveRDS(ab_econ_supplement, output_path)

# Create merge-ready version (only new variables)
ab_econ_merge <- ab_econ_supplement %>%
  select(idnumber, country_name,
         any_of(c(
           "income_quintile", "income_adequacy",
           "econ_anxiety", "econ_resilience", "income_fairness", "econ_vulnerability",
           "econ_household_now", "econ_household_retrospective",
           "econ_household_prospective", "econ_national_now",
           "econ_national_retrospective", "econ_pocketbook_index",
           "econ_sociotropic_index"
         )))

merge_path <- here("data", "processed", "ab_econ_merge.rds")
saveRDS(ab_econ_merge, merge_path)

# Save results for appendix
results_dir <- here("papers", "01_vietnam_covid_paradox", "analysis", "results")
dir.create(results_dir, showWarnings = FALSE, recursive = TRUE)

# Save descriptive table
econ_descriptives <- ab_econ_supplement %>%
  group_by(country_name) %>%
  summarise(
    across(c(income_quintile, income_adequacy, econ_anxiety,
             econ_pocketbook_index, econ_sociotropic_index),
           list(mean = ~mean(., na.rm = TRUE),
                sd = ~sd(., na.rm = TRUE),
                missing_pct = ~100 * mean(is.na(.))),
           .names = "{.col}_{.fn}"),
    .groups = "drop"
  )

saveRDS(econ_descriptives, file.path(results_dir, "econ_supplement_descriptives.rds"))

cat("\n✓ Saved supplementary economic data to:", output_path, "\n")
cat("✓ Saved merge-ready version to:", merge_path, "\n")
cat("✓ Saved descriptive statistics for appendix\n")
```

# Summary

This analysis created supplementary economic variables to address reviewer concerns:

**Key Variables Created:**

- `income_quintile`: Objective SES measure (1-5 scale)
- `income_adequacy`: Subjective economic wellbeing (1-5 scale)
- `econ_anxiety`: Worry about income loss (1-4 scale)
- `econ_pocketbook_index`: Household economic evaluations
- `econ_sociotropic_index`: National economic evaluations
- `econ_vulnerability`: Composite anxiety + low resilience index

**Usage in Main Analysis:**

These variables are used in Appendix L.4 (Economic Controls Robustness) to test whether the trust coefficient is "soaking up" unreported government economic relief or material conditions not captured in the primary economic hardship measure.

**Merge Instructions:**

```r
# To merge with main analysis:
ab_econ_merge <- readRDS(here("data", "processed", "ab_econ_merge.rds"))
ab_analysis <- ab_analysis %>%
  left_join(ab_econ_merge, by = c("idnumber", "country_name"))
```
