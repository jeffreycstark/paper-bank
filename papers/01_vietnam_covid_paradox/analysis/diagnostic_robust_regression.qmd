---
title: "Data Diagnostic: Troubleshooting Robust Regression"
subtitle: "Quick check for missing data and data quality issues"
author: "Jeffrey Stark"
date: today
format:
  html:
    toc: true
    code-fold: show
    embed-resources: true
execute:
  warning: true
  message: true
---

# Purpose

This script helps diagnose the "incompatible dimensions" error in robust regression. The error typically means: 1. Missing values (NAs) in the data 2. Variables with different lengths 3. Factor variables not properly coded

# Load Data and Packages

```{r setup}
# Load packages
library(tidyverse)
library(here)
library(MASS)

# Load data
data <- readRDS(here("papers", "01_vietnam_covid_paradox", "analysis", "data", "analysis_data.rds"))

# Convert haven_labelled country_name to standard factor for compatibility
data <- data %>%
  mutate(country_name = as.factor(as.character(country_name)))
```

# Check 1: Variable Existence and Types

```{r check-variables}
cat("=" , rep("=", 69), "\n", sep = "")
cat("CHECKING VARIABLE TYPES\n")
cat(rep("=", 70), "\n\n", sep = "")

# Check if variables exist
required_vars <- c("country_name", "covid_contracted", 
                  "covid_govt_handling", "covid_trust_info")

for(var in required_vars) {
  if(var %in% names(data)) {
    cat("✓", var, "exists\n")
    cat("  Type:", class(data[[var]]), "\n")
    if(is.factor(data[[var]]) || is.character(data[[var]])) {
      cat("  Levels:", length(unique(data[[var]])), "\n")
    } else {
      cat("  Range:", range(data[[var]], na.rm = TRUE), "\n")
    }
    cat("  NAs:", sum(is.na(data[[var]])), "\n\n")
  } else {
    cat("✗", var, "MISSING!\n\n")
  }
}
```

# Check 2: Missing Data by Country

```{r check-missing}
cat("\n", rep("=", 70), "\n", sep = "")
cat("MISSING DATA BY COUNTRY\n")
cat(rep("=", 70), "\n\n", sep = "")

data %>%
  group_by(country_name) %>%
  summarise(
    N_total = n(),
    N_govt_handling = sum(!is.na(covid_govt_handling)),
    N_contracted = sum(!is.na(covid_contracted)),
    N_trust_info = sum(!is.na(covid_trust_info)),
    N_complete = sum(!is.na(covid_govt_handling) & 
                    !is.na(covid_contracted) & 
                    !is.na(covid_trust_info))
  ) %>%
  print()
```

# Check 3: Test Robust Regression (Vietnam)

```{r test-vietnam}
cat("\n", rep("=", 70), "\n", sep = "")
cat("TESTING VIETNAM DATA\n")
cat(rep("=", 70), "\n\n", sep = "")

# Filter Vietnam data
vietnam_data <- data %>%
  filter(country_name == "Vietnam")

cat("Vietnam total rows:", nrow(vietnam_data), "\n")

# Select and clean
vietnam_clean <- vietnam_data %>%
  dplyr::select(covid_govt_handling, covid_contracted, covid_trust_info) %>%
  filter(!is.na(covid_govt_handling), 
         !is.na(covid_contracted), 
         !is.na(covid_trust_info))

cat("Vietnam complete cases:", nrow(vietnam_clean), "\n\n")

# Check for any weird values
cat("Checking for infinite or extreme values:\n")
cat("  covid_govt_handling - any Inf?", any(is.infinite(vietnam_clean$covid_govt_handling)), "\n")
cat("  covid_contracted - any Inf?", any(is.infinite(vietnam_clean$covid_contracted)), "\n")
cat("  covid_trust_info - any Inf?", any(is.infinite(vietnam_clean$covid_trust_info)), "\n\n")

# Try OLS first
cat("Attempting OLS regression...\n")
tryCatch({
  ols_model <- lm(covid_govt_handling ~ covid_contracted + covid_trust_info,
                  data = vietnam_clean)
  cat("✓ OLS successful\n")
  cat("  N observations:", nobs(ols_model), "\n")
  cat("  Coefficients:\n")
  print(coef(ols_model))
}, error = function(e) {
  cat("✗ OLS failed:", e$message, "\n")
})

# Try robust regression
cat("\nAttempting robust regression (MM method)...\n")
tryCatch({
  robust_model <- rlm(covid_govt_handling ~ covid_contracted + covid_trust_info,
                      data = vietnam_clean,
                      method = "MM",
                      maxit = 100)
  cat("✓ Robust regression successful\n")
  cat("  Coefficients:\n")
  print(coef(robust_model))
}, error = function(e) {
  cat("✗ Robust regression failed:", e$message, "\n")
  cat("\nTrying M method instead...\n")
  
  tryCatch({
    robust_model_m <- rlm(covid_govt_handling ~ covid_contracted + covid_trust_info,
                         data = vietnam_clean,
                         method = "M",
                         maxit = 100)
    cat("✓ M method successful\n")
    cat("  Coefficients:\n")
    print(coef(robust_model_m))
  }, error = function(e2) {
    cat("✗ M method also failed:", e2$message, "\n")
  })
})
```

# Check 4: Data Structure Issues

```{r check-structure}
cat("\n", rep("=", 70), "\n", sep = "")
cat("CHECKING DATA STRUCTURE\n")
cat(rep("=", 70), "\n\n", sep = "")

vietnam_clean <- data %>%
  filter(country_name == "Vietnam") %>%
  dplyr::select(covid_govt_handling, covid_contracted, covid_trust_info) %>%
  filter(!is.na(covid_govt_handling), 
         !is.na(covid_contracted), 
         !is.na(covid_trust_info))

cat("Dimensions:", dim(vietnam_clean), "\n")
cat("Column names:", names(vietnam_clean), "\n")
cat("All numeric?", all(sapply(vietnam_clean, is.numeric)), "\n\n")

cat("First 10 rows:\n")
print(head(vietnam_clean, 10))

cat("\nSummary statistics:\n")
print(summary(vietnam_clean))

# Check for constant variables
cat("\nChecking for constant (zero variance) variables:\n")
for(var in names(vietnam_clean)) {
  variance <- var(vietnam_clean[[var]], na.rm = TRUE)
  cat("  ", var, "variance:", variance, "\n")
  if(variance == 0 || is.na(variance)) {
    cat("    ⚠ WARNING: This variable has zero variance!\n")
  }
}
```

# Check 5: Correlation Matrix

```{r check-correlation}
cat("\n", rep("=", 70), "\n", sep = "")
cat("CORRELATION MATRIX (Vietnam)\n")
cat(rep("=", 70), "\n\n", sep = "")

vietnam_clean <- data %>%
  filter(country_name == "Vietnam") %>%
  dplyr::select(covid_govt_handling, covid_contracted, covid_trust_info) %>%
  filter(!is.na(covid_govt_handling), 
         !is.na(covid_contracted), 
         !is.na(covid_trust_info))

cor_matrix <- cor(vietnam_clean, use = "complete.obs")
print(round(cor_matrix, 3))

# Check for perfect collinearity
if(any(abs(cor_matrix[lower.tri(cor_matrix)]) > 0.99)) {
  cat("\n⚠ WARNING: Near-perfect correlation detected!\n")
  cat("This could cause problems in regression.\n")
}
```

# Recommended Fix

```{r show-fix}
cat("\n", rep("=", 70), "\n", sep = "")
cat("RECOMMENDED SOLUTION\n")
cat(rep("=", 70), "\n\n", sep = "")

cat("Based on diagnostics, use this function in Script 08:\n\n")

cat('
run_robust_regression <- function(country_data, country_name) {
  
  # Remove missing data very explicitly
  robust_data <- country_data %>%
    dplyr::select(covid_govt_handling, covid_contracted, covid_trust_info) %>%
    filter(!is.na(covid_govt_handling), 
           !is.na(covid_contracted), 
           !is.na(covid_trust_info)) %>%
    drop_na()  # Extra safety
  
  # Check sample size
  if(nrow(robust_data) < 30) {
    cat("  ⚠ Warning: Only", nrow(robust_data), "complete cases. Skipping.\\n\\n")
    return(NULL)
  }
  
  # OLS for comparison
  ols_model <- lm(covid_govt_handling ~ covid_contracted + covid_trust_info,
                  data = robust_data)
  
  # Robust regression with error handling
  robust_model <- tryCatch({
    rlm(covid_govt_handling ~ covid_contracted + covid_trust_info,
        data = robust_data,
        method = "MM",
        maxit = 100)
  }, error = function(e) {
    cat("  ⚠ MM method failed. Using M method...\\n")
    rlm(covid_govt_handling ~ covid_contracted + covid_trust_info,
        data = robust_data,
        method = "M")
  })
  
  # Extract coefficients
  ols_coef <- coef(ols_model)
  robust_coef <- coef(robust_model)
  
  # Create comparison
  comparison <- data.frame(
    Variable = names(ols_coef),
    OLS = ols_coef,
    Robust = robust_coef,
    Difference = ols_coef - robust_coef,
    Pct_Change = ((robust_coef - ols_coef) / ols_coef) * 100
  )
  
  cat("\\n", country_name, ":\\n\\n", sep = "")
  print(comparison)
  
  # Weights summary
  weights <- robust_model$w
  cat("\\n\\nOutlier Weights Summary:\\n")
  cat("  Min weight:", round(min(weights), 3), "\\n")
  cat("  Mean weight:", round(mean(weights), 3), "\\n")
  cat("  N observations downweighted (w < 0.95):", sum(weights < 0.95), "\\n")
  
  return(list(
    ols = ols_model,
    robust = robust_model,
    comparison = comparison
  ))
}
')

cat("\n\nThe script has been updated with this fix.\n")
```

# Session Info

```{r session}
sessionInfo()
```
