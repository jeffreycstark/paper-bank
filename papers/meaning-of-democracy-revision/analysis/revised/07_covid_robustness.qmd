---
title: "COVID Robustness Check â€” Wave 6"
author: "Jeffrey Stark"
date: today
format: html
execute:
  echo: true
  warning: false
  message: false
---

```{r setup}
library(tidyverse)
library(nnet)       # multinom
library(margins)
library(knitr)
library(kableExtra)
library(here)

here::i_am("papers/meaning-of-democracy/analysis/revised/07_covid_robustness.qmd")

# Load data
data_dir <- here("papers", "meaning-of-democracy", "analysis", "revised", "data")
results_dir <- here("papers", "meaning-of-democracy", "analysis", "revised", "results")

w346 <- readRDS(file.path(data_dir, "w346_main.rds"))
item_meta <- readRDS(file.path(data_dir, "item_metadata.rds"))

# Load master data for COVID variables
abs_master <- readRDS(here("data", "processed", "abs_econdev_authpref.rds"))
```

# Merge COVID variables into W6 analysis data

```{r merge-covid}
# Extract COVID variables from master data (Wave 6 only)
covid_vars <- abs_master %>%
  filter(wave == 6) %>%
  select(wave, country, row_id, covid_govt_handling, covid_trust_govt_info) %>%
  mutate(
    # Dichotomize: 1-2 = positive, 3-4 = negative
    covid_handling_neg = case_when(
      covid_govt_handling %in% c(3, 4) ~ 1L,
      covid_govt_handling %in% c(1, 2) ~ 0L,
      TRUE ~ NA_integer_
    ),
    covid_info_distrust = case_when(
      covid_trust_govt_info %in% c(3, 4) ~ 1L,
      covid_trust_govt_info %in% c(1, 2) ~ 0L,
      TRUE ~ NA_integer_
    )
  )

# Merge into W6 subset of analysis data
w6_analysis <- w346 %>% filter(wave == 6)

cat("W6 analysis rows:", nrow(w6_analysis), "\n")
cat("W6 analysis columns:\n")
cat(paste(names(w6_analysis), collapse = ", "), "\n")

# Try to merge on country + wave + row_id if available
if ("row_id" %in% names(w6_analysis)) {
  w6_covid <- w6_analysis %>%
    left_join(covid_vars, by = c("wave", "country" = "country", "row_id"))
} else {
  # If no row_id, try idnumber or other identifier
  cat("\nAvailable ID columns in w346:\n")
  cat(paste(grep("id|row|resp", names(w6_analysis), value = TRUE, ignore.case = TRUE), collapse = ", "), "\n")

  # Alternative approach: re-extract W6 voters from master with COVID vars
  country_codes <- sort(unique(w6_analysis$country))

  w6_covid <- abs_master %>%
    filter(
      wave == 6,
      country %in% country_codes,
      electoral_status %in% c(1, 2)
    ) %>%
    mutate(
      loser = as.integer(electoral_status == 2),
      covid_handling_neg = case_when(
        covid_govt_handling %in% c(3, 4) ~ 1L,
        covid_govt_handling %in% c(1, 2) ~ 0L,
        TRUE ~ NA_integer_
      ),
      covid_info_distrust = case_when(
        covid_trust_govt_info %in% c(3, 4) ~ 1L,
        covid_trust_govt_info %in% c(1, 2) ~ 0L,
        TRUE ~ NA_integer_
      )
    )
}

cat("\nW6 with COVID data:", nrow(w6_covid), "\n")
cat("Valid covid_handling_neg:", sum(!is.na(w6_covid$covid_handling_neg)), "\n")
cat("Valid covid_info_distrust:", sum(!is.na(w6_covid$covid_info_distrust)), "\n")
```

# COVID variable descriptives

```{r covid-descriptives}
# Distribution by winner/loser
w6_covid %>%
  filter(!is.na(covid_handling_neg)) %>%
  group_by(loser) %>%
  summarise(
    n = n(),
    pct_neg_handling = mean(covid_handling_neg, na.rm = TRUE) * 100,
    pct_distrust_info = mean(covid_info_distrust, na.rm = TRUE) * 100,
    .groups = "drop"
  ) %>%
  mutate(status = if_else(loser == 0, "Winner", "Loser")) %>%
  select(status, n, pct_neg_handling, pct_distrust_info) %>%
  kable(digits = 1, col.names = c("Status", "N", "% Neg Handling", "% Distrust Info"))
```

# Estimate multinomial models with and without COVID controls

```{r estimate-models}
# Function to estimate multinomial logit and extract AMEs for one set
estimate_set_ames <- function(data, set_num, controls = "base") {

  choice_var <- paste0("dem_meaning_set", set_num)

  # Check if the variable exists, try alternatives
  if (!choice_var %in% names(data)) {
    choice_var_alt <- paste0("set", set_num, "_choice")
    if (choice_var_alt %in% names(data)) {
      choice_var <- choice_var_alt
    } else {
      warning(paste("Cannot find choice variable for set", set_num))
      return(NULL)
    }
  }

  # Prepare data
  model_data <- data %>%
    filter(!is.na(.data[[choice_var]]),
           !is.na(loser),
           !is.na(age), !is.na(gender), !is.na(education_level), !is.na(urban_rural))

  if (controls == "covid") {
    model_data <- model_data %>%
      filter(!is.na(covid_handling_neg), !is.na(covid_info_distrust))
  }

  if (nrow(model_data) < 100) {
    warning(paste("Too few observations for set", set_num))
    return(NULL)
  }

  # Set up formula
  base_formula <- as.formula(paste0(
    choice_var, " ~ loser + age + gender + education_level + urban_rural + factor(country)"
  ))

  covid_formula <- as.formula(paste0(
    choice_var, " ~ loser + age + gender + education_level + urban_rural + ",
    "covid_handling_neg + covid_info_distrust + factor(country)"
  ))

  formula_to_use <- if (controls == "covid") covid_formula else base_formula

  # Estimate
  tryCatch({
    mod <- multinom(formula_to_use, data = model_data, trace = FALSE)

    # Compute AMEs for loser variable via prediction
    d0 <- d1 <- model_data
    d0$loser <- 0
    d1$loser <- 1

    pred0 <- predict(mod, newdata = d0, type = "probs")
    pred1 <- predict(mod, newdata = d1, type = "probs")

    if (is.null(dim(pred0))) return(NULL)

    ames <- colMeans(pred1 - pred0)

    tibble(
      set = paste0("Set", set_num),
      choice = names(ames),
      ame = ames,
      controls = controls,
      n = nrow(model_data)
    )
  }, error = function(e) {
    warning(paste("Error in set", set_num, ":", e$message))
    return(NULL)
  })
}

# Run for all 4 sets, with and without COVID controls
results_base <- map_dfr(1:4, ~estimate_set_ames(w6_covid, .x, "base"))
results_covid <- map_dfr(1:4, ~estimate_set_ames(w6_covid, .x, "covid"))

all_results <- bind_rows(results_base, results_covid)

cat("Base model results:", nrow(results_base), "rows\n")
cat("COVID model results:", nrow(results_covid), "rows\n")
```

# Compare results

```{r compare-results}
if (nrow(all_results) > 0) {
  comparison <- all_results %>%
    pivot_wider(names_from = controls, values_from = c(ame, n), names_sep = "_") %>%
    mutate(
      diff = ame_covid - ame_base,
      ame_base_pp = sprintf("%+.1f", ame_base * 100),
      ame_covid_pp = sprintf("%+.1f", ame_covid * 100),
      diff_pp = sprintf("%+.2f", diff * 100)
    )

  comparison %>%
    select(set, choice, ame_base_pp, ame_covid_pp, diff_pp) %>%
    kable(col.names = c("Set", "Item", "Base AME (pp)", "COVID AME (pp)", "Difference (pp)"),
          align = c("l", "l", "r", "r", "r"))
}
```

# Summary statistics for manuscript text

```{r summary-stats}
if (nrow(all_results) > 0) {
  cat("\n=== Summary for manuscript paragraph ===\n")
  cat("Fill in the X.X placeholders in the revision guide with these values:\n\n")

  # NOTE: You'll need to tag items by type (procedural/substantive/governance)
  # using item_meta to compute mean procedural and substantive AMEs.
  # The choice values (1,2,3,4) correspond to specific items per set.

  print(comparison %>% select(set, choice, ame_base_pp, ame_covid_pp, diff_pp))
}
```

# Thailand-specific check

```{r thailand-check}
thai_w6 <- w6_covid %>% filter(country == 8)  # Thailand = country code 8

cat("Thailand W6 voters:", nrow(thai_w6), "\n")
cat("With COVID data:", sum(!is.na(thai_w6$covid_handling_neg)), "\n")

# If enough observations, estimate Thailand-specific models
if (nrow(thai_w6) > 50) {
  thai_base <- map_dfr(1:4, ~estimate_set_ames(thai_w6, .x, "base"))
  thai_covid <- map_dfr(1:4, ~estimate_set_ames(thai_w6, .x, "covid"))

  if (nrow(thai_base) > 0 & nrow(thai_covid) > 0) {
    thai_comp <- bind_rows(
      thai_base %>% mutate(model = "Base"),
      thai_covid %>% mutate(model = "COVID controls")
    )

    thai_comp %>%
      mutate(ame_pp = sprintf("%+.1f", ame * 100)) %>%
      select(set, choice, model, ame_pp) %>%
      pivot_wider(names_from = model, values_from = ame_pp) %>%
      kable(col.names = c("Set", "Item", "Base", "COVID Controls"))
  } else {
    cat("Thailand sample too small for separate estimation (n =", nrow(thai_w6), ")\n")
    cat("Report in manuscript as: Thailand's small Wave 6 sample precludes\n")
    cat("separate estimation with COVID controls.\n")
  }
}
```

# Save results

```{r save}
if (nrow(all_results) > 0) {
  write_csv(all_results, file.path(results_dir, "robustness_covid_controls.csv"))
  cat("Results saved to:", file.path(results_dir, "robustness_covid_controls.csv"), "\n")
}
```
