---
title: "Vote Choice: Winner/Key Opposition/Other Coding"
author: "ABS Analysis"
date: today
format:
  html:
    toc: true
    code-fold: true
execute:
  warning: false
  message: false
---

```{r setup}
library(haven)
library(dplyr)
library(tidyr)
library(ggplot2)
library(knitr)
library(here)

here::i_am("papers/meaning-of-democracy/analysis/06_party_winner_loser.qmd")
proj_root <- here::here()
```

## Overview

This document creates `voted_winner_keyopposition_other` by matching **vote choice**
(which party did you vote for) to historical election results.

**Output variable**: `voted_winner_keyopposition_other`

- 1 = **Winner** (voted for party/coalition that won the election)
- 2 = **Key Opposition** (voted for main opposition party/coalition)
- 3 = **Other** (voted for minor parties, independents, etc.)

**Vote choice variables by wave:**

| Wave | Variable | Question |
|------|----------|----------|
| W2   | q39      | Which parties (or candidates) did you vote for? |
| W3   | q33      | Which parties (or candidates) did you vote for? |
| W4   | q34      | Which parties or candidates did you vote for? |
| W5   | q34      | Which parties or candidates did you vote for? |
| W6   | Q34      | Which parties or candidates did you vote for? |

**Countries currently coded:** Taiwan, South Korea, Thailand

To add a new country, update:
1. `election_winners` table (which coalition won each election)
2. `party_crosswalk` (party codes → coalition mapping)

## Election Context

```{r election-context}
# Define which coalition won each election by country and wave
# key_opposition = main opposition coalition
election_winners <- tribble(
  ~country, ~wave, ~winning_coalition, ~key_opposition, ~election_date, ~winner_party, ~notes,

 # Taiwan - Presidential elections
  "Taiwan", "W2", "pan_green", "pan_blue", "2004-03", "DPP (Chen Shui-bian)", "50.1% vs 49.9%",
  "Taiwan", "W3", "pan_blue", "pan_green", "2008-03", "KMT (Ma Ying-jeou)", "58.4% vs 41.6%",
  "Taiwan", "W4", "pan_blue", "pan_green", "2012-01", "KMT (Ma Ying-jeou)", "51.6% vs 45.6%",
  "Taiwan", "W5", "pan_green", "pan_blue", "2016-01", "DPP (Tsai Ing-wen)", "56.1% vs 31.0%",
  "Taiwan", "W6", "pan_green", "pan_blue", "2020-01", "DPP (Tsai Ing-wen)", "57.1% vs 38.6%",

  # South Korea - Presidential elections
  "Korea", "W3", "conservative", "progressive", "2007-12", "GNP (Lee Myung-bak)", "48.7% vs 26.1%",
  "Korea", "W4", "conservative", "progressive", "2012-12", "Saenuri (Park Geun-hye)", "51.6% vs 48.0%",
  "Korea", "W5", "progressive", "conservative", "2017-05", "Democratic (Moon Jae-in)", "41.1% plurality",
  "Korea", "W6", "conservative", "progressive", "2022-03", "PPP (Yoon Suk Yeol)", "48.6% vs 47.8%",

  # Thailand - Parliamentary elections
  "Thailand", "W3", "pro_thaksin", "anti_thaksin", "2007-12", "PPP", "233/480 seats",
  "Thailand", "W4", NA, NA, NA, NA, "NO VALID ELECTION - May 2014 coup",
  "Thailand", "W5", "pro_thaksin", "anti_thaksin", "2011-07", "Pheu Thai", "265/500 seats",
  "Thailand", "W6", "pro_military", "pro_thaksin", "2019-03", "PPRP", "Military govt formed"
)

kable(election_winners %>% select(-notes), caption = "Election Winners by Country and Wave")
```

## Detailed Election Results

```{r election-results-detail}
#| code-fold: true
#| code-summary: "Show detailed election results data"

# THAILAND ELECTIONS
thailand_2007 <- tribble(
  ~country, ~election_date, ~abs_wave, ~party_name, ~seats, ~ruling_coalition,
  "Thailand", "2007-12-23", "W3", "People's Power Party", 233, TRUE,
  "Thailand", "2007-12-23", "W3", "Democrat Party", 164, FALSE,
  "Thailand", "2007-12-23", "W3", "Thai Nation Party", 34, TRUE,
  "Thailand", "2007-12-23", "W3", "For the Motherland Party", 24, TRUE
)

thailand_2011 <- tribble(
  ~country, ~election_date, ~abs_wave, ~party_name, ~seats, ~ruling_coalition,
  "Thailand", "2011-07-03", "W4", "Pheu Thai Party", 265, TRUE,
  "Thailand", "2011-07-03", "W4", "Democrat Party", 159, FALSE,
  "Thailand", "2011-07-03", "W4", "Bhumjaithai Party", 34, TRUE,
  "Thailand", "2011-07-03", "W4", "Chartthaipattana Party", 19, TRUE
)

thailand_2019 <- tribble(
  ~country, ~election_date, ~abs_wave, ~party_name, ~seats, ~ruling_coalition,
  "Thailand", "2019-03-24", "W6", "Palang Pracharath Party", 116, TRUE,
  "Thailand", "2019-03-24", "W6", "Pheu Thai Party", 136, FALSE,
  "Thailand", "2019-03-24", "W6", "Future Forward Party", 81, FALSE,
  "Thailand", "2019-03-24", "W6", "Democrat Party", 52, TRUE,
  "Thailand", "2019-03-24", "W6", "Bhumjaithai Party", 51, TRUE
)

# SOUTH KOREA ELECTIONS
korea_2008 <- tribble(
  ~country, ~election_date, ~abs_wave, ~party_name, ~seats, ~ruling_coalition,
  "South Korea", "2008-04-09", "W3", "Grand National Party", 153, TRUE,
  "South Korea", "2008-04-09", "W3", "United Democratic Party", 81, FALSE,
  "South Korea", "2008-04-09", "W3", "Pro-Park Coalition", 14, TRUE,
  "South Korea", "2008-04-09", "W3", "Liberty Forward Party", 18, FALSE
)

korea_2012 <- tribble(
  ~country, ~election_date, ~abs_wave, ~party_name, ~seats, ~ruling_coalition,
  "South Korea", "2012-04-11", "W4", "Saenuri Party", 152, TRUE,
  "South Korea", "2012-04-11", "W4", "Democratic United Party", 127, FALSE,
  "South Korea", "2012-04-11", "W4", "Unified Progressive Party", 13, FALSE
)

korea_2020 <- tribble(
  ~country, ~election_date, ~abs_wave, ~party_name, ~seats, ~ruling_coalition,
  "South Korea", "2020-04-15", "W6", "Democratic Party of Korea", 180, TRUE,
  "South Korea", "2020-04-15", "W6", "United Future Party", 103, FALSE,
  "South Korea", "2020-04-15", "W6", "Justice Party", 6, FALSE
)

# TAIWAN ELECTIONS
taiwan_2004 <- tribble(
  ~country, ~election_date, ~abs_wave, ~party_name, ~seats, ~ruling_coalition,
  "Taiwan", "2004-12-11", "W2", "Democratic Progressive Party", 89, TRUE,
  "Taiwan", "2004-12-11", "W2", "Kuomintang", 79, FALSE,
  "Taiwan", "2004-12-11", "W2", "People First Party", 34, FALSE,
  "Taiwan", "2004-12-11", "W2", "Taiwan Solidarity Union", 12, TRUE
)

taiwan_2008 <- tribble(
  ~country, ~election_date, ~abs_wave, ~party_name, ~seats, ~ruling_coalition,
  "Taiwan", "2008-01-12", "W3", "Kuomintang", 81, TRUE,
  "Taiwan", "2008-01-12", "W3", "Democratic Progressive Party", 27, FALSE,
  "Taiwan", "2008-01-12", "W3", "Non-Partisan Solidarity Union", 3, FALSE
)

taiwan_2016 <- tribble(
  ~country, ~election_date, ~abs_wave, ~party_name, ~seats, ~ruling_coalition,
  "Taiwan", "2016-01-16", "W4", "Democratic Progressive Party", 68, TRUE,
  "Taiwan", "2016-01-16", "W4", "Kuomintang", 35, FALSE,
  "Taiwan", "2016-01-16", "W4", "New Power Party", 5, FALSE
)

cat("Detailed election results loaded for Thailand, Korea, Taiwan\n")
```

## Party Crosswalk

**IMPORTANT**: Party codes change meaning across waves, especially in South Korea where the
same code (e.g., 301) can represent progressive parties in some waves and conservative
parties in others due to party reorganizations.

```{r party-crosswalk}
# Create party crosswalk table
# NOTE: Same code can mean different parties across waves!
party_crosswalk <- tribble(
  ~country, ~code, ~wave, ~party_name, ~party_lineage, ~coalition,

  # TAIWAN - Codes are mostly stable
  # Pan-Blue coalition
  "Taiwan", 701, "W2", "KMT", "KMT", "pan_blue",
  "Taiwan", 701, "W3", "KMT", "KMT", "pan_blue",
 "Taiwan", 701, "W4", "KMT", "KMT", "pan_blue",
  "Taiwan", 701, "W5", "Kuomintang (KMT)", "KMT", "pan_blue",
  "Taiwan", 701, "W6", "Kuomintang (KMT)", "KMT", "pan_blue",

  "Taiwan", 703, "W2", "New Party", "New Party", "pan_blue",
  "Taiwan", 703, "W3", "New Party", "New Party", "pan_blue",
  "Taiwan", 703, "W4", "New Party", "New Party", "pan_blue",
  "Taiwan", 703, "W5", "New Party", "New Party", "pan_blue",
  "Taiwan", 703, "W6", "New Party", "New Party", "pan_blue",

  "Taiwan", 704, "W2", "PFP", "People First Party", "pan_blue",
  "Taiwan", 704, "W3", "People First Party", "People First Party", "pan_blue",
  "Taiwan", 704, "W4", "People First Party", "People First Party", "pan_blue",
  "Taiwan", 704, "W5", "People First Party", "People First Party", "pan_blue",
  "Taiwan", 704, "W6", "People First Party", "People First Party", "pan_blue",

  # Pan-Green coalition
  "Taiwan", 702, "W2", "DPP", "DPP", "pan_green",
  "Taiwan", 702, "W3", "DPP", "DPP", "pan_green",
  "Taiwan", 702, "W4", "DPP", "DPP", "pan_green",
  "Taiwan", 702, "W5", "Democratic Progressive Party (DPP)", "DPP", "pan_green",
  "Taiwan", 702, "W6", "Democratic Progressive Party (DPP)", "DPP", "pan_green",

  "Taiwan", 705, "W2", "TSU", "Taiwan Solidarity Union", "pan_green",
  "Taiwan", 705, "W3", "Taiwan Solidarity Union", "Taiwan Solidarity Union", "pan_green",
  "Taiwan", 705, "W4", "Taiwan Solidarity Union", "Taiwan Solidarity Union", "pan_green",
  "Taiwan", 705, "W5", "Taiwan Solidarity Union", "Taiwan Solidarity Union", "pan_green",
  "Taiwan", 705, "W6", "Taiwan Solidarity Union", "Taiwan Solidarity Union", "pan_green",

  # Code 706 changes meaning across waves
  "Taiwan", 706, "W2", "Other", NA, "other",
  "Taiwan", 706, "W3", "Other", NA, "other",
  "Taiwan", 706, "W4", "Green Party", "Green Party", "pan_green",
  "Taiwan", 706, "W5", "New Power Party", "New Power Party", "pan_green",
  "Taiwan", 706, "W6", "New Power Party", "New Power Party", "pan_green",

  # Code 707 changes meaning
  "Taiwan", 707, "W4", "Civic Party", "Civic Party", "other",
  "Taiwan", 707, "W6", "Taiwan Peoples Party (TPP)", "TPP", "neutral",

  "Taiwan", 708, "W6", "Taiwan Radical Wings", "Taiwan Radical Wings", "other",
  "Taiwan", 709, "W6", "Others", NA, "other",
  "Taiwan", 799, "W5", "Others", NA, "other",

  # SOUTH KOREA - Codes change meaning significantly!
  # Code 301 - changes between progressive and conservative!
  "Korea", 301, "W2", "Uri Party", "Uri/Democratic lineage", "progressive",
  "Korea", 301, "W3", "Uri Party", "Uri/Democratic lineage", "progressive",
  "Korea", 301, "W4", "Saenuri Party", "Grand National/Saenuri lineage", "conservative",
  "Korea", 301, "W5", "Democratic Party of Korea", "Uri/Democratic lineage", "progressive",
  "Korea", 301, "W6", "Democratic Party", "Uri/Democratic lineage", "progressive",

  # Code 302 - also changes!
  "Korea", 302, "W2", "Grand National Party", "Grand National/Saenuri lineage", "conservative",
  "Korea", 302, "W3", "Grand National Party", "Grand National/Saenuri lineage", "conservative",
  "Korea", 302, "W4", "New Politics Alliance for Democracy", "Uri/Democratic lineage", "progressive",
  "Korea", 302, "W5", "Liberty Korea Party", "Grand National/Saenuri lineage", "conservative",
  "Korea", 302, "W6", "People Power Party", "Grand National/Saenuri lineage", "conservative",

  # Code 303
  "Korea", 303, "W2", "Democratic Party", "Minor progressive", "progressive",
  "Korea", 303, "W3", "Democratic Party", "Minor progressive", "progressive",
  "Korea", 303, "W4", "Justice Party", "Justice Party", "progressive",
  "Korea", 303, "W5", "BAREUNMARAE Party", "Centrist split", "conservative",
  "Korea", 303, "W6", "Justice Party", "Justice Party", "progressive",

  # Code 304
  "Korea", 304, "W2", "Democratic Labor Party", "Labor/Justice lineage", "progressive",
  "Korea", 304, "W3", "Democratic Labor Party", "Labor/Justice lineage", "progressive",
  "Korea", 304, "W5", "Party for Democracy and Peace", "Minor progressive", "progressive",

  # Code 305
  "Korea", 305, "W2", "People First Party", "People First Party", "conservative",
  "Korea", 305, "W3", "People First Party", "People First Party", "conservative",
  "Korea", 305, "W5", "Justice Party", "Justice Party", "progressive",

  "Korea", 306, "W2", "Other Parties", NA, "other",
  "Korea", 306, "W3", "Other Parties", NA, "other",
  "Korea", 306, "W5", "ETC", NA, "other",

  "Korea", 307, "W3", "Liberty Forward Party", "Liberty Forward Party", "conservative",
  "Korea", 308, "W3", "Future hope solidarity", "Minor", "other",
  "Korea", 309, "W3", "Creative Korea Party", "Minor", "other",
  "Korea", 310, "W3", "New Progressive Party", "Labor/Justice lineage", "progressive",
  "Korea", 311, "W3", "Peoples Participation Party", "Minor progressive", "progressive",

  # THAILAND - Major changes due to coups/dissolutions
  # Code 801 - Democrat Party is stable
  "Thailand", 801, "W2", "Prajadhipat", "Democrat Party", "anti_thaksin",
  "Thailand", 801, "W3", "Prajadhipat", "Democrat Party", "anti_thaksin",
  "Thailand", 801, "W4", "Democrat Party", "Democrat Party", "anti_thaksin",
  "Thailand", 801, "W5", "Democrat Party", "Democrat Party", "anti_thaksin",
  "Thailand", 801, "W6", "Democrat Party", "Democrat Party", "anti_thaksin",

  # Code 802 - Pro-Thaksin lineage (conceptually stable despite party dissolutions)
  "Thailand", 802, "W2", "Thai Rak Thai", "Pro-Thaksin", "pro_thaksin",
  "Thailand", 802, "W3", "Thai Rak Thai", "Pro-Thaksin", "pro_thaksin",
  "Thailand", 802, "W4", "Pheu Thai Party", "Pro-Thaksin", "pro_thaksin",
  "Thailand", 802, "W5", "Pheu Thai Party", "Pro-Thaksin", "pro_thaksin",
  "Thailand", 802, "W6", "Pheu Thai Party", "Pro-Thaksin", "pro_thaksin",

  # Code 803 - Changes significantly
  "Thailand", 803, "W2", "Chart Thai", "Chart Thai", "other",
  "Thailand", 803, "W3", "Chart Thai", "Chart Thai", "other",
  "Thailand", 803, "W4", "Phumjai Thai Party", "Bhumjaithai", "other",
  "Thailand", 803, "W5", "Pracharat Party", "Pro-Military", "pro_military",
  "Thailand", 803, "W6", "Palang Pracharath Party", "Pro-Military", "pro_military",

  # Code 804 - Changes significantly
  "Thailand", 804, "W2", "Mahachon", "Mahachon", "other",
  "Thailand", 804, "W3", "Mahachon", "Mahachon", "other",
  "Thailand", 804, "W4", "Chart Thai Pattana", "Chart Thai Pattana", "other",
  "Thailand", 804, "W5", "Future Forward Party", "Progressive opposition", "progressive",
  "Thailand", 804, "W6", "Move Forward Party", "Progressive opposition", "progressive",

  # Code 805
  "Thailand", 805, "W2", "Other Party", NA, "other",
  "Thailand", 805, "W3", "Other Party", NA, "other",
  "Thailand", 805, "W4", "Pheu Pandin Party", "Pheu Pandin", "pro_thaksin",
  "Thailand", 805, "W5", "Bhumjaithai Party", "Bhumjaithai", "other",
  "Thailand", 805, "W6", "Chartthaipattana Party", "Chart Thai Pattana", "other",

  # Code 806
  "Thailand", 806, "W3", "Pheu Thai", "Pro-Thaksin", "pro_thaksin",
  "Thailand", 806, "W5", "Puea Pandin Party", "Pheu Pandin", "other",
  "Thailand", 806, "W6", "Thai Liberal Party", "Thai Liberal Party", "other",

  # Code 807-809 (W3 only)
  "Thailand", 807, "W3", "Bhumjai Thai", "Bhumjaithai", "other",
  "Thailand", 808, "W3", "Chart Thai Pattana", "Chart Thai Pattana", "other",
  "Thailand", 809, "W3", "Pua Paendin", "Pheu Pandin", "other",

  "Thailand", 899, "W5", "Others", NA, "other"
)

cat("Party crosswalk created:", nrow(party_crosswalk), "mappings\n\n")

# Show Korea example (code 301 changes meaning!)
cat("Example: Korea code 301 changes meaning across waves:\n")
party_crosswalk %>%
  filter(country == "Korea", code == 301) %>%
  select(wave, party_name, coalition) %>%
  kable()
```

## Load Raw Data and Extract Vote Choice

```{r load-data}
# Country codes
country_codes <- c(Taiwan = 7, Korea = 3, Thailand = 8)
target_countries <- unname(country_codes)

# Function to extract vote choice with respondent ID
extract_vote_choice <- function(data, wave, vote_var, id_var = "id",
                                 country_var = "country") {

  # Handle variable name case sensitivity
  names_lower <- tolower(names(data))

  # Find vote variable
  vote_col <- if (vote_var %in% names(data)) {
    vote_var
  } else if (toupper(vote_var) %in% names(data)) {
    toupper(vote_var)
  } else {
    warning(paste("Vote variable", vote_var, "not found in", wave))
    return(NULL)
  }

  # Find ID variable (try common names)
  id_candidates <- c("id", "ID", "caseid", "CASEID", "respid", "RESPID", "idnumber")
  id_col <- NULL
  for (candidate in id_candidates) {
    if (candidate %in% names(data)) {
      id_col <- candidate
      break
    }
  }
  if (is.null(id_col)) {
    # Create row number as ID
    data$row_id <- seq_len(nrow(data))
    id_col <- "row_id"
  }

  # Find country variable
  country_col <- if (country_var %in% names(data)) {
    country_var
  } else if (toupper(country_var) %in% names(data)) {
    toupper(country_var)
  } else if ("COUNTRY" %in% names(data)) {
    "COUNTRY"
  } else {
    warning(paste("Country variable not found in", wave))
    return(NULL)
  }

  result <- data %>%
    filter(.data[[country_col]] %in% target_countries) %>%
    transmute(
      wave = wave,
      country = as.numeric(.data[[country_col]]),
      country_name = case_when(
        country == 7 ~ "Taiwan",
        country == 3 ~ "Korea",
        country == 8 ~ "Thailand",
        TRUE ~ NA_character_
      ),
      respondent_id = as.character(.data[[id_col]]),
      vote_choice_raw = as.numeric(.data[[vote_col]])
    )

  return(result)
}

# Load merged wave files
w2 <- read_sav(file.path(proj_root, "data/raw/wave2/Wave2_20250609.sav"))
w3 <- read_sav(file.path(proj_root, "data/raw/wave3/ABS3 merge20250609.sav"))
w4 <- read_sav(file.path(proj_root, "data/raw/wave4/W4_v15_merged20250609_release.sav"))
w5 <- read_sav(file.path(proj_root, "data/raw/wave5/20230505_W5_merge_15.sav"))

# W6 country-specific files
w6_taiwan <- read_sav(file.path(proj_root, "data/raw/wave6/W6_Taiwan_EN_20240402.sav"))
w6_korea <- read_sav(file.path(proj_root, "data/raw/wave6/W6_Korea_Release_20241220.sav"))
w6_thailand <- read_sav(file.path(proj_root, "data/raw/wave6/W6_8_Thailand_Release_20250108.sav"))
```

```{r extract-vote-choice}
# Extract vote choice from each wave
vote_w2 <- extract_vote_choice(w2, "W2", "q39")
vote_w3 <- extract_vote_choice(w3, "W3", "q33")
vote_w4 <- extract_vote_choice(w4, "W4", "q34")
vote_w5 <- extract_vote_choice(w5, "W5", "q34")

# W6: Handle separately by country
vote_w6_taiwan <- w6_taiwan %>%
  mutate(row_id = row_number()) %>%
  transmute(
    wave = "W6",
    country = 7L,
    country_name = "Taiwan",
    respondent_id = as.character(row_id),
    vote_choice_raw = as.numeric(Q34)
  )

vote_w6_korea <- w6_korea %>%
  mutate(row_id = row_number()) %>%
  transmute(
    wave = "W6",
    country = 3L,
    country_name = "Korea",
    respondent_id = as.character(row_id),
    vote_choice_raw = as.numeric(q34)
  )

vote_w6_thailand <- w6_thailand %>%
  mutate(row_id = row_number()) %>%
  transmute(
    wave = "W6",
    country = 8L,
    country_name = "Thailand",
    respondent_id = as.character(row_id),
    vote_choice_raw = as.numeric(q34)
  )

vote_w6 <- bind_rows(vote_w6_taiwan, vote_w6_korea, vote_w6_thailand)

# Combine all waves
vote_all <- bind_rows(vote_w2, vote_w3, vote_w4, vote_w5, vote_w6)

cat("Total vote choice observations:", nrow(vote_all), "\n")
cat("\nBy wave and country:\n")
vote_all %>%
  count(wave, country_name) %>%
  pivot_wider(names_from = wave, values_from = n, values_fill = 0) %>%
  kable()
```

## Match Vote Choice to Coalition

```{r match-coalition}
# Join with crosswalk to get coalition membership
vote_coded <- vote_all %>%
  left_join(
    party_crosswalk %>%
      select(country, code, wave, party_name, coalition),
    by = c("country_name" = "country", "vote_choice_raw" = "code", "wave" = "wave")
  )

# Check match rates
cat("\nMatch rate by country and wave:\n")
vote_coded %>%
  filter(!is.na(vote_choice_raw), vote_choice_raw > 0, vote_choice_raw < 90) %>%
  group_by(country_name, wave) %>%
  summarise(
    n = n(),
    matched = sum(!is.na(coalition)),
    match_pct = round(100 * matched / n, 1),
    .groups = "drop"
  ) %>%
  kable()
```

## Create Winner/Key Opposition/Other Variable

```{r create-variable}
# Join with election winners and create the 3-category variable
vote_final <- vote_coded %>%
  left_join(
    election_winners %>% select(country, wave, winning_coalition, key_opposition),
    by = c("country_name" = "country", "wave")
  ) %>%
  mutate(
    # Create 3-category variable
    voted_winner_keyopposition_other = case_when(
      # Missing/invalid vote choice
      is.na(vote_choice_raw) | vote_choice_raw < 0 ~ NA_integer_,
      vote_choice_raw %in% c(90, 97, 98, 99) ~ NA_integer_,  # Specific missing codes

      # No valid election (Thailand W4)
      is.na(winning_coalition) ~ NA_integer_,

      # Unmatched party codes
      is.na(coalition) ~ 3L,  # Treat as "other"

      # Winner: voted for winning coalition
      coalition == winning_coalition ~ 1L,

      # Key Opposition: voted for main opposition coalition
      coalition == key_opposition ~ 2L,

      # Other: minor parties, independents, neutral
      TRUE ~ 3L
    ),

    # Labels for display
    vote_status = case_when(
      voted_winner_keyopposition_other == 1 ~ "Winner",
      voted_winner_keyopposition_other == 2 ~ "Key Opposition",
      voted_winner_keyopposition_other == 3 ~ "Other",
      TRUE ~ NA_character_
    )
  )

cat("=== voted_winner_keyopposition_other distribution ===\n")
vote_final %>%
  filter(!is.na(voted_winner_keyopposition_other)) %>%
  count(vote_status) %>%
  mutate(pct = round(100 * n / sum(n), 1)) %>%
  kable()
```

## Summary by Country and Wave

```{r summary}
cat("\n=== Distribution by Country and Wave ===\n")
summary_table <- vote_final %>%
  filter(!is.na(voted_winner_keyopposition_other)) %>%
  count(country_name, wave, vote_status) %>%
  group_by(country_name, wave) %>%
  mutate(pct = round(100 * n / sum(n), 1)) %>%
  ungroup()

summary_table %>%
  select(-pct) %>%
  pivot_wider(names_from = vote_status, values_from = n, values_fill = 0) %>%
  kable(caption = "Vote Status Counts by Country and Wave")
```

```{r visualize}
#| fig-width: 10
#| fig-height: 6

vote_final %>%
  filter(!is.na(vote_status)) %>%
  count(country_name, wave, vote_status) %>%
  group_by(country_name, wave) %>%
  mutate(pct = 100 * n / sum(n)) %>%
  ungroup() %>%
  ggplot(aes(x = wave, y = pct, fill = vote_status)) +
  geom_col(position = "stack") +
  facet_wrap(~country_name) +
  scale_fill_manual(
    values = c(
      "Winner" = "#2E7D32",
      "Key Opposition" = "#C62828",
      "Other" = "#757575"
    )
  ) +
  labs(
    title = "Vote Choice: Winner vs Key Opposition vs Other",
    subtitle = "Based on most recent election prior to survey",
    x = "Wave",
    y = "Percentage",
    fill = "Vote Status"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

## Thailand W4 Note

```{r thailand-note}
#| echo: false
cat("
IMPORTANT: Thailand W4 (Aug-Oct 2014)

Thailand W4 was surveyed during/after the May 2014 military coup.
- The February 2014 election was annulled by the Constitutional Court
- No valid prior election to use for winner/loser coding
- These respondents are coded as NA

Recommendation: Exclude Thailand W4 from winner/loser analysis.
")
```

## Save Output for Merging

```{r save}
# Create output dataset for merging with main harmonized data
# Key: wave + country + position in original data

output_data <- vote_final %>%
  select(
    wave,
    country,
    country_name,
    respondent_id,
    vote_choice_raw,
    party_name,
    coalition,
    winning_coalition,
    key_opposition,
    voted_winner_keyopposition_other,
    vote_status
  )

# Save to analysis data folder
output_dir <- here("papers", "meaning-of-democracy", "analysis", "data")
if (!dir.exists(output_dir)) dir.create(output_dir, recursive = TRUE)

saveRDS(output_data, file.path(output_dir, "vote_winner_opposition.rds"))
write.csv(output_data, file.path(output_dir, "vote_winner_opposition.csv"), row.names = FALSE)

cat("\n=== SAVED ===\n")
cat("File:", file.path(output_dir, "vote_winner_opposition.rds"), "\n")
cat("Rows:", nrow(output_data), "\n")
cat("Columns:", paste(names(output_data), collapse = ", "), "\n")
```

## Merging with Main Dataset

To merge this with the main harmonized dataset, you'll need to match on wave + country + row position.

```{r merge-instructions}
#| eval: false

# Example merge code (adjust as needed based on ID matching)
d <- readRDS("data/processed/abs_econdev_authpref.rds")

# The vote_winner_opposition data needs to be matched by wave, country, and position
# This requires careful alignment since we're using row numbers as IDs

# For Taiwan, Korea, Thailand in waves W2-W6:
vote_data <- readRDS("papers/meaning-of-democracy/analysis/data/vote_winner_opposition.rds")

# Merge (requires row-position matching logic)
# d <- d %>%
#   left_join(vote_data %>% select(wave, country, respondent_id, voted_winner_keyopposition_other),
#             by = c("wave", "country", "idnumber" = "respondent_id"))
```

## Codebook

| Variable | Values | Description |
|----------|--------|-------------|
| `voted_winner_keyopposition_other` | 1, 2, 3 | Vote choice status |
| | 1 = Winner | Voted for winning coalition |
| | 2 = Key Opposition | Voted for main opposition |
| | 3 = Other | Minor parties, independents |
| `vote_status` | Text | Label version of above |
| `vote_choice_raw` | Numeric | Original party code from ABS |
| `coalition` | Text | Coalition membership |
| `winning_coalition` | Text | Which coalition won that election |
| `key_opposition` | Text | Main opposition coalition |

## Adding New Countries

To add a new country (e.g., Japan, Philippines):

1. **Add to `election_winners` table:**
```r
"Japan", "W3", "ldp", "dpj", "2009-08", "DPJ (Hatoyama)", "Historic opposition win",
"Japan", "W4", "ldp", "dpj", "2012-12", "LDP (Abe)", "LDP returns to power",
# etc.
```

2. **Add to `party_id_crosswalk.rds`:**
   - Map party codes (101=LDP, 102=DPJ, etc.) to coalitions

3. **Update `country_codes` in this script:**
```r
country_codes <- c(Taiwan = 7, Korea = 3, Thailand = 8, Japan = 1, Philippines = 6)
```

4. **Re-run this script** to generate updated output

## Notes on Party Alliances

```{r alliance-notes}
#| echo: false
cat("
TAIWAN:
- Pan-Green coalition: DPP + TSU + New Power Party (independence-leaning)
- Pan-Blue coalition: KMT + PFP + New Party (unification-leaning)
- Taiwan Peoples Party (TPP): Neutral/centrist (Ko Wen-je's party, W6 only)

SOUTH KOREA:
- Progressive camp: Democratic Party lineage (Uri → Democratic → Minjoo)
- Conservative camp: Grand National → Saenuri → Liberty Korea → People Power Party
- NOTE: Party codes change meaning! Code 301 is progressive in W2-W3, conservative in W4!

THAILAND:
- Pro-Thaksin: Thai Rak Thai → People Power Party → Pheu Thai
- Anti-Thaksin: Democrat Party
- Pro-Military: Palang Pracharath Party (W6 only, formed after 2014 coup)
- Progressive: Future Forward → Move Forward (MFP dissolved Feb 2020)
- NOTE: W4 (2014) has no valid election due to coup

DATA SOURCES:
- IFES Election Guide (electionguide.org)
- Wikipedia election articles
- Taiwan Today, Focus Taiwan
- World Elections blog
")
```
