---
title: "Create Analysis Dataset"
subtitle: "Trust Dynamics and Democratic Resilience in Asia"
author: "Jeffrey Stark"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    toc-location: left
    number-sections: true
    code-fold: show
    code-tools: true
    df-print: paged
    embed-resources: true
execute:
  warning: false
  message: false
---

# Overview

This script creates analysis-ready datasets for examining trust dynamics and democratic resilience across Asia using Asian Barometer Survey data (Waves 1-6, 2001-2022).

**Source**: `abs_econdev_authpref.rds` — the fully harmonized dataset with haven labels already stripped.

**Outputs**:

- `abs_trust_panel.rds` — Full panel (all countries, all waves)
- `abs_trust_panel_balanced.rds` — Balanced W2-W6 panel (7 countries)
- `abs_trust_panel_core.rds` — Core 5 Southeast Asian countries

```{r setup}
library(tidyverse)
library(gt)

project_root <- "/Users/jeffreystark/Development/Research/econdev-authpref"
analysis_dir <- file.path(project_root, "papers/trust-dynamics/analysis")
set.seed(2025)
```

# Load Source Data

```{r load-source}
# Use abs_econdev_authpref.rds - has all variables with labels already zapped
abs_source <- readRDS(file.path(project_root, "data/processed/abs_econdev_authpref.rds"))

cat("Source: abs_econdev_authpref.rds\n")
cat("Rows:", format(nrow(abs_source), big.mark = ","), "\n")
cat("Columns:", ncol(abs_source), "\n")
cat("Waves:", paste(sort(unique(abs_source$wave)), collapse = ", "), "\n")

# Verify labels are zapped
n_labelled <- sum(sapply(abs_source, function(x) inherits(x, "haven_labelled")))
cat("Haven-labelled columns:", n_labelled, "(should be 0)\n")
```

# Variable Selection

```{r define-vars}
# Core variables to extract
vars_to_select <- c(
  # Identifiers
  "country", "wave", "idnumber",
  

  # Trust
  "trust_national_government", "trust_parliament", "trust_military",
  "trust_courts", "trust_police", "trust_political_parties",
  
  # Democratic attitudes
  "democracy_satisfaction", "democracy_suitability", "democracy_efficacy",
  "dem_always_preferable", "dem_vs_econ",
  
  # Authoritarian preferences
  "strongman_rule", "expert_rule", "military_rule", "single_party_rule",
  
  # Political behavior
  "action_demonstration", "action_petition", "voted_last_election", "political_interest",
  
  # Corruption perception (Reviewer 2)
  "corrupt_national_govt", "corrupt_local_govt",
  
  # Economic perception (Reviewer 2)
  "econ_national_now", "econ_change_1yr", "econ_outlook_1yr",
  "hh_income_sat", "gov_sat_national",
  
  # Controls
  "age", "gender", "education_years", "education_level",
  "urban_rural", "hh_income", "subjective_social_status",
  "employed", "religion", "religiosity_practice",
  
  # Country-level (if available)
  "regime_type"
)

available <- intersect(vars_to_select, names(abs_source))
missing <- setdiff(vars_to_select, names(abs_source))

cat("\nVariables: ", length(available), " available, ", length(missing), " missing\n", sep = "")
if (length(missing) > 0) cat("Missing:", paste(missing, collapse = ", "), "\n")
```

```{r select-vars}
abs_panel <- abs_source %>%
  select(all_of(available))

cat("Selected:", nrow(abs_panel), "rows,", ncol(abs_panel), "columns\n")
```

# Add Derived Variables

## Country Names

```{r country-names}
# Country codes per ABS documentation
country_lookup <- tribble(
  ~country, ~country_name,
  1, "Japan",
  2, "Hong Kong",
  3, "Korea",
  4, "China",
  5, "Mongolia",
  6, "Philippines",
  7, "Taiwan",
  8, "Thailand",
  9, "Indonesia",
  10, "Singapore",
  11, "Vietnam",
  12, "Cambodia",
  13, "Malaysia",
  14, "Myanmar",
  15, "Australia",
  18, "India"
)

abs_panel <- abs_panel %>%
  left_join(country_lookup, by = "country") %>%
  mutate(
    survey_year = case_when(
      wave == "w1" ~ 2002, wave == "w2" ~ 2006, wave == "w3" ~ 2011,
      wave == "w4" ~ 2015, wave == "w5" ~ 2019, wave == "w6" ~ 2022
    )
  )

cat("Countries:", length(unique(abs_panel$country_name)), "\n")
```

## Recode Demographics

```{r recode-demographics}
abs_panel <- abs_panel %>%
  mutate(
    # Gender: 1=male, 2=female in ABS → female indicator
    female = if_else(gender == 2, 1L, 0L),
    
    # Urban/rural: 1=urban, 2=rural in ABS → urban indicator
    is_urban = if_else(urban_rural == 1, 1L, 0L),
    
    # Centered/standardized versions
    age_centered = age - mean(age, na.rm = TRUE),
    education_z = (education_years - mean(education_years, na.rm = TRUE)) / 
                  sd(education_years, na.rm = TRUE),
    education_tertile = ntile(education_years, 3)
  )
```

## Trust Composites

```{r trust-composites}
abs_panel <- abs_panel %>%
  rowwise() %>%
  mutate(
    trust_political = mean(c(trust_national_government, trust_parliament, 
                             trust_political_parties), na.rm = TRUE),
    trust_nonpolitical = mean(c(trust_courts, trust_military, trust_police), na.rm = TRUE),
    trust_all = mean(c(trust_national_government, trust_parliament, trust_courts, 
                       trust_military, trust_police, trust_political_parties), na.rm = TRUE),
    auth_pref_mean = mean(c(strongman_rule, expert_rule, military_rule, 
                            single_party_rule), na.rm = TRUE),
    econ_perception_index = mean(c(econ_national_now, econ_outlook_1yr), na.rm = TRUE)
  ) %>%
  ungroup() %>%
  mutate(across(c(trust_political, trust_nonpolitical, trust_all, 
                  auth_pref_mean, econ_perception_index),
                ~if_else(is.nan(.), NA_real_, .)))
```

## Democracy/Economy Preference

```{r dem-econ-pref}
abs_panel <- abs_panel %>%
  mutate(
    # dem_vs_econ: 1=democracy important, 2=economy important
    econ_over_democracy = case_when(
      dem_vs_econ == 2 ~ 1, dem_vs_econ == 1 ~ 0, TRUE ~ NA_real_
    ),
    econ_over_democracy_strict = econ_over_democracy,
    sausage_binary = econ_over_democracy,
    # Democracy indicator based on country (simple classification)
    is_democracy = case_when(
      country_name %in% c("Taiwan", "Korea", "Japan", "Mongolia", "Philippines", "Indonesia") ~ 1L,
      country_name %in% c("China", "Vietnam", "Singapore", "Cambodia", "Myanmar") ~ 0L,
      country_name %in% c("Thailand", "Malaysia", "Hong Kong") ~ NA_integer_,  # Hybrid/contested
      TRUE ~ NA_integer_
    )
  )
```

## Time Variables

```{r time-vars}
abs_panel <- abs_panel %>%
  mutate(
    wave_num = as.integer(str_extract(wave, "\\d")),
    pre_covid = if_else(wave %in% c("w1", "w2", "w3", "w4"), 1L, 0L),
    covid_era = if_else(wave %in% c("w5", "w6"), 1L, 0L),
    post_covid = if_else(wave == "w6", 1L, 0L),
    wave_label = factor(wave,
      levels = paste0("w", 1:6),
      labels = c("W1\n(2001-03)", "W2\n(2005-08)", "W3\n(2010-12)", 
                 "W4\n(2014-16)", "W5\n(2018-20)", "W6\n(2020-22)")
    )
  )
```

## Country Groups

```{r country-groups}
core_5 <- c("Indonesia", "Thailand", "Philippines", "Taiwan", "Vietnam")
balanced_7 <- c("Indonesia", "Korea", "Mongolia", "Philippines", "Taiwan", "Thailand", "Vietnam")
has_w1 <- c("Japan", "Korea", "Mongolia", "Philippines", "Taiwan", "Thailand")

abs_panel <- abs_panel %>%
  mutate(
    in_core_5 = country_name %in% core_5,
    in_balanced_7 = country_name %in% balanced_7,
    has_w1_data = country_name %in% has_w1
  )
```

# Merge COVID/Economic Data

```{r merge-covid}
covid_path <- file.path(project_root, "data/external/covid_economic/country_covid_summary.csv")

if (file.exists(covid_path)) {
  covid <- read_csv(covid_path, show_col_types = FALSE)
  
  abs_panel <- abs_panel %>%
    left_join(covid %>% select(country_name, starts_with("gdp_growth"), 
                               starts_with("deaths_per_million"), vaccination_pct_2022),
              by = "country_name") %>%
    mutate(
      gdp_shock_z = scale(gdp_growth_2020)[,1],
      deaths_2021_z = scale(deaths_per_million_2021)[,1]
    )
  cat("COVID data merged\n")
} else {
  cat("COVID data not found\n")
}
```

# Reviewer 2: Critical Citizen Typology

```{r citizen-type}
abs_panel <- abs_panel %>%
  mutate(
    citizen_type = case_when(
      dem_always_preferable == 1 & auth_pref_mean < 2 ~ "Democratic supporter",
      dem_always_preferable == 1 & auth_pref_mean >= 2 ~ "Ambivalent democrat",
      dem_always_preferable != 1 & auth_pref_mean < 2 ~ "Disenchanted",
      dem_always_preferable != 1 & auth_pref_mean >= 2 ~ "Authoritarian supporter",
      TRUE ~ NA_character_
    ),
    citizen_type = factor(citizen_type, 
                          levels = c("Democratic supporter", "Ambivalent democrat",
                                     "Disenchanted", "Authoritarian supporter"))
  )

cat("\nCitizen type distribution:\n")
print(table(abs_panel$citizen_type, useNA = "ifany"))
```

# Create Dataset Variants

```{r create-variants}
abs_trust_panel <- abs_panel

abs_trust_panel_balanced <- abs_panel %>%
  filter(in_balanced_7, wave %in% paste0("w", 2:6))

abs_trust_panel_core <- abs_panel %>%
  filter(in_core_5, wave %in% paste0("w", 2:6))

cat("\n=== DATASET SUMMARY ===\n")
cat("Full panel:", format(nrow(abs_trust_panel), big.mark=","), "obs,", ncol(abs_trust_panel), "vars\n")
cat("Balanced (7 countries, W2-W6):", format(nrow(abs_trust_panel_balanced), big.mark=","), "obs\n")
cat("Core (5 countries, W2-W6):", format(nrow(abs_trust_panel_core), big.mark=","), "obs\n")
```

# Save Datasets

```{r save}
saveRDS(abs_trust_panel, file.path(analysis_dir, "abs_trust_panel.rds"))
saveRDS(abs_trust_panel_balanced, file.path(analysis_dir, "abs_trust_panel_balanced.rds"))
saveRDS(abs_trust_panel_core, file.path(analysis_dir, "abs_trust_panel_core.rds"))

cat("\nSaved to:", analysis_dir, "\n")
```

# Validation

## Thailand Check (Key for Reviewer 2)

```{r validate-thailand}
cat("\n=== THAILAND: KEY VARIABLES BY WAVE ===\n")

abs_trust_panel %>%
  filter(country_name == "Thailand") %>%
  group_by(wave) %>%
  summarise(
    n = n(),
    trust_govt = round(mean(trust_national_government, na.rm = TRUE), 2),
    trust_mil = round(mean(trust_military, na.rm = TRUE), 2),
    corrupt_n = sum(!is.na(corrupt_national_govt)),
    corrupt = round(mean(corrupt_national_govt, na.rm = TRUE), 2),
    econ_n = sum(!is.na(econ_national_now)),
    econ = round(mean(econ_national_now, na.rm = TRUE), 2),
    .groups = "drop"
  ) %>%
  gt() %>%
  tab_header(title = "Thailand: Trust, Corruption, and Economic Perception by Wave")
```

## Variable Coverage

```{r validate-coverage}
cat("\n=== KEY VARIABLE COVERAGE (% non-missing) ===\n")

key_vars <- c("trust_national_government", "trust_military",
              "corrupt_national_govt", "corrupt_local_govt",
              "econ_national_now", "econ_outlook_1yr",
              "dem_always_preferable", "auth_pref_mean", "citizen_type")

coverage <- abs_trust_panel_core %>%
  summarise(across(all_of(key_vars), ~round(100 * mean(!is.na(.)), 1))) %>%
  pivot_longer(everything(), names_to = "Variable", values_to = "% Valid")

coverage %>% gt() %>% tab_header(title = "Variable Coverage in Core Panel")
```

## Sample by Country × Wave

```{r sample-table}
abs_trust_panel_core %>%
  count(country_name, wave) %>%
  pivot_wider(names_from = wave, values_from = n, values_fill = 0) %>%
  gt() %>%
  tab_header(title = "Core Panel: Sample Size by Country and Wave")
```

# Session Info

```{r session}
sessionInfo()
```
