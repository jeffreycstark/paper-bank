---
title: "Hypothesis Testing"
subtitle: "I Don't Care How the Sausage Gets Made"
author: "Jeffrey Stark"
date: today
format:
  html:
    toc: true
    toc-depth: 4
    toc-location: left
    number-sections: true
    code-fold: show
    code-tools: true
    df-print: paged
    embed-resources: true
    fig-width: 10
    fig-height: 7
execute:
  warning: false
  message: false
  cache: true
---

# Setup

```{r setup}
# Core packages
library(tidyverse)
library(here)
library(gt)
library(gtsummary)
library(broom)
library(lme4)
library(lmerTest)
library(broom.mixed)
library(effectsize)

here::i_am("papers/trust-dynamics/analysis/03_hypothesis_testing.qmd")
set.seed(2025)
theme_set(theme_minimal(base_size = 12))

select <- dplyr::select
filter <- dplyr::filter

regime_colors <- c("Democracy" = "#66c2a5", "Hybrid" = "#fc8d62", "Autocracy" = "#8da0cb")
```

## Load Data

```{r load-data}
analysis_data <- readRDS(here("papers/trust-dynamics/analysis/sausage_analysis.rds"))
cat("Analysis sample: n =", nrow(analysis_data), "\n")

# DV coding verification
cat("\n=== DV CODING ===\n")
cat("econ_over_democracy: Higher = MORE economy priority ('sausage mentality')\n")
cat("  1 = Strong democracy priority\n")
cat("  2 = Moderate democracy priority\n")
cat("  2.5 = Both equally important (recoded from 5)\n")
cat("  3 = Moderate economy priority\n")
cat("  4 = Strong economy priority\n\n")

cat("Main DV stats:\n")
cat("  Mean:", round(mean(analysis_data$econ_over_democracy, na.rm = TRUE), 3), "\n")
cat("  SD:", round(sd(analysis_data$econ_over_democracy, na.rm = TRUE), 3), "\n")
cat("  N:", sum(!is.na(analysis_data$econ_over_democracy)), "\n")

if ("econ_over_democracy_strict" %in% names(analysis_data)) {
  cat("\nStrict DV (excluding 'both equally'):\n")
  cat("  Mean:", round(mean(analysis_data$econ_over_democracy_strict, na.rm = TRUE), 3), "\n")
  cat("  N:", sum(!is.na(analysis_data$econ_over_democracy_strict)), "\n")
}
```

# Hypotheses Overview

| Hypothesis | Prediction | Expected Coefficient |
|------------|------------|---------------------|
| **H1** | Citizens in democracies prioritize economy MORE | `is_democracy` > 0 |
| **H2** | Inverted-U education effect in democracies | Significant interaction |
| **H3** | Elite attitudes diverge over time | Significant 3-way |
| **H4** | Effect weaker in entrenched autocracies | Weaker/null in Cambodia/Vietnam |

**Key**: With corrected coding (higher = more economy priority), **positive** `is_democracy` coefficient supports H1.

# H1: Grass is Greener Effect

## Descriptive: Regime Means

```{r h1-descriptive}
regime_means <- analysis_data %>%
  group_by(regime_type) %>%
  summarise(
    n = n(),
    mean = mean(econ_over_democracy, na.rm = TRUE),
    sd = sd(econ_over_democracy, na.rm = TRUE),
    .groups = "drop"
  )

regime_means %>%
  gt() %>%
  tab_header(
    title = "Economy Priority by Regime Type",
    subtitle = "Higher = more 'sausage mentality'"
  ) %>%
  fmt_number(columns = c(mean, sd), decimals = 3) %>%
  fmt_number(columns = n, use_seps = TRUE)
```

## Model 1a: Basic OLS

```{r h1-basic}
model_h1a <- lm(econ_over_democracy ~ is_democracy, data = analysis_data)

tidy(model_h1a, conf.int = TRUE) %>%
  gt() %>%
  tab_header(
    title = "H1: Basic Regime Effect",
    subtitle = "Positive coefficient = democracies more economy-focused (supports H1)"
  ) %>%
  fmt_number(columns = c(estimate, std.error, statistic, conf.low, conf.high), decimals = 3)
```

## Model 1b: With Controls

```{r h1-controls}
model_h1b <- lm(econ_over_democracy ~ is_democracy + age_centered + female +
                  education_z + is_urban,
                data = analysis_data)

tidy(model_h1b, conf.int = TRUE) %>%
  gt() %>%
  tab_header(title = "H1: With Demographic Controls") %>%
  fmt_number(columns = c(estimate, std.error, statistic, conf.low, conf.high), decimals = 3)
```

## Model 1c: Multilevel (Country Random Effects)

```{r h1-multilevel}
model_h1c <- lmer(econ_over_democracy ~ is_democracy + age_centered + female +
                    education_z + is_urban + (1 | country),
                  data = analysis_data)

tidy(model_h1c, effects = "fixed", conf.int = TRUE) %>%
  gt() %>%
  tab_header(
    title = "H1: Multilevel Model",
    subtitle = "Most conservative - accounts for country clustering"
  ) %>%
  fmt_number(columns = c(estimate, std.error, statistic, conf.low, conf.high), decimals = 3)
```

## H1 Effect Size

```{r h1-effect}
dem_vals <- analysis_data$econ_over_democracy[analysis_data$is_democracy == 1]
auto_vals <- analysis_data$econ_over_democracy[analysis_data$is_democracy == 0]

d <- cohens_d(dem_vals, auto_vals, pooled_sd = TRUE)
cat("Cohen's d:", round(d$Cohens_d, 3), "\n")
cat("95% CI: [", round(d$CI_low, 3), ",", round(d$CI_high, 3), "]\n")
cat("\nInterpretation: d > 0 means democracies MORE economy-focused (supports H1)\n")
```

# H2: Education × Regime Interaction

## Model 2a: Linear Interaction

```{r h2-linear}
model_h2a <- lm(econ_over_democracy ~ education_z * is_democracy +
                  age_centered + female + is_urban,
                data = analysis_data)

tidy(model_h2a, conf.int = TRUE) %>%
  gt() %>%
  tab_header(title = "H2: Education × Regime Interaction") %>%
  fmt_number(columns = c(estimate, std.error, statistic, conf.low, conf.high), decimals = 3)
```

## Model 2b: Quadratic (Inverted-U Test)

```{r h2-quadratic}
model_h2b <- lm(econ_over_democracy ~ education_z + education_z_sq +
                  education_z:is_democracy + education_z_sq:is_democracy +
                  is_democracy + age_centered + female + is_urban,
                data = analysis_data)

tidy(model_h2b, conf.int = TRUE) %>%
  gt() %>%
  tab_header(
    title = "H2: Quadratic Education × Regime",
    subtitle = "Negative quadratic × democracy = inverted-U in democracies"
  ) %>%
  fmt_number(columns = c(estimate, std.error, statistic, conf.low, conf.high), decimals = 3)
```

## H2 Visualization

```{r h2-plot}
if (requireNamespace("ggeffects", quietly = TRUE)) {
  library(ggeffects)
  pred_h2 <- ggpredict(model_h2a, terms = c("education_z [-2:2]", "is_democracy"))
  
  plot(pred_h2) +
    labs(
      title = "H2: Education Effect by Regime Type",
      x = "Education (standardized)",
      y = "Economy Priority\n(Higher = more sausage mentality)",
      color = "Democracy"
    )
}
```

# H3: Elite Divergence Over Time

## Model 3a: Three-Way Interaction

```{r h3-threeway}
model_h3a <- lm(econ_over_democracy ~ education_z * is_democracy * wave_numeric +
                  age_centered + female + is_urban,
                data = analysis_data)

tidy(model_h3a, conf.int = TRUE) %>%
  filter(str_detect(term, "education|wave")) %>%
  gt() %>%
  tab_header(title = "H3: Elite Divergence (Three-Way Interaction)") %>%
  fmt_number(columns = c(estimate, std.error, statistic, conf.low, conf.high), decimals = 3)
```

## H3 Visualization: Elite Trends

```{r h3-trends}
if (all(c("wave", "education_tertile", "regime_type") %in% names(analysis_data))) {
  elite_trends <- analysis_data %>%
    filter(education_tertile == "High") %>%
    group_by(wave, regime_type) %>%
    summarise(
      mean_econ = mean(econ_over_democracy, na.rm = TRUE),
      se = sd(econ_over_democracy, na.rm = TRUE) / sqrt(n()),
      n = n(),
      .groups = "drop"
    )

  ggplot(elite_trends, aes(x = wave, y = mean_econ, color = regime_type, group = regime_type)) +
    geom_point(size = 3) +
    geom_line(linewidth = 1) +
    geom_errorbar(aes(ymin = mean_econ - 1.96*se, ymax = mean_econ + 1.96*se), width = 0.2) +
    scale_color_manual(values = regime_colors) +
    labs(
      title = "H3: Elite Attitudes Over Time",
      subtitle = "High-education respondents only",
      x = "Wave",
      y = "Economy Priority\n(Higher = more sausage mentality)",
      color = "Regime Type"
    )
}
```

# H4: Resignation Effect

## Model 4a: Cambodia/Vietnam Subgroup

```{r h4-subgroup}
entrenched <- analysis_data %>% filter(country %in% c(11, 12))

if (nrow(entrenched) > 100) {
  model_h4a <- lm(econ_over_democracy ~ education_z * wave_numeric +
                    age_centered + female + is_urban,
                  data = entrenched)

  tidy(model_h4a, conf.int = TRUE) %>%
    gt() %>%
    tab_header(title = "H4: Cambodia/Vietnam Subgroup") %>%
    fmt_number(columns = c(estimate, std.error, statistic, conf.low, conf.high), decimals = 3)

  cat("Subgroup n =", nrow(entrenched), "\n")
}
```

## H4 Comparison: Tightening vs Entrenched

```{r h4-comparison}
autocracy_comparison <- analysis_data %>%
  filter(country %in% c(4, 11, 12)) %>%
  mutate(autocracy_type = if_else(country == 4, "Tightening (China)", "Entrenched (Camb/Viet)"))

if (nrow(autocracy_comparison) > 200) {
  model_h4b <- lm(econ_over_democracy ~ education_z * wave_numeric * autocracy_type +
                    age_centered + female + is_urban,
                  data = autocracy_comparison)

  tidy(model_h4b, conf.int = TRUE) %>%
    filter(str_detect(term, "education|wave|autocracy")) %>%
    gt() %>%
    tab_header(title = "H4: Tightening vs Entrenched Autocracies") %>%
    fmt_number(columns = c(estimate, std.error, statistic, conf.low, conf.high), decimals = 3)
}
```

# Robustness: Strict DV

```{r robustness-strict}
if ("econ_over_democracy_strict" %in% names(analysis_data)) {
  cat("=== ROBUSTNESS CHECK: Excluding 'Both Equally' Responses ===\n\n")
  
  model_rob_h1 <- lm(econ_over_democracy_strict ~ is_democracy + age_centered + 
                       female + education_z + is_urban,
                     data = analysis_data)
  
  cat("H1 with strict DV:\n")
  cat("  is_democracy coefficient:", round(coef(model_rob_h1)["is_democracy"], 3), "\n")
  cat("  p-value:", format.pval(summary(model_rob_h1)$coefficients["is_democracy", 4]), "\n")
  
  model_rob_h2 <- lm(econ_over_democracy_strict ~ education_z * is_democracy +
                       age_centered + female + is_urban,
                     data = analysis_data)
  
  cat("\nH2 with strict DV:\n")
  cat("  Interaction coefficient:", round(coef(model_rob_h2)["education_z:is_democracy"], 3), "\n")
  cat("  p-value:", format.pval(summary(model_rob_h2)$coefficients["education_z:is_democracy", 4]), "\n")
}
```

# Summary

```{r summary}
cat("\n")
cat(strrep("=", 70), "\n")
cat("  HYPOTHESIS TESTING SUMMARY\n")
cat(strrep("=", 70), "\n\n")

cat("H1 (Grass is Greener):\n")
cat("  Coefficient:", round(coef(model_h1b)["is_democracy"], 3), "\n")
cat("  p-value:", format.pval(summary(model_h1b)$coefficients["is_democracy", 4]), "\n")
cat("  Interpretation: Positive = democracies MORE economy-focused\n\n")

cat("H2 (Education × Regime):\n")
cat("  Interaction:", round(coef(model_h2a)["education_z:is_democracy"], 3), "\n")
cat("  p-value:", format.pval(summary(model_h2a)$coefficients["education_z:is_democracy", 4]), "\n\n")

cat("H3 (Elite Divergence): See three-way interaction table\n\n")
cat("H4 (Resignation): See subgroup analysis\n\n")

cat(strrep("=", 70), "\n")
```

# Session Info

```{r session}
sessionInfo()
```
