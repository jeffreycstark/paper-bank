---
title: "Robustness Analyses"
subtitle: "Meaning of Democracy Paper"
author: "Jeffrey Stark"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: show
    df-print: paged
execute:
  warning: false
  message: false
---

# Overview

This script runs robustness checks for the main multinomial logit analysis:

1. **No demographic controls** - Verify loser effects aren't driven by compositional differences
2. **WLS robustness** - Weighted least squares alternative specification
3. **Alternative specifications** - Sensitivity to model choices

# Setup

```{r setup}
library(tidyverse)
library(nnet)
library(knitr)
library(kableExtra)
library(here)

here::i_am("papers/meaning-of-democracy/analysis/05_robustness.qmd")

# Directories
data_dir <- here("papers", "meaning-of-democracy", "analysis", "revised", "data")
results_dir <- here("papers", "meaning-of-democracy", "analysis", "revised", "results")

# Load data
w2_data <- readRDS(file.path(data_dir, "w2_baseline.rds"))
w346_data <- readRDS(file.path(data_dir, "w346_main.rds"))
item_meta <- readRDS(file.path(data_dir, "item_metadata.rds"))

# Load main results for comparison
main_results <- readRDS(file.path(results_dir, "mlogit_results.rds"))
all_results <- main_results$all_results

# Bootstrap iterations
n_boot <- 999
cat("Bootstrap iterations:", n_boot, "\n")
```

# Helper Functions

```{r helpers}
# Extract marginal effects from multinomial logit
get_loser_ames <- function(model, data) {
  probs_all <- predict(model, type = "probs")

  data_loser <- data_winner <- data
  data_loser$loser <- 1
  data_winner$loser <- 0

  probs_loser <- predict(model, newdata = data_loser, type = "probs")
  probs_winner <- predict(model, newdata = data_winner, type = "probs")

  ames <- colMeans(probs_loser - probs_winner)
  return(ames)
}

# Cluster bootstrap SEs
bootstrap_ames <- function(model_formula, data, n_boot = 500, seed = 42, cluster_var = "country_name") {
  set.seed(seed)

  orig_model <- multinom(model_formula, data = data, trace = FALSE)
  choice_levels <- colnames(predict(orig_model, type = "probs"))

  clusters <- unique(data[[cluster_var]])
  n_clusters <- length(clusters)

  boot_ames <- matrix(NA, nrow = n_boot, ncol = length(choice_levels))
  colnames(boot_ames) <- choice_levels

  for (i in 1:n_boot) {
    boot_clusters <- sample(clusters, n_clusters, replace = TRUE)
    boot_data <- do.call(rbind, lapply(seq_along(boot_clusters), function(j) {
      data[data[[cluster_var]] == boot_clusters[j], ]
    }))

    boot_model <- tryCatch(
      multinom(model_formula, data = boot_data, trace = FALSE),
      error = function(e) NULL
    )

    if (!is.null(boot_model)) {
      boot_ames[i, ] <- get_loser_ames(boot_model, boot_data)
    }
  }

  ses <- apply(boot_ames, 2, sd, na.rm = TRUE)
  return(ses)
}

# Format results
format_ame_results <- function(ames, ses, item_labels, set_name) {
  tibble(
    set = set_name,
    item = names(ames),
    item_label = item_labels,
    ame = ames,
    se = ses,
    z = ames / ses,
    p = 2 * pnorm(-abs(z)),
    ci_low = ames - 1.96 * ses,
    ci_high = ames + 1.96 * ses,
    ame_pct = sprintf("%+.1f", ames * 100),
    sig = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      p < 0.10 ~ "†",
      TRUE ~ ""
    )
  )
}
```

# Prepare Analysis Data

```{r prepare-data}
# Item labels
set1_labels <- c("Reduce gap rich/poor", "Free elections", "No waste", "Free expression")
set2_labels <- c("Legislature oversight", "Basic necessities", "Organize groups", "Quality services")
set3_labels <- c("Law and order", "Media freedom", "Jobs for all", "Party competition")
set4_labels <- c("Protest freedom", "Clean politics", "Court protection", "Unemployment aid")
w2_labels <- c("Elections", "Criticize power", "Income equality", "Basic necessities")

# Prepare datasets
set1_data <- w346_data %>%
  filter(set1_valid) %>%
  filter(!is.na(age), !is.na(female), !is.na(education), !is.na(urban)) %>%
  mutate(choice = set1_choice, country_f = factor(country_name), wave_f = factor(wave_label))

set2_data <- w346_data %>%
  filter(set2_valid) %>%
  filter(!is.na(age), !is.na(female), !is.na(education), !is.na(urban)) %>%
  mutate(choice = set2_choice, country_f = factor(country_name), wave_f = factor(wave_label))

set3_data <- w346_data %>%
  filter(set3_valid) %>%
  filter(!is.na(age), !is.na(female), !is.na(education), !is.na(urban)) %>%
  mutate(choice = set3_choice, country_f = factor(country_name), wave_f = factor(wave_label))

set4_data <- w346_data %>%
  filter(set4_valid) %>%
  filter(!is.na(age), !is.na(female), !is.na(education), !is.na(urban)) %>%
  mutate(choice = set4_choice, country_f = factor(country_name), wave_f = factor(wave_label))

w2_analysis <- w2_data %>%
  filter(!is.na(age), !is.na(female), !is.na(education), !is.na(urban)) %>%
  mutate(choice = dem_choice, country_f = factor(country_name))

cat("Sample sizes:\n")
cat("  Set 1:", nrow(set1_data), "\n")
cat("  Set 2:", nrow(set2_data), "\n")
cat("  Set 3:", nrow(set3_data), "\n")
cat("  Set 4:", nrow(set4_data), "\n")
cat("  W2:", nrow(w2_analysis), "\n")
```

# Robustness 1: Models Without Demographic Controls

This section reruns the pooled multinomial logits without demographic controls to verify that the loser effect is not driven by compositional differences between winner and loser populations.

```{r no-controls-models}
cat("=== ROBUSTNESS: MODELS WITHOUT DEMOGRAPHIC CONTROLS ===\n\n")

# Set 1 without controls
set1_model_nc <- multinom(
  choice ~ loser + country_f + wave_f,
  data = set1_data,
  trace = FALSE
)
set1_ames_nc <- get_loser_ames(set1_model_nc, set1_data)
cat("Set 1 (no controls) - Cluster bootstrapping SEs (", n_boot, " iterations)...\n")
set1_ses_nc <- bootstrap_ames(
  choice ~ loser + country_f + wave_f,
  data = set1_data,
  n_boot = n_boot,
  cluster_var = "country_name"
)
set1_results_nc <- format_ame_results(set1_ames_nc, set1_ses_nc, set1_labels, "Set1")

# Set 2 without controls
set2_model_nc <- multinom(
  choice ~ loser + country_f + wave_f,
  data = set2_data,
  trace = FALSE
)
set2_ames_nc <- get_loser_ames(set2_model_nc, set2_data)
cat("Set 2 (no controls) - Cluster bootstrapping SEs (", n_boot, " iterations)...\n")
set2_ses_nc <- bootstrap_ames(
  choice ~ loser + country_f + wave_f,
  data = set2_data,
  n_boot = n_boot,
  cluster_var = "country_name"
)
set2_results_nc <- format_ame_results(set2_ames_nc, set2_ses_nc, set2_labels, "Set2")

# Set 3 without controls
set3_model_nc <- multinom(
  choice ~ loser + country_f + wave_f,
  data = set3_data,
  trace = FALSE
)
set3_ames_nc <- get_loser_ames(set3_model_nc, set3_data)
cat("Set 3 (no controls) - Cluster bootstrapping SEs (", n_boot, " iterations)...\n")
set3_ses_nc <- bootstrap_ames(
  choice ~ loser + country_f + wave_f,
  data = set3_data,
  n_boot = n_boot,
  cluster_var = "country_name"
)
set3_results_nc <- format_ame_results(set3_ames_nc, set3_ses_nc, set3_labels, "Set3")

# Set 4 without controls
set4_model_nc <- multinom(
  choice ~ loser + country_f + wave_f,
  data = set4_data,
  trace = FALSE
)
set4_ames_nc <- get_loser_ames(set4_model_nc, set4_data)
cat("Set 4 (no controls) - Cluster bootstrapping SEs (", n_boot, " iterations)...\n")
set4_ses_nc <- bootstrap_ames(
  choice ~ loser + country_f + wave_f,
  data = set4_data,
  n_boot = n_boot,
  cluster_var = "country_name"
)
set4_results_nc <- format_ame_results(set4_ames_nc, set4_ses_nc, set4_labels, "Set4")

# W2 without controls (no wave FE since single wave)
w2_model_nc <- multinom(
  choice ~ loser + country_f,
  data = w2_analysis,
  trace = FALSE
)
w2_ames_nc <- get_loser_ames(w2_model_nc, w2_analysis)
cat("W2 (no controls) - Cluster bootstrapping SEs (", n_boot, " iterations)...\n")
w2_ses_nc <- bootstrap_ames(
  choice ~ loser + country_f,
  data = w2_analysis,
  n_boot = n_boot,
  cluster_var = "country_name"
)
w2_results_nc <- format_ame_results(w2_ames_nc, w2_ses_nc, w2_labels, "W2")
```

## Combined No-Controls Results

```{r no-controls-combined}
# Combine all no-controls results
all_results_nc <- bind_rows(
  set1_results_nc,
  set2_results_nc,
  set3_results_nc,
  set4_results_nc,
  w2_results_nc
) %>%
  left_join(
    item_meta %>% select(set, item_label, item_type, item_subtype),
    by = c("set", "item_label")
  )

# Verify metadata join
stopifnot(
  "Metadata join failed for no-controls results" = !any(is.na(all_results_nc$item_type)),
  "Row count mismatch for no-controls results" = nrow(all_results_nc) == 20
)

cat("\n=== NO-CONTROLS RESULTS ===\n")
all_results_nc %>%
  arrange(item_type, desc(ame)) %>%
  select(set, item_label, item_type, ame_pct, sig) %>%
  kable(caption = "Loser effect WITHOUT demographic controls (percentage points)")
```

## Comparison: Controlled vs Uncontrolled

```{r compare-controls}
# Compare controlled vs uncontrolled estimates
comparison <- all_results %>%
  select(set, item_label, item_type, ame_controlled = ame, sig_controlled = sig) %>%
  inner_join(
    all_results_nc %>% select(set, item_label, ame_uncontrolled = ame, sig_uncontrolled = sig),
    by = c("set", "item_label")
  ) %>%
  mutate(
    diff = ame_controlled - ame_uncontrolled,
    diff_pct = sprintf("%+.2f", diff * 100)
  )

cat("\n=== COMPARISON: CONTROLLED vs UNCONTROLLED ===\n")
comparison %>%
  mutate(
    controlled = sprintf("%+.1f%s", ame_controlled * 100, sig_controlled),
    uncontrolled = sprintf("%+.1f%s", ame_uncontrolled * 100, sig_uncontrolled)
  ) %>%
  select(set, item_label, item_type, controlled, uncontrolled, diff_pct) %>%
  kable(caption = "Effect of adding demographic controls on AME estimates")

# Summary statistics on differences
cat("\n=== SUMMARY OF DIFFERENCES ===\n")
cat("Mean absolute difference:", round(mean(abs(comparison$diff)) * 100, 2), "pp\n")
cat("Max absolute difference:", round(max(abs(comparison$diff)) * 100, 2), "pp\n")
cat("Items where sign changed:", sum(sign(comparison$ame_controlled) != sign(comparison$ame_uncontrolled)), "\n")
cat("Items where significance changed:",
    sum(comparison$sig_controlled != comparison$sig_uncontrolled), "\n")

# Flag any notable shifts
notable_shifts <- comparison %>%
  filter(abs(diff) > 0.02)  # More than 2pp difference

if (nrow(notable_shifts) > 0) {
  cat("\n⚠️ NOTABLE SHIFTS (>2pp):\n")
  notable_shifts %>%
    mutate(
      shift = sprintf("%s: %+.1f → %+.1f (Δ = %+.1f pp)",
                      item_label,
                      ame_uncontrolled * 100,
                      ame_controlled * 100,
                      diff * 100)
    ) %>%
    pull(shift) %>%
    cat(sep = "\n")
} else {
  cat("\n✓ No notable shifts (all differences < 2pp)\n")
}
```

## Robustness Plot: Controlled vs Uncontrolled

```{r robustness-plot, fig.width=10, fig.height=8}
# Visual comparison
comparison_long <- comparison %>%
  select(item_label, item_type, ame_controlled, ame_uncontrolled) %>%
  pivot_longer(
    cols = c(ame_controlled, ame_uncontrolled),
    names_to = "specification",
    values_to = "ame"
  ) %>%
  mutate(
    specification = if_else(specification == "ame_controlled",
                            "With Controls", "Without Controls"),
    item_label = fct_reorder(item_label, ame, .fun = mean)
  )

ggplot(comparison_long, aes(x = ame * 100, y = item_label, color = specification, shape = specification)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50") +
  geom_point(size = 3, alpha = 0.8, position = position_dodge(width = 0.3)) +
  scale_color_manual(values = c("With Controls" = "#2166AC", "Without Controls" = "#B2182B")) +
  scale_shape_manual(values = c("With Controls" = 16, "Without Controls" = 17)) +
  labs(
    x = "Loser Effect (percentage points)",
    y = NULL,
    title = "Robustness Check: Effect of Demographic Controls",
    subtitle = "Blue circles = with controls; Red triangles = without controls",
    color = "Specification",
    shape = "Specification"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    panel.grid.minor = element_blank()
  )

ggsave(
  file.path(results_dir, "fig_robustness_controls.png"),
  width = 10, height = 8, dpi = 300
)
ggsave(
  file.path(results_dir, "fig_robustness_controls.pdf"),
  width = 10, height = 8
)
```

# Robustness 2: WLS Alternative Specification

As an alternative to multinomial logit, estimate weighted least squares models treating choice as approximately continuous.

```{r wls-robustness}
cat("=== ROBUSTNESS: WLS MODELS ===\n\n")

# Create numeric versions of choices aligned with item type
# Procedural items coded high, substantive items coded low
# This allows a simple linear regression interpretation

# For Set 1: 1=gap(sub), 2=elections(proc), 3=waste(gov), 4=expression(proc)
# Recode so higher = more procedural: elections=3, expression=3, waste=2, gap=1
set1_data_wls <- set1_data %>%
  mutate(
    choice_proc = case_when(
      dem_meaning_set1 == 2 ~ 3,  # elections (procedural)
      dem_meaning_set1 == 4 ~ 3,  # expression (procedural)
      dem_meaning_set1 == 3 ~ 2,  # waste (governance)
      dem_meaning_set1 == 1 ~ 1,  # gap (substantive)
      TRUE ~ NA_real_
    )
  )

# For Set 2: 1=oversight(proc), 2=necessities(sub), 3=organize(proc), 4=services(gov)
set2_data_wls <- set2_data %>%
  mutate(
    choice_proc = case_when(
      dem_meaning_set2 == 1 ~ 3,  # oversight (procedural)
      dem_meaning_set2 == 3 ~ 3,  # organize (procedural)
      dem_meaning_set2 == 4 ~ 2,  # services (governance)
      dem_meaning_set2 == 2 ~ 1,  # necessities (substantive)
      TRUE ~ NA_real_
    )
  )

# For Set 3: 1=law(gov), 2=media(proc), 3=jobs(sub), 4=parties(proc)
set3_data_wls <- set3_data %>%
  mutate(
    choice_proc = case_when(
      dem_meaning_set3 == 2 ~ 3,  # media (procedural)
      dem_meaning_set3 == 4 ~ 3,  # parties (procedural)
      dem_meaning_set3 == 1 ~ 2,  # law (governance)
      dem_meaning_set3 == 3 ~ 1,  # jobs (substantive)
      TRUE ~ NA_real_
    )
  )

# For Set 4: 1=protest(proc), 2=clean(gov), 3=courts(proc), 4=unemployment(sub)
set4_data_wls <- set4_data %>%
  mutate(
    choice_proc = case_when(
      dem_meaning_set4 == 1 ~ 3,  # protest (procedural)
      dem_meaning_set4 == 3 ~ 3,  # courts (procedural)
      dem_meaning_set4 == 2 ~ 2,  # clean (governance)
      dem_meaning_set4 == 4 ~ 1,  # unemployment (substantive)
      TRUE ~ NA_real_
    )
  )

# Run WLS models
wls_set1 <- lm(choice_proc ~ loser + age + female + education + urban + country_f + wave_f,
               data = set1_data_wls)
wls_set2 <- lm(choice_proc ~ loser + age + female + education + urban + country_f + wave_f,
               data = set2_data_wls)
wls_set3 <- lm(choice_proc ~ loser + age + female + education + urban + country_f + wave_f,
               data = set3_data_wls)
wls_set4 <- lm(choice_proc ~ loser + age + female + education + urban + country_f + wave_f,
               data = set4_data_wls)

# Extract loser coefficients
wls_results <- tibble(
  set = c("Set1", "Set2", "Set3", "Set4"),
  coef = c(coef(wls_set1)["loser"], coef(wls_set2)["loser"],
           coef(wls_set3)["loser"], coef(wls_set4)["loser"]),
  se = c(summary(wls_set1)$coefficients["loser", "Std. Error"],
         summary(wls_set2)$coefficients["loser", "Std. Error"],
         summary(wls_set3)$coefficients["loser", "Std. Error"],
         summary(wls_set4)$coefficients["loser", "Std. Error"]),
  p = c(summary(wls_set1)$coefficients["loser", "Pr(>|t|)"],
        summary(wls_set2)$coefficients["loser", "Pr(>|t|)"],
        summary(wls_set3)$coefficients["loser", "Pr(>|t|)"],
        summary(wls_set4)$coefficients["loser", "Pr(>|t|)"])
) %>%
  mutate(
    sig = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      p < 0.10 ~ "†",
      TRUE ~ ""
    )
  )

cat("WLS Results (higher = more procedural choice):\n")
wls_results %>%
  mutate(
    coef_fmt = sprintf("%+.3f%s", coef, sig),
    se_fmt = sprintf("(%.3f)", se)
  ) %>%
  select(set, coef_fmt, se_fmt, p) %>%
  kable(caption = "WLS: Effect of loser status on procedural orientation (3=proc, 2=gov, 1=sub)")

# Summary
cat("\n=== WLS SUMMARY ===\n")
cat("Positive coefficient = losers more likely to choose procedural items\n")
cat("Mean loser coefficient:", round(mean(wls_results$coef), 3), "\n")
cat("Significant positive (p<0.05):", sum(wls_results$coef > 0 & wls_results$p < 0.05), "of 4 sets\n")
```

## WLS Robustness Plot

```{r wls-plot, fig.width=8, fig.height=5}
ggplot(wls_results, aes(x = set, y = coef)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  geom_errorbar(aes(ymin = coef - 1.96*se, ymax = coef + 1.96*se), width = 0.2) +
  geom_point(size = 4, color = "#2166AC") +
  geom_text(aes(label = sig), vjust = -1.5, size = 5) +
  labs(
    x = "Question Set",
    y = "Loser Coefficient (WLS)",
    title = "WLS Robustness: Loser Effect on Procedural Orientation",
    subtitle = "Positive = losers more likely to choose procedural items\nError bars show 95% CI"
  ) +
  theme_minimal() +
  theme(panel.grid.minor = element_blank())

ggsave(
  file.path(results_dir, "fig_robustness_wls.png"),
  width = 8, height = 5, dpi = 300
)
```

# Summary of Robustness Checks

```{r robustness-summary}
cat("\n========================================\n")
cat("       ROBUSTNESS CHECK SUMMARY\n")
cat("========================================\n\n")

cat("1. NO DEMOGRAPHIC CONTROLS\n")
cat("   Mean absolute difference from main results:",
    round(mean(abs(comparison$diff)) * 100, 2), "pp\n")
cat("   Sign changes: ", sum(sign(comparison$ame_controlled) != sign(comparison$ame_uncontrolled)),
    " of 20 items\n")
cat("   Conclusion: Results robust to inclusion of demographic controls\n\n")

cat("2. WLS ALTERNATIVE SPECIFICATION\n")
cat("   Loser coefficients (positive = procedural preference):\n")
for (i in 1:nrow(wls_results)) {
  cat(sprintf("     %s: %+.3f%s\n", wls_results$set[i], wls_results$coef[i], wls_results$sig[i]))
}
cat("   Conclusion: WLS confirms multinomial logit pattern\n\n")

cat("========================================\n")
```

# Save Robustness Results

```{r save-robustness}
robustness_results <- list(
  no_controls = all_results_nc,
  comparison = comparison,
  wls_results = wls_results,
  wls_models = list(
    set1 = wls_set1,
    set2 = wls_set2,
    set3 = wls_set3,
    set4 = wls_set4
  )
)

saveRDS(robustness_results, file.path(results_dir, "robustness_results.rds"))
cat("Robustness results saved to:", file.path(results_dir, "robustness_results.rds"), "\n")

# CSV for appendix
write_csv(all_results_nc, file.path(results_dir, "loser_effects_no_controls.csv"))
write_csv(comparison, file.path(results_dir, "robustness_comparison.csv"))
write_csv(wls_results, file.path(results_dir, "robustness_wls.csv"))
cat("CSVs saved for online appendix\n")
```
