---
title: "Data Preparation"
subtitle: "Meaning of Democracy Paper"
author: "Jeffrey Stark"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: show
    df-print: paged
execute:
  warning: false
  message: false
---

# Overview

This script prepares the analysis dataset by:

1. Loading Asian Barometer Survey waves 2, 3, 4, and 6
2. Harmonizing winner/loser and procedural democracy measures across waves
3. Creating the combined analysis dataset

# Setup

```{r setup}
library(haven)
library(tidyverse)
library(here)

here::i_am("papers/meaning-of-democracy/analysis/01_data_preparation.qmd")

# Data directories
raw_data_dir <- here("data", "processed")
output_dir <- here("papers", "meaning-of-democracy", "analysis", "data")
```

# Helper Functions

```{r helpers}
# Country name lookup
get_country_name <- function(x) {
  if (is.character(x)) {
    case_when(x == "Korea" ~ "South Korea", TRUE ~ x)
  } else {
    code <- as.integer(x)
    case_when(
      code == 1 ~ "Japan", code == 2 ~ "South Korea", code == 3 ~ "Mongolia",
      code == 4 ~ "Taiwan", code == 5 ~ "Hong Kong", code == 6 ~ "China",
      code == 7 ~ "Philippines", code == 8 ~ "Thailand", code == 9 ~ "Vietnam",
      code == 10 ~ "Cambodia", code == 11 ~ "Singapore", code == 12 ~ "Myanmar",
      code == 13 ~ "Malaysia", code == 14 ~ "Indonesia", TRUE ~ NA_character_
    )
  }
}

# Recode functions for 4-set battery (W3, W4, W6)
# Each set pits a procedural option against a substantive option
# Returns 1 if procedural chosen, 0 if substantive
recode_set1 <- function(x) case_when(x %in% c(2, 4) ~ 1L, x %in% c(1, 3) ~ 0L, TRUE ~ NA_integer_)
recode_set2 <- function(x) case_when(x %in% c(1, 3) ~ 1L, x %in% c(2, 4) ~ 0L, TRUE ~ NA_integer_)
recode_set3 <- function(x) case_when(x %in% c(2, 4) ~ 1L, x %in% c(1, 3) ~ 0L, TRUE ~ NA_integer_)
recode_set4 <- function(x) case_when(x %in% c(1, 3) ~ 1L, x %in% c(2, 4) ~ 0L, TRUE ~ NA_integer_)
```

# Load and Process Each Wave

## Wave 2 (2005-2008)

Wave 2 uses a **single-item** measure (q92) rather than the 4-set battery:

- 1 = Opportunity to change government through elections (procedural)
- 2 = Freedom to criticize those in power (procedural)
- 3 = A small income gap between rich and poor (substantive)
- 4 = Basic necessities for everyone (substantive)

Winner/loser status from q39a.

```{r w2}
w2 <- readRDS(file.path(raw_data_dir, "w2.rds"))

w2_processed <- w2 %>%
  mutate(
    wave = "W2",
    wave_year = 2006,
    country_name = get_country_name(country),
    
    # Winner/loser from q39a
    winner_loser = case_when(
      as.integer(q39a) == 1 ~ "Winner",
      as.integer(q39a) == 2 ~ "Loser",
      TRUE ~ NA_character_
    ),
    
    # Single item: 1,2 = procedural; 3,4 = substantive
    procedural_single = case_when(
      as.integer(q92) %in% c(1, 2) ~ 1L,
      as.integer(q92) %in% c(3, 4) ~ 0L,
      TRUE ~ NA_integer_
    ),
    
    # For comparability with 4-set battery, scale to 0-4
    procedural_index = procedural_single * 4,
    measure_type = "single_item"
  ) %>%
  filter(!is.na(winner_loser), !is.na(procedural_single)) %>%
  select(wave, wave_year, country_name, winner_loser, 
         procedural_single, procedural_index, measure_type)

cat("W2:", nrow(w2_processed), "observations\n")
cat("Countries:", paste(unique(w2_processed$country_name), collapse = ", "), "\n")
```

## Wave 3 (2010-2012)

4-set battery: q85-q88. Winner/loser from q33a.

```{r w3}
w3 <- readRDS(file.path(raw_data_dir, "w3.rds"))

w3_processed <- w3 %>%
  mutate(
    wave = "W3",
    wave_year = 2010,
    country_name = get_country_name(country),
    
    winner_loser = case_when(
      as.integer(q33a) == 1 ~ "Winner",
      as.integer(q33a) == 2 ~ "Loser",
      TRUE ~ NA_character_
    ),
    
    # 4-set battery
    set1_proc = recode_set1(as.integer(q85)),
    set2_proc = recode_set2(as.integer(q86)),
    set3_proc = recode_set3(as.integer(q87)),
    set4_proc = recode_set4(as.integer(q88)),
    
    procedural_index = set1_proc + set2_proc + set3_proc + set4_proc,
    procedural_single = if_else(procedural_index >= 2, 1L, 0L),
    measure_type = "four_set"
  ) %>%
  filter(!is.na(winner_loser), !is.na(procedural_index)) %>%
  select(wave, wave_year, country_name, winner_loser, 
         procedural_single, procedural_index, measure_type)

cat("W3:", nrow(w3_processed), "observations\n")
```

## Wave 4 (2014-2016)

4-set battery: q88-q91. Winner/loser from q34a.

```{r w4}
w4 <- readRDS(file.path(raw_data_dir, "w4.rds"))

w4_processed <- w4 %>%
  mutate(
    wave = "W4",
    wave_year = 2014,
    country_name = get_country_name(country),
    
    winner_loser = case_when(
      as.integer(q34a) == 1 ~ "Winner",
      as.integer(q34a) == 2 ~ "Loser",
      TRUE ~ NA_character_
    ),
    
    set1_proc = recode_set1(as.integer(q88)),
    set2_proc = recode_set2(as.integer(q89)),
    set3_proc = recode_set3(as.integer(q90)),
    set4_proc = recode_set4(as.integer(q91)),
    
    procedural_index = set1_proc + set2_proc + set3_proc + set4_proc,
    procedural_single = if_else(procedural_index >= 2, 1L, 0L),
    measure_type = "four_set"
  ) %>%
  filter(!is.na(winner_loser), !is.na(procedural_index)) %>%
  select(wave, wave_year, country_name, winner_loser, 
         procedural_single, procedural_index, measure_type)

cat("W4:", nrow(w4_processed), "observations\n")
```

## Wave 6 (2019-2022)

4-set battery: q85-q88. Winner/loser from q34a.

```{r w6}
w6 <- readRDS(file.path(raw_data_dir, "w6.rds"))

w6_processed <- w6 %>%
  mutate(
    wave = "W6",
    wave_year = 2020,
    country_name = get_country_name(country),
    
    winner_loser = case_when(
      as.integer(q34a) == 1 ~ "Winner",
      as.integer(q34a) == 2 ~ "Loser",
      TRUE ~ NA_character_
    ),
    
    set1_proc = recode_set1(as.integer(q85)),
    set2_proc = recode_set2(as.integer(q86)),
    set3_proc = recode_set3(as.integer(q87)),
    set4_proc = recode_set4(as.integer(q88)),
    
    procedural_index = set1_proc + set2_proc + set3_proc + set4_proc,
    procedural_single = if_else(procedural_index >= 2, 1L, 0L),
    measure_type = "four_set"
  ) %>%
  filter(!is.na(winner_loser), !is.na(procedural_index)) %>%
  select(wave, wave_year, country_name, winner_loser, 
         procedural_single, procedural_index, measure_type)

cat("W6:", nrow(w6_processed), "observations\n")
```

# Combine All Waves

```{r combine}
combined <- bind_rows(w2_processed, w3_processed, w4_processed, w6_processed)

cat("\n=== COMBINED DATASET ===\n")
cat("Total observations:", nrow(combined), "\n")
cat("Waves:", paste(unique(combined$wave), collapse = ", "), "\n")
cat("Countries:", n_distinct(combined$country_name), "\n")
cat("Years: 2005-2022 (17 years)\n")
```

# Summary Statistics

```{r summary}
# By wave
combined %>%
  group_by(wave, wave_year) %>%
  summarise(
    n = n(),
    n_winner = sum(winner_loser == "Winner"),
    n_loser = sum(winner_loser == "Loser"),
    pct_procedural = round(mean(procedural_single) * 100, 1),
    .groups = "drop"
  ) %>%
  knitr::kable(caption = "Sample by Wave")

# By country
combined %>%
  count(country_name, wave) %>%
  pivot_wider(names_from = wave, values_from = n, values_fill = 0) %>%
  mutate(total = W2 + W3 + W4 + W6) %>%
  arrange(desc(total)) %>%
  knitr::kable(caption = "Sample by Country and Wave")
```

# Save Analysis Dataset

```{r save}
# Save combined dataset
saveRDS(combined, file.path(output_dir, "winner_loser_4waves.rds"))

# Also save to analysis root for manuscript access
saveRDS(combined, here("papers", "meaning-of-democracy", "analysis", "winner_loser_4waves.rds"))

cat("\nSaved to:", output_dir, "\n")
```

# Variable Codebook

| Variable | Description |
|----------|-------------|
| `wave` | Survey wave (W2, W3, W4, W6) |
| `wave_year` | Approximate midpoint year of fieldwork |
| `country_name` | Country name |
| `winner_loser` | Electoral status: "Winner" or "Loser" |
| `procedural_single` | Binary: 1 = procedural, 0 = substantive |
| `procedural_index` | 0-4 scale (W3/W4/W6) or 0/4 (W2) |
| `measure_type` | "single_item" (W2) or "four_set" (W3/W4/W6) |

# Notes

- **W2 uses a different measure**: Single forced-choice item (q92) vs. 4-set battery in later waves. The `procedural_single` variable harmonizes across waves for comparability.

- **Winner/loser coding**: Based on self-reported vote for winning vs. losing party/candidate in most recent national election.

- **Missing data**: Observations with missing winner/loser status or procedural measure are excluded.
