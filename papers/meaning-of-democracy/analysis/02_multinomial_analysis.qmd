---
title: "Multinomial Logit Analysis"
subtitle: "Meaning of Democracy Paper (Revised)"
author: "Jeffrey Stark"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: show
    df-print: paged
execute:
  warning: false
  message: false
---

# Overview

This script estimates multinomial logit models for each question set, then extracts
marginal effects of loser status on the probability of choosing each item.

**Approach:**
- 4 multinomial logits for W3/W4/W6 (one per question set)
- 1 multinomial logit for W2 (baseline validation)
- Convert to average marginal effects (AMEs) for interpretation
- No arbitrary binary coding—patterns emerge from the data

# Setup

```{r setup}
library(tidyverse)
library(nnet)        # multinom()
library(margins)     # marginal effects
library(broom)       # tidy model output
library(knitr)
library(kableExtra)
library(here)

here::i_am("papers/meaning-of-democracy/analysis/02_multinomial_analysis.qmd")

# Load prepared data
data_dir <- here("papers", "meaning-of-democracy", "analysis", "revised", "data")
results_dir <- here("papers", "meaning-of-democracy", "analysis", "revised", "results")
if (!dir.exists(results_dir)) dir.create(results_dir, recursive = TRUE)

w2_data <- readRDS(file.path(data_dir, "w2_baseline.rds"))
w346_data <- readRDS(file.path(data_dir, "w346_main.rds"))
item_meta <- readRDS(file.path(data_dir, "item_metadata.rds"))

# Bootstrap iterations (use 999 for final production run)
n_boot <- 999  # Final run with full bootstrap iterations
cat("Bootstrap iterations:", n_boot, "\n")
```

# Helper Functions

```{r helpers}
# Extract marginal effects from multinomial logit
# Returns AME of 'loser' on probability of each choice
get_loser_ames <- function(model, data) {
  # Get predicted probabilities for each observation
  probs_all <- predict(model, type = "probs")
  
  # Create counterfactual datasets
  data_loser <- data_winner <- data
  data_loser$loser <- 1
  data_winner$loser <- 0
  
  # Predict under each counterfactual
  probs_loser <- predict(model, newdata = data_loser, type = "probs")
  probs_winner <- predict(model, newdata = data_winner, type = "probs")
  
  # AME = mean difference in predicted probability
  ames <- colMeans(probs_loser - probs_winner)
  
  return(ames)
}

# Bootstrap standard errors for AMEs using cluster/block bootstrap
# Resamples countries (clusters) rather than individual observations
# This properly accounts for within-country correlation
bootstrap_ames <- function(model_formula, data, n_boot = 500, seed = 42, cluster_var = "country_name") {
  set.seed(seed)

  # Fit original model to get choice levels
  orig_model <- multinom(model_formula, data = data, trace = FALSE)
  choice_levels <- colnames(predict(orig_model, type = "probs"))

  # Get unique clusters
  clusters <- unique(data[[cluster_var]])
  n_clusters <- length(clusters)

  # Bootstrap
  boot_ames <- matrix(NA, nrow = n_boot, ncol = length(choice_levels))
  colnames(boot_ames) <- choice_levels

  for (i in 1:n_boot) {
    # Cluster bootstrap: resample clusters with replacement
    boot_clusters <- sample(clusters, n_clusters, replace = TRUE)

    # Build bootstrap dataset by binding all observations from selected clusters
    boot_data <- do.call(rbind, lapply(seq_along(boot_clusters), function(j) {
      data[data[[cluster_var]] == boot_clusters[j], ]
    }))

    # Fit model
    boot_model <- tryCatch(
      multinom(model_formula, data = boot_data, trace = FALSE),
      error = function(e) NULL
    )

    if (!is.null(boot_model)) {
      boot_ames[i, ] <- get_loser_ames(boot_model, boot_data)
    }
  }

  # Calculate SEs
  ses <- apply(boot_ames, 2, sd, na.rm = TRUE)

  return(ses)
}

# Format results into a nice table
format_ame_results <- function(ames, ses, item_labels, set_name) {
  tibble(
    set = set_name,
    item = names(ames),
    item_label = item_labels,
    ame = ames,
    se = ses,
    z = ames / ses,
    p = 2 * pnorm(-abs(z)),
    ci_low = ames - 1.96 * ses,
    ci_high = ames + 1.96 * ses,
    ame_pct = sprintf("%+.1f", ames * 100),
    sig = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      p < 0.10 ~ "†",
      TRUE ~ ""
    )
  )
}
```

# Main Analysis: W3/W4/W6

## Set 1: Gap, Elections, Waste, Expression

```{r set1-model}
# Filter to valid Set 1 responses
set1_data <- w346_data %>%
  filter(set1_valid) %>%
  filter(!is.na(age), !is.na(female), !is.na(education), !is.na(urban)) %>%
  mutate(
    choice = set1_choice,
    country_f = factor(country_name),
    wave_f = factor(wave_label)
  )

cat("Set 1 N:", nrow(set1_data), "\n")
cat("Choice distribution:\n")
print(table(set1_data$choice))

# Multinomial logit with demographic controls plus country and wave FEs
set1_model <- multinom(
  choice ~ loser + age + female + education + urban + country_f + wave_f,
  data = set1_data,
  trace = FALSE
)

cat("\nModel summary:\n")
summary(set1_model)
```

```{r set1-ames}
# Get AMEs
set1_ames <- get_loser_ames(set1_model, set1_data)
cat("\nLoser AMEs (Set 1):\n")
print(round(set1_ames, 4))

# Bootstrap SEs using cluster bootstrap (resampling countries)
cat("\nCluster bootstrapping SEs (", n_boot, " iterations)...\n")
set1_ses <- bootstrap_ames(
  choice ~ loser + age + female + education + urban + country_f + wave_f,
  data = set1_data,
  n_boot = n_boot,
  cluster_var = "country_name"
)

# Format results
set1_labels <- c("Reduce gap rich/poor", "Free elections", "No waste", "Free expression")
set1_results <- format_ame_results(set1_ames, set1_ses, set1_labels, "Set1")

cat("\n=== SET 1 RESULTS ===\n")
set1_results %>%
  select(item_label, ame_pct, se, p, sig) %>%
  kable(digits = 3, caption = "Loser effect on item choice probability (Set 1)")
```

## Set 2: Oversight, Necessities, Organize, Services

```{r set2-model}
set2_data <- w346_data %>%
  filter(set2_valid) %>%
  filter(!is.na(age), !is.na(female), !is.na(education), !is.na(urban)) %>%
  mutate(
    choice = set2_choice,
    country_f = factor(country_name),
    wave_f = factor(wave_label)
  )

cat("Set 2 N:", nrow(set2_data), "\n")

set2_model <- multinom(
  choice ~ loser + age + female + education + urban + country_f + wave_f,
  data = set2_data,
  trace = FALSE
)

set2_ames <- get_loser_ames(set2_model, set2_data)
set2_ses <- bootstrap_ames(
  choice ~ loser + age + female + education + urban + country_f + wave_f,
  data = set2_data,
  n_boot = n_boot,
  cluster_var = "country_name"
)

set2_labels <- c("Legislature oversight", "Basic necessities", "Organize groups", "Quality services")
set2_results <- format_ame_results(set2_ames, set2_ses, set2_labels, "Set2")

cat("\n=== SET 2 RESULTS ===\n")
set2_results %>%
  select(item_label, ame_pct, se, p, sig) %>%
  kable(digits = 3, caption = "Loser effect on item choice probability (Set 2)")
```

## Set 3: Law/Order, Media, Jobs, Parties

```{r set3-model}
set3_data <- w346_data %>%
  filter(set3_valid) %>%
  filter(!is.na(age), !is.na(female), !is.na(education), !is.na(urban)) %>%
  mutate(
    choice = set3_choice,
    country_f = factor(country_name),
    wave_f = factor(wave_label)
  )

cat("Set 3 N:", nrow(set3_data), "\n")

set3_model <- multinom(
  choice ~ loser + age + female + education + urban + country_f + wave_f,
  data = set3_data,
  trace = FALSE
)

set3_ames <- get_loser_ames(set3_model, set3_data)
set3_ses <- bootstrap_ames(
  choice ~ loser + age + female + education + urban + country_f + wave_f,
  data = set3_data,
  n_boot = n_boot,
  cluster_var = "country_name"
)

set3_labels <- c("Law and order", "Media freedom", "Jobs for all", "Party competition")
set3_results <- format_ame_results(set3_ames, set3_ses, set3_labels, "Set3")

cat("\n=== SET 3 RESULTS ===\n")
set3_results %>%
  select(item_label, ame_pct, se, p, sig) %>%
  kable(digits = 3, caption = "Loser effect on item choice probability (Set 3)")
```

## Set 4: Protest, Corruption, Courts, Unemployment

```{r set4-model}
set4_data <- w346_data %>%
  filter(set4_valid) %>%
  filter(!is.na(age), !is.na(female), !is.na(education), !is.na(urban)) %>%
  mutate(
    choice = set4_choice,
    country_f = factor(country_name),
    wave_f = factor(wave_label)
  )

cat("Set 4 N:", nrow(set4_data), "\n")

set4_model <- multinom(
  choice ~ loser + age + female + education + urban + country_f + wave_f,
  data = set4_data,
  trace = FALSE
)

set4_ames <- get_loser_ames(set4_model, set4_data)
set4_ses <- bootstrap_ames(
  choice ~ loser + age + female + education + urban + country_f + wave_f,
  data = set4_data,
  n_boot = n_boot,
  cluster_var = "country_name"
)

set4_labels <- c("Protest freedom", "Clean politics", "Court protection", "Unemployment aid")
set4_results <- format_ame_results(set4_ames, set4_ses, set4_labels, "Set4")

cat("\n=== SET 4 RESULTS ===\n")
set4_results %>%
  select(item_label, ame_pct, se, p, sig) %>%
  kable(digits = 3, caption = "Loser effect on item choice probability (Set 4)")
```

# Baseline Validation: W2

```{r w2-model}
w2_analysis <- w2_data %>%
  filter(!is.na(age), !is.na(female), !is.na(education), !is.na(urban)) %>%
  mutate(
    choice = dem_choice,
    country_f = factor(country_name)
  )

cat("W2 N:", nrow(w2_analysis), "\n")
cat("Choice distribution:\n")
print(table(w2_analysis$choice))

# W2 has no wave FE (single wave)
w2_model <- multinom(
  choice ~ loser + age + female + education + urban + country_f,
  data = w2_analysis,
  trace = FALSE
)

w2_ames <- get_loser_ames(w2_model, w2_analysis)
w2_ses <- bootstrap_ames(
  choice ~ loser + age + female + education + urban + country_f,
  data = w2_analysis,
  n_boot = n_boot,
  cluster_var = "country_name"
)

w2_labels <- c("Elections", "Criticize power", "Income equality", "Basic necessities")
w2_results <- format_ame_results(w2_ames, w2_ses, w2_labels, "W2")

cat("\n=== W2 BASELINE RESULTS ===\n")
w2_results %>%
  select(item_label, ame_pct, se, p, sig) %>%
  kable(digits = 3, caption = "Loser effect on item choice probability (W2 Baseline)")
```

# Combined Results

```{r combined-results}
# Combine all results
all_results <- bind_rows(
  set1_results,
  set2_results,
  set3_results,
  set4_results,
  w2_results
) %>%
  # Add item type from metadata
  left_join(
    item_meta %>% select(set, item_label, item_type, item_subtype),
    by = c("set", "item_label")
  )

# Verify metadata join succeeded (no missing types)
stopifnot(
  "Metadata join failed: some items have NA item_type" = !any(is.na(all_results$item_type)),
  "Metadata join failed: row count mismatch" = nrow(all_results) == 20
)

cat("\n=== ALL LOSER EFFECTS ===\n")
all_results %>%
  arrange(item_type, desc(ame)) %>%
  select(set, item_label, item_type, ame_pct, sig) %>%
  kable(caption = "Loser effect on choosing each item (percentage points)")
```

## Summary by Item Type

```{r summary-by-type}
# Summarize by procedural/substantive/governance
type_summary <- all_results %>%
  group_by(item_type) %>%
  summarise(
    n_items = n(),
    mean_ame = mean(ame),
    median_ame = median(ame),
    n_positive = sum(ame > 0),
    n_sig_positive = sum(ame > 0 & p < 0.05),
    n_sig_negative = sum(ame < 0 & p < 0.05),
    .groups = "drop"
  )

cat("\n=== SUMMARY BY ITEM TYPE ===\n")
type_summary %>%
  mutate(
    mean_ame_pct = sprintf("%+.2f", mean_ame * 100),
    pattern = paste0(n_positive, "/", n_items, " positive")
  ) %>%
  select(item_type, n_items, mean_ame_pct, pattern, n_sig_positive, n_sig_negative) %>%
  kable(caption = "Does the loser effect differ by item type?")
```

# Visualize Results

```{r plot-results, fig.width=10, fig.height=8}
# Coefficient plot
all_results %>%
  mutate(
    item_label = fct_reorder(item_label, ame),
    item_type = factor(item_type, levels = c("procedural", "substantive", "governance"))
  ) %>%
  ggplot(aes(x = ame * 100, y = item_label, color = item_type)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50") +
  geom_errorbarh(aes(xmin = ci_low * 100, xmax = ci_high * 100), height = 0.2) +
  geom_point(size = 3) +
  scale_color_manual(
    values = c("procedural" = "#2166AC", "substantive" = "#B2182B", "governance" = "#666666"),
    name = "Item Type"
  ) +
  labs(
    x = "Loser Effect (percentage points)",
    y = NULL,
    title = "Effect of Loser Status on Item Choice Probability",
    subtitle = "Positive = losers more likely to choose; Negative = winners more likely",
    caption = "Note: 95% confidence intervals from bootstrap (200 iterations)"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    panel.grid.minor = element_blank()
  )

ggsave(
  file.path(results_dir, "fig_loser_effects_all_items.png"),
  width = 10, height = 8, dpi = 300
)
ggsave(
  file.path(results_dir, "fig_loser_effects_all_items.pdf"),
  width = 10, height = 8
)
```

# Country-Wave Marginal Effects

This section estimates separate multinomial logit models for each country-wave combination to examine how the loser effect varies across contexts (H2) and over time within countries (H3). Results are saved for reproduction in the online appendix.

```{r country-wave-ames}
#| cache: true

# Get unique country-wave combinations
country_waves <- w346_data %>%
  distinct(country_name, wave_label, wave) %>%
  arrange(country_name, wave)

cat("Estimating country-wave models for", nrow(country_waves), "combinations...\n")
cat("Using", n_boot, "bootstrap iterations per model for SEs\n\n")

# Function to estimate model and extract AMEs with bootstrap SEs for a single country-wave-set
estimate_cw_ames_with_se <- function(data, set_num, n_boot = 100) {
  # Get the appropriate choice variable
  choice_var <- paste0("set", set_num, "_choice")
  valid_var <- paste0("set", set_num, "_valid")

  # Filter to valid responses for this set
  df <- data %>%
    filter(.data[[valid_var]]) %>%
    mutate(choice = .data[[choice_var]])

  # Need sufficient sample size and variation
  if (nrow(df) < 50) return(NULL)
  if (length(unique(df$loser)) < 2) return(NULL)
  if (length(unique(df$choice)) < 2) return(NULL)

  # Fit multinomial logit: choice ~ loser only (no demographic controls)
  # Justification: Small N per country-wave makes controls unreliable;
  # within-context estimation already accounts for country-wave heterogeneity
  model <- tryCatch(
    multinom(choice ~ loser, data = df, trace = FALSE),
    error = function(e) NULL
  )

  if (is.null(model)) return(NULL)

  # Get point estimates of AMEs
  ames <- tryCatch(
    get_loser_ames(model, df),
    error = function(e) NULL
  )

  if (is.null(ames)) return(NULL)

  # Bootstrap for standard errors
  boot_ames <- matrix(NA, nrow = n_boot, ncol = length(ames))
  colnames(boot_ames) <- names(ames)

  for (b in 1:n_boot) {
    boot_idx <- sample(nrow(df), replace = TRUE)
    boot_df <- df[boot_idx, ]

    # Check variation in bootstrap sample
    if (length(unique(boot_df$loser)) < 2) next
    if (length(unique(boot_df$choice)) < 2) next

    boot_model <- tryCatch(
      multinom(choice ~ loser, data = boot_df, trace = FALSE),
      error = function(e) NULL
    )

    if (!is.null(boot_model)) {
      boot_result <- tryCatch(
        get_loser_ames(boot_model, boot_df),
        error = function(e) NULL
      )
      if (!is.null(boot_result) && length(boot_result) == length(ames)) {
        boot_ames[b, ] <- boot_result
      }
    }
  }

  # Compute SEs from bootstrap
  ses <- apply(boot_ames, 2, sd, na.rm = TRUE)

  # Return as tibble with full inference
 tibble(
    item = names(ames),
    ame = as.numeric(ames),
    se = ses,
    z = ame / se,
    p = 2 * pnorm(-abs(z)),
    ci_low = ame - 1.96 * se,
    ci_high = ame + 1.96 * se,
    n = nrow(df),
    n_loser = sum(df$loser),
    pct_loser = mean(df$loser) * 100
  )
}

# Estimate for each country-wave and set
cw_results_list <- list()

for (i in 1:nrow(country_waves)) {
  cw <- country_waves[i, ]

  # Filter data for this country-wave
  cw_data <- w346_data %>%
    filter(country_name == cw$country_name, wave_label == cw$wave_label)

  # Estimate for each set
  for (set_num in 1:4) {
    result <- estimate_cw_ames_with_se(cw_data, set_num, n_boot = n_boot)

    if (!is.null(result)) {
      result <- result %>%
        mutate(
          country_name = cw$country_name,
          wave_label = cw$wave_label,
          wave = cw$wave,
          set = paste0("Set", set_num)
        )
      cw_results_list[[length(cw_results_list) + 1]] <- result
    }
  }

  if (i %% 5 == 0) cat("  Completed", i, "of", nrow(country_waves), "country-waves\n")
}

# Combine results
cw_ames <- bind_rows(cw_results_list)

# Add significance indicators
cw_ames <- cw_ames %>%
  mutate(
    sig = case_when(
      p < 0.001 ~ "***",
      p < 0.01 ~ "**",
      p < 0.05 ~ "*",
      p < 0.10 ~ "†",
      TRUE ~ ""
    ),
    ame_pct = sprintf("%+.1f", ame * 100)
  )

cat("\n=== COUNTRY-WAVE RESULTS SUMMARY ===\n")
cat("Total country-wave-set combinations:", nrow(cw_ames %>% distinct(country_name, wave_label, set)), "\n")
cat("Total item-level estimates:", nrow(cw_ames), "\n")
cat("Significant at p<0.05:", sum(cw_ames$p < 0.05, na.rm = TRUE), "items\n")
```

```{r cw-add-metadata}
# Add item metadata
cw_ames <- cw_ames %>%
  left_join(
    item_meta %>%
      filter(set %in% c("Set1", "Set2", "Set3", "Set4")) %>%
      select(set, value, item_label, item_type, item_subtype),
    by = c("set", "item" = "item_label")
  )

# Verify metadata join succeeded
n_missing_type <- sum(is.na(cw_ames$item_type))
stopifnot(
  "Country-wave metadata join failed: some items have NA item_type" = n_missing_type == 0
)
cat("Metadata join verified:", nrow(cw_ames), "items with valid types\n")

# Preview with significance
cat("\n=== SAMPLE OF COUNTRY-WAVE RESULTS (with inference) ===\n")
cw_ames %>%
  filter(country_name %in% c("Thailand", "South Korea")) %>%
  select(country_name, wave_label, set, item, item_type, ame_pct, sig, se, n) %>%
  mutate(se_pct = sprintf("%.1f", se * 100)) %>%
  head(20) %>%
  print()
```

## Country-Wave Summary: Procedural vs Substantive

```{r cw-summary-by-type}
# Summarize by country-wave and item type with significance counts
cw_type_summary <- cw_ames %>%
  group_by(country_name, wave_label, wave, item_type) %>%
  summarise(
    mean_ame = mean(ame, na.rm = TRUE),
    mean_se = mean(se, na.rm = TRUE),
    n_items = n(),
    n_sig = sum(p < 0.05, na.rm = TRUE),
    mean_n = mean(n, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from = item_type,
    values_from = c(mean_ame, mean_se, n_items, n_sig, mean_n),
    names_sep = "_"
  )

cat("\n=== COUNTRY-WAVE SUMMARY BY ITEM TYPE ===\n")
cw_type_summary %>%
  mutate(
    procedural = sprintf("%+.1f (%.1f)", mean_ame_procedural * 100, mean_se_procedural * 100),
    substantive = sprintf("%+.1f (%.1f)", mean_ame_substantive * 100, mean_se_substantive * 100),
    governance = sprintf("%+.1f (%.1f)", mean_ame_governance * 100, mean_se_governance * 100)
  ) %>%
  select(country_name, wave_label, procedural, substantive, governance) %>%
  arrange(country_name, wave_label) %>%
  print(n = 50)
```

## Country Trajectories

```{r cw-trajectories}
# Calculate overall procedural-substantive gap for each country-wave with SEs
cw_gap <- cw_ames %>%
  group_by(country_name, wave_label, wave, item_type) %>%
  summarise(
    mean_ame = mean(ame, na.rm = TRUE),
    # Aggregate variance: sum of squared SEs / n^2
    se_agg = sqrt(sum(se^2, na.rm = TRUE)) / n(),
    n_items = n(),
    n_sig = sum(p < 0.05, na.rm = TRUE),
    mean_n = mean(n, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from = item_type,
    values_from = c(mean_ame, se_agg, n_items, n_sig, mean_n),
    names_sep = "_"
  ) %>%
  mutate(
    # Procedural - Substantive gap (positive = losers more procedural)
    proc_sub_gap = mean_ame_procedural - mean_ame_substantive,
    # SE of difference (assuming independence)
    proc_sub_gap_se = sqrt(se_agg_procedural^2 + se_agg_substantive^2),
    proc_sub_gap_ci_low = proc_sub_gap - 1.96 * proc_sub_gap_se,
    proc_sub_gap_ci_high = proc_sub_gap + 1.96 * proc_sub_gap_se
  )

# Countries with multiple waves
multi_wave_countries <- cw_gap %>%
  group_by(country_name) %>%
  filter(n() >= 2) %>%
  ungroup()

cat("\n=== COUNTRY TRAJECTORIES (Procedural - Substantive Gap) ===\n")
cat("Positive = losers favor procedural more than substantive\n")
cat("Format: Gap (SE)\n\n")

multi_wave_countries %>%
  mutate(gap_pct = sprintf("%+.1f (%.1f)", proc_sub_gap * 100, proc_sub_gap_se * 100)) %>%
  select(country_name, wave_label, gap_pct) %>%
  pivot_wider(names_from = wave_label, values_from = gap_pct) %>%
  print()
```

## Trajectory Plot

```{r cw-trajectory-plot, fig.width=12, fig.height=8}
# Plot trajectories for countries with 3+ waves (with confidence bands)
trajectory_countries <- multi_wave_countries %>%
  group_by(country_name) %>%
  filter(n() >= 3) %>%
  ungroup()

if (nrow(trajectory_countries) > 0) {
  p <- ggplot(trajectory_countries, aes(x = wave, y = proc_sub_gap * 100,
                                    color = country_name, fill = country_name,
                                    group = country_name)) +
    geom_ribbon(aes(ymin = proc_sub_gap_ci_low * 100, ymax = proc_sub_gap_ci_high * 100),
                alpha = 0.2, color = NA) +
    geom_line(linewidth = 1) +
    geom_point(size = 3) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
    scale_x_continuous(breaks = c(3, 4, 6), labels = c("W3\n(2011)", "W4\n(2015)", "W6\n(2022)")) +
    labs(
      x = "Wave",
      y = "Loser Effect Gap (pp)\n(Procedural − Substantive)",
      title = "Country Trajectories: How the Loser Effect Changes Over Time",
      subtitle = "Shaded regions show 95% confidence intervals",
      color = "Country",
      fill = "Country"
    ) +
    theme_minimal() +
    theme(
      legend.position = "right",
      panel.grid.minor = element_blank()
    )

  print(p)
  ggsave(file.path(results_dir, "fig_country_trajectories.png"), width = 12, height = 8, dpi = 300)
  ggsave(file.path(results_dir, "fig_country_trajectories.pdf"), width = 12, height = 8)
}
```

## Key Country Deep Dives

```{r thailand-trajectory}
cat("\n=== THAILAND TRAJECTORY ===\n")
cw_ames %>%
  filter(country_name == "Thailand") %>%
  group_by(wave_label, item_type) %>%
  summarise(
    mean_ame = mean(ame, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(ame_pct = sprintf("%+.1f", mean_ame * 100)) %>%
  pivot_wider(names_from = item_type, values_from = ame_pct) %>%
  print()
```

```{r korea-trajectory}
cat("\n=== SOUTH KOREA TRAJECTORY ===\n")
cw_ames %>%
  filter(country_name == "South Korea") %>%
  group_by(wave_label, item_type) %>%
  summarise(
    mean_ame = mean(ame, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(ame_pct = sprintf("%+.1f", mean_ame * 100)) %>%
  pivot_wider(names_from = item_type, values_from = ame_pct) %>%
  print()
```

## Item-Level Trajectory Plots

Create publication-ready trajectory plots highlighting key countries with different patterns:
- **Thailand**: Rising gap (democratization under pressure)
- **South Korea**: Falling/stable gap (consolidated democracy)
- **Taiwan, Japan**: Flat/moderate gap (stable democracies)

```{r trajectory-item-plots, fig.width=14, fig.height=10}
# Select focal countries with 3+ waves and interesting patterns
focal_countries <- c("Thailand", "South Korea", "Taiwan", "Japan",
                     "Philippines", "Indonesia", "Mongolia")

# Filter to focal countries with sufficient data
trajectory_data <- cw_ames %>%
  filter(country_name %in% focal_countries) %>%
  group_by(country_name) %>%
  filter(n_distinct(wave) >= 2) %>%
  ungroup()

if (nrow(trajectory_data) > 0) {
  # Create item-level trajectory plot by item type
  p_items <- ggplot(trajectory_data,
                    aes(x = wave, y = ame * 100, color = item_type, group = item)) +
    geom_line(alpha = 0.5, linewidth = 0.8) +
    geom_point(size = 2, alpha = 0.7) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
    facet_wrap(~country_name, ncol = 4) +
    scale_x_continuous(breaks = c(3, 4, 6), labels = c("W3", "W4", "W6")) +
    scale_color_manual(
      values = c("procedural" = "#2166AC", "substantive" = "#B2182B", "governance" = "#4DAF4A"),
      labels = c("Procedural", "Substantive", "Governance")
    ) +
    labs(
      x = "Wave",
      y = "Loser Effect (pp)",
      title = "Item-Level Loser Effects Across Waves",
      subtitle = "Blue = Procedural items (losers favor more); Red = Substantive items (winners favor more)",
      color = "Item Type"
    ) +
    theme_minimal() +
    theme(
      legend.position = "bottom",
      panel.grid.minor = element_blank(),
      strip.text = element_text(face = "bold", size = 11)
    )

  print(p_items)
  ggsave(file.path(results_dir, "fig_item_trajectories_by_country.png"),
         width = 14, height = 10, dpi = 300)
  ggsave(file.path(results_dir, "fig_item_trajectories_by_country.pdf"),
         width = 14, height = 10)
}
```

```{r highlight-country-plot, fig.width=12, fig.height=8}
# Highlight plot: Thailand vs South Korea contrasting patterns
highlight_countries <- c("Thailand", "South Korea", "Taiwan", "Japan")

highlight_data <- cw_gap %>%
  filter(country_name %in% highlight_countries) %>%
  mutate(
    pattern = case_when(
      country_name == "Thailand" ~ "Rising (Thailand)",
      country_name == "South Korea" ~ "Stable (South Korea)",
      country_name == "Taiwan" ~ "Flat (Taiwan)",
      country_name == "Japan" ~ "Moderate (Japan)"
    )
  )

if (nrow(highlight_data) > 0) {
  p_highlight <- ggplot(highlight_data,
                        aes(x = wave, y = proc_sub_gap * 100,
                            color = country_name, linetype = country_name)) +
    geom_ribbon(aes(ymin = proc_sub_gap_ci_low * 100,
                    ymax = proc_sub_gap_ci_high * 100,
                    fill = country_name),
                alpha = 0.15, color = NA) +
    geom_line(linewidth = 1.5) +
    geom_point(size = 4) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "gray50", linewidth = 0.8) +
    scale_x_continuous(breaks = c(3, 4, 6),
                       labels = c("Wave 3\n(2011)", "Wave 4\n(2015)", "Wave 6\n(2022)")) +
    scale_color_manual(values = c(
      "Thailand" = "#D62728",    # Red - rising
      "South Korea" = "#1F77B4", # Blue - stable
      "Taiwan" = "#2CA02C",      # Green - flat
      "Japan" = "#9467BD"        # Purple - moderate
    )) +
    scale_fill_manual(values = c(
      "Thailand" = "#D62728",
      "South Korea" = "#1F77B4",
      "Taiwan" = "#2CA02C",
      "Japan" = "#9467BD"
    )) +
    scale_linetype_manual(values = c(
      "Thailand" = "solid",
      "South Korea" = "solid",
      "Taiwan" = "dashed",
      "Japan" = "dashed"
    )) +
    labs(
      x = NULL,
      y = "Loser Effect Gap (pp)\n(Procedural − Substantive)",
      title = "Diverging Trajectories: How Loser Effects Change Over Time",
      subtitle = "Positive gap = losers favor procedural items more than substantive\n95% confidence intervals shown",
      color = "Country",
      fill = "Country",
      linetype = "Country"
    ) +
    theme_minimal(base_size = 14) +
    theme(
      legend.position = "right",
      legend.title = element_text(face = "bold"),
      panel.grid.minor = element_blank(),
      plot.title = element_text(face = "bold", size = 16),
      axis.text.x = element_text(size = 12)
    )

  print(p_highlight)
  ggsave(file.path(results_dir, "fig_highlight_country_trajectories.png"),
         width = 12, height = 8, dpi = 300)
  ggsave(file.path(results_dir, "fig_highlight_country_trajectories.pdf"),
         width = 12, height = 8)
}

cat("\n=== HIGHLIGHT COUNTRIES: PROC-SUB GAP ===\n")
highlight_data %>%
  select(country_name, wave_label, proc_sub_gap, proc_sub_gap_se) %>%
  mutate(
    gap_pct = sprintf("%+.1f (%.1f)", proc_sub_gap * 100, proc_sub_gap_se * 100)
  ) %>%
  select(country_name, wave_label, gap_pct) %>%
  pivot_wider(names_from = wave_label, values_from = gap_pct) %>%
  print()
```

# Save Results

```{r save-results}
# Save all results
results_list <- list(
  # Pooled results
  all_results = all_results,
  type_summary = type_summary,
  w2_results = w2_results,
  set1_results = set1_results,
  set2_results = set2_results,
  set3_results = set3_results,
  set4_results = set4_results,
  item_metadata = item_meta,
  # Country-wave results
  country_wave_ames = cw_ames,
  country_wave_type_summary = cw_type_summary,
  country_wave_gap = cw_gap,
  # Models (pooled only - country-wave models not saved due to size)
  models = list(
    w2 = w2_model,
    set1 = set1_model,
    set2 = set2_model,
    set3 = set3_model,
    set4 = set4_model
  )
)

saveRDS(results_list, file.path(results_dir, "mlogit_results.rds"))
cat("\nResults saved to:", file.path(results_dir, "mlogit_results.rds"), "\n")

# Save CSVs for easy viewing and online appendix
write_csv(all_results, file.path(results_dir, "loser_effects_all_items.csv"))
cat("CSV saved to:", file.path(results_dir, "loser_effects_all_items.csv"), "\n")

# Country-wave results for online appendix (with full inference)
cw_ames_export <- cw_ames %>%
  select(
    country_name, wave_label, wave, set, item, item_type, item_subtype,
    ame, se, z, p, ci_low, ci_high, sig, ame_pct,
    n, n_loser, pct_loser
  ) %>%
  arrange(country_name, wave, set, item)

write_csv(cw_ames_export, file.path(results_dir, "country_wave_item_ames.csv"))
cat("CSV saved to:", file.path(results_dir, "country_wave_item_ames.csv"), "\n")

write_csv(cw_type_summary, file.path(results_dir, "country_wave_type_summary.csv"))
cat("CSV saved to:", file.path(results_dir, "country_wave_type_summary.csv"), "\n")

# Gap file with CIs
cw_gap_export <- cw_gap %>%
  select(
    country_name, wave_label, wave,
    mean_ame_procedural, mean_ame_substantive, mean_ame_governance,
    se_agg_procedural, se_agg_substantive, se_agg_governance,
    proc_sub_gap, proc_sub_gap_se, proc_sub_gap_ci_low, proc_sub_gap_ci_high,
    n_items_procedural, n_items_substantive, n_items_governance,
    n_sig_procedural, n_sig_substantive, n_sig_governance
  ) %>%
  arrange(country_name, wave)

write_csv(cw_gap_export, file.path(results_dir, "country_wave_proc_sub_gap.csv"))
cat("CSV saved to:", file.path(results_dir, "country_wave_proc_sub_gap.csv"), "\n")

cat("\n=== FILES FOR ONLINE APPENDIX ===\n")
cat("1. loser_effects_all_items.csv - Pooled AMEs for all 20 items\n")
cat("2. country_wave_item_ames.csv - Item-level AMEs by country-wave\n")
cat("3. country_wave_type_summary.csv - Type-level summary by country-wave\n")
cat("4. country_wave_proc_sub_gap.csv - Procedural-Substantive gap by country-wave\n")
cat("5. fig_loser_effects_all_items.pdf - Coefficient plot (pooled)\n")
cat("6. fig_country_trajectories.pdf - Country trajectory plot\n")
```

# Interpretation Guide

## Expected Pattern (if theory is correct)

**Procedural items** (losers should choose MORE):
- Elections, Party competition (electoral path back to power)
- Free expression, Media freedom, Protest, Organize groups (protect opposition voice)
- Legislature oversight, Court protection (constrain winners)

**Substantive items** (winners should choose MORE):
- Reduce gap, Income equality (redistribution from power)
- Basic necessities, Jobs, Unemployment aid (welfare delivery)

**Governance items** (unclear prediction):
- No waste, Quality services, Law and order, Clean politics
- These might appeal to both sides, or neither

## What to report

If the pattern holds:
> "Across 16 items in four question sets, losers are systematically more likely to choose items related to elections (+X pp), civil liberties (+Y pp), and accountability mechanisms (+Z pp). Winners are more likely to choose items related to economic equality (−A pp) and welfare provision (−B pp). This pattern emerges without any ex ante coding decisions—the data reveal that losers and winners conceptualize democracy differently."
