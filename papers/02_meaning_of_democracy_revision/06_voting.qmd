---
title: "Voting Behavior Analysis"
subtitle: "Meaning of Democracy Paper"
author: "Jeffrey Stark"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: show
    df-print: paged
execute:
  warning: false
  message: false
---

# Overview

This script analyzes voting behavior using harmonized Asian Barometer data. Key variables:

- `voted_last_election`: Whether respondent voted (0=No, 1=Yes)
- `voted_winning_losing`: Winner/loser status (1=Winner, 2=Loser)

# Setup

```{r setup}
library(tidyverse)
library(here)

here::i_am("papers/02_meaning_of_democracy_revision/06_voting.qmd")

# Master dataset (from survey-data-prep repo)
source(here("_data_config.R"))
master_file <- abs_harmonized_path
```

# Load Data

```{r load}
abs <- readRDS(master_file)

cat("Master dataset:", nrow(abs), "rows,", ncol(abs), "columns\n")
cat("Waves:", paste(sort(unique(abs$wave)), collapse = ", "), "\n")
```

# Helper Functions

```{r helpers}
# Country name lookup
get_country_name <- function(code) {
  code <- as.integer(code)
  case_when(
    code == 1 ~ "Japan",
    code == 2 ~ "Hong Kong",
    code == 3 ~ "South Korea",
    code == 4 ~ "China",
    code == 5 ~ "Mongolia",
    code == 6 ~ "Philippines",
    code == 7 ~ "Taiwan",
    code == 8 ~ "Thailand",
    code == 9 ~ "Indonesia",
    code == 10 ~ "Singapore",
    code == 11 ~ "Vietnam",
    code == 12 ~ "Cambodia",
    code == 13 ~ "Malaysia",
    code == 14 ~ "Myanmar",
    code == 15 ~ "Australia",
    code == 18 ~ "India",
    TRUE ~ NA_character_
  )
}
```

# Check Voting Variables

```{r check-vars}
cat("=== VOTING VARIABLES CHECK ===\n\n")

# voted_last_election
cat("voted_last_election:\n")
cat("  Scale: 0=No, 1=Yes\n")
cat("  Values:", paste(sort(unique(abs$voted_last_election[!is.na(abs$voted_last_election)])), collapse = ", "), "\n")
cat("  Distribution by wave:\n")
abs %>%
  group_by(wave) %>%
  summarise(
    n = n(),
    voted = sum(voted_last_election == 1, na.rm = TRUE),
    not_voted = sum(voted_last_election == 0, na.rm = TRUE),
    missing = sum(is.na(voted_last_election)),
    pct_voted = round(100 * voted / (voted + not_voted), 1)
  ) %>%
  print()

cat("\n")

# voted_winning_losing
cat("voted_winning_losing:\n")
cat("  Scale: 1=Winner, 2=Loser\n")
cat("  Values:", paste(sort(unique(abs$voted_winning_losing[!is.na(abs$voted_winning_losing)])), collapse = ", "), "\n")
cat("  Distribution by wave:\n")
abs %>%
  group_by(wave) %>%
  summarise(
    n = n(),
    winner = sum(voted_winning_losing == 1, na.rm = TRUE),
    loser = sum(voted_winning_losing == 2, na.rm = TRUE),
    missing = sum(is.na(voted_winning_losing))
  ) %>%
  print()
```

# Process Voting Data

The harmonized dataset already contains properly coded voting variables:

- `voted_last_election`: 0=No, 1=Yes (NA for not eligible, proxy voting, missing)
- `voted_winning_losing`: 1=Winner, 2=Loser (only for those who voted)

We derive additional variables conditional on having voted:

```{r process}
voting_data <- abs %>%
  mutate(
    # Country name
    country_name = get_country_name(country),

    # Use harmonized voted variable directly (already 0=No, 1=Yes)
    voted = voted_last_election,

    # Winner/loser status - only for those who voted
    # Recode to 0=Loser, 1=Winner for analysis convenience
    voted_winner = if_else(
      voted == 1,
      case_when(
        voted_winning_losing == 1 ~ 1L,  # Winner
        voted_winning_losing == 2 ~ 0L,  # Loser
        TRUE ~ NA_integer_
      ),
      NA_integer_
    ),

    # Winner/loser as character label
    winner_loser = if_else(
      voted == 1,
      case_when(
        voted_winning_losing == 1 ~ "Winner",
        voted_winning_losing == 2 ~ "Loser",
        TRUE ~ NA_character_
      ),
      NA_character_
    )
  ) %>%
  filter(!is.na(country_name))

cat("=== PROCESSED VOTING DATA ===\n")
cat("Total observations:", nrow(voting_data), "\n")
```

# Voting Summary by Wave

```{r summary-wave}
cat("=== VOTING PARTICIPATION BY WAVE ===\n")
voting_data %>%
  group_by(wave) %>%
  summarise(
    n = n(),
    voted_yes = sum(voted == 1, na.rm = TRUE),
    voted_no = sum(voted == 0, na.rm = TRUE),
    voted_na = sum(is.na(voted)),
    pct_voted = round(100 * voted_yes / (voted_yes + voted_no), 1),
    .groups = "drop"
  ) %>%
  knitr::kable(caption = "Voting Participation by Wave")
```

# Winner/Loser Summary

```{r summary-winner}
cat("=== WINNER/LOSER STATUS BY WAVE ===\n")
voting_data %>%
  filter(voted == 1) %>%
  group_by(wave) %>%
  summarise(
    n_voters = n(),
    n_winner = sum(voted_winner == 1, na.rm = TRUE),
    n_loser = sum(voted_winner == 0, na.rm = TRUE),
    n_unknown = sum(is.na(voted_winner)),
    pct_winner = round(100 * n_winner / (n_winner + n_loser), 1),
    .groups = "drop"
  ) %>%
  knitr::kable(caption = "Winner/Loser Status Among Voters by Wave")
```

# Voting by Country

```{r summary-country}
cat("=== VOTING PARTICIPATION BY COUNTRY ===\n")
voting_data %>%
  group_by(country_name) %>%
  summarise(
    n = n(),
    voted_yes = sum(voted == 1, na.rm = TRUE),
    voted_no = sum(voted == 0, na.rm = TRUE),
    pct_voted = round(100 * voted_yes / (voted_yes + voted_no), 1),
    .groups = "drop"
  ) %>%
  arrange(desc(pct_voted)) %>%
  knitr::kable(caption = "Voting Participation by Country")
```

# Winner/Loser by Country

```{r winner-country}
cat("=== WINNER/LOSER STATUS BY COUNTRY ===\n")
voting_data %>%
  filter(voted == 1, !is.na(voted_winner)) %>%
  group_by(country_name) %>%
  summarise(
    n_voters = n(),
    n_winner = sum(voted_winner == 1),
    n_loser = sum(voted_winner == 0),
    pct_winner = round(100 * n_winner / n_voters, 1),
    .groups = "drop"
  ) %>%
  arrange(desc(pct_winner)) %>%
  knitr::kable(caption = "Winner/Loser Status Among Voters by Country")
```

# Variable Codebook

| Variable | Description | Values | Source |
|----------|-------------|--------|--------|
| `voted` | Did respondent vote in last election | 0=No, 1=Yes | `voted_last_election` |
| `voted_winner` | Did respondent vote for winning party/candidate | 0=Loser, 1=Winner | `voted_winning_losing` (recoded) |
| `winner_loser` | Winner/loser as text label | "Winner", "Loser" | `voted_winning_losing` |
| `country_name` | Country name | Text | `country` (recoded) |

# Data Notes

## Source Variables (Harmonized)

- **voted_last_election**: Harmonized across waves
  - W1: q027 (reversed: 1=No, 2=Yes in original)
  - W2: q38 (reversed: 1=No, 2=Yes in original)
  - W3: q32
  - W4: q33
  - W5: q33
  - W6: q33 (includes proxy voting codes 1103, 1104 in Vietnam → NA)

- **voted_winning_losing**: Winner/loser status (W2-W6 only)
  - W2: q39a
  - W3: q33a
  - W4: q34a
  - W5: q34a
  - W6: q34a

## Recoding Applied

The harmonization pipeline applies:

1. **voted_last_election**:
   - W1/W2: Reversed (1=No→0, 2=Yes→1)
   - W3-W6: Standard (1=Yes→1, 2=No→0)
   - "Not eligible", "proxy voting" (W6: 1103, 1104) → NA

2. **voted_winner** (derived here):
   - Only calculated for respondents who voted (voted == 1)
   - Winner (original=1) → 1
   - Loser (original=2) → 0
   - Non-voters → NA
