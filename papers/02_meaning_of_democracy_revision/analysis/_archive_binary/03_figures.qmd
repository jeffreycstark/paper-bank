---
title: "Figures"
subtitle: "Publication-Quality Visualizations"
author: "Jeffrey Stark"
date: today
format:
  html:
    toc: true
    code-fold: true
execute:
  warning: false
  message: false
---

# Overview

This script generates publication-quality figures for the paper. All figures are saved in both PNG (300 dpi) and PDF formats.

# Setup

```{r setup}
library(tidyverse)
library(here)
library(patchwork)

here::i_am("papers/02_meaning_of_democracy_revision/analysis/03_figures.qmd")

# Directories
fig_dir <- here("papers", "meaning-of-democracy", "figures")
data_dir <- here("papers", "meaning-of-democracy", "analysis", "data")

if (!dir.exists(fig_dir)) dir.create(fig_dir, recursive = TRUE)

# Load analysis data
df <- readRDS(file.path(data_dir, "winner_loser_4waves.rds"))

# Create country-wave summary with minimum n filter
by_country_wave <- df %>%
  group_by(country_name, wave, wave_year) %>%
  filter(n() >= 50) %>%
  summarise(
    n = n(),
    pct_winner = round(sum(winner_loser == "Winner") / n() * 100, 1),
    pct_proc_winner = mean(procedural_single[winner_loser == "Winner"]) * 100,
    pct_proc_loser = mean(procedural_single[winner_loser == "Loser"]) * 100,
    loser_effect = round(pct_proc_loser - pct_proc_winner, 1),
    .groups = "drop"
  )

# Countries with 3+ waves
countries_3plus <- by_country_wave %>%
  count(country_name) %>%
  filter(n >= 3) %>%
  pull(country_name)

# Set global theme
theme_set(theme_minimal(base_size = 12))

# Color palette
colors <- c(
  "Thailand" = "#E63946",
  "South Korea" = "#1D3557",
  "Taiwan" = "#457B9D",
  "Philippines" = "#2A9D8F",
  "Mongolia" = "#E9C46A",
  "Japan" = "#F4A261",
  "Hong Kong" = "#9B5DE5",
  "China" = "#00BBF9",
  "Vietnam" = "#00F5D4",
  "Malaysia" = "#F15BB5",
  "Cambodia" = "#7B68EE",
  "Indonesia" = "#FF6B6B",
  "Singapore" = "#4ECDC4"
)

cat("Data loaded.\n")
cat("Countries with 3+ waves:", paste(countries_3plus, collapse = ", "), "\n")
```

# Figure 1: Thailand Trajectory

The hero figure showing Thailand's dramatic arc from 2006-2020 (if Thailand data available).

```{r fig-thailand}
#| fig-width: 10
#| fig-height: 6
#| fig-cap: "Thailand: As Democracy Eroded, Losers Embraced Procedural Values"

thailand <- by_country_wave %>%
  filter(country_name == "Thailand") %>%
  arrange(wave_year)

if (nrow(thailand) > 0) {
  # Event labels
  events <- tibble(
    wave_year = thailand$wave_year,
    label = case_when(
      wave_year == 2006 ~ "Post-2006\ncoup",
      wave_year == 2010 ~ "Democrat\ngovt",
      wave_year == 2014 ~ "2014\nCOUP",
      wave_year == 2020 ~ "Military-\nbacked",
      TRUE ~ ""
    )
  )
  
  fig1 <- ggplot(thailand, aes(x = wave_year, y = loser_effect)) +
    # Zero reference
    geom_hline(yintercept = 0, linetype = "dashed", color = "gray50", linewidth = 0.5) +
    # Area fill
    geom_area(alpha = 0.3, fill = "#E63946") +
    # Line and points
    geom_line(linewidth = 1.2, color = "#E63946") +
    geom_point(size = 4, color = "#E63946") +
    # Event labels above points
    geom_text(data = events,
              aes(y = max(thailand$loser_effect) + 3, label = label),
              size = 3, lineheight = 0.9) +
    # Value labels below points
    geom_text(aes(label = paste0(ifelse(loser_effect > 0, "+", ""), loser_effect, " pp")),
              vjust = 2.5, size = 3.5, fontface = "bold") +
    # Scales
    scale_x_continuous(
      breaks = thailand$wave_year,
      labels = paste0(thailand$wave_year, "\n(", thailand$wave, ")")
    ) +
    scale_y_continuous(limits = c(min(thailand$loser_effect) - 5, max(thailand$loser_effect) + 8),
                       breaks = seq(-10, 30, 5)) +
    # Labels
    labs(
      x = NULL,
      y = "Loser Effect (percentage points)",
      caption = "Loser effect = % losers procedural − % winners procedural\nData: Asian Barometer Survey"
    ) +
    theme(
      plot.caption = element_text(color = "gray50", size = 9, hjust = 0),
      panel.grid.minor = element_blank(),
      panel.grid.major.x = element_blank()
    )
  
  print(fig1)
  
  ggsave(file.path(fig_dir, "fig1_thailand_trajectory.png"), fig1,
         width = 10, height = 6, dpi = 300, bg = "white")
  ggsave(file.path(fig_dir, "fig1_thailand_trajectory.pdf"), fig1,
         width = 10, height = 6, bg = "white")
  
  cat("Thailand figure saved.\n")
} else {
  cat("Thailand data not available - skipping Figure 1.\n")
}
```

# Figure 2: Thailand Dual Panel

Shows both the loser effect and % winners over time (if Thailand data available).

```{r fig-thailand-dual}
#| fig-width: 9
#| fig-height: 8
#| fig-cap: "Thailand: Democratic Erosion in Two Metrics"

if (nrow(thailand) > 0) {
  # Top panel: Loser Effect
  p1 <- ggplot(thailand, aes(x = wave_year)) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
    geom_area(aes(y = loser_effect), alpha = 0.3, fill = "#E63946") +
    geom_line(aes(y = loser_effect), linewidth = 1.2, color = "#E63946") +
    geom_point(aes(y = loser_effect), size = 4, color = "#E63946") +
    geom_text(aes(y = loser_effect, 
                  label = paste0(ifelse(loser_effect > 0, "+", ""), loser_effect)),
              vjust = -1.5, fontface = "bold", color = "#E63946") +
    scale_x_continuous(breaks = thailand$wave_year) +
    scale_y_continuous(limits = c(min(thailand$loser_effect) - 3, max(thailand$loser_effect) + 5)) +
    labs(y = "Percentage points", title = "Loser Effect") +
    theme(plot.title = element_text(color = "#E63946", face = "bold"))
  
  # Bottom panel: % Winners
  p2 <- ggplot(thailand, aes(x = wave_year)) +
    geom_area(aes(y = pct_winner), alpha = 0.3, fill = "#457B9D") +
    geom_line(aes(y = pct_winner), linewidth = 1.2, color = "#457B9D") +
    geom_point(aes(y = pct_winner), size = 4, color = "#457B9D") +
    geom_text(aes(y = pct_winner, label = paste0(round(pct_winner), "%")),
              vjust = -1.5, fontface = "bold", color = "#457B9D") +
    scale_x_continuous(
      breaks = thailand$wave_year,
      labels = paste0(thailand$wave_year, "\n(", thailand$wave, ")")
    ) +
    scale_y_continuous(limits = c(0, 105)) +
    labs(y = "Percent", title = "% Identifying as Electoral Winners") +
    theme(plot.title = element_text(color = "#457B9D", face = "bold"))
  
  fig2 <- p1 / p2 +
    plot_annotation(
      subtitle = "As fewer citizens 'won' elections, losers increasingly valued procedural democracy",
      caption = "Data: Asian Barometer Survey"
    )
  
  print(fig2)
  
  ggsave(file.path(fig_dir, "fig2_thailand_dual.png"), fig2,
         width = 9, height = 8, dpi = 300, bg = "white")
  ggsave(file.path(fig_dir, "fig2_thailand_dual.pdf"), fig2,
         width = 9, height = 8, bg = "white")
  
  cat("Thailand dual panel saved.\n")
} else {
  cat("Thailand data not available - skipping Figure 2.\n")
}
```

# Figure 3: Multi-Country Trajectories

All countries with 3+ waves, highlighting key cases.

```{r fig-multicountry}
#| fig-width: 12
#| fig-height: 7
#| fig-cap: "Trajectories of the Loser Effect Across Asia"

multi <- by_country_wave %>%
  filter(country_name %in% countries_3plus)

if (nrow(multi) > 0) {
  # Identify highlight countries (if present)
  highlight_countries <- intersect(c("Thailand", "South Korea"), unique(multi$country_name))
  other_countries <- setdiff(unique(multi$country_name), highlight_countries)
  
  fig3 <- ggplot(multi, aes(x = wave_year, y = loser_effect, 
                             color = country_name, group = country_name)) +
    # Zero reference
    geom_hline(yintercept = 0, linetype = "dashed", color = "gray50")
  
  # Add other countries (faded)
  if (length(other_countries) > 0) {
    fig3 <- fig3 +
      geom_line(data = filter(multi, country_name %in% other_countries),
                linewidth = 0.8, alpha = 0.4) +
      geom_point(data = filter(multi, country_name %in% other_countries),
                 size = 2, alpha = 0.4)
  }
  
  # Add highlighted countries
  if ("Thailand" %in% highlight_countries) {
    fig3 <- fig3 +
      geom_line(data = filter(multi, country_name == "Thailand"),
                linewidth = 1.8, color = "#E63946") +
      geom_point(data = filter(multi, country_name == "Thailand"),
                 size = 4, color = "#E63946")
  }
  
  if ("South Korea" %in% highlight_countries) {
    fig3 <- fig3 +
      geom_line(data = filter(multi, country_name == "South Korea"),
                linewidth = 1.5, color = "#1D3557") +
      geom_point(data = filter(multi, country_name == "South Korea"),
                 size = 3.5, color = "#1D3557")
  }
  
  # Add end labels
  fig3 <- fig3 +
    geom_text(data = multi %>% group_by(country_name) %>% 
                filter(wave_year == max(wave_year)),
              aes(label = country_name), hjust = -0.1, size = 3) +
    scale_color_manual(values = colors) +
    scale_x_continuous(breaks = unique(multi$wave_year), 
                       limits = c(min(multi$wave_year) - 1, max(multi$wave_year) + 4)) +
    labs(
      x = NULL,
      y = "Loser Effect (percentage points)",
      caption = "Data: Asian Barometer Survey. Countries with 3+ waves shown."
    ) +
    theme(
      legend.position = "none",
      panel.grid.minor = element_blank()
    )
  
  print(fig3)
  
  ggsave(file.path(fig_dir, "fig3_multicountry_trajectory.png"), fig3,
         width = 12, height = 7, dpi = 300, bg = "white")
  ggsave(file.path(fig_dir, "fig3_multicountry_trajectory.pdf"), fig3,
         width = 12, height = 7, bg = "white")
  
  cat("Multi-country trajectory saved.\n")
} else {
  cat("No countries with 3+ waves - skipping Figure 3.\n")
}
```

# Figure 4: Wave-Level Bar Chart

Pooled loser effect by wave with significance indicators.

```{r fig-wave-bar}
#| fig-width: 9
#| fig-height: 5
#| fig-cap: "The Loser Effect Over Time: Pooled Across Countries"

# Calculate wave-level statistics
wave_summary <- df %>%
  group_by(wave, wave_year) %>%
  summarise(
    n = n(),
    loser_pct = mean(procedural_single[winner_loser == "Loser"]) * 100,
    winner_pct = mean(procedural_single[winner_loser == "Winner"]) * 100,
    loser_effect = loser_pct - winner_pct,
    p_value = chisq.test(table(winner_loser, procedural_single))$p.value,
    .groups = "drop"
  ) %>%
  mutate(
    significant = p_value < 0.05,
    wave_label = paste0(wave, "\n", wave_year)
  )

fig4 <- ggplot(wave_summary, aes(x = wave_label, y = loser_effect, fill = significant)) +
  geom_hline(yintercept = 0, color = "gray30") +
  geom_col(width = 0.6, alpha = 0.9) +
  geom_text(aes(label = paste0(ifelse(loser_effect > 0, "+", ""), round(loser_effect, 1), " pp"),
                vjust = ifelse(loser_effect > 0, -0.5, 1.5)),
            fontface = "bold") +
  geom_text(aes(label = paste0("n=", format(n, big.mark = ",")), 
                y = min(loser_effect) - 1.5),
            size = 3, color = "gray50") +
  scale_fill_manual(values = c("TRUE" = "#2A9D8F", "FALSE" = "#E76F51"),
                    labels = c("TRUE" = "Significant (p < 0.05)", 
                               "FALSE" = "Not significant")) +
  scale_y_continuous(limits = c(min(wave_summary$loser_effect) - 2.5, 
                                max(wave_summary$loser_effect) + 2)) +
  labs(
    x = NULL,
    y = "Loser Effect (percentage points)",
    fill = NULL,
    caption = "Loser effect = % losers procedural − % winners procedural"
  ) +
  theme(
    legend.position = "top",
    panel.grid.major.x = element_blank()
  )

print(fig4)

ggsave(file.path(fig_dir, "fig4_wave_losereffect.png"), fig4,
       width = 9, height = 5, dpi = 300, bg = "white")
ggsave(file.path(fig_dir, "fig4_wave_losereffect.pdf"), fig4,
       width = 9, height = 5, bg = "white")

cat("Wave bar chart saved.\n")
```

# Figure 5: Slope Chart (First to Last Wave)

```{r fig-slope}
#| fig-width: 10
#| fig-height: 7
#| fig-cap: "Change in Loser Effect: First to Last Wave"

if (length(countries_3plus) > 0) {
  slope_data <- by_country_wave %>%
    filter(country_name %in% countries_3plus) %>%
    group_by(country_name) %>%
    arrange(wave_year) %>%
    summarise(
      early = first(loser_effect),
      late = last(loser_effect),
      early_year = first(wave_year),
      late_year = last(wave_year),
      .groups = "drop"
    ) %>%
    mutate(
      change = late - early,
      direction = if_else(change > 0, "Increased", "Decreased")
    )
  
  fig5 <- slope_data %>%
    pivot_longer(cols = c(early, late), names_to = "period", values_to = "value") %>%
    mutate(period = factor(period, levels = c("early", "late"),
                           labels = c("First Wave", "Last Wave"))) %>%
    ggplot(aes(x = period, y = value, group = country_name, color = direction)) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
    geom_line(linewidth = 1, alpha = 0.7) +
    geom_point(size = 3) +
    geom_text(data = . %>% filter(period == "Last Wave"),
              aes(label = paste0(country_name, " (", 
                                 ifelse(slope_data$change[match(country_name, slope_data$country_name)] > 0, "+", ""),
                                 round(slope_data$change[match(country_name, slope_data$country_name)], 1), ")")),
              hjust = -0.05, size = 3) +
    scale_color_manual(values = c("Increased" = "#E63946", "Decreased" = "#457B9D")) +
    scale_x_discrete(expand = expansion(mult = c(0.1, 0.4))) +
    labs(
      x = NULL,
      y = "Loser Effect (percentage points)",
      color = NULL,
      caption = "Countries with 3+ waves. Change shown in parentheses."
    ) +
    theme(
      legend.position = "top",
      panel.grid.major.x = element_blank()
    )
  
  print(fig5)
  
  ggsave(file.path(fig_dir, "fig5_slope_change.png"), fig5,
         width = 10, height = 7, dpi = 300, bg = "white")
  ggsave(file.path(fig_dir, "fig5_slope_change.pdf"), fig5,
         width = 10, height = 7, bg = "white")
  
  cat("Slope chart saved.\n")
} else {
  cat("No countries with 3+ waves - skipping Figure 5.\n")
}
```

# Figure 6: Heatmap of Loser Effect by Country × Wave

```{r fig-heatmap}
#| fig-width: 10
#| fig-height: 8
#| fig-cap: "Loser Effect Across Countries and Waves"

# Create complete grid
all_countries <- unique(by_country_wave$country_name)
all_waves <- unique(by_country_wave$wave)

heatmap_data <- by_country_wave %>%
  select(country_name, wave, loser_effect)

fig6 <- ggplot(heatmap_data, aes(x = wave, y = reorder(country_name, loser_effect), 
                                   fill = loser_effect)) +
  geom_tile(color = "white", linewidth = 0.5) +
  geom_text(aes(label = ifelse(!is.na(loser_effect), 
                               paste0(ifelse(loser_effect > 0, "+", ""), round(loser_effect, 0)),
                               "")),
            size = 3, fontface = "bold",
            color = ifelse(abs(heatmap_data$loser_effect) > 15, "white", "black")) +
  scale_fill_gradient2(
    low = "#457B9D", mid = "white", high = "#E63946",
    midpoint = 0,
    na.value = "gray90",
    name = "Loser Effect\n(pp)"
  ) +
  labs(
    x = NULL,
    y = NULL,
    caption = "Values show loser effect in percentage points.\nGray cells = insufficient data (n < 50)."
  ) +
  theme(
    panel.grid = element_blank(),
    axis.text.y = element_text(size = 10),
    legend.position = "right"
  )

print(fig6)

ggsave(file.path(fig_dir, "fig6_heatmap.png"), fig6,
       width = 10, height = 8, dpi = 300, bg = "white")
ggsave(file.path(fig_dir, "fig6_heatmap.pdf"), fig6,
       width = 10, height = 8, bg = "white")

cat("Heatmap saved.\n")
```

# Summary

```{r summary}
cat("\n=== FIGURES SAVED ===\n")
cat("Directory:", fig_dir, "\n\n")

saved_files <- list.files(fig_dir, pattern = "\\.(png|pdf)$")
cat("Files:\n")
for (f in sort(saved_files)) {
  cat("  -", f, "\n")
}
```

# Figure Descriptions for Paper

| Figure | Description | Use |
|--------|-------------|-----|
| fig1_thailand_trajectory | Thailand's 17-year arc showing loser effect growth | Hero figure for democratic backsliding narrative |
| fig2_thailand_dual | Thailand dual panel (loser effect + % winners) | Shows mechanism: fewer winners → larger effect |
| fig3_multicountry_trajectory | All countries with 3+ waves | Comparative trajectories |
| fig4_wave_losereffect | Pooled loser effect by wave | Overview of temporal pattern |
| fig5_slope_change | First-to-last wave changes | Summary of country-level change |
| fig6_heatmap | Country × wave matrix | Complete data visualization |
