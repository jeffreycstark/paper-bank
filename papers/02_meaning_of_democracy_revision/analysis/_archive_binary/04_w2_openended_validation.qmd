---
title: "W2 Open-Ended Democracy Coding"
subtitle: "Validation of Procedural vs Substantive Classification"
author: "Jeffrey Stark"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: show
    df-print: paged
execute:
  warning: false
  message: false
---

# Overview

This script codes Wave 2 open-ended democracy responses (q91_1, q91_2, q91_3) as procedural vs substantive, and validates against the 4-point forced-choice item (q92). This addresses reviewer concerns about measurement validity by demonstrating convergent validity between the closed-ended measure and open-ended conceptions.

# Setup

```{r setup}
library(tidyverse)
library(haven)
library(here)

here::i_am("papers/02_meaning_of_democracy_revision/analysis/04_w2_openended_validation.qmd")

# Output directory
output_dir <- here("papers", "meaning-of-democracy", "analysis", "data")
if (!dir.exists(output_dir)) dir.create(output_dir, recursive = TRUE)

# Wave 2 raw data
w2_file <- here("data", "raw", "wave2", "Wave2_20250609.sav")
```

# Coding Scheme

We classify open-ended response codes into three categories based on conceptual distinctions from the democracy literature:

## Procedural Codes (n = 64)

Emphasize institutional processes, rights, and constraints on government:

- **Popular sovereignty** (100-134): How government derives authority from the people
- **Anti-authoritarian** (140-142): Absence of dictatorship, repression
- **Liberal freedoms** (200-218): Speech, press, association, belief, etc.
- **Political equality** (220-223): Equal voting rights, equality before law
- **Democratic institutions** (230-241): Elections, parliament, rule of law
- **Participation** (250-263): Voting, voice, civil society

## Substantive Codes (n = 55)

Emphasize governance outcomes, welfare, and responsive government:

- **Economic arrangements** (300-340): Free markets, welfare, jobs, prosperity
- **Social equality outcomes** (320-329): Justice, fraternity, equal opportunity
- **Good governance** (400-453): Honest, responsive, efficient government

## Excluded Codes (n = 85)

Neither procedural nor substantive (excluded from analysis):

- **Individual behaviors** (500s): Personal style, duties, tolerance
- **Abstract concepts** (600s): Nationalism, harmony, world peace
- **Preconditions** (700s): Gradualism, education level requirements
- **Evaluative statements** (800s): "Democracy is good/bad"
- **Country/figure references** (900s): Mentions of specific countries/figures

# Define Code Mappings

```{r code-mappings}
# PROCEDURAL: processes, institutions, constraints, rights, freedoms
procedural_codes <- c(
  # Popular sovereignty / government of-by-for people (mechanism-focused)
  100, 110, 111, 120, 121, 122, 130, 131, 132, 133, 134,
  # Absence of non-democratic arrangements
  140, 141, 142,
  # Liberal elements header
  200, 201,
  # Freedoms and civil liberties (constraints on government)
  202, 203, 210, 211, 212, 213, 214, 215, 216, 217, 218,
  # Political equality
  220, 221, 222, 223,
  # Democratic institutions and processes
  230, 231, 232, 233, 234, 235, 236, 237, 238, 239, 240, 241,
  # Participation and citizen empowerment
  250, 251, 252, 253, 254, 255, 256,
  # Social pluralism and civil society
  260, 261, 262, 263
)

# SUBSTANTIVE: outcomes, welfare, performance, responsive governance
substantive_codes <- c(
  # Economic system header
  300,
  # Free economy (outcome-focused)
  310, 311, 312, 313, 314, 316, 317, 318,
  # Equality, justice, fraternity (outcomes)
  320, 321, 322, 323, 324, 325, 326, 327, 328, 329,
  # Socio-economic performance
  330, 331, 332, 333, 334, 335, 336, 337, 338, 339, 340,
  # Good governance header
  400,
  # Good governance outcomes
  410, 411, 412, 413, 414, 415, 416, 418, 419,
  # Social stability and order (outcomes)
  420, 421,
  # Reform
  430, 431, 432,
  # Leadership quality (outcome-focused)
  440, 441, 443, 444, 445, 447, 448, 451, 452, 453
)

# EXCLUDED: individual behaviors, abstract, preconditions, evaluative
excluded_codes <- c(
  # Individual behaviors
  500, 510, 511, 512, 513, 514, 515, 516, 517, 518, 519,
  520, 521, 522, 523, 530, 531, 532, 533, 534, 535, 536, 537, 538, 540,
  # Abstract/nationalist
  600, 610, 611, 612, 620, 621, 622, 623, 624, 625, 626,
  630, 631, 632, 633, 634, 635, 636, 640, 641, 642, 650, 651, 652, 660,
  # Preconditions
  700, 710, 711, 712, 713, 721, 722, 723, 724, 725,
  # Evaluative (positive/negative appraisals)
  810, 811, 812, 813, 814, 820, 821, 822, 823, 824, 825, 826, 827, 828, 829,
  830, 831, 832, 833, 834, 835, 836, 837, 840, 850,
  # Country/figure references
  910, 911, 912, 920, 921, 922
)

cat("Code counts:\n")
cat("  Procedural:", length(procedural_codes), "\n")
cat("  Substantive:", length(substantive_codes), "\n")
cat("  Excluded:", length(excluded_codes), "\n")
```

# Coding Functions

```{r coding-functions}
# Convert to numeric: procedural = 1, substantive = 0, excluded = NA
code_to_numeric <- function(response_code) {
  case_when(
    response_code %in% procedural_codes ~ 1,
    response_code %in% substantive_codes ~ 0,
    TRUE ~ NA_real_
  )
}
```

# Load and Process Wave 2 Data

```{r load-data}
# Load Wave 2 data
w2 <- read_sav(w2_file)

# Standardize column names to lowercase
names(w2) <- tolower(names(w2))

cat("Wave 2 dataset:", nrow(w2), "rows,", ncol(w2), "columns\n")
cat("\nQ91 variables found:", paste(grep("q91", names(w2), value = TRUE), collapse = ", "), "\n")
cat("Q92 variable found:", "q92" %in% names(w2), "\n")
```

# Apply Coding

```{r apply-coding}
# Code each of the three responses
w2_coded <- w2 %>%
  mutate(
    # Code each response
    dem_code1 = code_to_numeric(q91_1),
    dem_code2 = code_to_numeric(q91_2),
    dem_code3 = code_to_numeric(q91_3),

    # Count valid (non-NA) responses
    n_valid_responses = rowSums(!is.na(across(c(dem_code1, dem_code2, dem_code3)))),

    # Count procedural responses
    n_procedural = rowSums(across(c(dem_code1, dem_code2, dem_code3), ~ . == 1), na.rm = TRUE),

    # Proportion procedural (continuous: 0, 0.33, 0.5, 0.67, 1)
    procedural_proportion = case_when(
      n_valid_responses == 0 ~ NA_real_,
      TRUE ~ n_procedural / n_valid_responses
    ),

    # Binary version (>0.5 threshold = procedural)
    democracy_binary = case_when(
      is.na(procedural_proportion) ~ NA_real_,
      procedural_proportion > 0.5 ~ 1,
      procedural_proportion < 0.5 ~ 0,
      procedural_proportion == 0.5 ~ NA_real_  # Ties excluded
    ),

    # Q92 procedural indicator for validation
    q92_procedural = case_when(
      q92 == 1 ~ 1,  # elections = procedural
      q92 == 2 ~ 1,  # criticize = procedural
      q92 == 3 ~ 0,  # income gap = substantive
      q92 == 4 ~ 0,  # basic needs = substantive
      TRUE ~ NA_real_
    )
  )
```

# Distribution of Procedural Proportion

```{r distribution}
w2_coded %>%
  filter(!is.na(procedural_proportion)) %>%
  count(procedural_proportion) %>%
  mutate(
    pct = round(n / sum(n) * 100, 1),
    interpretation = case_when(
      procedural_proportion == 0 ~ "All substantive",
      procedural_proportion == 1 ~ "All procedural",
      procedural_proportion == 0.5 ~ "Mixed (tie)",
      procedural_proportion < 0.5 ~ "Majority substantive",
      procedural_proportion > 0.5 ~ "Majority procedural"
    )
  ) %>%
  knitr::kable(caption = "Distribution of Procedural Proportion Scores")
```

# Number of Valid Responses per Person

```{r response-count}
w2_coded %>%
  filter(n_valid_responses > 0) %>%
  count(n_valid_responses) %>%
  mutate(pct = round(n / sum(n) * 100, 1)) %>%
  knitr::kable(caption = "Number of Codeable Responses per Respondent")
```

# Validation Against Q92 (4-Point Item)

## Correlation Analysis

```{r correlation}
cor_result <- cor.test(
  w2_coded$procedural_proportion,
  w2_coded$q92_procedural,
  use = "complete.obs"
)

cat("Pearson correlation between open-ended proportion and Q92 procedural:\n")
cat("  r =", round(cor_result$estimate, 3), "\n")
cat("  t =", round(cor_result$statistic, 2), "\n")
cat("  df =", cor_result$parameter, "\n")
cat("  p <", format.pval(cor_result$p.value, digits = 3), "\n")
cat("  95% CI: [", round(cor_result$conf.int[1], 3), ",", round(cor_result$conf.int[2], 3), "]\n")
```

## Mean Procedural Proportion by Q92 Response

```{r by-q92}
w2_coded %>%
  filter(!is.na(procedural_proportion) & !is.na(q92) & q92 %in% 1:4) %>%
  mutate(
    q92_label = case_when(
      q92 == 1 ~ "1: Elections",
      q92 == 2 ~ "2: Criticize",
      q92 == 3 ~ "3: Income gap",
      q92 == 4 ~ "4: Basic needs"
    ),
    q92_type = if_else(q92 %in% c(1, 2), "Procedural", "Substantive")
  ) %>%
  group_by(q92_label, q92_type) %>%
  summarise(
    n = n(),
    mean_procedural = round(mean(procedural_proportion), 3),
    sd = round(sd(procedural_proportion), 3),
    .groups = "drop"
  ) %>%
  knitr::kable(caption = "Mean Open-Ended Procedural Proportion by Q92 Response")
```

## Cross-Tabulation (Binary Measures)

```{r crosstab}
w2_coded %>%
  filter(!is.na(democracy_binary) & !is.na(q92_procedural)) %>%
  mutate(
    openended = if_else(democracy_binary == 1, "Procedural", "Substantive"),
    q92 = if_else(q92_procedural == 1, "Procedural", "Substantive")
  ) %>%
  count(openended, q92) %>%
  pivot_wider(names_from = q92, values_from = n, names_prefix = "Q92: ") %>%
  knitr::kable(caption = "Cross-Tabulation: Open-Ended Binary vs Q92 Binary")
```

# Validation Plot

```{r validation-plot}
#| fig-width: 8
#| fig-height: 6
#| label: fig-validation
#| fig-cap: "Validation of open-ended coding against 4-point forced-choice item (Q92). Boxplots show the distribution of procedural proportion scores from open-ended responses, grouped by Q92 response. Respondents choosing procedural options on Q92 (elections, criticize) show higher mean procedural proportions in their open-ended responses."

p <- w2_coded %>%
  filter(!is.na(procedural_proportion) & !is.na(q92) & q92 %in% 1:4) %>%
  mutate(
    q92_label = case_when(
      q92 == 1 ~ "1: Elections\n(Procedural)",
      q92 == 2 ~ "2: Criticize\n(Procedural)",
      q92 == 3 ~ "3: Income gap\n(Substantive)",
      q92 == 4 ~ "4: Basic needs\n(Substantive)"
    ),
    q92_label = factor(q92_label, levels = c(
      "1: Elections\n(Procedural)",
      "2: Criticize\n(Procedural)",
      "3: Income gap\n(Substantive)",
      "4: Basic needs\n(Substantive)"
    ))
  ) %>%
  ggplot(aes(x = q92_label, y = procedural_proportion, fill = q92_label)) +
  geom_boxplot(alpha = 0.7, outlier.alpha = 0.3) +
  scale_fill_manual(values = c(
    "1: Elections\n(Procedural)" = "#2166ac",
    "2: Criticize\n(Procedural)" = "#67a9cf",
    "3: Income gap\n(Substantive)" = "#ef8a62",
    "4: Basic needs\n(Substantive)" = "#b2182b"
  )) +
  labs(
    x = "Q92: 4-Point Democracy Item",
    y = "Proportion Procedural (Open-Ended)",
    title = "Validation: Open-Ended Coding vs. 4-Point Item",
    subtitle = sprintf("Correlation r = %.3f, p < 0.001 (N = %s)",
                       cor_result$estimate,
                       format(cor_result$parameter + 2, big.mark = ","))
  ) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(size = 10),
    panel.grid.minor = element_blank()
  ) +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray50", alpha = 0.7)

print(p)

# Save plot
ggsave(
  here("papers", "meaning-of-democracy", "figures", "validation_openended_vs_q92.png"),
  p, width = 8, height = 6, dpi = 300
)
```

# Country-Level Summary

```{r country-summary}
# Country name lookup
get_country_name <- function(code) {
  code <- as.integer(code)
  case_when(
    code == 1 ~ "Japan",
    code == 3 ~ "South Korea",
    code == 4 ~ "China",
    code == 5 ~ "Mongolia",
    code == 6 ~ "Philippines",
    code == 7 ~ "Taiwan",
    code == 8 ~ "Thailand",
    code == 9 ~ "Indonesia",
    code == 10 ~ "Singapore",
    code == 11 ~ "Vietnam",
    code == 12 ~ "Cambodia",
    code == 13 ~ "Malaysia",
    TRUE ~ paste0("Country ", code)
  )
}

country_summary <- w2_coded %>%
  filter(!is.na(procedural_proportion)) %>%
  mutate(country_name = get_country_name(country)) %>%
  group_by(country_name) %>%
  summarise(
    n = n(),
    mean_procedural = round(mean(procedural_proportion), 3),
    sd = round(sd(procedural_proportion), 3),
    pct_binary_procedural = round(mean(democracy_binary, na.rm = TRUE) * 100, 1),
    .groups = "drop"
  ) %>%
  arrange(desc(mean_procedural))

knitr::kable(
  country_summary,
  caption = "Country-Level Summary: Open-Ended Procedural Proportion (Wave 2)",
  col.names = c("Country", "N", "Mean Procedural", "SD", "% Procedural (Binary)")
)
```

# Save Results

```{r save}
# Save coded dataset (key variables only)
w2_export <- w2_coded %>%
  select(
    country,
    q91_1, q91_2, q91_3,
    q92, q92_procedural,
    dem_code1, dem_code2, dem_code3,
    n_valid_responses, n_procedural,
    procedural_proportion, democracy_binary
  )

saveRDS(w2_export, file.path(output_dir, "w2_openended_coded.rds"))
write_csv(country_summary, file.path(output_dir, "w2_openended_country_summary.csv"))

cat("Saved:\n")
cat("  - w2_openended_coded.rds (", nrow(w2_export), " rows)\n")
cat("  - w2_openended_country_summary.csv (", nrow(country_summary), " countries)\n")
```

# Summary

## Key Findings

1. **Convergent validity confirmed**: The open-ended procedural proportion correlates positively with the Q92 procedural indicator (r = `r round(cor_result$estimate, 3)`, p < 0.001), demonstrating that respondents who choose procedural options on the forced-choice item also tend to provide procedural open-ended responses.

2. **Distribution**: `r round(mean(w2_coded$procedural_proportion >= 0.5, na.rm = TRUE) * 100, 1)`% of respondents with valid open-ended responses gave majority-procedural answers.

3. **Country variation**: Thailand (`r country_summary$mean_procedural[country_summary$country_name == "Thailand"]`) and Philippines (`r country_summary$mean_procedural[country_summary$country_name == "Philippines"]`) show highest procedural orientation; Japan (`r country_summary$mean_procedural[country_summary$country_name == "Japan"]`) and Mongolia (`r country_summary$mean_procedural[country_summary$country_name == "Mongolia"]`) show lowest.

## Methods Text

> To supplement the single 4-point democracy conception item, we coded respondents' open-ended responses to "What does democracy mean to you?" (Q91) as procedural or substantive. Following [cite], procedural conceptions emphasize institutional processes, rights, and constraints (e.g., elections, civil liberties, rule of law), while substantive conceptions emphasize governance outcomes and welfare (e.g., economic performance, responsive government, social equality).
>
> Respondents could provide up to three responses. We calculated a proportion score reflecting the share of valid responses coded as procedural (range: 0-1). Responses falling into neither category (e.g., evaluative statements, abstract concepts) were excluded from the calculation. For binary analyses, respondents with proportion scores >0.5 were classified as procedural; those <0.5 as substantive; ties (0.5) were excluded.
>
> The proportion score correlated with the 4-point item at r = `r round(cor_result$estimate, 2)`, p < .001, suggesting adequate convergent validity.
