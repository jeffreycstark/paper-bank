---
title: "Three-Way Loser Decomposition"
subtitle: "Winner vs Key Opposition vs Other Loser"
author: "Jeffrey Stark"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: true
    df-print: paged
execute:
  warning: false
  message: false
---

```{r setup}
library(tidyverse)
library(here)
library(knitr)
library(kableExtra)

here::i_am("papers/02_meaning_of_democracy_revision/analysis/revised/08_threeway_decomposition.qmd")

# Output directory
output_dir <- here("papers", "meaning-of-democracy-revision", "analysis", "revised", "results")
if (!dir.exists(output_dir)) dir.create(output_dir, recursive = TRUE)

# Load master data (from survey-data-prep repo)
source(here("_data_config.R"))
abs <- readRDS(abs_harmonized_path)

# Load three-way vote coding from archive
vote_3way <- readRDS(here("papers", "meaning-of-democracy-revision", "analysis",
                          "_archive_binary", "data", "vote_winner_opposition.rds"))

# Item metadata
item_meta <- readRDS(here("papers", "meaning-of-democracy-revision", "analysis",
                          "data", "item_metadata.rds"))

# Country codes for the three coded countries
country_codes <- c(Taiwan = 7, `South Korea` = 3, Thailand = 8)
```

## Overview

This analysis decomposes the binary loser category into **key opposition** 
supporters and **other** (minor party) voters for three countries where 
party-level coding was feasible: Taiwan, South Korea, and Thailand. The goal 
is to test whether the procedural orientation is concentrated among 
key opposition supporters --- those with a realistic path back to power --- 
or is shared across all types of losers.

## Merge Three-Way Coding with Main Data

```{r merge}
# Both datasets share identical row counts per country-wave and were coded
# in the same row order.  Merge by position WITHOUT sorting — sorting by
# respondent_id vs row_id destroys the natural alignment because
# respondent_id encoding varies across country-waves.

merged_parts <- list()

for (w in c(3, 4, 6)) {
  for (ccode in country_codes) {
    v <- vote_3way %>%
      filter(country == ccode,
             as.numeric(gsub("W", "", wave)) == w)

    a <- abs %>%
      filter(country == ccode, wave == w)

    if (nrow(v) == 0 | nrow(a) == 0) next
    if (nrow(v) != nrow(a)) {
      warning(sprintf("Size mismatch: W%d country=%d: vote=%d abs=%d",
                       w, ccode, nrow(v), nrow(a)))
      next
    }

    combined <- a
    combined$vote_status_3way <- v$vote_status
    merged_parts[[length(merged_parts) + 1]] <- combined
  }
}

merged <- bind_rows(merged_parts)

# Filter to respondents with valid three-way coding
analysis <- merged %>% 
  filter(!is.na(vote_status_3way))

cat("Analysis sample:", nrow(analysis), "respondents\n\n")

analysis %>%
  mutate(country_name = names(country_codes)[match(country, country_codes)]) %>%
  count(country_name, wave, vote_status_3way) %>%
  pivot_wider(names_from = vote_status_3way, values_from = n, values_fill = 0) %>%
  kable(caption = "Sample Size by Country, Wave, and Three-Way Status")
```

## Item Choice Proportions by Three-Way Status

```{r proportions}
# Get item types for Sets 1-4
item_info <- item_meta %>%
  filter(grepl("^Set", set)) %>%
  select(set, value, item_label, item_type)

# Compute proportions for each item by three-way status
props <- list()

for (s in 1:4) {
  col <- paste0("dem_meaning_set", s)
  sname <- paste0("Set", s)
  
  valid <- analysis %>% 
    filter(!is.na(.data[[col]]))
  
  for (status in c("Winner", "Key Opposition", "Other")) {
    sub <- valid %>% filter(vote_status_3way == status)
    if (nrow(sub) == 0) next
    
    dist <- sub %>%
      count(item = .data[[col]]) %>%
      mutate(proportion = n / sum(n),
             set = sname,
             status = status,
             n_total = sum(n))
    
    props[[length(props) + 1]] <- dist
  }
}

props_df <- bind_rows(props) %>%
  left_join(item_info, by = c("set", "item" = "value")) %>%
  select(set, item, item_label, item_type, status, proportion, n_total)

# Pivot for display
props_wide <- props_df %>%
  select(set, item, item_label, item_type, status, proportion) %>%
  pivot_wider(names_from = status, values_from = proportion) %>%
  mutate(
    `KO - W` = `Key Opposition` - Winner,
    `Other - W` = Other - Winner
  ) %>%
  arrange(set, item)

props_wide %>%
  mutate(across(where(is.numeric), ~round(.x, 3))) %>%
  select(Item = item_label, Type = item_type, 
         Winner, `Key Opp.` = `Key Opposition`, Other, 
         `KO - W`, `Other - W`) %>%
  kable(caption = "Item Choice Proportions by Three-Way Electoral Status (Pooled)",
        booktabs = TRUE) %>%
  kable_styling(font_size = 10, latex_options = c("hold_position", "striped")) %>%
  pack_rows("Set 1", 1, 4) %>%
  pack_rows("Set 2", 5, 8) %>%
  pack_rows("Set 3", 9, 12) %>%
  pack_rows("Set 4", 13, 16)
```

## Summary: Procedural-Substantive Gap by Status

```{r gap-summary}
# Compute mean difference on procedural and substantive items
gap_summary <- props_wide %>%
  filter(item_type %in% c("procedural", "substantive")) %>%
  group_by(item_type) %>%
  summarise(
    n_items = n(),
    `Mean KO-W diff` = mean(`KO - W`, na.rm = TRUE),
    `KO-W positive` = sum(`KO - W` > 0, na.rm = TRUE),
    `Mean Other-W diff` = mean(`Other - W`, na.rm = TRUE),
    `Other-W positive` = sum(`Other - W` > 0, na.rm = TRUE),
    .groups = "drop"
  )

# Add proc-sub gap row
ko_gap <- gap_summary$`Mean KO-W diff`[gap_summary$item_type == "procedural"] - 
          gap_summary$`Mean KO-W diff`[gap_summary$item_type == "substantive"]
other_gap <- gap_summary$`Mean Other-W diff`[gap_summary$item_type == "procedural"] - 
             gap_summary$`Mean Other-W diff`[gap_summary$item_type == "substantive"]

gap_row <- tibble(
  item_type = "Proc - Sub gap",
  n_items = NA_integer_,
  `Mean KO-W diff` = ko_gap,
  `KO-W positive` = NA_integer_,
  `Mean Other-W diff` = other_gap,
  `Other-W positive` = NA_integer_
)

bind_rows(gap_summary, gap_row) %>%
  mutate(across(where(is.numeric) & !matches("n_items|positive"), ~round(.x, 3))) %>%
  kable(caption = "Mean Differences Relative to Winners by Item Type",
        booktabs = TRUE) %>%
  kable_styling(font_size = 10, latex_options = c("hold_position"))
```

## By-Country Results

```{r by-country}
country_gaps <- list()

for (ccode in country_codes) {
  cname <- names(country_codes)[match(ccode, country_codes)]
  csub <- analysis %>% filter(country == ccode)
  
  cprops <- list()
  for (s in 1:4) {
    col <- paste0("dem_meaning_set", s)
    sname <- paste0("Set", s)
    valid <- csub %>% filter(!is.na(.data[[col]]))
    
    for (status in c("Winner", "Key Opposition")) {
      sub <- valid %>% filter(vote_status_3way == status)
      if (nrow(sub) == 0) next
      dist <- sub %>%
        count(item = .data[[col]]) %>%
        mutate(proportion = n / sum(n), set = sname, status = status)
      cprops[[length(cprops) + 1]] <- dist
    }
  }
  
  if (length(cprops) == 0) next
  
  cprops_df <- bind_rows(cprops) %>%
    left_join(item_info, by = c("set", "item" = "value")) %>%
    select(set, item, item_type, status, proportion) %>%
    pivot_wider(names_from = status, values_from = proportion) %>%
    mutate(`KO - W` = `Key Opposition` - Winner)
  
  proc_diffs <- cprops_df %>% filter(item_type == "procedural") %>% pull(`KO - W`)
  sub_diffs <- cprops_df %>% filter(item_type == "substantive") %>% pull(`KO - W`)
  
  ns <- csub %>% count(vote_status_3way) %>% deframe()
  
  country_gaps[[length(country_gaps) + 1]] <- tibble(
    Country = cname,
    `N Winner` = ns["Winner"] %||% 0L,
    `N Key Opp.` = ns["Key Opposition"] %||% 0L,
    `N Other` = ns["Other"] %||% 0L,
    `Mean proc diff (KO-W)` = round(mean(proc_diffs, na.rm = TRUE), 3),
    `Mean sub diff (KO-W)` = round(mean(sub_diffs, na.rm = TRUE), 3),
    `Proc-Sub gap` = round(mean(proc_diffs, na.rm = TRUE) - mean(sub_diffs, na.rm = TRUE), 3)
  )
}

bind_rows(country_gaps) %>%
  kable(caption = "Key Opposition vs Winner: Procedural-Substantive Gap by Country",
        booktabs = TRUE) %>%
  kable_styling(font_size = 10, latex_options = c("hold_position"))
```

## Save Results

```{r save}
# Save for appendix tables
write.csv(props_wide %>% mutate(across(where(is.numeric), ~round(.x, 3))),
          file.path(output_dir, "threeway_item_proportions.csv"),
          row.names = FALSE)

write.csv(bind_rows(country_gaps),
          file.path(output_dir, "threeway_country_gaps.csv"),
          row.names = FALSE)

cat("Results saved to:", output_dir, "\n")
```

## Interpretation

The three-way decomposition yields **no clear differentiation** between key 
opposition supporters and other losers across all three countries. The 
procedural-substantive gap between key opposition voters and winners is 
small and inconsistent in direction:

- **South Korea**: +0.025 (weakly consistent with theory)
- **Taiwan**: −0.016 (opposite to prediction)
- **Thailand**: −0.080 (opposite to prediction)

Pooled across countries, key opposition supporters show a mean procedural 
difference of −0.016 relative to winners --- the *opposite* of the predicted 
direction (only 2 of 8 procedural items positive). The "other" loser category 
shows an even larger negative gap (−0.025 on procedural items).

These null results likely reflect two factors: (1) the limited country coverage 
(3 of 14 analysis countries) substantially reduces statistical power, and 
(2) the additional missingness inherent in party-level coding further shrinks 
effective sample sizes. The binary winner-loser distinction, which the ABS 
pre-codes across all surveyed countries, provides broader coverage and 
cleaner identification.
