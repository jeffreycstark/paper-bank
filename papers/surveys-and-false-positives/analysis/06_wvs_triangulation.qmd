---
title: "06 - WVS Wave 7 Triangulation"
subtitle: "Pre-protest baseline comparison for Hong Kong democratic attitudes"
format: html
execute:
  echo: true
  warning: false
  message: false
  cache: true
---

# Overview
#
# This script loads WVS Wave 7 Hong Kong data to establish a pre-protest
# baseline (fieldwork ~2018-2019) for comparison with ABS Wave 5 protest-period
# and post-NSL measures. The goal is a compact triangulation showing that
# ABS W5 represents a sharp departure from pre-protest attitudes.
#
# SETUP: Download WVS W7 Stata file from:
#   https://www.worldvaluessurvey.org/WVSDocumentationWV7.jsp
#   → "Statistical Data Files" → "WVS Cross-National Wave 7" (Stata .dta)
#   → Free registration required
#
# Place the downloaded file at:
#   ../../../data/raw/wvs_wave7/WVS_Cross-National_Wave_7_stata_v6_0.dta
#   (adjust filename to match whatever version you download)

```{r setup}
library(tidyverse)
library(haven)
library(knitr)
```

# ─── 1. Load WVS Wave 7 ──────────────────────────────────────────────────

```{r load-wvs}
# Adjust path/filename to match your download
wvs_path <- "../../../data/raw/wvs_wave7/WVS_Cross-National_Wave_7_stata_v6_0.dta"

if (!file.exists(wvs_path)) {
  # Try alternate naming conventions
  alt_paths <- list.files(
    "../../../data/raw/wvs_wave7/",
    pattern = "\\.dta$",
    full.names = TRUE
  )
  if (length(alt_paths) > 0) {
    wvs_path <- alt_paths[1]
    cat("Using:", wvs_path, "\n")
  } else {
    stop(
      "WVS W7 data file not found.\n",
      "Download from: https://www.worldvaluessurvey.org/WVSDocumentationWV7.jsp\n",
      "Place .dta file in: data/raw/wvs_wave7/"
    )
  }
}

wvs_raw <- read_dta(wvs_path, encoding = "latin1")
cat("WVS W7 full dataset:", nrow(wvs_raw), "respondents,",
    n_distinct(wvs_raw$B_COUNTRY_ALPHA), "countries\n")
```

# ─── 2. Extract Hong Kong ────────────────────────────────────────────────

```{r hk-extract}
# Hong Kong = country code 344 or B_COUNTRY_ALPHA == "HKG"
wvs_hk <- wvs_raw |>
  filter(B_COUNTRY_ALPHA == "HKG" | B_COUNTRY == 344)

cat("Hong Kong N:", nrow(wvs_hk), "\n")

# Check fieldwork dates
wvs_hk |>
  count(A_YEAR, A_WAVE) |>
  kable(caption = "WVS W7 Hong Kong: fieldwork year")
```

# ─── 3. Recode key variables ─────────────────────────────────────────────

```{r recode-wvs}
wvs_hk_clean <- wvs_hk |>
  transmute(
    source = "WVS W7",
    fieldwork_year = A_YEAR,

    # Democracy importance (Q250): 1-10 scale
    # "How important is it for you to live in a country that is governed democratically?"
    # 1 = not at all important, 10 = absolutely important
    # NOTE: Q235 is actually "strong leader" (authoritarian pref), NOT democracy importance
    dem_importance_raw = if_else(Q250 > 0, Q250, NA_real_),

    # Confidence items: 1 = a great deal, 2 = quite a lot, 3 = not very much, 4 = none at all
    # REVERSE so higher = more confidence (to match ABS convention: 1-4, higher = more trust)
    conf_police_raw    = if_else(Q69 > 0, 5 - Q69, NA_real_),
    conf_govt_raw      = if_else(Q71 > 0, 5 - Q71, NA_real_),
    # NOTE: WVS Q72 = "Confidence: Political Parties" (NOT parliament/legislature)
    # No direct parliament equivalent in WVS W7 HK; use political parties as rough proxy
    conf_parties_raw   = if_else(Q72 > 0, 5 - Q72, NA_real_),
    conf_courts_raw    = if_else(Q70 > 0, 5 - Q70, NA_real_),
    conf_military_raw  = if_else(Q65 > 0, 5 - Q65, NA_real_),

    # For ABS comparability, rescale confidence items from 1-4 to match ABS 1-4 trust scale
    # After reversing, WVS is already 1-4 with higher = more confidence
    trust_police    = conf_police_raw,
    trust_govt      = conf_govt_raw,
    trust_parliament = conf_parties_raw,  # political parties as proxy for parliament
    trust_courts    = conf_courts_raw,
    trust_military  = conf_military_raw,

    # Democracy suitability proxy: keep on native 1-10 scale
    # ABS democracy_suitability (q104) is ALSO 1-10 (1=not suitable, 10=completely suitable)
    # WVS Q235 is 1-10 (1=not at all important, 10=absolutely important)
    # Both scales comparable without rescaling
    dem_suitability = dem_importance_raw
  )

cat("Valid observations per variable:\n")
wvs_hk_clean |>
  summarise(across(where(is.numeric), ~sum(!is.na(.)))) |>
  pivot_longer(everything(), names_to = "variable", values_to = "n_valid") |>
  kable()
```

# ─── 4. Load ABS W5 Hong Kong means ──────────────────────────────────────

```{r load-abs}
source("../../../_data_config.R")
d <- readRDS(abs_harmonized_path)

hk5 <- d |>
  filter(country == 2, wave == 5) |>
  mutate(
    int_month = as.numeric(int_month),
    int_year = as.numeric(int_year),
    period = case_when(
      int_year == 2019 | (int_year == 2020 & int_month <= 1) ~ "Protest",
      int_year == 2021 & int_month >= 3 ~ "Post-NSL",
      TRUE ~ "Gap"
    )
  ) |>
  filter(period != "Gap")
```

# ─── 5. Compute comparison means ─────────────────────────────────────────

```{r comparison-means}
# WVS W7 (pre-protest baseline)
wvs_means <- wvs_hk_clean |>
  summarise(
    trust_police    = mean(trust_police, na.rm = TRUE),
    trust_govt      = mean(trust_govt, na.rm = TRUE),
    trust_parliament = mean(trust_parliament, na.rm = TRUE),
    trust_courts    = mean(trust_courts, na.rm = TRUE),
    trust_military  = mean(trust_military, na.rm = TRUE),
    dem_suitability = mean(dem_suitability, na.rm = TRUE)
  ) |>
  pivot_longer(everything(), names_to = "variable", values_to = "mean") |>
  mutate(source = "WVS W7 (Pre-protest)", .before = 1)

# ABS W5 Protest period (weighted)
abs_protest <- hk5 |>
  filter(period == "Protest") |>
  summarise(
    trust_police    = weighted.mean(trust_police, weight, na.rm = TRUE),
    trust_govt      = weighted.mean(trust_national_government, weight, na.rm = TRUE),
    trust_parliament = weighted.mean(trust_parliament, weight, na.rm = TRUE),
    trust_courts    = weighted.mean(trust_courts, weight, na.rm = TRUE),
    trust_military  = weighted.mean(trust_military, weight, na.rm = TRUE),
    dem_suitability = weighted.mean(democracy_suitability, weight, na.rm = TRUE)
  ) |>
  pivot_longer(everything(), names_to = "variable", values_to = "mean") |>
  mutate(source = "ABS W5 (Protest)", .before = 1)

# ABS W5 Post-NSL period (weighted)
abs_postnsl <- hk5 |>
  filter(period == "Post-NSL") |>
  summarise(
    trust_police    = weighted.mean(trust_police, weight, na.rm = TRUE),
    trust_govt      = weighted.mean(trust_national_government, weight, na.rm = TRUE),
    trust_parliament = weighted.mean(trust_parliament, weight, na.rm = TRUE),
    trust_courts    = weighted.mean(trust_courts, weight, na.rm = TRUE),
    trust_military  = weighted.mean(trust_military, weight, na.rm = TRUE),
    dem_suitability = weighted.mean(democracy_suitability, weight, na.rm = TRUE)
  ) |>
  pivot_longer(everything(), names_to = "variable", values_to = "mean") |>
  mutate(source = "ABS W5 (Post-NSL)", .before = 1)

# Combine
comparison <- bind_rows(wvs_means, abs_protest, abs_postnsl) |>
  mutate(
    source = factor(source, levels = c(
      "WVS W7 (Pre-protest)", "ABS W5 (Protest)", "ABS W5 (Post-NSL)"
    )),
    variable = recode(variable,
      "trust_police" = "Police",
      "trust_govt" = "National Gov't",
      "trust_parliament" = "Parliament / Parties*",
      "trust_courts" = "Courts",
      "trust_military" = "Military",
      "dem_suitability" = "Democracy Suitability"
    )
  )

comparison |>
  pivot_wider(names_from = source, values_from = mean) |>
  mutate(across(where(is.numeric), ~round(., 2))) |>
  kable(caption = "Hong Kong: WVS W7 pre-protest baseline vs. ABS W5 periods (trust: 1-4; dem suitability: 1-10). *WVS = political parties; ABS = parliament.")
```

# ─── 6. Dot plot ──────────────────────────────────────────────────────────

```{r dot-plot, fig.width=8, fig.height=6}
# Separate trust (1-4) and democracy suitability (1-10) into facets
comparison <- comparison |>
  mutate(
    scale_group = if_else(
      variable == "Democracy Suitability",
      "Democracy Suitability (1-10)",
      "Institutional Trust (1-4)"
    )
  )

ggplot(comparison, aes(x = mean, y = fct_rev(variable), color = source, shape = source)) +
  geom_point(size = 3.5, position = position_dodge(width = 0.4)) +
  facet_wrap(~scale_group, scales = "free", ncol = 1) +
  scale_color_manual(
    values = c(
      "WVS W7 (Pre-protest)" = "#4477AA",
      "ABS W5 (Protest)" = "#EE6677",
      "ABS W5 (Post-NSL)" = "#228833"
    )
  ) +
  scale_shape_manual(values = c(16, 17, 15)) +
  labs(
    title = "Hong Kong: WVS W7 pre-protest baseline vs. ABS W5 periods",
    subtitle = "WVS W7 (2018) provides pre-crisis reference point",
    x = NULL,
    y = NULL,
    color = NULL, shape = NULL,
    caption = paste0(
      "Note: WVS confidence items reverse-coded (higher = more confidence). ",
      "WVS Q235 (democracy importance) compared with ABS q104 (democracy suitability), both 1-10.\n",
      "WVS W7 mode: mixed PAPI + CAWI. ABS W5 mode: face-to-face."
    )
  ) +
  theme_minimal(base_size = 13) +
  theme(
    legend.position = "top",
    panel.grid.major.y = element_line(color = "grey90"),
    plot.caption = element_text(size = 9, hjust = 0),
    strip.text = element_text(face = "bold")
  )

ggsave("figures/wvs_abs_comparison.pdf", width = 8, height = 6)
ggsave("figures/wvs_abs_comparison.png", width = 8, height = 6, dpi = 300)
```

# ─── 7. Summary statistics ───────────────────────────────────────────────

```{r summary}
# Print key takeaway
cat("\n=== KEY COMPARISON ===\n\n")
comparison |>
  pivot_wider(names_from = source, values_from = mean) |>
  mutate(
    `Protest vs WVS` = round(`ABS W5 (Protest)` - `WVS W7 (Pre-protest)`, 2),
    `Post-NSL vs WVS` = round(`ABS W5 (Post-NSL)` - `WVS W7 (Pre-protest)`, 2)
  ) |>
  kable(digits = 2,
        caption = "Change from WVS W7 pre-protest baseline to ABS W5 periods")
```

```{r wvs-n}
# Report for manuscript
cat("\nFor manuscript reporting:\n")
cat("WVS W7 Hong Kong N =", nrow(wvs_hk), "\n")
cat("Fieldwork year(s):", paste(unique(wvs_hk$A_YEAR[wvs_hk$A_YEAR > 0]), collapse = ", "), "\n")
cat("Mode: Mixed PAPI + CAWI\n")
```
