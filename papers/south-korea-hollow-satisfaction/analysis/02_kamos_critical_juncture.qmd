---
title: "KAMOS Critical Juncture Analysis: The Satisfaction Paradox (South Korea)"
format:
  html:
    toc: true
    toc-depth: 3
    number-sections: true
    theme: cosmo
    code-fold: true
execute:
  echo: true
  warning: false
  message: false
  cache: true
---

The KAMOS data (W1 = 2016, W4 = 2019) provide a critical juncture test.
The Candlelight Revolution (Oct–Nov 2016) and impeachment (Dec 2016 – Mar 2017)
represent the most direct democratic accountability event in recent Korean history.
If the satisfaction–quality decoupling is conjunctural — driven by specific
governments or economic conditions — the transition from Park to Moon should
have restored it. This file tests whether the decoupling persists post-Revolution.

```{r setup}
library(tidyverse)
library(lme4)
library(marginaleffects)
library(broom.mixed)
library(patchwork)
library(scales)
library(kableExtra)

project_root <- "/Users/jeffreystark/Development/Research/econdev-authpref"
source(file.path(project_root, "_data_config.R"))

paper_dir    <- file.path(project_root, "papers/south-korea-hollow-satisfaction")
analysis_dir <- file.path(paper_dir, "analysis")
fig_dir      <- file.path(analysis_dir, "figures")
results_dir  <- file.path(analysis_dir, "results")

# ── Shared palette ────────────────────────────────────────────────────────────
col_pre    <- "#2166AC"   # W1 2016 — pre-Revolution
col_post   <- "#D6604D"   # W4 2019 — post-Revolution / Moon admin
col_exec   <- "#4393C3"
col_horiz  <- "#D73027"
col_soc    <- "#4DAF4A"

theme_paper <- theme_bw(base_size = 12) +
  theme(
    panel.grid.minor = element_blank(),
    legend.position  = "bottom",
    plot.title       = element_text(size = 11, face = "bold"),
    plot.caption     = element_text(size = 8, color = "grey40")
  )
```

```{r load-data}
kamos <- readRDS(file.path(analysis_dir, "kor_kamos.rds"))

cat("KAMOS loaded: n =", nrow(kamos),
    "| waves:", paste(sort(unique(kamos$wave)), collapse = " "), "\n")
cat("Wave distribution:\n")
print(table(kamos$wave))
```

---

# Institutional Trust by Type (Three-Way Model) {#sec-trust}

Replicates the three-way trust model from the accountability-gap paper for
direct comparability, and extends it to ask whether all three institution types
collapsed uniformly or differentially across the critical juncture.

## Reshape to long and classify

```{r reshape-long}
kamos_long <- kamos |>
  mutate(
    # Row number as respondent ID for random effects clustering
    resp_id = row_number(),
    wave    = factor(wave, levels = c(1, 4), labels = c("W1", "W4"))
  ) |>
  pivot_longer(
    cols      = c(trust_central_govt, trust_local_govt,
                  trust_legislative,
                  trust_media, trust_ngo),
    names_to  = "institution",
    values_to = "trust"
  ) |>
  mutate(
    inst_type = case_when(
      institution %in% c("trust_central_govt", "trust_local_govt") ~ "A_Executive",
      institution == "trust_legislative"                           ~ "B_Horizontal",
      institution %in% c("trust_media", "trust_ngo")              ~ "C_Societal"
    ),
    inst_type = factor(inst_type,
      levels = c("A_Executive", "B_Horizontal", "C_Societal"),
      labels = c("Executive", "Horizontal", "Societal")
    ),
    inst_label = recode(institution,
      trust_central_govt = "Central government",
      trust_local_govt   = "Local government",
      trust_legislative  = "National Assembly",
      trust_media        = "Media",
      trust_ngo          = "NGOs"
    )
  )

cat("Long-format rows:", nrow(kamos_long),
    "| unique respondents:", n_distinct(kamos_long$resp_id), "\n")

# Wave means by institution
kamos_inst_means <- kamos_long |>
  filter(!is.na(trust)) |>
  group_by(wave, inst_type, inst_label) |>
  summarise(
    mean = mean(trust, na.rm = TRUE),
    se   = sd(trust, na.rm = TRUE) / sqrt(n()),
    n    = n(),
    .groups = "drop"
  )

cat("\n=== KAMOS trust means by institution and wave ===\n")
kamos_inst_means |>
  mutate(mean = round(mean, 2)) |>
  pivot_wider(names_from = wave, values_from = c(mean, se, n)) |>
  print()
```

## Three-way mixed-effects model

```{r trust-threeway-model}
# Executive = reference category; W1 = reference wave
# Random intercept clusters 5 institution observations per respondent
m_trust3 <- lmer(
  trust ~ wave * inst_type +
    age + gender + education + income + ideology + party_id +
    (1 | resp_id),
  data  = kamos_long,
  REML  = FALSE
)

summary(m_trust3)
```

## Predicted margins

```{r trust-preds}
preds_trust3 <- predictions(
  m_trust3,
  newdata = datagrid(
    wave      = c("W1", "W4"),
    inst_type = c("Executive", "Horizontal", "Societal")
  )
)

preds_trust3 |>
  as_tibble() |>
  select(wave, inst_type, estimate, conf.low, conf.high) |>
  mutate(across(where(is.numeric), ~ round(.x, 2))) |>
  print()
```

## Figure 7: Three-way trust collapse

```{r fig7-trust-threeway, fig.width=6.5, fig.height=5}
fig7 <- preds_trust3 |>
  as_tibble() |>
  mutate(
    wave_label = recode(wave, "W1" = "2016 (pre)", "W4" = "2019 (post)"),
    inst_label = recode(inst_type,
      "Executive"  = "Executive\n(Central + Local govt)",
      "Horizontal" = "Horizontal\n(National Assembly)",
      "Societal"   = "Societal\n(Media + NGO)"
    )
  ) |>
  ggplot(aes(x = wave_label, y = estimate,
             color = inst_label, group = inst_label,
             ymin = conf.low, ymax = conf.high)) +
  geom_ribbon(aes(fill = inst_label), alpha = 0.12, color = NA) +
  geom_line(linewidth = 0.9) +
  geom_point(size = 2.8) +
  scale_color_manual(values = c(
    "Executive\n(Central + Local govt)" = col_exec,
    "Horizontal\n(National Assembly)"   = col_horiz,
    "Societal\n(Media + NGO)"           = col_soc
  )) +
  scale_fill_manual(values = c(
    "Executive\n(Central + Local govt)" = col_exec,
    "Horizontal\n(National Assembly)"   = col_horiz,
    "Societal\n(Media + NGO)"           = col_soc
  )) +
  scale_y_continuous(limits = c(0, 10), breaks = seq(0, 10, 2)) +
  labs(
    x        = NULL,
    y        = "Predicted trust (0–10)",
    color    = NULL, fill = NULL,
    title    = "Trust collapse by accountability function across the\nCandlelight Revolution, South Korea 2016–2019",
    subtitle = "Controlled for age, gender, education, income, ideology, party ID",
    caption  = paste0("Predicted margins from mixed-effects model (REML=FALSE). 95% CIs.\n",
                      "Source: KAMOS W1 (2016) / W4 (2019). N ≈ 3,500.")
  ) +
  theme_paper

fig7

ggsave(file.path(fig_dir, "fig7_kamos_trust_threeway.png"),
       fig7, width = 6.5, height = 5.5, dpi = 300)
ggsave(file.path(fig_dir, "fig7_kamos_trust_threeway.pdf"),
       fig7, width = 6.5, height = 5.5)
```

---

# The Critical Juncture Test {#sec-cj-test}

The core test: does the Revolution restore the satisfaction–quality link?
We compare satisfaction, democratic quality perceptions, and economic evaluations
across W1 (2016, pre-Revolution) and W4 (2019, post-transition).

## Wave means: satisfaction, quality, and economic evaluations

```{r cj-means}
# ── Identify available KAMOS variables ────────────────────────────────────────
# KAMOS trust module confirmed; these demographic/attitudinal vars also present:
#   wave, age, gender, education, income, ideology, party_id
#   trust_central_govt, trust_local_govt, trust_national_assembly,
#   trust_legislature, trust_media, trust_ngo
#   + economic: national econ assessment, household econ, social mobility
#
# Note: KAMOS may not have all ABS attitudinal items (dem_extent_current etc.)
#       Check available columns and proceed with confirmed variables only.

kamos_vars <- names(kamos)
cat("KAMOS columns:\n")
cat(paste(kamos_vars, collapse = ", "), "\n\n")

# Filter to the economic + trust variables we know exist
# Satisfaction-adjacent items: check availability
potential_sat_vars  <- intersect(kamos_vars,
  c("democracy_satisfaction", "dem_satisfied", "sat_democracy",
    "gov_sat_national", "govt_performance_sat"))
potential_qual_vars <- intersect(kamos_vars,
  c("dem_extent_current", "dem_quality", "dem_always_preferable"))
potential_econ_vars <- intersect(kamos_vars,
  c("econ_national_now", "econ_national", "hh_income_sat",
    "econ_hh_sat", "econ_outlook_1yr", "econ_outlook"))

cat("Confirmed satisfaction vars:", paste(potential_sat_vars,  collapse = ", "), "\n")
cat("Confirmed quality vars:     ", paste(potential_qual_vars, collapse = ", "), "\n")
cat("Confirmed economic vars:    ", paste(potential_econ_vars, collapse = ", "), "\n\n")
```

```{r cj-trust-summary}
# Trust composite change W1 → W4 (confirmed available)
trust_change <- kamos_long |>
  filter(!is.na(trust)) |>
  group_by(wave, inst_type) |>
  summarise(mean_trust = mean(trust, na.rm = TRUE), .groups = "drop") |>
  pivot_wider(names_from = wave, values_from = mean_trust) |>
  mutate(
    change    = W4 - W1,
    pct_change = change / W1 * 100
  )

cat("=== Trust change W1 (2016) → W4 (2019) by institution type ===\n")
trust_change |> mutate(across(where(is.numeric), ~ round(.x, 2))) |> print()
```

## Figure 8: Critical juncture — W1 vs W4 across all available measures

```{r fig8-cj-dumbbell, fig.width=7, fig.height=5}
# Dumbbell chart: W1 vs W4 means for each trust institution
dumbbell_data <- kamos_inst_means |>
  select(wave, inst_label, inst_type, mean) |>
  pivot_wider(names_from = wave, values_from = mean)

fig8 <- ggplot(dumbbell_data) +
  geom_segment(aes(x = W1, xend = W4,
                   y = reorder(inst_label, W1),
                   yend = reorder(inst_label, W1)),
               color = "grey70", linewidth = 1.2) +
  geom_point(aes(x = W1, y = reorder(inst_label, W1)),
             color = col_pre, size = 3.5) +
  geom_point(aes(x = W4, y = reorder(inst_label, W1)),
             color = col_post, size = 3.5) +
  annotate("point", x = -Inf, y = -Inf, color = col_pre,  size = 3,
           shape = 19) +  # legend manual trick
  scale_x_continuous(limits = c(0, 10), breaks = seq(0, 10, 2),
                     name = "Mean institutional trust (0–10)") +
  labs(
    y       = NULL,
    title   = "Institutional trust before and after the Candlelight Revolution",
    subtitle = paste0("● 2016 (W1, pre-Revolution)    ● 2019 (W4, Moon admin)\n",
                      "All institutions declined across the critical juncture"),
    caption = "Raw wave means. Source: KAMOS W1 (2016) / W4 (2019)."
  ) +
  theme_paper +
  theme(legend.position = "none")

fig8

ggsave(file.path(fig_dir, "fig8_kamos_dumbbell.png"),
       fig8, width = 7, height = 5, dpi = 300)
ggsave(file.path(fig_dir, "fig8_kamos_dumbbell.pdf"),
       fig8, width = 7, height = 5)
```

---

# Interaction Terms and Inline Statistics {#sec-inline}

```{r interaction-terms}
# Extract and save interaction terms for manuscript inline reporting
interaction_terms <- tidy(m_trust3, conf.int = TRUE) |>
  filter(str_detect(term, "wave"))

cat("=== Interaction terms (wave × inst_type) ===\n")
print(interaction_terms)

# Average slopes by institution type (for appendix table)
slopes_by_type <- avg_slopes(
  m_trust3,
  variables = "wave",
  by        = "inst_type"
)

cat("\n=== Average slopes by institution type ===\n")
print(slopes_by_type)

# Assembly–Legislature correlation (for footnote)
assembly_leg_cor <- cor(
  kamos$trust_national_assembly,
  kamos$trust_legislature,
  use = "complete.obs"
)
cat(sprintf("\ntrust_national_assembly × trust_legislature  r = %.2f\n",
            assembly_leg_cor))
```

---

# Save Results {#sec-save}

```{r save}
saveRDS(kamos_inst_means,   file.path(results_dir, "kamos_inst_means.rds"))
saveRDS(trust_change,       file.path(results_dir, "kamos_trust_change.rds"))
saveRDS(preds_trust3,       file.path(results_dir, "kamos_preds_trust3.rds"))
saveRDS(interaction_terms,  file.path(results_dir, "kamos_interaction_terms.rds"))
saveRDS(slopes_by_type,     file.path(results_dir, "kamos_slopes_by_type.rds"))
saveRDS(assembly_leg_cor,   file.path(results_dir, "kamos_assembly_leg_cor.rds"))
saveRDS(m_trust3,           file.path(results_dir, "kamos_m_trust3.rds"))

cat("✓ All KAMOS results saved to", results_dir, "\n")
```
