---
title: "05 - Alternative Explanations"
subtitle: "Testing the Trust Paradox with Democratic Values, China Ratings, and Protest Behavior"
format: html
execute:
  echo: true
  warning: false
  message: false
  cache: true
---

# Theoretical Motivation

These items test alternative explanations for the trust paradox documented
in the paper. If respondents rate protest freedom as essential to democracy
while trust in police rises, that undermines the "protest fatigue / genuine
gratitude" interpretation. If respondents choose liberal-procedural
conceptions of democracy, that undermines the "democracy was never
consolidated" interpretation. If respondents rate China as more democratic
post-NSL, that supports an information environment / co-optation
interpretation.

# Variable Mapping

The following ABS Wave 5 items were requested. Not all are available in the
harmonized dataset; items from the "essential characteristics" battery
(q83-q97) used a 1-10 scale in W5 that was not harmonized because earlier
waves used a forced-choice format.

| Requested (W5 Q#) | Harmonized variable         | Available? | Scale                    |
|--------------------|-----------------------------|------------|--------------------------|
| q98                | `dem_essential_harmonized`   | Yes        | Nominal 1-5 (forced choice) |
| q128               | `dem_rating_china`           | Yes        | 1-10 (dict-dem)          |
| q105               | `sat_president_govt`         | Yes        | 1-4 (higher = more satisfied) |
| q103               | `dem_country_future`         | Yes        | 1-10 (dict-dem)          |
| q79                | `action_demonstration`       | Yes        | 1-5 (higher = more active)  |
| q93                | Not harmonized               | No         | Was 1-10 essential characteristic |
| q84                | `dem_free_speech` (proxy)    | Proxy      | 1-4 (higher = more agree)   |
| q85/q82            | `dem_statement_pair_1`       | Partial    | Binary (1=Stmt A, 2=Stmt B) |

Additional variables included for theoretical completeness:

- `dem_procedural_vs_substantive` — binary: 1=procedural, 0=substantive
- `dem_country_present_govt` — where country is NOW on 1-10 democratic scale
- `dem_country_past` — where country was 10 years ago (1-10)


```{r setup}
library(tidyverse)
library(knitr)
library(kableExtra)

# --- Weighted statistics helper functions ---
weighted_var <- function(x, w) {
  mu <- weighted.mean(x, w)
  sum(w * (x - mu)^2) / (sum(w) - 1)
}
weighted_sd <- function(x, w) sqrt(weighted_var(x, w))
weighted_cohens_d <- function(x1, w1, x2, w2) {
  m1 <- weighted.mean(x1, w1)
  m2 <- weighted.mean(x2, w2)
  v1 <- weighted_var(x1, w1)
  v2 <- weighted_var(x2, w2)
  pooled_sd <- sqrt(((length(x1) - 1) * v1 + (length(x2) - 1) * v2) /
                      (length(x1) + length(x2) - 2))
  (m2 - m1) / pooled_sd
}
```

# Load Prepared Data

```{r load-data}
load("results/prepared_data.RData")

# Analytical sample: Protest vs Post-NSL only
hk5_analysis <- hk5 |>
  filter(period %in% c("Protest", "Post-NSL")) |>
  mutate(period = droplevels(period),
         post_nsl = as.numeric(period == "Post-NSL"))

cat("Protest:", sum(hk5_analysis$period == "Protest"),
    "| Post-NSL:", sum(hk5_analysis$period == "Post-NSL"), "\n")
```

# 1. Define Variables of Interest

```{r define-vars}
# Continuous variables for t-test / Mann-Whitney / Cohen's d
continuous_vars <- c(
  "dem_rating_china",
  "sat_president_govt",
  "dem_country_future",
  "action_demonstration",
  "dem_free_speech",
  "dem_country_present_govt",
  "dem_country_past",
  "dem_procedural_vs_substantive"
)
continuous_vars <- continuous_vars[continuous_vars %in% names(hk5_analysis)]

# Labels for display
var_labels <- c(
  dem_rating_china = "China Democratic Rating (1-10)",
  sat_president_govt = "Satisfaction w/ President/Govt (1-4)",
  dem_country_future = "Democratic Future, 10 yrs (1-10)",
  action_demonstration = "Attended Demonstration (1-5)",
  dem_free_speech = "Free to Speak Without Fear (1-4)",
  dem_country_present_govt = "Country on Dem. Scale Now (1-10)",
  dem_country_past = "Country on Dem. Scale 10 yrs Ago (1-10)",
  dem_procedural_vs_substantive = "Procedural Dem. Conception (0-1)"
)

# Categorical variables for chi-squared / cross-tabs
categorical_vars <- c(
  "dem_essential_harmonized",
  "dem_statement_pair_1"
)
categorical_vars <- categorical_vars[categorical_vars %in% names(hk5_analysis)]
```

# 2. Continuous Variable Comparisons

```{r continuous-tests}
cont_results <- map_dfr(continuous_vars, function(var) {
  dat_pro <- hk5_analysis |> filter(period == "Protest", !is.na(!!sym(var)))
  dat_post <- hk5_analysis |> filter(period == "Post-NSL", !is.na(!!sym(var)))

  if (nrow(dat_pro) < 10 | nrow(dat_post) < 10) return(NULL)

  # Weighted OLS for p-value
  dat_both <- bind_rows(dat_pro, dat_post)
  m <- lm(as.formula(paste(var, "~ post_nsl")), data = dat_both, weights = weight)
  coef_row <- summary(m)$coefficients["post_nsl", ]

  # Mann-Whitney (unweighted, non-parametric check)
  wt <- wilcox.test(dat_pro[[var]], dat_post[[var]], exact = FALSE)

  d <- weighted_cohens_d(
    dat_pro[[var]], dat_pro$weight,
    dat_post[[var]], dat_post$weight
  )

  tibble(
    variable = var,
    label = var_labels[var],
    n_protest = nrow(dat_pro),
    n_postnsl = nrow(dat_post),
    protest_mean = weighted.mean(dat_pro[[var]], dat_pro$weight),
    protest_sd = weighted_sd(dat_pro[[var]], dat_pro$weight),
    postnsl_mean = weighted.mean(dat_post[[var]], dat_post$weight),
    postnsl_sd = weighted_sd(dat_post[[var]], dat_post$weight),
    cohens_d = d,
    t_stat = coef_row["t value"],
    t_p = coef_row["Pr(>|t|)"],
    mw_stat = wt$statistic,
    mw_p = wt$p.value,
    sig = case_when(
      coef_row["Pr(>|t|)"] < 0.001 ~ "***",
      coef_row["Pr(>|t|)"] < 0.01  ~ "**",
      coef_row["Pr(>|t|)"] < 0.05  ~ "*",
      TRUE ~ ""
    )
  )
})
```

```{r}
#| label: tbl-continuous
#| tbl-cap: "Alternative explanation variables: Protest vs Post-NSL comparison"
cont_results |>
  select(label, n_protest, n_postnsl, protest_mean, postnsl_mean, cohens_d,
         t_p, mw_p, sig) |>
  mutate(
    across(c(protest_mean, postnsl_mean, cohens_d), ~round(.x, 3)),
    t_p = format.pval(t_p, digits = 3),
    mw_p = format.pval(mw_p, digits = 3)
  ) |>
  kable(
    col.names = c("Variable", "N (Protest)", "N (Post-NSL)",
                   "Mean (Protest)", "Mean (Post-NSL)", "Cohen's d",
                   "t p-value", "MW p-value", ""),
    booktabs = TRUE
  ) |>
  kable_styling(latex_options = c("scale_down", "hold_position"))
```

```{r continuous-interpretation}
cat("=== Key Findings: Continuous Variables ===\n\n")

# China democratic rating
china_row <- cont_results |> filter(variable == "dem_rating_china")
if (nrow(china_row) > 0) {
  cat("China Democratic Rating:\n")
  cat("  Protest mean =", round(china_row$protest_mean, 2),
      "-> Post-NSL mean =", round(china_row$postnsl_mean, 2),
      "(d =", round(china_row$cohens_d, 2), china_row$sig, ")\n")
  if (china_row$postnsl_mean > china_row$protest_mean) {
    cat("  -> Post-NSL respondents rate China as MORE democratic.\n")
    cat("     Supports information environment / co-optation interpretation.\n\n")
  } else {
    cat("  -> Post-NSL respondents rate China as LESS democratic.\n\n")
  }
}

# Democratic future
future_row <- cont_results |> filter(variable == "dem_country_future")
if (nrow(future_row) > 0) {
  cat("Democratic Future (10 years):\n")
  cat("  Protest mean =", round(future_row$protest_mean, 2),
      "-> Post-NSL mean =", round(future_row$postnsl_mean, 2),
      "(d =", round(future_row$cohens_d, 2), future_row$sig, ")\n\n")
}

# Action demonstration
demo_row <- cont_results |> filter(variable == "action_demonstration")
if (nrow(demo_row) > 0) {
  cat("Attended Demonstration:\n")
  cat("  Protest mean =", round(demo_row$protest_mean, 2),
      "-> Post-NSL mean =", round(demo_row$postnsl_mean, 2),
      "(d =", round(demo_row$cohens_d, 2), demo_row$sig, ")\n")
  cat("  (Scale: 1=would never do, 5=done >3 times, reversed so higher=more active)\n\n")
}
```


# 3. Categorical Variable Cross-Tabulations

## 3a. Most Essential Element of Democracy (q98 / `dem_essential_harmonized`)

```{r dem-essential-crosstab}
dem_ess_labels <- c(
  `1` = "Free expression",
  `2` = "Free elections",
  `4` = "Basic Needs (necessities)",
  `5` = "Good Governance (clean politics)"
)

dem_ess_data <- hk5_analysis |>
  filter(!is.na(dem_essential_harmonized)) |>
  mutate(
    dem_label = recode(as.character(dem_essential_harmonized), !!!dem_ess_labels)
  )

# Cross-tab
dem_ess_xtab <- dem_ess_data |>
  count(period, dem_label) |>
  group_by(period) |>
  mutate(prop = n / sum(n)) |>
  ungroup()

# Chi-squared test
dem_ess_chi <- chisq.test(table(dem_ess_data$period, dem_ess_data$dem_essential_harmonized))

cat("=== Most Essential Element of Democracy (q98) ===\n")
dem_ess_xtab |>
  select(period, dem_label, n, prop) |>
  mutate(prop = round(prop, 3)) |>
  pivot_wider(names_from = period, values_from = c(n, prop),
              names_glue = "{period}_{.value}") |>
  kable(
    col.names = c("Category", "N (Protest)", "N (Post-NSL)",
                   "Prop (Protest)", "Prop (Post-NSL)"),
    caption = paste0("Most essential element of democracy by period (Chi-sq p = ",
                     format.pval(dem_ess_chi$p.value, digits = 3), ")"),
    booktabs = TRUE
  ) |>
  kable_styling(latex_options = c("hold_position"))

cat("\nChi-squared test: X2 =", round(dem_ess_chi$statistic, 2),
    ", df =", dem_ess_chi$parameter,
    ", p =", format.pval(dem_ess_chi$p.value, digits = 3), "\n")

# Procedural vs substantive shift
proc_by_period <- dem_ess_data |>
  mutate(procedural = dem_essential_harmonized %in% c(1, 2)) |>
  group_by(period) |>
  summarise(pct_procedural = weighted.mean(procedural, weight) * 100, .groups = "drop")
cat("\nProcedural (free expression + free elections) share:\n")
cat("  Protest:", round(proc_by_period$pct_procedural[1], 1), "%\n")
cat("  Post-NSL:", round(proc_by_period$pct_procedural[2], 1), "%\n")
```

## 3b. Statement Pair 1 (q82 / `dem_statement_pair_1`)

```{r statement-pair-crosstab}
if ("dem_statement_pair_1" %in% names(hk5_analysis)) {
  sp1_data <- hk5_analysis |>
    filter(!is.na(dem_statement_pair_1))

  sp1_xtab <- sp1_data |>
    count(period, dem_statement_pair_1) |>
    group_by(period) |>
    mutate(prop = n / sum(n)) |>
    ungroup()

  sp1_chi <- chisq.test(table(sp1_data$period, sp1_data$dem_statement_pair_1))

  cat("=== Statement Pair 1 (q82) ===\n")
  cat("Note: In W5 q82, Statement 1 vs Statement 2 (generic labels in harmonized data).\n")
  cat("Check ABS W5 codebook for exact wording.\n\n")

  sp1_xtab |>
    mutate(prop = round(prop, 3)) |>
    kable(
      col.names = c("Period", "Statement Choice", "N", "Proportion"),
      caption = paste0("Statement pair 1 by period (Chi-sq p = ",
                       format.pval(sp1_chi$p.value, digits = 3), ")"),
      booktabs = TRUE
    ) |>
    kable_styling(latex_options = c("hold_position")) |>
    print()

  cat("\nChi-squared: X2 =", round(sp1_chi$statistic, 2),
      ", p =", format.pval(sp1_chi$p.value, digits = 3), "\n")
}
```


# 4. Visualizations

## 4a. Conceptions of Democracy by Period (q98)

```{r}
#| label: fig-dem-conceptions
#| fig-cap: "Most essential element of democracy by period. Post-NSL respondents shift toward basic needs and away from expressive/electoral conceptions."
#| fig-width: 8
#| fig-height: 5

dem_ess_labels_short <- c(
  `1` = "Free\nexpression",
  `2` = "Free\nelections",
  `4` = "Basic Needs\n(necessities)",
  `5` = "Good Gov.\n(clean politics)"
)

dem_ess_plot <- hk5_analysis |>
  filter(!is.na(dem_essential_harmonized)) |>
  mutate(dem_label = recode(as.character(dem_essential_harmonized),
                             !!!dem_ess_labels_short)) |>
  count(period, dem_label) |>
  group_by(period) |>
  mutate(prop = n / sum(n)) |>
  ungroup()

ggplot(dem_ess_plot, aes(x = dem_label, y = prop, fill = period)) +
  geom_col(position = position_dodge(0.8), width = 0.7, alpha = 0.85) +
  geom_text(aes(label = paste0(round(prop * 100, 1), "%")),
            position = position_dodge(0.8), vjust = -0.5, size = 3) +
  scale_fill_manual(values = c("Protest" = "#FF7043", "Post-NSL" = "#5C6BC0")) +
  scale_y_continuous(labels = scales::percent_format(), expand = expansion(mult = c(0, 0.15))) +
  labs(
    x = NULL, y = "Proportion",
    fill = NULL,
    title = "Most Essential Element of Democracy (q98)",
    subtitle = paste0("Chi-squared p = ", format.pval(dem_ess_chi$p.value, digits = 3)),
    caption = "Source: ABS W5 Hong Kong. Labels: 1=Free expression, 2=Free elections, 4=Basic Needs, 5=Good Governance.\nNote: Redistributive (3) not available in W5."
  ) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "top",
    plot.caption = element_text(size = 9, hjust = 0)
  )

ggsave("figures/dem_conceptions_by_period.pdf", width = 8, height = 5)
ggsave("figures/dem_conceptions_by_period.png", width = 8, height = 5, dpi = 300)
```

## 4b. China Democratic Rating by Period (q128)

```{r}
#| label: fig-china-rating
#| fig-cap: "Distribution of China democratic rating (1-10) by period. Post-NSL respondents rate China as substantially more democratic."
#| fig-width: 8
#| fig-height: 5

china_data <- hk5_analysis |> filter(!is.na(dem_rating_china))

china_means <- china_data |>
  group_by(period) |>
  summarise(mean_val = weighted.mean(dem_rating_china, weight), .groups = "drop")

ggplot(china_data, aes(x = dem_rating_china, fill = period, color = period)) +
  geom_density(alpha = 0.35, bw = 0.7) +
  geom_vline(data = china_means, aes(xintercept = mean_val, color = period),
             linetype = "dashed", linewidth = 0.8) +
  scale_fill_manual(values = c("Protest" = "#FF7043", "Post-NSL" = "#5C6BC0")) +
  scale_color_manual(values = c("Protest" = "#FF7043", "Post-NSL" = "#5C6BC0")) +
  scale_x_continuous(breaks = 1:10) +
  labs(
    x = "Democratic Rating (1 = Complete Dictatorship, 10 = Complete Democracy)",
    y = "Density",
    fill = NULL, color = NULL,
    title = "Where Would You Place China on a Democratic Scale? (q128)",
    subtitle = paste0("Protest mean = ", round(china_means$mean_val[1], 2),
                      ", Post-NSL mean = ", round(china_means$mean_val[2], 2)),
    caption = paste0("Cohen's d = ",
                     round(cont_results$cohens_d[cont_results$variable == "dem_rating_china"], 2),
                     ". Dashed lines = period means.")
  ) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "top",
    plot.caption = element_text(size = 9, hjust = 0)
  )

ggsave("figures/china_rating_density.pdf", width = 8, height = 5)
ggsave("figures/china_rating_density.png", width = 8, height = 5, dpi = 300)
```

## 4c. Demonstration Attendance by Period (q79)

```{r}
#| label: fig-demonstration
#| fig-cap: "Distribution of demonstration attendance (1-5, higher = more active) by period."
#| fig-width: 8
#| fig-height: 5

demo_data <- hk5_analysis |> filter(!is.na(action_demonstration))

demo_means <- demo_data |>
  group_by(period) |>
  summarise(mean_val = weighted.mean(action_demonstration, weight), .groups = "drop")

demo_bar <- demo_data |>
  count(period, action_demonstration) |>
  group_by(period) |>
  mutate(prop = n / sum(n)) |>
  ungroup()

ggplot(demo_bar, aes(x = factor(action_demonstration), y = prop, fill = period)) +
  geom_col(position = position_dodge(0.8), width = 0.7, alpha = 0.85) +
  scale_fill_manual(values = c("Protest" = "#FF7043", "Post-NSL" = "#5C6BC0")) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_x_discrete(labels = c("Would\nnever do", "Not done,\nbut might",
                               "Done\nonce", "Done\n2-3x", "Done\n>3x")) +
  labs(
    x = "Demonstration Attendance", y = "Proportion",
    fill = NULL,
    title = "Attended a Demonstration or Protest March (q79)",
    subtitle = paste0("Protest mean = ", round(demo_means$mean_val[1], 2),
                      ", Post-NSL mean = ", round(demo_means$mean_val[2], 2)),
    caption = paste0("Cohen's d = ",
                     round(cont_results$cohens_d[cont_results$variable == "action_demonstration"], 2),
                     ". Scale reversed so higher = more active.")
  ) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "top",
    plot.caption = element_text(size = 9, hjust = 0)
  )

ggsave("figures/demonstration_by_period.pdf", width = 8, height = 5)
ggsave("figures/demonstration_by_period.png", width = 8, height = 5, dpi = 300)
```


# 5. Age-Stratified Analysis

## 5a. Conceptions of Democracy (q98) by Age Group

```{r}
#| label: fig-dem-conceptions-age
#| fig-cap: "Most essential element of democracy by period and age cohort. The shift toward basic needs appears across all age groups."
#| fig-width: 12
#| fig-height: 8

dem_ess_age <- hk5_analysis |>
  filter(!is.na(dem_essential_harmonized), !is.na(age_group)) |>
  mutate(dem_label = recode(as.character(dem_essential_harmonized),
                             !!!dem_ess_labels_short)) |>
  count(period, age_group, dem_label) |>
  group_by(period, age_group) |>
  mutate(prop = n / sum(n)) |>
  ungroup()

ggplot(dem_ess_age, aes(x = dem_label, y = prop, fill = period)) +
  geom_col(position = position_dodge(0.8), width = 0.7, alpha = 0.85) +
  facet_wrap(~age_group, ncol = 3) +
  scale_fill_manual(values = c("Protest" = "#FF7043", "Post-NSL" = "#5C6BC0")) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    x = NULL, y = "Proportion", fill = NULL,
    title = "Conceptions of Democracy by Period and Age Cohort (q98)"
  ) +
  theme_minimal(base_size = 11) +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
    strip.text = element_text(face = "bold")
  )

ggsave("figures/dem_conceptions_age.pdf", width = 12, height = 8)
ggsave("figures/dem_conceptions_age.png", width = 12, height = 8, dpi = 300)
```

## 5b. Demonstration Attendance (q79) by Age Group

Note: q93 (protest freedom as essential democratic characteristic, 1-10)
is not available in the harmonized dataset because W5 used a different
question format than other waves. We substitute `action_demonstration`
(q79) which captures actual protest participation rather than normative
valuation, and is the closest available behavioral measure.

```{r}
#| label: fig-demonstration-age
#| fig-cap: "Demonstration attendance by period and age cohort. Young adults show the sharpest decline in protest activity post-NSL."
#| fig-width: 12
#| fig-height: 7

demo_age <- hk5_analysis |>
  filter(!is.na(action_demonstration), !is.na(age_group)) |>
  group_by(period, age_group) |>
  summarise(
    mean = weighted.mean(action_demonstration, weight),
    se = weighted_sd(action_demonstration, weight) / sqrt(n()),
    n = n(),
    .groups = "drop"
  )

ggplot(demo_age, aes(x = age_group, y = mean, fill = period)) +
  geom_col(position = position_dodge(0.8), width = 0.7, alpha = 0.85) +
  geom_errorbar(aes(ymin = mean - 1.96 * se, ymax = mean + 1.96 * se),
                position = position_dodge(0.8), width = 0.25) +
  scale_fill_manual(values = c("Protest" = "#FF7043", "Post-NSL" = "#5C6BC0")) +
  labs(
    x = "Age Cohort", y = "Mean (1-5, higher = more active)", fill = NULL,
    title = "Demonstration Attendance by Period and Age Cohort (q79)"
  ) +
  theme_minimal(base_size = 11) +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

ggsave("figures/demonstration_age.pdf", width = 12, height = 7)
ggsave("figures/demonstration_age.png", width = 12, height = 7, dpi = 300)
```

## 5c. China Democratic Rating by Age Group

```{r}
#| label: fig-china-rating-age
#| fig-cap: "China democratic rating by period and age cohort. The upward shift in China ratings appears across all age groups."
#| fig-width: 12
#| fig-height: 7

china_age <- hk5_analysis |>
  filter(!is.na(dem_rating_china), !is.na(age_group)) |>
  group_by(period, age_group) |>
  summarise(
    mean = weighted.mean(dem_rating_china, weight),
    se = weighted_sd(dem_rating_china, weight) / sqrt(n()),
    n = n(),
    .groups = "drop"
  )

ggplot(china_age, aes(x = age_group, y = mean, fill = period)) +
  geom_col(position = position_dodge(0.8), width = 0.7, alpha = 0.85) +
  geom_errorbar(aes(ymin = mean - 1.96 * se, ymax = mean + 1.96 * se),
                position = position_dodge(0.8), width = 0.25) +
  scale_fill_manual(values = c("Protest" = "#FF7043", "Post-NSL" = "#5C6BC0")) +
  labs(
    x = "Age Cohort", y = "Mean (1-10)", fill = NULL,
    title = "China Democratic Rating by Period and Age Cohort (q128)"
  ) +
  theme_minimal(base_size = 11) +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

ggsave("figures/china_rating_age.pdf", width = 12, height = 7)
ggsave("figures/china_rating_age.png", width = 12, height = 7, dpi = 300)
```


# 6. Item-Level Response Rates (Differential Sensitivity)

If the NSL chilled responses on politically sensitive items, we should see
lower response rates post-NSL for evaluative/institutional items but not for
abstract/normative ones. This follows Jiang & Yang (2016) on differential
item sensitivity under authoritarian constraints.

```{r response-rate-table}
rr_vars <- tribble(
  ~variable,                       ~label,                                  ~type,
  "trust_police",                  "Trust: Police",                         "Trust",
  "trust_national_government",     "Trust: National Government",            "Trust",
  "trust_courts",                  "Trust: Courts",                         "Trust",
  "trust_parliament",              "Trust: Parliament",                     "Trust",
  "trust_military",                "Trust: Military",                       "Trust",
  "trust_civil_service",           "Trust: Civil Service",                  "Trust",
  "democracy_suitability",         "Democracy Suitability (q104)",          "Democracy",
  "democracy_satisfaction",        "Democracy Satisfaction (q99)",          "Democracy",
  "dem_essential_harmonized",      "Essential Dem Characteristic (q98)",    "Democracy",
  "dem_rating_china",              "China Dem Rating (q128)",               "Evaluative",
  "sat_president_govt",            "Satisfaction w/ Govt (q105)",           "Evaluative",
  "dem_free_speech",               "Free Speech Important",                "Democracy",
  "action_demonstration",          "Demonstration Participation (q79)",    "Behavioral",
  "dem_country_future",            "Dem Country Future (q103)",             "Evaluative",
  "dem_country_present_govt",      "Extent of Democracy Now",              "Evaluative",
  "dem_procedural_vs_substantive", "Procedural vs Substantive",            "Democracy",
  "dem_always_preferable",         "Dem Always Preferable (q132)",         "Democracy",
  "dem_statement_pair_1",          "Dem Statement Pair 1",                 "Democracy",
  "system_deserves_support",       "System Deserves Support",              "Evaluative",
  "dem_best_form",                 "Democracy Best Form",                  "Democracy"
)

# Keep only variables present in dataset
rr_vars <- rr_vars |> filter(variable %in% names(hk5_analysis))

rr_results <- map_dfr(seq_len(nrow(rr_vars)), function(i) {
  v <- rr_vars$variable[i]
  hk5_analysis |>
    group_by(period) |>
    summarise(
      total_n = n(),
      valid_n = sum(!is.na(.data[[v]])),
      rr = valid_n / total_n,
      .groups = "drop"
    ) |>
    mutate(variable = v, label = rr_vars$label[i], type = rr_vars$type[i])
})

rr_wide <- rr_results |>
  select(label, type, period, valid_n, rr) |>
  pivot_wider(
    names_from = period,
    values_from = c(valid_n, rr),
    names_glue = "{period}_{.value}"
  )

# Fix column names (Post-NSL becomes backtick-quoted)
rr_wide <- rr_wide |>
  rename(
    protest_n = Protest_valid_n,
    postnsl_n = `Post-NSL_valid_n`,
    protest_rr = Protest_rr,
    postnsl_rr = `Post-NSL_rr`
  ) |>
  mutate(
    diff_pp = round((postnsl_rr - protest_rr) * 100, 1),
    flag = ifelse(abs(diff_pp) > 5, ">>5pp", "")
  ) |>
  arrange(diff_pp)
```

```{r}
#| label: tbl-response-rates
#| tbl-cap: "Item-level response rates by period. Negative difference indicates lower response post-NSL. Items flagged where |difference| > 5 percentage points."
rr_wide |>
  mutate(
    protest_rr_fmt = paste0(round(protest_rr * 100, 1), "%"),
    postnsl_rr_fmt = paste0(round(postnsl_rr * 100, 1), "%"),
    diff_fmt = paste0(ifelse(diff_pp > 0, "+", ""), diff_pp, "pp")
  ) |>
  select(label, type, protest_n, protest_rr_fmt, postnsl_n, postnsl_rr_fmt,
         diff_fmt, flag) |>
  kable(
    col.names = c("Variable", "Type", "N (Prot.)", "RR (Prot.)",
                   "N (Post)", "RR (Post)", "Diff (pp)", "Flag"),
    booktabs = TRUE
  ) |>
  kable_styling(latex_options = c("scale_down", "hold_position")) |>
  row_spec(which(rr_wide$flag != ""), bold = TRUE)
```

```{r response-rate-interpretation}
flagged <- rr_wide |> filter(flag != "")
cat("=== DIFFERENTIAL ITEM SENSITIVITY ===\n\n")
cat("Items with >5pp response rate drop post-NSL:\n")
for (i in seq_len(nrow(flagged))) {
  cat("  -", flagged$label[i], "(", flagged$type[i], "):",
      flagged$diff_pp[i], "pp\n")
}

cat("\nPattern: Evaluative/political items (regime assessment, democracy preferences)",
    "\nshow lower response rates post-NSL, while trust items show near-zero",
    "\nor slightly positive differences.",
    "\n\nThis is consistent with Jiang & Yang (2016) differential item sensitivity:",
    "\nrespondents post-NSL are more likely to skip items requiring explicit",
    "\nevaluation of the regime's democratic performance, but answer trust items",
    "\n(which are more ambiguous in valence) without difficulty.\n")

# Mean RR by type
rr_by_type <- rr_results |>
  group_by(type, period) |>
  summarise(mean_rr = mean(rr), .groups = "drop") |>
  pivot_wider(names_from = period, values_from = mean_rr) |>
  mutate(diff = round((`Post-NSL` - Protest) * 100, 1))

cat("\nMean response rate by item type:\n")
rr_by_type |>
  mutate(across(c(Protest, `Post-NSL`), ~paste0(round(. * 100, 1), "%"))) |>
  kable(col.names = c("Type", "Protest RR", "Post-NSL RR", "Diff (pp)")) |>
  print()
```


# 7. Summary

```{r summary-findings}
cat("\n========================================\n")
cat("ALTERNATIVE EXPLANATIONS: KEY FINDINGS\n")
cat("========================================\n\n")

# China rating
china_row <- cont_results |> filter(variable == "dem_rating_china")
if (nrow(china_row) > 0) {
  cat("1. CHINA DEMOCRATIC RATING (q128):\n")
  cat("   Post-NSL respondents rate China as MORE democratic\n")
  cat("   (", round(china_row$protest_mean, 2), "->",
      round(china_row$postnsl_mean, 2), ", d =",
      round(china_row$cohens_d, 2), ")\n")
  cat("   -> Supports information environment / co-optation interpretation\n\n")
}

# Democratic conceptions
cat("2. CONCEPTIONS OF DEMOCRACY (q98):\n")
cat("   Shift in composition of democratic conceptions across periods.\n")
cat("   Chi-squared p =", format.pval(dem_ess_chi$p.value, digits = 3), "\n")
cat("   -> Tests whether 'democracy was never consolidated' explanation holds\n\n")

# Demonstration
demo_row <- cont_results |> filter(variable == "action_demonstration")
if (nrow(demo_row) > 0) {
  cat("3. DEMONSTRATION ATTENDANCE (q79):\n")
  cat("   Post-NSL respondents report LESS protest activity\n")
  cat("   (", round(demo_row$protest_mean, 2), "->",
      round(demo_row$postnsl_mean, 2), ", d =",
      round(demo_row$cohens_d, 2), ")\n")
  cat("   -> Consistent with chilling effect of NSL on reported behavior\n\n")
}

# Democratic future
future_row <- cont_results |> filter(variable == "dem_country_future")
if (nrow(future_row) > 0) {
  cat("4. DEMOCRATIC FUTURE (q103):\n")
  cat("   Post-NSL respondents expect LESS democratic future\n")
  cat("   (", round(future_row$protest_mean, 2), "->",
      round(future_row$postnsl_mean, 2), ", d =",
      round(future_row$cohens_d, 2), ")\n")
  cat("   -> Trust increase coexists with democratic pessimism\n\n")
}

# Free speech
speech_row <- cont_results |> filter(variable == "dem_free_speech")
if (nrow(speech_row) > 0) {
  cat("5. FREE SPEECH (q115 proxy for q84):\n")
  cat("   (", round(speech_row$protest_mean, 2), "->",
      round(speech_row$postnsl_mean, 2), ", d =",
      round(speech_row$cohens_d, 2), ")\n\n")
}

# Satisfaction with president/govt
sat_row <- cont_results |> filter(variable == "sat_president_govt")
if (nrow(sat_row) > 0) {
  cat("6. SATISFACTION WITH PRESIDENT/GOVT (q105):\n")
  cat("   (", round(sat_row$protest_mean, 2), "->",
      round(sat_row$postnsl_mean, 2), ", d =",
      round(sat_row$cohens_d, 2), ")\n\n")
}
```


# 8. Save Results

```{r save-results}
save(cont_results, dem_ess_xtab, dem_ess_chi, rr_wide, rr_by_type,
     file = "results/alt_explanations_results.RData")
cat("Results saved to results/alt_explanations_results.RData\n")
```
