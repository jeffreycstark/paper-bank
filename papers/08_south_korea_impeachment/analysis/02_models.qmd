---
title: "02 — Main Models: PAPER TITLE"
format:
  html:
    toc: true
    toc-depth: 3
    number-sections: true
    theme: cosmo
    code-fold: true
    self-contained: true
execute:
  echo: true
  warning: false
  message: false
  cache: true
---

**Purpose**: Main regression models and primary results.

- **Input**: `analysis/results/analysis_data.rds`
- **Output**: `analysis/results/model_results.rds`,
  figures → `analysis/figures/`, tables → `analysis/tables/`

```{r setup}
library(tidyverse)
library(broom)
library(modelsummary)
library(knitr)
library(kableExtra)

project_root <- "/Users/jeffreystark/Development/Research/paper-bank"
paper_dir    <- file.path(project_root, "papers/00-model")
analysis_dir <- file.path(paper_dir, "analysis")
results_dir  <- file.path(analysis_dir, "results")
fig_dir      <- file.path(analysis_dir, "figures")
tables_dir   <- file.path(analysis_dir, "tables")

source(file.path(paper_dir, "R", "helpers.R"))

dat <- readRDS(file.path(results_dir, "analysis_data.rds"))
```

## Main model specification

```{r model-spec}
# TODO: define the model formula(s) for this paper
# controls_formula <- "age_n + gender + edu_n + urban_rural + polint_n"
# main_formula     <- as.formula(paste("dv1_n ~", "iv1_n +", controls_formula))
```

## Estimate models

```{r estimate}
# TODO: estimate models — example pattern for wave-by-wave OLS:
#
# model_list <- dat |>
#   group_by(country_label, wave) |>
#   group_map(function(df, grp) {
#     m <- lm(main_formula, data = df)
#     tidy(m, conf.int = TRUE) |>
#       mutate(country = grp$country_label, wave = grp$wave, n = nrow(df))
#   }) |>
#   bind_rows()
#
# model_list |>
#   filter(term == "iv1_n") |>
#   select(country, wave, estimate, std.error, p.value, conf.low, conf.high) |>
#   print()
```

## Coefficient plot

```{r coef-plot}
# TODO: visualize main coefficients across waves / countries
#
# p_coef <- model_list |>
#   filter(term == "iv1_n") |>
#   ggplot(aes(x = wave, y = estimate, ymin = conf.low, ymax = conf.high,
#              colour = country)) +
#   geom_hline(yintercept = 0, linetype = "dashed", colour = "grey50") +
#   geom_errorbar(width = 0.15) +
#   geom_point(size = 2.5) +
#   theme_pub +
#   labs(title = "IV1 → DV1 by wave", x = "Wave", y = "OLS coefficient (95% CI)")
#
# ggsave(file.path(fig_dir, "fig_coef_main.pdf"), p_coef, width = 6, height = 4)
# ggsave(file.path(fig_dir, "fig_coef_main.png"), p_coef, width = 6, height = 4, dpi = 300)
```

## Model summary table

```{r model-table}
# TODO: build publication-quality table using modelsummary()
#
# models_for_table <- list(...)
# modelsummary(models_for_table,
#              stars = c("*" = 0.05, "**" = 0.01, "***" = 0.001),
#              output = file.path(tables_dir, "table_main_models.csv"))
```

## Save results

```{r save}
# TODO: collect all model outputs into a list for use by the manuscript
# mr <- list(
#   model_list = model_list,
#   ...
# )
# saveRDS(mr, file.path(results_dir, "model_results.rds"))
cat("✓ Main models complete\n")
```
