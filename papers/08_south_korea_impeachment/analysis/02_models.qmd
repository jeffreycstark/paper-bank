---
title: "02 — Main Models: The Accountability Paradox"
subtitle: "Three-way pooled OLS + output legitimacy moderation + partisan sorting check"
format:
  html:
    toc: true
    toc-depth: 3
    number-sections: true
    theme: cosmo
    code-fold: true
    self-contained: true
execute:
  echo: true
  warning: false
  message: false
  cache: true
---

**Purpose**: Estimate the three main regression models for the accountability paradox
paper and save results for the manuscript.

**Model logic**: The KAMOS institution-stacked long dataset has five trust observations
per respondent (CentralGovt, LocalGovt, NatlAssembly, Media, NGOs). Pooled weighted OLS
with cluster-robust standard errors on respondent ID tests whether Wave 4 (2019) trust
declined differentially by institution type, with Executive as the reference category.

- **Inputs**:
  - `analysis/results/kamos_wide.rds`
  - `analysis/results/kamos_long.rds`
  - `analysis/results/kamos_trust_means.rds`
- **Outputs**:
  - `analysis/results/threeway_model.rds`
  - `analysis/results/output_legitimacy_model.rds`
  - `analysis/results/partisan_model.rds`
  - `analysis/figures/fig3_predicted_margins.pdf/png`
  - `analysis/figures/fig4_output_legitimacy.pdf/png`

```{r setup}
library(tidyverse)
library(sandwich)        # vcovCL() cluster-robust variance
library(lmtest)          # coeftest()
library(marginaleffects) # avg_comparisons(), predictions()
library(modelsummary)
library(knitr)
library(kableExtra)
library(broom)

project_root <- "/Users/jeffreystark/Development/Research/paper-bank"
paper_dir    <- file.path(project_root, "papers/08_south_korea_impeachment")
analysis_dir <- file.path(paper_dir, "analysis")
results_dir  <- file.path(analysis_dir, "results")
fig_dir      <- file.path(analysis_dir, "figures")
tables_dir   <- file.path(analysis_dir, "tables")

source(file.path(paper_dir, "R", "helpers.R"))

kamos_wide  <- readRDS(file.path(results_dir, "kamos_wide.rds"))
kamos_long  <- readRDS(file.path(results_dir, "kamos_long.rds"))
kamos_means <- readRDS(file.path(results_dir, "kamos_trust_means.rds"))

# Ensure reference category: Executive = baseline, wave_num 0 = W1 (2016)
kamos_long <- kamos_long |>
  mutate(
    inst_type = relevel(factor(inst_type), ref = "Executive"),
    wave_num  = as.integer(wave_num)   # 0 = W1, 1 = W4
  )

cat("KAMOS long: n =", nrow(kamos_long), "obs\n")
cat("Institution types:", levels(kamos_long$inst_type), "\n")
cat("Wave distribution:", table(kamos_long$wave_num), "\n")
```

---

## Model 1: Three-way pooled OLS (main result)

### Specification

The main model asks: controlling for demographics and partisanship, did trust decline
significantly more for Horizontal and Societal institutions than for Executive
institutions across the 2016–2019 window?

```
trust_score_n ~ wave_num * inst_type + controls
```

Key interactions (`wave_num × inst_type`):
- `wave_num:inst_typeHorizontal` — excess decline in horizontal trust vs. executive
- `wave_num:inst_typeSocietal`   — excess decline in societal trust vs. executive

```{r model1-estimate}
controls <- c("age_n", "gender", "edu_n", "income_n", "ideology_n")
controls_f <- paste(controls, collapse = " + ")

f1 <- as.formula(
  paste("trust_score_n ~ wave_num * inst_type +", controls_f)
)

threeway_mod <- lm(f1, data = kamos_long, weights = weight)

# Cluster-robust SEs: one cluster per respondent (observations within respondent are correlated)
threeway_vcov <- vcovCL(threeway_mod, cluster = ~resp_id, type = "HC1")
threeway_ct   <- coeftest(threeway_mod, vcov = threeway_vcov)

cat("=== Model 1: Three-way pooled OLS ===\n")
cat("N (observations):", nobs(threeway_mod), "\n")
cat("N (respondents):", n_distinct(kamos_long$resp_id), "\n\n")
print(threeway_ct)
```

### Predicted trust margins

```{r model1-margins}
# Predicted means by wave × institution type, holding controls at means
pred_m1 <- predictions(
  threeway_mod,
  newdata = datagrid(
    wave_num  = c(0, 1),
    inst_type = levels(kamos_long$inst_type)
  ),
  vcov = threeway_vcov
)

pred_m1_df <- as.data.frame(pred_m1) |>
  mutate(
    wave_f    = factor(wave_num, levels = c(0, 1),
                       labels = c("W1 (2016)", "W4 (2019)")),
    inst_type = factor(inst_type, levels = c("Executive", "Horizontal", "Societal"))
  )

cat("\n=== Predicted trust means by wave and institution type ===\n")
pred_m1_df |>
  select(wave_f, inst_type, estimate, conf.low, conf.high) |>
  mutate(across(where(is.numeric), ~round(.x, 3))) |>
  print()

# Average marginal effect of wave (W4 vs W1) by institution type
ame_wave <- avg_comparisons(
  threeway_mod,
  variables = "wave_num",
  by        = "inst_type",
  vcov      = threeway_vcov
)

cat("\n=== AME of wave (W4 vs W1) by institution type ===\n")
as.data.frame(ame_wave) |>
  select(inst_type, estimate, conf.low, conf.high, p.value) |>
  mutate(across(where(is.numeric), ~round(.x, 3))) |>
  print()
```

### Figure 3: Predicted trust margins

```{r fig3-predicted-margins}
p3 <- ggplot(pred_m1_df,
             aes(x = inst_type, y = estimate,
                 colour = wave_f, shape = wave_f, group = wave_f)) +
  geom_point(size = 3.5, position = position_dodge(width = 0.4)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high),
                width = 0.18, linewidth = 0.7,
                position = position_dodge(width = 0.4)) +
  geom_line(position = position_dodge(width = 0.4), linewidth = 0.6,
            linetype = "dashed", alpha = 0.6) +
  scale_colour_manual(
    values = c("W1 (2016)" = "#4575B4", "W4 (2019)" = "#D73027"),
    labels = c("W1 (2016) — During crisis",
               "W4 (2019) — Post-impeachment")
  ) +
  scale_shape_manual(
    values = c(16, 17),
    labels = c("W1 (2016) — During crisis",
               "W4 (2019) — Post-impeachment")
  ) +
  scale_y_continuous(limits = c(0.15, 0.65),
                     labels = scales::number_format(accuracy = 0.01)) +
  labs(
    x      = "Institution accountability function",
    y      = "Predicted trust (0–1 scale)",
    colour = NULL, shape  = NULL,
    caption = paste0(
      "Note: Predicted means from pooled weighted OLS with cluster-robust SEs (cluster = respondent).\n",
      "Controls held at means. Reference category: Executive, W1 (2016). Source: KAMOS W1/W4."
    )
  ) +
  theme_pub +
  theme(legend.position = "bottom")

ggsave(file.path(fig_dir, "fig3_predicted_margins.pdf"), p3, width = 6.5, height = 4.5)
ggsave(file.path(fig_dir, "fig3_predicted_margins.png"), p3, width = 6.5, height = 4.5, dpi = 300)
cat("✓ Figure 3 saved\n")
p3
```

### Table 3: Main model coefficients

```{r tbl3-threeway}
# Build coefficient table for manuscript
tbl3_rows <- threeway_ct |>
  tidy() |>
  filter(str_detect(term, "wave_num|inst_type")) |>
  mutate(
    stars = sig_stars(p.value),
    term  = recode(term,
      wave_num                       = "Wave (W4 = 1)",
      inst_typeHorizontal            = "Horizontal (ref: Executive)",
      inst_typeSocietal              = "Societal (ref: Executive)",
      `wave_num:inst_typeHorizontal` = "Wave × Horizontal",
      `wave_num:inst_typeSocietal`   = "Wave × Societal"
    )
  ) |>
  select(term, estimate, std.error, statistic, p.value, stars) |>
  mutate(across(c(estimate, std.error, statistic), ~round(.x, 4)),
         p.value = round(p.value, 4))

write_csv(tbl3_rows, file.path(tables_dir, "tbl3_threeway_model.csv"))

tbl3_rows |>
  kbl(caption = "Pooled OLS: trust decline by institution type, 2016–2019 (cluster-robust SEs)",
      col.names = c("Term", "Estimate", "SE", "t", "p", "")) |>
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) |>
  footnote(general = paste0(
    "N = ", nobs(threeway_mod), " obs (", n_distinct(kamos_long$resp_id),
    " respondents × 5 institutions). SEs clustered on respondent. ",
    "Controls: age, gender, education, income, ideology (all normalized 0–1). ",
    "Reference: Executive institution, Wave 1 (2016). ",
    "*** p < 0.001, ** p < 0.01, * p < 0.05."
  ))
```

---

## Model 2: Output legitimacy moderation

Does the institutional asymmetry in trust decline operate through economic evaluation?
The output legitimacy mechanism predicts that Executive trust is buffered by economic
satisfaction, but Horizontal and Societal trust are not.

```
trust_score_n ~ wave_num * inst_type * econ_present_n + controls
```

The key three-way interaction terms:
- `wave_num:inst_typeHorizontal:econ_present_n`
- `wave_num:inst_typeSocietal:econ_present_n`

```{r model2-outleg}
f2 <- as.formula(
  paste("trust_score_n ~ wave_num * inst_type * econ_present_n +",
        paste(setdiff(controls, "ideology_n"), collapse = " + "))
)

outleg_mod  <- lm(f2, data = kamos_long, weights = weight)
outleg_vcov <- vcovCL(outleg_mod, cluster = ~resp_id, type = "HC1")
outleg_ct   <- coeftest(outleg_mod, vcov = outleg_vcov)

cat("=== Model 2: Output legitimacy moderation ===\n")
cat("N:", nobs(outleg_mod), "\n\n")

# Show only the interaction terms
outleg_ct |>
  tidy() |>
  filter(str_detect(term, ":")) |>
  select(term, estimate, std.error, p.value) |>
  mutate(across(where(is.numeric), ~round(.x, 4))) |>
  print()
```

### Predicted trust margins by econ quartile × institution type

```{r model2-margins-econ}
# Compute predicted trust at low/high economic evaluation
econ_lo <- quantile(kamos_long$econ_present_n, 0.25, na.rm = TRUE)
econ_hi <- quantile(kamos_long$econ_present_n, 0.75, na.rm = TRUE)

pred_m2 <- predictions(
  outleg_mod,
  newdata = datagrid(
    wave_num      = c(0, 1),
    inst_type     = levels(kamos_long$inst_type),
    econ_present_n = c(econ_lo, econ_hi)
  ),
  vcov = outleg_vcov
) |>
  as.data.frame() |>
  mutate(
    wave_f    = factor(wave_num, levels = c(0, 1),
                       labels = c("W1 (2016)", "W4 (2019)")),
    econ_lab  = if_else(econ_present_n == econ_lo,
                        "Low econ. eval. (Q1)", "High econ. eval. (Q3)"),
    inst_type = factor(inst_type, levels = c("Executive", "Horizontal", "Societal"))
  )

cat("\n=== Predicted trust by wave × inst_type × econ quartile ===\n")
pred_m2 |>
  select(wave_f, inst_type, econ_lab, estimate, conf.low, conf.high) |>
  mutate(across(where(is.numeric), ~round(.x, 3))) |>
  print()
```

### Figure 4: Output legitimacy moderation

```{r fig4-output-legitimacy}
p4 <- ggplot(pred_m2,
             aes(x = wave_f, y = estimate,
                 colour = econ_lab, shape = econ_lab, group = econ_lab)) +
  geom_line(linewidth = 0.9) +
  geom_point(size = 3) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = econ_lab),
              alpha = 0.12, colour = NA) +
  facet_wrap(~inst_type, nrow = 1) +
  scale_colour_manual(values = c("Low econ. eval. (Q1)"  = "#D73027",
                                  "High econ. eval. (Q3)" = "#4575B4")) +
  scale_fill_manual(values = c("Low econ. eval. (Q1)"  = "#D73027",
                                "High econ. eval. (Q3)" = "#4575B4")) +
  scale_shape_manual(values = c(17, 16)) +
  scale_y_continuous(labels = scales::number_format(accuracy = 0.01)) +
  labs(
    x      = NULL,
    y      = "Predicted trust (0–1 scale)",
    colour = NULL, shape = NULL, fill = NULL,
    caption = paste0(
      "Note: Predicted means by economic evaluation quartile. ",
      "Shaded bands = 95% CI. Cluster-robust SEs. Source: KAMOS W1/W4."
    )
  ) +
  theme_pub +
  theme(legend.position  = "bottom",
        strip.background = element_rect(fill = "grey92", colour = NA),
        strip.text       = element_text(face = "bold"))

ggsave(file.path(fig_dir, "fig4_output_legitimacy.pdf"), p4, width = 7.5, height = 4.5)
ggsave(file.path(fig_dir, "fig4_output_legitimacy.png"), p4, width = 7.5, height = 4.5, dpi = 300)
cat("✓ Figure 4 saved\n")
p4
```

### Table 4: Output legitimacy model

```{r tbl4-outleg}
tbl4_rows <- outleg_ct |>
  tidy() |>
  filter(str_detect(term, "inst_type|wave_num|econ")) |>
  mutate(
    stars = sig_stars(p.value),
    term  = term |>
      str_replace_all("wave_num", "Wave") |>
      str_replace_all("inst_type", "Inst.type:") |>
      str_replace_all("econ_present_n", "Econ.eval")
  ) |>
  select(term, estimate, std.error, p.value, stars) |>
  mutate(across(c(estimate, std.error), ~round(.x, 4)),
         p.value = round(p.value, 4))

write_csv(tbl4_rows, file.path(tables_dir, "tbl4_output_legitimacy_model.csv"))

tbl4_rows |>
  kbl(caption = "Output legitimacy moderation model (key coefficients)",
      col.names = c("Term", "Estimate", "SE", "p", "")) |>
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

---

## Model 3: Partisan sorting check

Tests whether the trust divergence reflects partisan sorting rather than a structural
pattern. If the collapse is driven by Park supporters punishing the institutions that
removed her, we should see a strong interaction between conservative party ID and
wave for the Horizontal category specifically.

```
trust_score_n ~ wave_num * inst_type * party_id + age_n + gender + edu_n + income_n
```

```{r model3-partisan}
# Recode party_id to three groups: governing (Moon/progressive), opposition
# (conservative/PPP-predecessor), and none/independent
kamos_long <- kamos_long |>
  mutate(
    party_id3 = case_when(
      # CHECK: update party codes against actual KAMOS party_id coding
      # Typical KAMOS coding: 1=Minjoo/Democratic, 2=PPP/Liberty Korea, 3=none/independent
      as.integer(party_id) == 1 ~ "Progressive",
      as.integer(party_id) == 2 ~ "Conservative",
      TRUE ~ "None/Other"
    ) |>
    factor(levels = c("None/Other", "Progressive", "Conservative"))
  )

f3 <- as.formula(
  paste("trust_score_n ~ wave_num * inst_type * party_id3 +",
        paste(setdiff(controls, "ideology_n"), collapse = " + "))
)

partisan_mod  <- lm(f3, data = kamos_long, weights = weight)
partisan_vcov <- vcovCL(partisan_mod, cluster = ~resp_id, type = "HC1")
partisan_ct   <- coeftest(partisan_mod, vcov = partisan_vcov)

cat("=== Model 3: Partisan sorting check ===\n")
cat("N:", nobs(partisan_mod), "\n\n")

# Show three-way interactions only
partisan_ct |>
  tidy() |>
  filter(str_detect(term, "party_id3") & str_detect(term, ":")) |>
  select(term, estimate, std.error, p.value) |>
  mutate(across(where(is.numeric), ~round(.x, 4)),
         stars = sig_stars(p.value)) |>
  print()
```

### Predicted trust by party group × wave × institution type

```{r partisan-margins}
pred_m3 <- predictions(
  partisan_mod,
  newdata = datagrid(
    wave_num  = c(0, 1),
    inst_type = levels(kamos_long$inst_type),
    party_id3 = c("Progressive", "Conservative", "None/Other")
  ),
  vcov = partisan_vcov
) |>
  as.data.frame() |>
  mutate(
    wave_f    = factor(wave_num, levels = c(0, 1),
                       labels = c("W1 (2016)", "W4 (2019)")),
    inst_type = factor(inst_type, levels = c("Executive", "Horizontal", "Societal"))
  )

cat("=== Predicted trust by party × wave × institution type ===\n")
pred_m3 |>
  select(wave_f, inst_type, party_id3, estimate, conf.low, conf.high) |>
  mutate(across(where(is.numeric), ~round(.x, 3))) |>
  print()
```

### Table 5: Partisan model key interactions

```{r tbl5-partisan}
tbl5_rows <- partisan_ct |>
  tidy() |>
  filter(str_detect(term, "party_id3") & str_detect(term, ":")) |>
  mutate(
    stars = sig_stars(p.value),
    term  = term |>
      str_replace_all("wave_num", "Wave") |>
      str_replace_all("inst_type", "Inst.type:") |>
      str_replace_all("party_id3", "Party:")
  ) |>
  select(term, estimate, std.error, p.value, stars) |>
  mutate(across(c(estimate, std.error), ~round(.x, 4)),
         p.value = round(p.value, 4))

write_csv(tbl5_rows, file.path(tables_dir, "tbl5_partisan_model.csv"))

tbl5_rows |>
  kbl(caption = "Partisan sorting check: three-way interaction terms (key estimates only)",
      col.names = c("Term", "Estimate", "SE", "p", "")) |>
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) |>
  footnote(general = paste0(
    "Reference category: None/Other, Executive institution, Wave 1. ",
    "Full model includes Wave × Inst.type and Wave × Party interactions. ",
    "Cluster-robust SEs. *** p<0.001, ** p<0.01, * p<0.05."
  ))
```

---

## Save all model objects

```{r save}
threeway_results <- list(
  model    = threeway_mod,
  vcov     = threeway_vcov,
  coeftest = threeway_ct,
  predicted = pred_m1_df,
  ame_wave  = as.data.frame(ame_wave)
)
saveRDS(threeway_results, file.path(results_dir, "threeway_model.rds"))
cat("✓ threeway_model.rds saved\n")

outleg_results <- list(
  model     = outleg_mod,
  vcov      = outleg_vcov,
  coeftest  = outleg_ct,
  predicted = pred_m2,
  econ_lo   = econ_lo,
  econ_hi   = econ_hi
)
saveRDS(outleg_results, file.path(results_dir, "output_legitimacy_model.rds"))
cat("✓ output_legitimacy_model.rds saved\n")

partisan_results <- list(
  model     = partisan_mod,
  vcov      = partisan_vcov,
  coeftest  = partisan_ct,
  predicted = pred_m3
)
saveRDS(partisan_results, file.path(results_dir, "partisan_model.rds"))
cat("✓ partisan_model.rds saved\n")

cat("\n=== Model estimation complete ===\n")
cat("Main model N:", nobs(threeway_mod), "obs /",
    n_distinct(kamos_long$resp_id), "respondents\n")
```
