---
title: "00 — Data Preparation: The Accountability Paradox"
subtitle: "ABS Korea (W1–W6) + KAMOS (W1/W4) — variable construction and dataset building"
format:
  html:
    toc: true
    toc-depth: 3
    number-sections: true
    theme: cosmo
    code-fold: true
    self-contained: true
execute:
  echo: true
  warning: false
  message: false
  cache: true
---

**Purpose**: Load harmonized ABS and KAMOS data, filter to South Korea, construct
analysis variables, and save the analysis-ready datasets.

- **Inputs**: `abs_harmonized_path`, `kamos_harmonized_path` (via `_data_config.R`)
- **Outputs**:
  - `analysis/results/abs_wave_means.rds`   — ABS Korea wave-level trust/satisfaction means
  - `analysis/results/kamos_wide.rds`        — KAMOS respondent-level wide format (W1/W4)
  - `analysis/results/kamos_long.rds`        — KAMOS institution-stacked long format (5 per respondent)
  - `analysis/results/kamos_all_vars.rds`    — All 10 KAMOS trust items with wave means (direction table)
  - `analysis/results/descriptives.rds`      — Descriptive statistics for appendix

```{r setup}
library(tidyverse)
library(haven)

project_root <- "/Users/jeffreystark/Development/Research/paper-bank"
source(file.path(project_root, "_data_config.R"))

paper_dir    <- file.path(project_root, "papers/08_south_korea_impeachment")
analysis_dir <- file.path(paper_dir, "analysis")
results_dir  <- file.path(analysis_dir, "results")
fig_dir      <- file.path(analysis_dir, "figures")
tables_dir   <- file.path(analysis_dir, "tables")

dir.create(results_dir, showWarnings = FALSE, recursive = TRUE)
dir.create(fig_dir,     showWarnings = FALSE, recursive = TRUE)
dir.create(tables_dir,  showWarnings = FALSE, recursive = TRUE)

source(file.path(paper_dir, "R", "helpers.R"))
```

## Part 1: ABS Korea (Waves 1–6, 2003–2022)

### Load and filter

```{r abs-load}
abs_all <- readRDS(abs_harmonized_path)
cat("ABS harmonized:", nrow(abs_all), "obs,", ncol(abs_all), "variables\n")
cat("Countries:", n_distinct(abs_all$country), "\n")

# Filter to South Korea (country == 3), all six waves
korea_abs <- abs_all |>
  filter(country == 3)

cat("\nKorea ABS: n =", nrow(korea_abs),
    "| Waves:", paste(sort(unique(korea_abs$wave)), collapse = ", "), "\n")
```

### Variable construction

The ABS analysis establishes the long-run decoupling between democratic satisfaction
and intermediary trust. Key variables (all on 1–4 scales, higher = more):

```{r abs-vars}
# CHECK: verify exact harmonized variable names against abs_harmonized codebook.
# The names below follow the harmonized conventions used across this repo.

korea_abs <- korea_abs |>
  mutate(
    # --- Democratic satisfaction (q90) ---
    # 1=Not at all satisfied, 4=Very satisfied
    dem_sat = democracy_satisfaction,

    # --- Democratic quality/extent assessment ---
    # ABS: "To what extent is Korea governed democratically?" (1-4)
    dem_quality = dem_extent_current,

    # --- Government responsiveness ---
    # ABS: "The government responds to what people want" (1-4)
    govt_resp = govt_responds_people,

    # --- Economic evaluation (current national conditions) ---
    econ_eval_raw = econ_national_now,

    # --- Institutional trust (1-4 scale, higher = more trust) ---
    # Executive
    trust_exec = trust_national_government,

    # Horizontal accountability
    trust_legis      = trust_parliament,
    trust_courts_abs = trust_courts,

    # Societal: average newspaper and television trust
    trust_media_abs = rowMeans(cbind(trust_newspapers, trust_television), na.rm = TRUE),

    # --- Normalize all to 0-1 ---
    dem_sat_n      = normalize_01(dem_sat),
    dem_quality_n  = normalize_01(dem_quality),
    govt_resp_n    = normalize_01(govt_resp),
    econ_eval_n    = normalize_01(econ_eval_raw),
    trust_exec_n   = normalize_01(trust_exec),
    trust_legis_n  = normalize_01(trust_legis),
    trust_courts_n = normalize_01(trust_courts_abs),
    trust_media_n  = normalize_01(trust_media_abs)
  )
```

### ABS wave-level means

```{r abs-wave-means}
# Wave year labels for plots
wave_years <- c("1" = 2003, "2" = 2006, "3" = 2010, "4" = 2014, "5" = 2016, "6" = 2021)

abs_wave_means <- korea_abs |>
  group_by(wave) |>
  summarise(
    year           = wave_years[as.character(unique(wave)[1])],
    n              = n(),
    dem_sat        = mean(dem_sat_n,      na.rm = TRUE),
    dem_quality    = mean(dem_quality_n,  na.rm = TRUE),
    govt_resp      = mean(govt_resp_n,    na.rm = TRUE),
    econ_eval      = mean(econ_eval_n,    na.rm = TRUE),
    trust_exec     = mean(trust_exec_n,   na.rm = TRUE),
    trust_legis    = mean(trust_legis_n,  na.rm = TRUE),
    trust_courts   = mean(trust_courts_n, na.rm = TRUE),
    trust_media    = mean(trust_media_n,  na.rm = TRUE),
    # SEs for plotting
    dem_sat_se     = sd(dem_sat_n,      na.rm = TRUE) / sqrt(sum(!is.na(dem_sat_n))),
    trust_exec_se  = sd(trust_exec_n,   na.rm = TRUE) / sqrt(sum(!is.na(trust_exec_n))),
    trust_legis_se = sd(trust_legis_n,  na.rm = TRUE) / sqrt(sum(!is.na(trust_legis_n))),
    trust_media_se = sd(trust_media_n,  na.rm = TRUE) / sqrt(sum(!is.na(trust_media_n))),
    .groups = "drop"
  ) |>
  arrange(wave)

cat("ABS wave means computed:\n")
abs_wave_means |>
  select(wave, year, n, dem_sat, trust_exec, trust_legis, trust_media) |>
  print()
```

### Diagnostics

```{r abs-diagnostics}
cat("=== ABS Korea: variable coverage by wave ===\n")
korea_abs |>
  group_by(wave) |>
  summarise(
    n           = n(),
    pct_dem_sat = round(mean(!is.na(dem_sat)) * 100, 1),
    pct_exec    = round(mean(!is.na(trust_exec_n)) * 100, 1),
    pct_legis   = round(mean(!is.na(trust_legis_n)) * 100, 1),
    pct_media   = round(mean(!is.na(trust_media_n)) * 100, 1),
    pct_quality = round(mean(!is.na(dem_quality_n)) * 100, 1),
    pct_econ    = round(mean(!is.na(econ_eval_n)) * 100, 1),
    .groups = "drop"
  ) |>
  print()
```

---

## Part 2: KAMOS (Waves 1 and 4, 2016 and 2019)

### Load and filter

```{r kamos-load}
kamos_all_raw <- readRDS(kamos_harmonized_path)
cat("KAMOS harmonized:", nrow(kamos_all_raw), "obs,", ncol(kamos_all_raw), "variables\n")
cat("Waves available:", paste(sort(unique(kamos_all_raw$wave)), collapse = ", "), "\n")

# Filter to waves 1 (2016) and 4 (2019)
kamos_raw <- kamos_all_raw |>
  filter(wave %in% c(1, 4))

cat("\nKAMOS W1/W4: n =", nrow(kamos_raw),
    "| W1:", sum(kamos_raw$wave == 1),
    "| W4:", sum(kamos_raw$wave == 4), "\n")
```

### Construct respondent ID and design variables

```{r kamos-ids}
# Construct a stable respondent ID for cluster-robust SEs
kamos_raw <- kamos_raw |>
  mutate(
    resp_id = row_number(),   # unique within the filtered (wide) dataset

    # Wave as factor and numeric (0/1 for interaction models)
    wave_f   = factor(wave, levels = c(1, 4), labels = c("W1 (2016)", "W4 (2019)")),
    wave_num = if_else(wave == 1, 0L, 1L),   # 0 = pre-crisis, 1 = post-crisis

    # Survey weight (use 1.0 if missing)
    weight = if_else(is.na(weight), 1.0, weight)
  )
```

### Construct trust variables

```{r kamos-trust}
# KAMOS institutional trust battery: 1-5 scale (1=do not trust at all, 5=trust very much)
# We normalize to 0-1 for pooled models with OLS.
# Trust variable names follow the KAMOS harmonized conventions used in paper 07 (SKA).

kamos_raw <- kamos_raw |>
  mutate(
    # --- Raw trust items (1-5 scale) ---
    # Executive institutions
    trust_cg_raw = trust_central_govt,   # central government
    trust_lg_raw = trust_local_govt,     # local government

    # Horizontal accountability institutions
    trust_na_raw = trust_national_assembly,  # National Assembly
    trust_le_raw = trust_legislature,         # legislature composite / courts

    # Societal accountability institutions
    trust_md_raw = trust_media,   # news media
    trust_ng_raw = trust_ngo,     # NGOs / civil society organizations

    # --- Normalized 0-1 (for regression) ---
    trust_cg_n = normalize_01(trust_cg_raw),
    trust_lg_n = normalize_01(trust_lg_raw),
    trust_na_n = normalize_01(trust_na_raw),
    trust_le_n = normalize_01(trust_le_raw),
    trust_md_n = normalize_01(trust_md_raw),
    trust_ng_n = normalize_01(trust_ng_raw),

    # --- Institution-type composites (normalized) ---
    exec_trust_n = rowMeans(cbind(trust_cg_n, trust_lg_n), na.rm = TRUE),
    horiz_trust_n = rowMeans(cbind(trust_na_n, trust_le_n), na.rm = TRUE),
    soc_trust_n   = rowMeans(cbind(trust_md_n, trust_ng_n), na.rm = TRUE)
  )
```

### Construct economic and political controls

```{r kamos-controls}
kamos_raw <- kamos_raw |>
  mutate(
    # --- Economic evaluation (KAMOS: econ_national, econ_family; likely 1-5) ---
    econ_present_raw = econ_national,
    econ_present_n   = normalize_01(econ_national),

    # Economic composite: average national + family economic evaluations
    econ_composite_n = rowMeans(
      cbind(normalize_01(econ_national), normalize_01(econ_family)),
      na.rm = TRUE
    ),

    # --- Demographic controls ---
    age_n    = normalize_01(age),
    gender   = as.integer(gender),   # typically 0=female, 1=male; CHECK coding
    edu_n    = normalize_01(education),
    income_n = normalize_01(income),

    # --- Political controls ---
    ideology_n = normalize_01(ideology),   # left-right, CHECK direction
    party_id   = as.factor(party_id)       # party identification as factor
  )
```

### Reliability check: horizontal composite

```{r horiz-reliability}
# Pearson correlation between the two horizontal trust items
r_horiz <- cor(kamos_raw$trust_na_raw, kamos_raw$trust_le_raw,
               use = "pairwise.complete.obs")
cat("Horizontal trust composite (NA + Legislature) correlation: r =",
    round(r_horiz, 3), "\n")

# Also check executive and societal composites
r_exec <- cor(kamos_raw$trust_cg_raw, kamos_raw$trust_lg_raw,
              use = "pairwise.complete.obs")
r_soc  <- cor(kamos_raw$trust_md_raw, kamos_raw$trust_ng_raw,
              use = "pairwise.complete.obs")
cat("Executive trust composite (CG + LG) correlation: r =",  round(r_exec, 3), "\n")
cat("Societal trust composite (Media + NGO) correlation: r =", round(r_soc,  3), "\n")
```

### Build wide dataset

```{r kamos-wide}
# Select respondent-level analysis variables (one row per respondent per wave)
kamos_wide <- kamos_raw |>
  select(
    resp_id, wave, wave_f, wave_num, weight,
    # Trust items (raw and normalized)
    trust_cg_raw, trust_lg_raw, trust_na_raw, trust_le_raw,
    trust_md_raw, trust_ng_raw,
    trust_cg_n, trust_lg_n, trust_na_n, trust_le_n, trust_md_n, trust_ng_n,
    # Composites
    exec_trust_n, horiz_trust_n, soc_trust_n,
    # Economic
    econ_present_raw, econ_present_n, econ_composite_n,
    # Controls
    age_n, gender, edu_n, income_n, ideology_n, party_id
  )

cat("KAMOS wide: n =", nrow(kamos_wide), "| Waves:", paste(unique(kamos_wide$wave), collapse = "/"), "\n")
```

### Build institution-stacked long dataset

Five institutions are stacked as separate observations per respondent, each assigned
to an accountability-function category (Executive / Horizontal / Societal).

```{r kamos-long}
# Stack five institutions: CentralGovt, LocalGovt, NatlAssembly, Media, NGO
kamos_long <- kamos_wide |>
  pivot_longer(
    cols = c(trust_cg_n, trust_lg_n, trust_na_n, trust_md_n, trust_ng_n),
    names_to  = "institution",
    values_to = "trust_score_n"
  ) |>
  mutate(
    # Human-readable institution label
    inst_label = recode(institution,
      trust_cg_n = "Central Govt",
      trust_lg_n = "Local Govt",
      trust_na_n = "National Assembly",
      trust_md_n = "Media",
      trust_ng_n = "NGOs"
    ),
    # Three-way institution-type factor (Executive = reference category)
    inst_type = factor(
      recode(institution,
        trust_cg_n = "Executive",
        trust_lg_n = "Executive",
        trust_na_n = "Horizontal",
        trust_md_n = "Societal",
        trust_ng_n = "Societal"
      ),
      levels = c("Executive", "Horizontal", "Societal")
    ),
    # Keep raw trust score (1-5 scale) for ordered logit robustness check
    trust_score_raw = case_when(
      institution == "trust_cg_n" ~ trust_cg_raw,
      institution == "trust_lg_n" ~ trust_lg_raw,
      institution == "trust_na_n" ~ trust_na_raw,
      institution == "trust_md_n" ~ trust_md_raw,
      institution == "trust_ng_n" ~ trust_ng_raw
    )
  )

cat("KAMOS long: n =", nrow(kamos_long), "obs (",
    nrow(kamos_wide), "respondents × 5 institutions)\n")
cat("Institution-type distribution:\n")
kamos_long |> count(inst_type, inst_label) |> print()
```

### Build all-variables dataset (direction table, appendix)

```{r kamos-all-vars}
# All available KAMOS trust items (up to 10) with wave means
# Used for Appendix D direction table showing which items rose/fell
all_trust_vars <- kamos_raw |>
  select(wave, wave_f, weight,
         matches("^trust_"), matches("^confidence_"))

# Compute weighted means by wave for all trust items
kamos_all_vars <- all_trust_vars |>
  group_by(wave, wave_f) |>
  summarise(
    n = n(),
    across(
      matches("^trust_|^confidence_"),
      list(
        mean = ~weighted.mean(.x, weight, na.rm = TRUE),
        sd   = ~sd(.x, na.rm = TRUE)
      ),
      .names = "{.col}_{.fn}"
    ),
    .groups = "drop"
  )

cat("KAMOS all-vars direction table: ", ncol(kamos_all_vars), "columns\n")
```

### Descriptive statistics

```{r descriptives}
desc_wide <- kamos_wide |>
  group_by(wave_f) |>
  summarise(
    n              = n(),
    # Trust means (normalized)
    exec_trust     = weighted.mean(exec_trust_n,  weight, na.rm = TRUE),
    horiz_trust    = weighted.mean(horiz_trust_n, weight, na.rm = TRUE),
    soc_trust      = weighted.mean(soc_trust_n,   weight, na.rm = TRUE),
    # Trust items individually
    cg_trust       = weighted.mean(trust_cg_n, weight, na.rm = TRUE),
    lg_trust       = weighted.mean(trust_lg_n, weight, na.rm = TRUE),
    na_trust       = weighted.mean(trust_na_n, weight, na.rm = TRUE),
    md_trust       = weighted.mean(trust_md_n, weight, na.rm = TRUE),
    ng_trust       = weighted.mean(trust_ng_n, weight, na.rm = TRUE),
    # Economic evaluation
    econ_mean      = weighted.mean(econ_present_n, weight, na.rm = TRUE),
    # Demographics
    age_mean       = mean(age_n, na.rm = TRUE),
    pct_female     = mean(gender == 0, na.rm = TRUE),
    edu_mean       = mean(edu_n, na.rm = TRUE),
    income_mean    = mean(income_n, na.rm = TRUE),
    ideology_mean  = mean(ideology_n, na.rm = TRUE),
    .groups = "drop"
  )

cat("=== KAMOS Descriptives by Wave ===\n")
desc_wide |>
  select(wave_f, n, exec_trust, horiz_trust, soc_trust, econ_mean) |>
  print()

# Descriptives for each normalized variable (pooled)
desc_vars <- kamos_long |>
  group_by(wave_f, inst_type) |>
  summarise(
    n           = n(),
    mean_trust  = weighted.mean(trust_score_n, weight, na.rm = TRUE),
    sd_trust    = sd(trust_score_n, na.rm = TRUE),
    pct_missing = mean(is.na(trust_score_n)),
    .groups     = "drop"
  )

cat("\n=== Trust by Wave and Institution Type ===\n")
print(desc_vars)
```

### Missing data summary

```{r missing-data}
cat("=== Missing data: key KAMOS variables ===\n")
kamos_wide |>
  group_by(wave_f) |>
  summarise(
    across(
      c(trust_cg_n, trust_na_n, trust_md_n, econ_present_n,
        age_n, edu_n, income_n, ideology_n),
      ~round(mean(is.na(.x)) * 100, 1),
      .names = "pct_miss_{.col}"
    ),
    .groups = "drop"
  ) |>
  print()
```

## Save all datasets

```{r save}
saveRDS(abs_wave_means, file.path(results_dir, "abs_wave_means.rds"))
cat("✓ abs_wave_means.rds:", nrow(abs_wave_means), "rows\n")

saveRDS(kamos_wide, file.path(results_dir, "kamos_wide.rds"))
cat("✓ kamos_wide.rds:", nrow(kamos_wide), "rows\n")

saveRDS(kamos_long, file.path(results_dir, "kamos_long.rds"))
cat("✓ kamos_long.rds:", nrow(kamos_long), "rows\n")

saveRDS(kamos_all_vars, file.path(results_dir, "kamos_all_vars.rds"))
cat("✓ kamos_all_vars.rds saved\n")

descriptives <- list(
  wave_level  = desc_wide,
  by_inst_type = desc_vars,
  horiz_r     = r_horiz,
  exec_r      = r_exec,
  soc_r       = r_soc
)
saveRDS(descriptives, file.path(results_dir, "descriptives.rds"))
cat("✓ descriptives.rds saved\n")

cat("\n=== Data preparation complete ===\n")
cat("Total KAMOS respondents:", nrow(kamos_wide), "\n")
cat("  W1 (2016):", sum(kamos_wide$wave == 1), "\n")
cat("  W4 (2019):", sum(kamos_wide$wave == 4), "\n")
cat("ABS Korea observations:", nrow(korea_abs), "\n")
cat("  Waves:", paste(sort(unique(korea_abs$wave)), collapse = ", "), "\n")
```
